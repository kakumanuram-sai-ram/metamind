## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by T20 Cities

This metric tracks user engagement and transaction activity segmented by India's top 20 cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and calculated Transactions Per User (TPU) to assess geographic performance patterns. The analysis filters for users with defined lifecycle status and applies temporal filtering on transaction dates. Cities not in the top 20 list are grouped as "Other" for comparison. This enables geographic performance analysis and identification of high-engagement metropolitan markets within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn
hive.midgar.engage_data_snapshot_v3 user_geo
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction validity and success criteria
upi_txn.transaction_type IN ('PAY','COLLECT') AND
upi_txn.status IN ('SUCCESS','DEEMED') AND
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- user lifecycle filtering for active users only
lifecycle IS NOT NULL

--- specific filters
--- temporal range for transaction analysis period
upi_txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
upi_txn.transaction_date_key < current_date AND
--- geographic segmentation for top 20 cities
CASE WHEN upper(user_geo.popular_city) IN ('NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA') THEN user_geo.popular_city ELSE 'Other' END

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1,payer_cust_id,null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1,payer_cust_id,null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(DAU) as TPU




## UPI Overall Retention: Monthly

This metric tracks UPI user retention across monthly cohorts, measuring what percentage of users from each base month continue to be active in subsequent months. The analysis categorizes users by lifecycle status, consolidating certain reactive user types into broader categories. It calculates retention by dividing the number of users active in each retention month by the total users from the corresponding base month. The metric helps understand user engagement patterns and lifecycle behavior across different monthly cohorts, providing insights into user stickiness and platform engagement over time. Data covers the most recent 4-month period to ensure relevance and statistical significance.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to recent 4-month window for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month from base month calculations
date_trunc('month', a.dt) < current_date

--- specific filters
--- consolidate reactive user categories for simplified lifecycle analysis
if(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as user_type

--- calculation_logic
WITH cc AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, 
         if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type
),
reten AS (
  SELECT date_diff('month', a.mt, b.mt) as diff, a.mt base_month, b.mt retention_month,
         count(distinct b.scope_cust_id) users
  FROM cc a LEFT JOIN cc b ON b.scope_cust_id = a.scope_cust_id
  WHERE b.mt >= a.mt
  GROUP BY 1,2,3
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) AS Retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states by measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transaction count, and Transactions Per User (TPU). It provides geographic insights into UPI ecosystem performance by analyzing successful payment transactions from major PSP partners including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The analysis focuses on users with defined lifecycle classifications and includes both peer-to-peer and merchant payment categories. TPU is calculated as the ratio of total transactions to DAU, indicating transaction frequency per active user. This state-wise segmentation enables regional performance comparison and helps identify high-engagement markets for strategic decision-making in the UPI payments ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.midgar.engage_data_snapshot_v3 top20
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key < current_date AND
--- only successful transactions
a.status IN ('SUCCESS', 'DEEMED') AND
--- core UPI transaction types
transaction_type IN ('PAY', 'COLLECT') AND
--- major payment categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- paytm ecosystem PSP partners for comprehensive coverage
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
count(distinct if(rn_dau = 1, payer_cust_id, null)) as DAU,
count(distinct if(rn_mau = 1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns) * 1.00 / sum(DAU) as TPU




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance. It calculates the percentage of successful transactions (including deemed success) against total attempted transactions across different UPI flows. The analysis focuses on major PSPs including Paytm, Yes Bank, Axis, HDFC, and SBI, covering PAY and COLLECT transaction types over the last two months. This success rate metric helps identify flow-specific performance issues and compare reliability across different payment channels within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: last 2 months including current month
transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND

--- specific filters  
--- focus on core transaction types for success rate analysis
transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- VPA-based flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
SR: CAST(ROUND(SUM(success_txn)*100/SUM(overall_txn), 2) AS VARCHAR) || '%'




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category to monitor operational performance trends with day-over-day comparison capabilities. It calculates the ratio of successful transactions (including deemed successful) to total attempted transactions across PAY and COLLECT transaction types. The analysis focuses on key PSP partners (Paytm, Yes Bank, Axis, HDFC, SBI) while excluding mandate-related and onus flows to provide clarity on core P2P and P2M transaction performance. The temporal scope covers the previous month to yesterday, enabling stakeholders to identify performance patterns, detect anomalies, and assess the health of different transaction flow categories within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction recency filter for performance optimization
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: previous month start to yesterday
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month 
and current_date + interval '-1' day AND
--- core UPI transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on key PSP ecosystem partners
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and onus flows for core transaction analysis
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)
SR: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category, showing day-over-day trends for operational performance monitoring. It measures the percentage of successful transactions (including deemed success) out of total attempted transactions across different UPI flow types. The analysis focuses on standard payment flows by excluding mandate-related and onus transaction categories, while limiting scope to transactions processed through major PSP handles (Paytm ecosystem). The temporal window covers the previous month to current date, enabling trend analysis and performance comparison across different transaction flow categories for operational insights and system reliability assessment.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- focus on payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to major PSP ecosystem handles
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- include standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
AND current_date + interval '-1' day AND
--- exclude mandate and onus flow categories for focus on standard flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
SUM(success_txn * 1.0000) / SUM(overall_txn) as SR
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their base month (M0) to measure initial user acquisition and engagement patterns. It calculates the total count of active users in their first month of activity and their month-over-month growth percentage. The analysis focuses specifically on M0 cohorts (diff=0) to understand new user onboarding success and growth trends. The metric provides insights into user acquisition velocity and helps identify patterns in initial user engagement within the UPI ecosystem. This forms the foundation for broader retention analysis by establishing baseline user counts before tracking their subsequent monthly activity patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on M0 cohort analysis - users in their base month
vt.diff = 0 AND
--- exclude current month to ensure complete data
vt.base_month < current_date AND
--- limit analysis window to recent 4 months for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month

--- specific filters
--- temporal range filter (no specific constraint applied)
--- base_month temporal range = 'No filter'

--- calculation_logic
sum(vt.users) as MAU,
SUM(vt.mom_growth * 1.0000) / SUM(vt.users) as growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI LMTD Retention

This metric tracks UPI user retention from last month to current month-to-date, segmented by user lifecycle stages including reactive users (consolidated from react 1-3 and react 3+ categories). It measures how many users who were active in the previous month continue to transact in the current month, providing insights into user engagement and stickiness across different behavioral segments. The analysis focuses on Paytm ecosystem transactions (payer handles: paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes PAY/COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention rate calculation shows the percentage of last month's user base that remains active in the current period.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp filtering
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status filtering
txn.status IN ('SUCCESS','DEEMED') AND
--- core upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- current month period for retention analysis
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.dl_last_updated <= current_date + interval '-1' day + interval '-1' month AND
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.transaction_date_key <= current_date + interval '-1' day + interval '-1' month

--- calculation_logic
--- lifecycle consolidation: reactive users (react 1-3 and react 3+ combined as 'c:react')
if(mau.user_type in ('c:react 3+','c:react 1-3'),'c:react',mau.user_type) as lifecycle,
--- base users from last month
count(distinct mau.scope_cust_id) as Base_users,
--- retained users active in current month
count(distinct txn.customer_id_payer) as Retained_users,
--- retention rate calculation
sum(Retained_users) * 1.0000 / sum(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## RMG Retentions

RMG Retentions tracks user retention rates for gaming merchant customers across monthly cohorts, measuring how many monthly active users (MAU) from gaming merchants continue to perform UPI transactions in the following month. The analysis segments users by lifecycle stages (including consolidated 'c:react' for users with 1+ reactions) and gaming merchant status, calculating retention as a percentage of retained users divided by total MAU users. The metric focuses specifically on gaming merchants identified through transaction patterns from May to August 2025, tracking their retention from August to September and September to October periods, filtering for successful UPI transactions across Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) in VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND
gma.mnt <= date'2025-08-31' AND
gma.gaming_merc = 'Gaming merc' AND

--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- cohort-specific date ranges for retention measurement
--- Aug-to-Sep cohort: MAU from Aug 2025, retention checked in Sep 2025
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
day(txn.transaction_date_key) < day(current_date)

--- Sep-to-Oct cohort: MAU from Sep 2025, retention checked in Oct 2025  
mau.dt >= date'2025-09-01' AND mau.dt <= date'2025-09-30' AND
txn.dl_last_updated BETWEEN date'2025-10-01' AND date'2025-10-31' AND
txn.transaction_date_key BETWEEN date'2025-10-01' AND date'2025-10-31' AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct mau.cust_id) as mau_users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(mau_users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gm_flag,
if(mau.user_type in ('c:react 3+','c:react 1-3'), 'c:react', mau.user_type) as lifecycle




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag



