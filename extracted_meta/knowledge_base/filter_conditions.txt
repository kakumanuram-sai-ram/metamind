
================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard merged
================================================================================


================================================================================
## Dashboard 511
================================================================================

## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 476
================================================================================

## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by T20 Cities

This metric tracks user engagement and transaction activity segmented by India's top 20 cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and calculated Transactions Per User (TPU) to assess geographic performance patterns. The analysis filters for users with defined lifecycle status and applies temporal filtering on transaction dates. Cities not in the top 20 list are grouped as "Other" for comparison. This enables geographic performance analysis and identification of high-engagement metropolitan markets within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn
hive.midgar.engage_data_snapshot_v3 user_geo
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction validity and success criteria
upi_txn.transaction_type IN ('PAY','COLLECT') AND
upi_txn.status IN ('SUCCESS','DEEMED') AND
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- user lifecycle filtering for active users only
lifecycle IS NOT NULL

--- specific filters
--- temporal range for transaction analysis period
upi_txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
upi_txn.transaction_date_key < current_date AND
--- geographic segmentation for top 20 cities
CASE WHEN upper(user_geo.popular_city) IN ('NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA') THEN user_geo.popular_city ELSE 'Other' END

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1,payer_cust_id,null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1,payer_cust_id,null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(DAU) as TPU




## UPI Overall Retention: Monthly

This metric tracks UPI user retention across monthly cohorts, measuring what percentage of users from each base month continue to be active in subsequent months. The analysis categorizes users by lifecycle status, consolidating certain reactive user types into broader categories. It calculates retention by dividing the number of users active in each retention month by the total users from the corresponding base month. The metric helps understand user engagement patterns and lifecycle behavior across different monthly cohorts, providing insights into user stickiness and platform engagement over time. Data covers the most recent 4-month period to ensure relevance and statistical significance.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to recent 4-month window for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month from base month calculations
date_trunc('month', a.dt) < current_date

--- specific filters
--- consolidate reactive user categories for simplified lifecycle analysis
if(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as user_type

--- calculation_logic
WITH cc AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, 
         if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type
),
reten AS (
  SELECT date_diff('month', a.mt, b.mt) as diff, a.mt base_month, b.mt retention_month,
         count(distinct b.scope_cust_id) users
  FROM cc a LEFT JOIN cc b ON b.scope_cust_id = a.scope_cust_id
  WHERE b.mt >= a.mt
  GROUP BY 1,2,3
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) AS Retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states by measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transaction count, and Transactions Per User (TPU). It provides geographic insights into UPI ecosystem performance by analyzing successful payment transactions from major PSP partners including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The analysis focuses on users with defined lifecycle classifications and includes both peer-to-peer and merchant payment categories. TPU is calculated as the ratio of total transactions to DAU, indicating transaction frequency per active user. This state-wise segmentation enables regional performance comparison and helps identify high-engagement markets for strategic decision-making in the UPI payments ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.midgar.engage_data_snapshot_v3 top20
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key < current_date AND
--- only successful transactions
a.status IN ('SUCCESS', 'DEEMED') AND
--- core UPI transaction types
transaction_type IN ('PAY', 'COLLECT') AND
--- major payment categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- paytm ecosystem PSP partners for comprehensive coverage
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
count(distinct if(rn_dau = 1, payer_cust_id, null)) as DAU,
count(distinct if(rn_mau = 1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns) * 1.00 / sum(DAU) as TPU




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance. It calculates the percentage of successful transactions (including deemed success) against total attempted transactions across different UPI flows. The analysis focuses on major PSPs including Paytm, Yes Bank, Axis, HDFC, and SBI, covering PAY and COLLECT transaction types over the last two months. This success rate metric helps identify flow-specific performance issues and compare reliability across different payment channels within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: last 2 months including current month
transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND

--- specific filters  
--- focus on core transaction types for success rate analysis
transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- VPA-based flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
SR: CAST(ROUND(SUM(success_txn)*100/SUM(overall_txn), 2) AS VARCHAR) || '%'




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category to monitor operational performance trends with day-over-day comparison capabilities. It calculates the ratio of successful transactions (including deemed successful) to total attempted transactions across PAY and COLLECT transaction types. The analysis focuses on key PSP partners (Paytm, Yes Bank, Axis, HDFC, SBI) while excluding mandate-related and onus flows to provide clarity on core P2P and P2M transaction performance. The temporal scope covers the previous month to yesterday, enabling stakeholders to identify performance patterns, detect anomalies, and assess the health of different transaction flow categories within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction recency filter for performance optimization
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: previous month start to yesterday
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month 
and current_date + interval '-1' day AND
--- core UPI transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on key PSP ecosystem partners
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and onus flows for core transaction analysis
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)
SR: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category, showing day-over-day trends for operational performance monitoring. It measures the percentage of successful transactions (including deemed success) out of total attempted transactions across different UPI flow types. The analysis focuses on standard payment flows by excluding mandate-related and onus transaction categories, while limiting scope to transactions processed through major PSP handles (Paytm ecosystem). The temporal window covers the previous month to current date, enabling trend analysis and performance comparison across different transaction flow categories for operational insights and system reliability assessment.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- focus on payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to major PSP ecosystem handles
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- include standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
AND current_date + interval '-1' day AND
--- exclude mandate and onus flow categories for focus on standard flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
SUM(success_txn * 1.0000) / SUM(overall_txn) as SR
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their base month (M0) to measure initial user acquisition and engagement patterns. It calculates the total count of active users in their first month of activity and their month-over-month growth percentage. The analysis focuses specifically on M0 cohorts (diff=0) to understand new user onboarding success and growth trends. The metric provides insights into user acquisition velocity and helps identify patterns in initial user engagement within the UPI ecosystem. This forms the foundation for broader retention analysis by establishing baseline user counts before tracking their subsequent monthly activity patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on M0 cohort analysis - users in their base month
vt.diff = 0 AND
--- exclude current month to ensure complete data
vt.base_month < current_date AND
--- limit analysis window to recent 4 months for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month

--- specific filters
--- temporal range filter (no specific constraint applied)
--- base_month temporal range = 'No filter'

--- calculation_logic
sum(vt.users) as MAU,
SUM(vt.mom_growth * 1.0000) / SUM(vt.users) as growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI LMTD Retention

This metric tracks UPI user retention from last month to current month-to-date, segmented by user lifecycle stages including reactive users (consolidated from react 1-3 and react 3+ categories). It measures how many users who were active in the previous month continue to transact in the current month, providing insights into user engagement and stickiness across different behavioral segments. The analysis focuses on Paytm ecosystem transactions (payer handles: paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes PAY/COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention rate calculation shows the percentage of last month's user base that remains active in the current period.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp filtering
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status filtering
txn.status IN ('SUCCESS','DEEMED') AND
--- core upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- current month period for retention analysis
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.dl_last_updated <= current_date + interval '-1' day + interval '-1' month AND
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.transaction_date_key <= current_date + interval '-1' day + interval '-1' month

--- calculation_logic
--- lifecycle consolidation: reactive users (react 1-3 and react 3+ combined as 'c:react')
if(mau.user_type in ('c:react 3+','c:react 1-3'),'c:react',mau.user_type) as lifecycle,
--- base users from last month
count(distinct mau.scope_cust_id) as Base_users,
--- retained users active in current month
count(distinct txn.customer_id_payer) as Retained_users,
--- retention rate calculation
sum(Retained_users) * 1.0000 / sum(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## RMG Retentions

RMG Retentions tracks user retention rates for gaming merchant customers across monthly cohorts, measuring how many monthly active users (MAU) from gaming merchants continue to perform UPI transactions in the following month. The analysis segments users by lifecycle stages (including consolidated 'c:react' for users with 1+ reactions) and gaming merchant status, calculating retention as a percentage of retained users divided by total MAU users. The metric focuses specifically on gaming merchants identified through transaction patterns from May to August 2025, tracking their retention from August to September and September to October periods, filtering for successful UPI transactions across Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) in VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND
gma.mnt <= date'2025-08-31' AND
gma.gaming_merc = 'Gaming merc' AND

--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- cohort-specific date ranges for retention measurement
--- Aug-to-Sep cohort: MAU from Aug 2025, retention checked in Sep 2025
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
day(txn.transaction_date_key) < day(current_date)

--- Sep-to-Oct cohort: MAU from Sep 2025, retention checked in Oct 2025  
mau.dt >= date'2025-09-01' AND mau.dt <= date'2025-09-30' AND
txn.dl_last_updated BETWEEN date'2025-10-01' AND date'2025-10-31' AND
txn.transaction_date_key BETWEEN date'2025-10-01' AND date'2025-10-31' AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct mau.cust_id) as mau_users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(mau_users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gm_flag,
if(mau.user_type in ('c:react 3+','c:react 1-3'), 'c:react', mau.user_type) as lifecycle




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag






================================================================================
## Dashboard 511
================================================================================

## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 476
================================================================================

## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by T20 Cities

This metric tracks user engagement and transaction activity segmented by India's top 20 cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and calculated Transactions Per User (TPU) to assess geographic performance patterns. The analysis filters for users with defined lifecycle status and applies temporal filtering on transaction dates. Cities not in the top 20 list are grouped as "Other" for comparison. This enables geographic performance analysis and identification of high-engagement metropolitan markets within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn
hive.midgar.engage_data_snapshot_v3 user_geo
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction validity and success criteria
upi_txn.transaction_type IN ('PAY','COLLECT') AND
upi_txn.status IN ('SUCCESS','DEEMED') AND
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- user lifecycle filtering for active users only
lifecycle IS NOT NULL

--- specific filters
--- temporal range for transaction analysis period
upi_txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
upi_txn.transaction_date_key < current_date AND
--- geographic segmentation for top 20 cities
CASE WHEN upper(user_geo.popular_city) IN ('NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA') THEN user_geo.popular_city ELSE 'Other' END

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1,payer_cust_id,null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1,payer_cust_id,null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(DAU) as TPU




## UPI Overall Retention: Monthly

This metric tracks UPI user retention across monthly cohorts, measuring what percentage of users from each base month continue to be active in subsequent months. The analysis categorizes users by lifecycle status, consolidating certain reactive user types into broader categories. It calculates retention by dividing the number of users active in each retention month by the total users from the corresponding base month. The metric helps understand user engagement patterns and lifecycle behavior across different monthly cohorts, providing insights into user stickiness and platform engagement over time. Data covers the most recent 4-month period to ensure relevance and statistical significance.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to recent 4-month window for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month from base month calculations
date_trunc('month', a.dt) < current_date

--- specific filters
--- consolidate reactive user categories for simplified lifecycle analysis
if(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as user_type

--- calculation_logic
WITH cc AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, 
         if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type
),
reten AS (
  SELECT date_diff('month', a.mt, b.mt) as diff, a.mt base_month, b.mt retention_month,
         count(distinct b.scope_cust_id) users
  FROM cc a LEFT JOIN cc b ON b.scope_cust_id = a.scope_cust_id
  WHERE b.mt >= a.mt
  GROUP BY 1,2,3
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) AS Retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states by measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transaction count, and Transactions Per User (TPU). It provides geographic insights into UPI ecosystem performance by analyzing successful payment transactions from major PSP partners including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The analysis focuses on users with defined lifecycle classifications and includes both peer-to-peer and merchant payment categories. TPU is calculated as the ratio of total transactions to DAU, indicating transaction frequency per active user. This state-wise segmentation enables regional performance comparison and helps identify high-engagement markets for strategic decision-making in the UPI payments ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.midgar.engage_data_snapshot_v3 top20
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key < current_date AND
--- only successful transactions
a.status IN ('SUCCESS', 'DEEMED') AND
--- core UPI transaction types
transaction_type IN ('PAY', 'COLLECT') AND
--- major payment categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- paytm ecosystem PSP partners for comprehensive coverage
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
count(distinct if(rn_dau = 1, payer_cust_id, null)) as DAU,
count(distinct if(rn_mau = 1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns) * 1.00 / sum(DAU) as TPU




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance. It calculates the percentage of successful transactions (including deemed success) against total attempted transactions across different UPI flows. The analysis focuses on major PSPs including Paytm, Yes Bank, Axis, HDFC, and SBI, covering PAY and COLLECT transaction types over the last two months. This success rate metric helps identify flow-specific performance issues and compare reliability across different payment channels within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: last 2 months including current month
transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND

--- specific filters  
--- focus on core transaction types for success rate analysis
transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- VPA-based flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
SR: CAST(ROUND(SUM(success_txn)*100/SUM(overall_txn), 2) AS VARCHAR) || '%'




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category to monitor operational performance trends with day-over-day comparison capabilities. It calculates the ratio of successful transactions (including deemed successful) to total attempted transactions across PAY and COLLECT transaction types. The analysis focuses on key PSP partners (Paytm, Yes Bank, Axis, HDFC, SBI) while excluding mandate-related and onus flows to provide clarity on core P2P and P2M transaction performance. The temporal scope covers the previous month to yesterday, enabling stakeholders to identify performance patterns, detect anomalies, and assess the health of different transaction flow categories within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction recency filter for performance optimization
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: previous month start to yesterday
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month 
and current_date + interval '-1' day AND
--- core UPI transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on key PSP ecosystem partners
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and onus flows for core transaction analysis
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)
SR: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category, showing day-over-day trends for operational performance monitoring. It measures the percentage of successful transactions (including deemed success) out of total attempted transactions across different UPI flow types. The analysis focuses on standard payment flows by excluding mandate-related and onus transaction categories, while limiting scope to transactions processed through major PSP handles (Paytm ecosystem). The temporal window covers the previous month to current date, enabling trend analysis and performance comparison across different transaction flow categories for operational insights and system reliability assessment.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- focus on payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to major PSP ecosystem handles
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- include standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
AND current_date + interval '-1' day AND
--- exclude mandate and onus flow categories for focus on standard flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
SUM(success_txn * 1.0000) / SUM(overall_txn) as SR
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their base month (M0) to measure initial user acquisition and engagement patterns. It calculates the total count of active users in their first month of activity and their month-over-month growth percentage. The analysis focuses specifically on M0 cohorts (diff=0) to understand new user onboarding success and growth trends. The metric provides insights into user acquisition velocity and helps identify patterns in initial user engagement within the UPI ecosystem. This forms the foundation for broader retention analysis by establishing baseline user counts before tracking their subsequent monthly activity patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on M0 cohort analysis - users in their base month
vt.diff = 0 AND
--- exclude current month to ensure complete data
vt.base_month < current_date AND
--- limit analysis window to recent 4 months for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month

--- specific filters
--- temporal range filter (no specific constraint applied)
--- base_month temporal range = 'No filter'

--- calculation_logic
sum(vt.users) as MAU,
SUM(vt.mom_growth * 1.0000) / SUM(vt.users) as growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI LMTD Retention

This metric tracks UPI user retention from last month to current month-to-date, segmented by user lifecycle stages including reactive users (consolidated from react 1-3 and react 3+ categories). It measures how many users who were active in the previous month continue to transact in the current month, providing insights into user engagement and stickiness across different behavioral segments. The analysis focuses on Paytm ecosystem transactions (payer handles: paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes PAY/COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention rate calculation shows the percentage of last month's user base that remains active in the current period.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp filtering
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status filtering
txn.status IN ('SUCCESS','DEEMED') AND
--- core upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- current month period for retention analysis
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.dl_last_updated <= current_date + interval '-1' day + interval '-1' month AND
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.transaction_date_key <= current_date + interval '-1' day + interval '-1' month

--- calculation_logic
--- lifecycle consolidation: reactive users (react 1-3 and react 3+ combined as 'c:react')
if(mau.user_type in ('c:react 3+','c:react 1-3'),'c:react',mau.user_type) as lifecycle,
--- base users from last month
count(distinct mau.scope_cust_id) as Base_users,
--- retained users active in current month
count(distinct txn.customer_id_payer) as Retained_users,
--- retention rate calculation
sum(Retained_users) * 1.0000 / sum(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## RMG Retentions

RMG Retentions tracks user retention rates for gaming merchant customers across monthly cohorts, measuring how many monthly active users (MAU) from gaming merchants continue to perform UPI transactions in the following month. The analysis segments users by lifecycle stages (including consolidated 'c:react' for users with 1+ reactions) and gaming merchant status, calculating retention as a percentage of retained users divided by total MAU users. The metric focuses specifically on gaming merchants identified through transaction patterns from May to August 2025, tracking their retention from August to September and September to October periods, filtering for successful UPI transactions across Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) in VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND
gma.mnt <= date'2025-08-31' AND
gma.gaming_merc = 'Gaming merc' AND

--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- cohort-specific date ranges for retention measurement
--- Aug-to-Sep cohort: MAU from Aug 2025, retention checked in Sep 2025
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
day(txn.transaction_date_key) < day(current_date)

--- Sep-to-Oct cohort: MAU from Sep 2025, retention checked in Oct 2025  
mau.dt >= date'2025-09-01' AND mau.dt <= date'2025-09-30' AND
txn.dl_last_updated BETWEEN date'2025-10-01' AND date'2025-10-31' AND
txn.transaction_date_key BETWEEN date'2025-10-01' AND date'2025-10-31' AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct mau.cust_id) as mau_users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(mau_users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gm_flag,
if(mau.user_type in ('c:react 3+','c:react 1-3'), 'c:react', mau.user_type) as lifecycle




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag






================================================================================
## Dashboard 511
================================================================================

## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 476
================================================================================

## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by T20 Cities

This metric tracks user engagement and transaction activity segmented by India's top 20 cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and calculated Transactions Per User (TPU) to assess geographic performance patterns. The analysis filters for users with defined lifecycle status and applies temporal filtering on transaction dates. Cities not in the top 20 list are grouped as "Other" for comparison. This enables geographic performance analysis and identification of high-engagement metropolitan markets within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn
hive.midgar.engage_data_snapshot_v3 user_geo
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction validity and success criteria
upi_txn.transaction_type IN ('PAY','COLLECT') AND
upi_txn.status IN ('SUCCESS','DEEMED') AND
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- user lifecycle filtering for active users only
lifecycle IS NOT NULL

--- specific filters
--- temporal range for transaction analysis period
upi_txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
upi_txn.transaction_date_key < current_date AND
--- geographic segmentation for top 20 cities
CASE WHEN upper(user_geo.popular_city) IN ('NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA') THEN user_geo.popular_city ELSE 'Other' END

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1,payer_cust_id,null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1,payer_cust_id,null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(DAU) as TPU




## UPI Overall Retention: Monthly

This metric tracks UPI user retention across monthly cohorts, measuring what percentage of users from each base month continue to be active in subsequent months. The analysis categorizes users by lifecycle status, consolidating certain reactive user types into broader categories. It calculates retention by dividing the number of users active in each retention month by the total users from the corresponding base month. The metric helps understand user engagement patterns and lifecycle behavior across different monthly cohorts, providing insights into user stickiness and platform engagement over time. Data covers the most recent 4-month period to ensure relevance and statistical significance.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to recent 4-month window for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month from base month calculations
date_trunc('month', a.dt) < current_date

--- specific filters
--- consolidate reactive user categories for simplified lifecycle analysis
if(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as user_type

--- calculation_logic
WITH cc AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, 
         if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type
),
reten AS (
  SELECT date_diff('month', a.mt, b.mt) as diff, a.mt base_month, b.mt retention_month,
         count(distinct b.scope_cust_id) users
  FROM cc a LEFT JOIN cc b ON b.scope_cust_id = a.scope_cust_id
  WHERE b.mt >= a.mt
  GROUP BY 1,2,3
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) AS Retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states by measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transaction count, and Transactions Per User (TPU). It provides geographic insights into UPI ecosystem performance by analyzing successful payment transactions from major PSP partners including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The analysis focuses on users with defined lifecycle classifications and includes both peer-to-peer and merchant payment categories. TPU is calculated as the ratio of total transactions to DAU, indicating transaction frequency per active user. This state-wise segmentation enables regional performance comparison and helps identify high-engagement markets for strategic decision-making in the UPI payments ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.midgar.engage_data_snapshot_v3 top20
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key < current_date AND
--- only successful transactions
a.status IN ('SUCCESS', 'DEEMED') AND
--- core UPI transaction types
transaction_type IN ('PAY', 'COLLECT') AND
--- major payment categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- paytm ecosystem PSP partners for comprehensive coverage
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
count(distinct if(rn_dau = 1, payer_cust_id, null)) as DAU,
count(distinct if(rn_mau = 1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns) * 1.00 / sum(DAU) as TPU




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance. It calculates the percentage of successful transactions (including deemed success) against total attempted transactions across different UPI flows. The analysis focuses on major PSPs including Paytm, Yes Bank, Axis, HDFC, and SBI, covering PAY and COLLECT transaction types over the last two months. This success rate metric helps identify flow-specific performance issues and compare reliability across different payment channels within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: last 2 months including current month
transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND

--- specific filters  
--- focus on core transaction types for success rate analysis
transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- VPA-based flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
SR: CAST(ROUND(SUM(success_txn)*100/SUM(overall_txn), 2) AS VARCHAR) || '%'




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category to monitor operational performance trends with day-over-day comparison capabilities. It calculates the ratio of successful transactions (including deemed successful) to total attempted transactions across PAY and COLLECT transaction types. The analysis focuses on key PSP partners (Paytm, Yes Bank, Axis, HDFC, SBI) while excluding mandate-related and onus flows to provide clarity on core P2P and P2M transaction performance. The temporal scope covers the previous month to yesterday, enabling stakeholders to identify performance patterns, detect anomalies, and assess the health of different transaction flow categories within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction recency filter for performance optimization
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: previous month start to yesterday
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month 
and current_date + interval '-1' day AND
--- core UPI transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on key PSP ecosystem partners
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and onus flows for core transaction analysis
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)
SR: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category, showing day-over-day trends for operational performance monitoring. It measures the percentage of successful transactions (including deemed success) out of total attempted transactions across different UPI flow types. The analysis focuses on standard payment flows by excluding mandate-related and onus transaction categories, while limiting scope to transactions processed through major PSP handles (Paytm ecosystem). The temporal window covers the previous month to current date, enabling trend analysis and performance comparison across different transaction flow categories for operational insights and system reliability assessment.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- focus on payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to major PSP ecosystem handles
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- include standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
AND current_date + interval '-1' day AND
--- exclude mandate and onus flow categories for focus on standard flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
SUM(success_txn * 1.0000) / SUM(overall_txn) as SR
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their base month (M0) to measure initial user acquisition and engagement patterns. It calculates the total count of active users in their first month of activity and their month-over-month growth percentage. The analysis focuses specifically on M0 cohorts (diff=0) to understand new user onboarding success and growth trends. The metric provides insights into user acquisition velocity and helps identify patterns in initial user engagement within the UPI ecosystem. This forms the foundation for broader retention analysis by establishing baseline user counts before tracking their subsequent monthly activity patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on M0 cohort analysis - users in their base month
vt.diff = 0 AND
--- exclude current month to ensure complete data
vt.base_month < current_date AND
--- limit analysis window to recent 4 months for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month

--- specific filters
--- temporal range filter (no specific constraint applied)
--- base_month temporal range = 'No filter'

--- calculation_logic
sum(vt.users) as MAU,
SUM(vt.mom_growth * 1.0000) / SUM(vt.users) as growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI LMTD Retention

This metric tracks UPI user retention from last month to current month-to-date, segmented by user lifecycle stages including reactive users (consolidated from react 1-3 and react 3+ categories). It measures how many users who were active in the previous month continue to transact in the current month, providing insights into user engagement and stickiness across different behavioral segments. The analysis focuses on Paytm ecosystem transactions (payer handles: paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes PAY/COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention rate calculation shows the percentage of last month's user base that remains active in the current period.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp filtering
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status filtering
txn.status IN ('SUCCESS','DEEMED') AND
--- core upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- current month period for retention analysis
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.dl_last_updated <= current_date + interval '-1' day + interval '-1' month AND
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.transaction_date_key <= current_date + interval '-1' day + interval '-1' month

--- calculation_logic
--- lifecycle consolidation: reactive users (react 1-3 and react 3+ combined as 'c:react')
if(mau.user_type in ('c:react 3+','c:react 1-3'),'c:react',mau.user_type) as lifecycle,
--- base users from last month
count(distinct mau.scope_cust_id) as Base_users,
--- retained users active in current month
count(distinct txn.customer_id_payer) as Retained_users,
--- retention rate calculation
sum(Retained_users) * 1.0000 / sum(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## RMG Retentions

RMG Retentions tracks user retention rates for gaming merchant customers across monthly cohorts, measuring how many monthly active users (MAU) from gaming merchants continue to perform UPI transactions in the following month. The analysis segments users by lifecycle stages (including consolidated 'c:react' for users with 1+ reactions) and gaming merchant status, calculating retention as a percentage of retained users divided by total MAU users. The metric focuses specifically on gaming merchants identified through transaction patterns from May to August 2025, tracking their retention from August to September and September to October periods, filtering for successful UPI transactions across Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) in VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND
gma.mnt <= date'2025-08-31' AND
gma.gaming_merc = 'Gaming merc' AND

--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- cohort-specific date ranges for retention measurement
--- Aug-to-Sep cohort: MAU from Aug 2025, retention checked in Sep 2025
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
day(txn.transaction_date_key) < day(current_date)

--- Sep-to-Oct cohort: MAU from Sep 2025, retention checked in Oct 2025  
mau.dt >= date'2025-09-01' AND mau.dt <= date'2025-09-30' AND
txn.dl_last_updated BETWEEN date'2025-10-01' AND date'2025-10-31' AND
txn.transaction_date_key BETWEEN date'2025-10-01' AND date'2025-10-31' AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct mau.cust_id) as mau_users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(mau_users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gm_flag,
if(mau.user_type in ('c:react 3+','c:react 1-3'), 'c:react', mau.user_type) as lifecycle




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag






================================================================================
## Dashboard 511
================================================================================

## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 476
================================================================================

## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by T20 Cities

This metric tracks user engagement and transaction activity segmented by India's top 20 cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and calculated Transactions Per User (TPU) to assess geographic performance patterns. The analysis filters for users with defined lifecycle status and applies temporal filtering on transaction dates. Cities not in the top 20 list are grouped as "Other" for comparison. This enables geographic performance analysis and identification of high-engagement metropolitan markets within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn
hive.midgar.engage_data_snapshot_v3 user_geo
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction validity and success criteria
upi_txn.transaction_type IN ('PAY','COLLECT') AND
upi_txn.status IN ('SUCCESS','DEEMED') AND
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- user lifecycle filtering for active users only
lifecycle IS NOT NULL

--- specific filters
--- temporal range for transaction analysis period
upi_txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
upi_txn.transaction_date_key < current_date AND
--- geographic segmentation for top 20 cities
CASE WHEN upper(user_geo.popular_city) IN ('NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA') THEN user_geo.popular_city ELSE 'Other' END

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1,payer_cust_id,null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1,payer_cust_id,null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(DAU) as TPU




## UPI Overall Retention: Monthly

This metric tracks UPI user retention across monthly cohorts, measuring what percentage of users from each base month continue to be active in subsequent months. The analysis categorizes users by lifecycle status, consolidating certain reactive user types into broader categories. It calculates retention by dividing the number of users active in each retention month by the total users from the corresponding base month. The metric helps understand user engagement patterns and lifecycle behavior across different monthly cohorts, providing insights into user stickiness and platform engagement over time. Data covers the most recent 4-month period to ensure relevance and statistical significance.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to recent 4-month window for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month from base month calculations
date_trunc('month', a.dt) < current_date

--- specific filters
--- consolidate reactive user categories for simplified lifecycle analysis
if(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as user_type

--- calculation_logic
WITH cc AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, 
         if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type
),
reten AS (
  SELECT date_diff('month', a.mt, b.mt) as diff, a.mt base_month, b.mt retention_month,
         count(distinct b.scope_cust_id) users
  FROM cc a LEFT JOIN cc b ON b.scope_cust_id = a.scope_cust_id
  WHERE b.mt >= a.mt
  GROUP BY 1,2,3
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) AS Retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states by measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transaction count, and Transactions Per User (TPU). It provides geographic insights into UPI ecosystem performance by analyzing successful payment transactions from major PSP partners including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The analysis focuses on users with defined lifecycle classifications and includes both peer-to-peer and merchant payment categories. TPU is calculated as the ratio of total transactions to DAU, indicating transaction frequency per active user. This state-wise segmentation enables regional performance comparison and helps identify high-engagement markets for strategic decision-making in the UPI payments ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.midgar.engage_data_snapshot_v3 top20
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key < current_date AND
--- only successful transactions
a.status IN ('SUCCESS', 'DEEMED') AND
--- core UPI transaction types
transaction_type IN ('PAY', 'COLLECT') AND
--- major payment categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- paytm ecosystem PSP partners for comprehensive coverage
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
count(distinct if(rn_dau = 1, payer_cust_id, null)) as DAU,
count(distinct if(rn_mau = 1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns) * 1.00 / sum(DAU) as TPU




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance. It calculates the percentage of successful transactions (including deemed success) against total attempted transactions across different UPI flows. The analysis focuses on major PSPs including Paytm, Yes Bank, Axis, HDFC, and SBI, covering PAY and COLLECT transaction types over the last two months. This success rate metric helps identify flow-specific performance issues and compare reliability across different payment channels within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: last 2 months including current month
transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND

--- specific filters  
--- focus on core transaction types for success rate analysis
transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- VPA-based flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
SR: CAST(ROUND(SUM(success_txn)*100/SUM(overall_txn), 2) AS VARCHAR) || '%'




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category to monitor operational performance trends with day-over-day comparison capabilities. It calculates the ratio of successful transactions (including deemed successful) to total attempted transactions across PAY and COLLECT transaction types. The analysis focuses on key PSP partners (Paytm, Yes Bank, Axis, HDFC, SBI) while excluding mandate-related and onus flows to provide clarity on core P2P and P2M transaction performance. The temporal scope covers the previous month to yesterday, enabling stakeholders to identify performance patterns, detect anomalies, and assess the health of different transaction flow categories within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction recency filter for performance optimization
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: previous month start to yesterday
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month 
and current_date + interval '-1' day AND
--- core UPI transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on key PSP ecosystem partners
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and onus flows for core transaction analysis
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)
SR: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category, showing day-over-day trends for operational performance monitoring. It measures the percentage of successful transactions (including deemed success) out of total attempted transactions across different UPI flow types. The analysis focuses on standard payment flows by excluding mandate-related and onus transaction categories, while limiting scope to transactions processed through major PSP handles (Paytm ecosystem). The temporal window covers the previous month to current date, enabling trend analysis and performance comparison across different transaction flow categories for operational insights and system reliability assessment.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- focus on payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to major PSP ecosystem handles
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- include standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
AND current_date + interval '-1' day AND
--- exclude mandate and onus flow categories for focus on standard flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
SUM(success_txn * 1.0000) / SUM(overall_txn) as SR
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their base month (M0) to measure initial user acquisition and engagement patterns. It calculates the total count of active users in their first month of activity and their month-over-month growth percentage. The analysis focuses specifically on M0 cohorts (diff=0) to understand new user onboarding success and growth trends. The metric provides insights into user acquisition velocity and helps identify patterns in initial user engagement within the UPI ecosystem. This forms the foundation for broader retention analysis by establishing baseline user counts before tracking their subsequent monthly activity patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on M0 cohort analysis - users in their base month
vt.diff = 0 AND
--- exclude current month to ensure complete data
vt.base_month < current_date AND
--- limit analysis window to recent 4 months for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month

--- specific filters
--- temporal range filter (no specific constraint applied)
--- base_month temporal range = 'No filter'

--- calculation_logic
sum(vt.users) as MAU,
SUM(vt.mom_growth * 1.0000) / SUM(vt.users) as growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI LMTD Retention

This metric tracks UPI user retention from last month to current month-to-date, segmented by user lifecycle stages including reactive users (consolidated from react 1-3 and react 3+ categories). It measures how many users who were active in the previous month continue to transact in the current month, providing insights into user engagement and stickiness across different behavioral segments. The analysis focuses on Paytm ecosystem transactions (payer handles: paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes PAY/COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention rate calculation shows the percentage of last month's user base that remains active in the current period.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp filtering
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status filtering
txn.status IN ('SUCCESS','DEEMED') AND
--- core upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- current month period for retention analysis
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.dl_last_updated <= current_date + interval '-1' day + interval '-1' month AND
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.transaction_date_key <= current_date + interval '-1' day + interval '-1' month

--- calculation_logic
--- lifecycle consolidation: reactive users (react 1-3 and react 3+ combined as 'c:react')
if(mau.user_type in ('c:react 3+','c:react 1-3'),'c:react',mau.user_type) as lifecycle,
--- base users from last month
count(distinct mau.scope_cust_id) as Base_users,
--- retained users active in current month
count(distinct txn.customer_id_payer) as Retained_users,
--- retention rate calculation
sum(Retained_users) * 1.0000 / sum(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## RMG Retentions

RMG Retentions tracks user retention rates for gaming merchant customers across monthly cohorts, measuring how many monthly active users (MAU) from gaming merchants continue to perform UPI transactions in the following month. The analysis segments users by lifecycle stages (including consolidated 'c:react' for users with 1+ reactions) and gaming merchant status, calculating retention as a percentage of retained users divided by total MAU users. The metric focuses specifically on gaming merchants identified through transaction patterns from May to August 2025, tracking their retention from August to September and September to October periods, filtering for successful UPI transactions across Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) in VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND
gma.mnt <= date'2025-08-31' AND
gma.gaming_merc = 'Gaming merc' AND

--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- cohort-specific date ranges for retention measurement
--- Aug-to-Sep cohort: MAU from Aug 2025, retention checked in Sep 2025
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
day(txn.transaction_date_key) < day(current_date)

--- Sep-to-Oct cohort: MAU from Sep 2025, retention checked in Oct 2025  
mau.dt >= date'2025-09-01' AND mau.dt <= date'2025-09-30' AND
txn.dl_last_updated BETWEEN date'2025-10-01' AND date'2025-10-31' AND
txn.transaction_date_key BETWEEN date'2025-10-01' AND date'2025-10-31' AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct mau.cust_id) as mau_users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(mau_users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gm_flag,
if(mau.user_type in ('c:react 3+','c:react 1-3'), 'c:react', mau.user_type) as lifecycle




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag






================================================================================
## Dashboard 511
================================================================================

## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 476
================================================================================

## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by T20 Cities

This metric tracks user engagement and transaction activity segmented by India's top 20 cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and calculated Transactions Per User (TPU) to assess geographic performance patterns. The analysis filters for users with defined lifecycle status and applies temporal filtering on transaction dates. Cities not in the top 20 list are grouped as "Other" for comparison. This enables geographic performance analysis and identification of high-engagement metropolitan markets within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn
hive.midgar.engage_data_snapshot_v3 user_geo
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction validity and success criteria
upi_txn.transaction_type IN ('PAY','COLLECT') AND
upi_txn.status IN ('SUCCESS','DEEMED') AND
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- user lifecycle filtering for active users only
lifecycle IS NOT NULL

--- specific filters
--- temporal range for transaction analysis period
upi_txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
upi_txn.transaction_date_key < current_date AND
--- geographic segmentation for top 20 cities
CASE WHEN upper(user_geo.popular_city) IN ('NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA') THEN user_geo.popular_city ELSE 'Other' END

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1,payer_cust_id,null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1,payer_cust_id,null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(DAU) as TPU




## UPI Overall Retention: Monthly

This metric tracks UPI user retention across monthly cohorts, measuring what percentage of users from each base month continue to be active in subsequent months. The analysis categorizes users by lifecycle status, consolidating certain reactive user types into broader categories. It calculates retention by dividing the number of users active in each retention month by the total users from the corresponding base month. The metric helps understand user engagement patterns and lifecycle behavior across different monthly cohorts, providing insights into user stickiness and platform engagement over time. Data covers the most recent 4-month period to ensure relevance and statistical significance.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to recent 4-month window for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month from base month calculations
date_trunc('month', a.dt) < current_date

--- specific filters
--- consolidate reactive user categories for simplified lifecycle analysis
if(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as user_type

--- calculation_logic
WITH cc AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, 
         if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type
),
reten AS (
  SELECT date_diff('month', a.mt, b.mt) as diff, a.mt base_month, b.mt retention_month,
         count(distinct b.scope_cust_id) users
  FROM cc a LEFT JOIN cc b ON b.scope_cust_id = a.scope_cust_id
  WHERE b.mt >= a.mt
  GROUP BY 1,2,3
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) AS Retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states by measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transaction count, and Transactions Per User (TPU). It provides geographic insights into UPI ecosystem performance by analyzing successful payment transactions from major PSP partners including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The analysis focuses on users with defined lifecycle classifications and includes both peer-to-peer and merchant payment categories. TPU is calculated as the ratio of total transactions to DAU, indicating transaction frequency per active user. This state-wise segmentation enables regional performance comparison and helps identify high-engagement markets for strategic decision-making in the UPI payments ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.midgar.engage_data_snapshot_v3 top20
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
transaction_date_key < current_date AND
--- only successful transactions
a.status IN ('SUCCESS', 'DEEMED') AND
--- core UPI transaction types
transaction_type IN ('PAY', 'COLLECT') AND
--- major payment categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- paytm ecosystem PSP partners for comprehensive coverage
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
count(distinct if(rn_dau = 1, payer_cust_id, null)) as DAU,
count(distinct if(rn_mau = 1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns) * 1.00 / sum(DAU) as TPU




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## UPI SR DoD Overall Line Trend

This metric tracks the UPI transaction success rate trends for the Paytm ecosystem, measuring the percentage of successful transactions (including deemed successful) out of all attempted transactions over time. It focuses on PAY and COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories, filtered to include transactions from Paytm and partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). The success rate calculation provides a key performance indicator for payment processing reliability, helping monitor day-over-day trends in transaction completion rates. The metric uses a rolling two-month window starting from the previous month to capture sufficient historical context for trend analysis while maintaining relevance to current performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for reliable snapshot data
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2-month rolling window
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND
--- payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- paytm ecosystem including partner PSPs
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- core UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range filter from superset interface
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-25'

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS INT) AS SR




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance. It calculates the percentage of successful transactions (including deemed success) against total attempted transactions across different UPI flows. The analysis focuses on major PSPs including Paytm, Yes Bank, Axis, HDFC, and SBI, covering PAY and COLLECT transaction types over the last two months. This success rate metric helps identify flow-specific performance issues and compare reliability across different payment channels within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: last 2 months including current month
transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
  AND current_date + interval '-1' day AND

--- specific filters  
--- focus on core transaction types for success rate analysis
transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- VPA-based flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
SR: CAST(ROUND(SUM(success_txn)*100/SUM(overall_txn), 2) AS VARCHAR) || '%'




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category to monitor operational performance trends with day-over-day comparison capabilities. It calculates the ratio of successful transactions (including deemed successful) to total attempted transactions across PAY and COLLECT transaction types. The analysis focuses on key PSP partners (Paytm, Yes Bank, Axis, HDFC, SBI) while excluding mandate-related and onus flows to provide clarity on core P2P and P2M transaction performance. The temporal scope covers the previous month to yesterday, enabling stakeholders to identify performance patterns, detect anomalies, and assess the health of different transaction flow categories within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction recency filter for performance optimization
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal scope: previous month start to yesterday
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month 
and current_date + interval '-1' day AND
--- core UPI transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on key PSP ecosystem partners
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and onus flows for core transaction analysis
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
Success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
Overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)
SR: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category, showing day-over-day trends for operational performance monitoring. It measures the percentage of successful transactions (including deemed success) out of total attempted transactions across different UPI flow types. The analysis focuses on standard payment flows by excluding mandate-related and onus transaction categories, while limiting scope to transactions processed through major PSP handles (Paytm ecosystem). The temporal window covers the previous month to current date, enabling trend analysis and performance comparison across different transaction flow categories for operational insights and system reliability assessment.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- focus on payment transaction types only
a.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to major PSP ecosystem handles
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- include standard UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- temporal range for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
AND current_date + interval '-1' day AND
--- exclude mandate and onus flow categories for focus on standard flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')

--- calculation_logic
SUM(success_txn * 1.0000) / SUM(overall_txn) as SR
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their base month (M0) to measure initial user acquisition and engagement patterns. It calculates the total count of active users in their first month of activity and their month-over-month growth percentage. The analysis focuses specifically on M0 cohorts (diff=0) to understand new user onboarding success and growth trends. The metric provides insights into user acquisition velocity and helps identify patterns in initial user engagement within the UPI ecosystem. This forms the foundation for broader retention analysis by establishing baseline user counts before tracking their subsequent monthly activity patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on M0 cohort analysis - users in their base month
vt.diff = 0 AND
--- exclude current month to ensure complete data
vt.base_month < current_date AND
--- limit analysis window to recent 4 months for relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month

--- specific filters
--- temporal range filter (no specific constraint applied)
--- base_month temporal range = 'No filter'

--- calculation_logic
sum(vt.users) as MAU,
SUM(vt.mom_growth * 1.0000) / SUM(vt.users) as growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the ratio of P2P (peer-to-peer) to P2M (peer-to-merchant) transactions across three key dimensions: Daily Active Users (DAU), transaction count, and gross merchandise value (GMV). It provides insights into user behavior patterns and transaction preferences within the UPI ecosystem. The analysis is filtered to current month data excluding future dates, focusing on successful transactions from Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). The ratios help understand whether users prefer person-to-person transfers versus merchant payments, segmented by month and transaction type for trend analysis and business strategy decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal constraint for current month analysis
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- data freshness constraint
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- successful transaction status filter
txn.status IN ('SUCCESS', 'DEEMED') AND
--- transaction type scope
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- UPI category constraints
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- paytm ecosystem PSP filtering for internal analysis
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future dates from current day comparison
day(day_id) < day(current_date)

--- calculation_logic
CASE WHEN is_p2p = True THEN 'P2P' WHEN is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
sum(if(p2m_p2p_flag='P2P', {metric}, 0)) * 1.0000 / sum(if(p2m_p2p_flag='P2M', {metric}, 1)) as ratio_calculation,
count(distinct payer_cust_id) as DAU,
sum(txns) as total_transactions,
sum(amount) as total_amount




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) buckets from the previous month, measuring what percentage of users in each activity segment continue transacting in the current month-to-date period. The analysis segments users into TPU buckets (1, 2, 3, 4-10, 11-20, 20+ transactions) to understand retention patterns across different engagement levels. Base users are those who transacted in the previous month, while retained users are those who also transacted in the current MTD period. The metric includes lifecycle categorization and GMV bucketing for comprehensive user behavior analysis, helping identify which transaction frequency segments have the highest retention rates and inform user engagement strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem transactions
--- paytm ecosystem PSP handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction statuses only
txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for user activity measurement
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories excluding system transactions
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                          AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                               AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
--- current MTD period for retention measurement
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day)
                          AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day)
                               AND current_date - interval '1' day

--- calculation_logic
TPU bucketing: CASE WHEN tpu = 1 THEN 'a.1' WHEN tpu = 2 THEN 'b.2' WHEN tpu = 3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
GMV bucketing: CASE WHEN gmv >= 1 AND gmv < 1000 THEN 'A: 11k' ... WHEN gmv >= 20000 THEN 'F: 20k+' END,
Retention rate: SUM(retained_users*1.0000)/SUM(base_users),
Base users: COUNT(DISTINCT customer_id_payer) from last month,
Retained users: COUNT(DISTINCT CASE WHEN current_month_user IS NOT NULL THEN customer_id_payer END)




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## UPI Retention TPU wise LMTD

This metric measures UPI user retention rates segmented by transaction frequency buckets (TPU) and customer lifecycle stages for last month to date analysis. It tracks how many users from the previous complete month continued transacting in the current month up to the same day, providing insights into user engagement and retention patterns across different transaction behavior segments. The analysis includes base users (previous month active users), retained users (those who continued in current month), and retention percentage, with segmentation by TPU buckets ranging from single transactions to 20+ transactions per user. This helps identify which user segments demonstrate stronger retention and engagement levels.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base users
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month to date for retention check (same day comparison)
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(transaction_date_key) < day(current_date)

--- calculation_logic
--- tpu buckets segmentation
CASE 
    WHEN tpu = 1 THEN 'a.1'
    WHEN tpu = 2 THEN 'b.2' 
    WHEN tpu = 3 THEN 'c.3'
    WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10'
    WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20'
    WHEN tpu > 20 THEN 'f.20+'
END AS tpu_bucket,
--- retention calculation
COUNT(DISTINCT last_month_users) AS base_users,
COUNT(DISTINCT retained_users) AS retained_users,
SUM(retained_users*1.0000)/SUM(base_users) AS retention_percentage




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## State wise flow wise

This metric tracks daily active users (DAU), transaction volume, and transaction amounts for UPI payments segmented by customer state, payment flow type (P2P vs P2M), and specific flow categories. It provides geographic distribution analysis of UPI usage patterns by mapping customer locations from engagement data to transaction flows. The analysis focuses on recent activity with a 4-day lookback period and includes all Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi). This segmentation enables understanding of regional adoption patterns, flow preferences by geography, and helps identify high-value states and transaction types for business strategy and resource allocation decisions.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 eng
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- recent transaction data filtering
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- transaction date range for analysis period
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- successful transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- standard UPI categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- recent activity focus for dashboard
vt.day_id >= current_date - interval '4' day

--- calculation_logic
count(distinct txn.payer_cust_id) as DAU,
sum(txn_count) as total_transactions,
sum(txn_amount) as total_amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE txn.flow_category END as p2m_p2p_flag,
coalesce(eng.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise MTD

UPI Retention by GPU (GMV Per User) measures month-over-month user retention rates segmented by transaction frequency buckets (1, 2, 3, 4-10, 11-20, 20+ TPU) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention patterns across different user value segments. This metric tracks how many users from the previous month continue transacting in the current month-to-date period, providing insights into user engagement and value-based retention performance. The analysis includes customer lifecycle segmentation and covers UPI transactions across merchant, P2P, and account transfer categories for comprehensive retention analysis across different transaction behaviors and monetary value tiers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm psp ecosystem focus
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- comprehensive upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- mtd retention analysis time windows
--- current mtd: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day
--- last month: txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND date_trunc('month', current_date - interval '1' day) - interval '1' day
--- lifecycle snapshot period: lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND date_trunc('month', current_date) - interval '1' day

--- calculation_logic
base_users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV buckets,
retained_users: COUNT(DISTINCT customer_id_payer) who also appear in current MTD,
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu > 20 THEN 'f.20+' END,
gmv_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv >= 20000 THEN 'F: 20k+' END




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI Retention GPU wise LMTD

This metric tracks UPI user retention by analyzing last month's active users (base) and measuring how many remain active in the current month-to-date period (retained users). The analysis segments retention performance across customer lifecycle stages (fresh users vs existing users) and GMV buckets (A: 1-1k through F: 20k+) to identify which user profiles demonstrate stronger retention patterns. It applies standard UPI transaction filters for successful PAY/COLLECT transactions across major PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention percentage calculation provides actionable insights for user engagement strategies across different value segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to successful transactions only
a.transaction_type IN ('PAY','COLLECT') AND
a.status IN ('SUCCESS','DEEMED') AND
--- include major PSP ecosystem participants
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover all primary UPI transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base users (LlM CTE)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month-to-date for retained users (lMTD CTE)
--- ensuring MTD comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct case when retained_user_exists then base_user_id end) as retained_users,
count(distinct base_user_id) as base_users,
sum(retained_users*1.0000)/sum(base_users) as retention_percentage,
--- GMV bucketing: A(1-1k), B(1k-3k), C(3k-5k), D(5k-10k), E(10k-20k), F(20k+)
--- TPU bucketing: 1, 2, 3, 4-10, 11-20, 20+
--- lifecycle segmentation via left join with customer lifecycle snapshot




## UPI LMTD Retention

This metric tracks UPI user retention from last month to current month-to-date, segmented by user lifecycle stages including reactive users (consolidated from react 1-3 and react 3+ categories). It measures how many users who were active in the previous month continue to transact in the current month, providing insights into user engagement and stickiness across different behavioral segments. The analysis focuses on Paytm ecosystem transactions (payer handles: paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes PAY/COLLECT transaction types across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The retention rate calculation shows the percentage of last month's user base that remains active in the current period.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp filtering
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status filtering
txn.status IN ('SUCCESS','DEEMED') AND
--- core upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month period for base user identification
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- current month period for retention analysis
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.dl_last_updated <= current_date + interval '-1' day + interval '-1' month AND
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
txn.transaction_date_key <= current_date + interval '-1' day + interval '-1' month

--- calculation_logic
--- lifecycle consolidation: reactive users (react 1-3 and react 3+ combined as 'c:react')
if(mau.user_type in ('c:react 3+','c:react 1-3'),'c:react',mau.user_type) as lifecycle,
--- base users from last month
count(distinct mau.scope_cust_id) as Base_users,
--- retained users active in current month
count(distinct txn.customer_id_payer) as Retained_users,
--- retention rate calculation
sum(Retained_users) * 1.0000 / sum(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## RMG Retentions

RMG Retentions tracks user retention rates for gaming merchant customers across monthly cohorts, measuring how many monthly active users (MAU) from gaming merchants continue to perform UPI transactions in the following month. The analysis segments users by lifecycle stages (including consolidated 'c:react' for users with 1+ reactions) and gaming merchant status, calculating retention as a percentage of retained users divided by total MAU users. The metric focuses specifically on gaming merchants identified through transaction patterns from May to August 2025, tracking their retention from August to September and September to October periods, filtering for successful UPI transactions across Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) in VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND
gma.mnt <= date'2025-08-31' AND
gma.gaming_merc = 'Gaming merc' AND

--- successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- cohort-specific date ranges for retention measurement
--- Aug-to-Sep cohort: MAU from Aug 2025, retention checked in Sep 2025
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
day(txn.transaction_date_key) < day(current_date)

--- Sep-to-Oct cohort: MAU from Sep 2025, retention checked in Oct 2025  
mau.dt >= date'2025-09-01' AND mau.dt <= date'2025-09-30' AND
txn.dl_last_updated BETWEEN date'2025-10-01' AND date'2025-10-31' AND
txn.transaction_date_key BETWEEN date'2025-10-01' AND date'2025-10-31' AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
count(distinct mau.cust_id) as mau_users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(mau_users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gm_flag,
if(mau.user_type in ('c:react 3+','c:react 1-3'), 'c:react', mau.user_type) as lifecycle




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag






================================================================================
## Dashboard 729
================================================================================

## UPI  - MTD Daily Cashback

This metric tracks the daily count of unique users who received UPI cashback within the current month, providing insights into cashback distribution patterns and user engagement. The measurement focuses on users with processed cashback tasks (status 1 or 2, fulfillment_status 1-3) and applies month-to-date filtering to analyze current month performance against historical trends. The cashback amounts are normalized based on redemption type, with specific conversion rates for coins (166.67), goldcoins (100), and UPI (+0.2478). This metric helps monitor the effectiveness of UPI cashback campaigns and user adoption of the cashback program on a daily basis.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 scts
hive.code.campaign_snapshot_v3 ccs

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to current month data for MTD analysis
scts.updated_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND scts.updated_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- include only valid cashback tasks
scts.status IN (1, 2) AND
--- include all fulfillment stages
scts.fulfillment_status IN (1, 2, 3) AND
--- month-to-date flag for period comparison
scts.is_mtd_u = true AND
--- recent campaign data for wallet mapping
ccs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- historical data partition for supercash tasks
scts.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
COUNT(DISTINCT scts.user_id) as unique_cashback_users,
date_trunc('day', CAST(scts.updated_at AS TIMESTAMP)) as daily_grouping,
CASE 
  WHEN scts.redemption_type = 'coins' THEN (scts.amount/166.67)
  WHEN scts.redemption_type = 'goldcoins' THEN (scts.amount/100)
  WHEN scts.redemption_type = 'upi' THEN (scts.amount+0.2478)
  ELSE scts.amount
END as normalized_cashburn_amount




## UPI  - MTD Cashback

This metric tracks the total UPI SuperCash cashback amount burned (given to users) on a month-to-date basis, aggregated hourly. It measures the financial impact of cashback campaigns by converting different redemption types (coins, goldcoins, UPI) to standardized cashburn values using specific conversion rates. The metric filters for current month transactions with valid status conditions (status 1 or 2, fulfillment_status 1-3) to capture legitimate cashback burns. This helps monitor daily cashback expenditure patterns and campaign performance within the UPI ecosystem, providing insights into user engagement and promotional costs across different redemption mechanisms.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 st
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month temporal filter for MTD analysis
st.created_at >= date_trunc('month', current_date) AND
st.created_at < date_trunc('month', current_date) + interval '1' month AND
--- valid transaction status filters
st.status IN (1, 2) AND
st.fulfillment_status IN (1, 2, 3) AND
--- recent campaign data for wallet mapping
cs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- MTD flag for month-to-date calculations
st.is_mtd_u = true

--- calculation_logic
CASE 
  WHEN st.redemption_type = 'coins' THEN (st.amount/166.67)
  WHEN st.redemption_type = 'goldcoins' THEN (st.amount/100)
  WHEN st.redemption_type = 'upi' THEN (st.amount + 0.2478)
  ELSE st.amount
END AS cashburn,
SUM(cashburn) grouped by date_trunc('hour', updated_at)




## UPI  - MTD Gratified Users

This metric measures the count of distinct users who have been gratified (received cashback rewards) in the UPI SuperCash program during the current month. It tracks user engagement with the cashback reward system by identifying unique users who have participated in promotional campaigns and received benefits. The metric applies month-to-date filtering to show progressive user acquisition within the current reporting period. The underlying logic handles complex cashback calculations with different redemption types (coins at 1/166.67 rate, goldcoins at 1/100 rate, UPI with 0.2478 adjustment) and categorizes fulfillment status into business-meaningful states like 'Given', 'Processing', 'Pending', and 'Unscratched'. This enables monitoring of user satisfaction and campaign effectiveness in the SuperCash ecosystem.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 sct
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to current month data for MTD reporting
sct.created_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND sct.created_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- ensure valid status and fulfillment status combinations
sct.status IN (1,2) AND sct.fulfillment_status IN (1,2,3) AND
--- MTD user qualification flag
is_mtd_u = true

--- specific filters
--- data freshness requirement for campaign lookup
cs.dl_last_updated >= current_date - interval '62' day

--- calculation_logic
COUNT(DISTINCT sct.user_id) as gratified_users,
CASE 
  WHEN sct.redemption_type = 'coins' THEN sct.amount/166.67
  WHEN sct.redemption_type = 'goldcoins' THEN sct.amount/100
  WHEN sct.redemption_type = 'upi' THEN sct.amount + 0.2478
  ELSE sct.amount
END as cashburn_amount,
CASE
  WHEN sct.status = 1 AND sct.fulfillment_status = 3 THEN 'Given'
  WHEN sct.status = 1 AND sct.fulfillment_status = 2 THEN 'Processing'
  WHEN sct.status = 2 AND sct.fulfillment_status = 1 THEN 'Unscratched'
  WHEN sct.status = 1 AND sct.fulfillment_status = 1 THEN 'Pending'
END as status_category




## UPI  - MTD Daily Users

This metric tracks the count of distinct users engaging with UPI SuperCash campaigns on a daily basis within the current month. It measures daily user activity in the SuperCash burn program by counting unique user_ids from supercash task records, providing insights into user engagement patterns and campaign adoption rates. The metric filters for active tasks (status 1,2) with various fulfillment statuses (1,2,3) and applies month-to-date temporal filtering on the updated_at timestamp. This helps monitor daily user participation trends and identify peak engagement periods within the UPI SuperCash ecosystem for performance tracking and campaign optimization.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 sc
hive.code.campaign_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for active supercash tasks
sc.status IN (1, 2) AND
--- filter for valid fulfillment statuses
sc.fulfillment_status IN (1, 2, 3) AND
--- data freshness filter for campaign lookup
c.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- month-to-date filtering for current month analysis
sc.updated_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND
sc.updated_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- data partition filter for supercash tasks
sc.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
count(distinct sc.user_id) as daily_unique_users,
date_trunc('day', cast(sc.updated_at as timestamp)) as day_dimension




## UPI  - Daily Updated Campaign Wise Burn summary

This metric tracks UPI supercash campaign burn performance by measuring unique users and total cash burn amounts across different campaign statuses, wallet types, and redemption methods. The analysis includes complex cash burn calculations that vary by redemption type - coins divided by 166.67, goldcoins by 100, and UPI with 0.2478 added. Status classification distinguishes between Given, Processing, Pending, and Unscratched states based on status and fulfillment_status combinations. The metric enables campaign performance monitoring by providing daily granular visibility into user participation and actual cash expenditure across different promotional campaigns, helping optimize campaign effectiveness and budget allocation decisions.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 a
hive.code.campaign_snapshot_v3 b

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data quality by including only active and processable records
a.status IN (1, 2) AND
--- include only valid fulfillment states for burn calculation
a.fulfillment_status IN (1, 2, 3) AND
--- ensure campaign metadata is recent for accurate wallet mapping
b.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- temporal range for supercash task data starting from previous month
a.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month)

--- calculation_logic
CASE 
  WHEN a.status = 1 AND a.fulfillment_status = 3 THEN 'Given'
  WHEN a.status = 1 AND a.fulfillment_status = 2 THEN 'Processing'
  WHEN a.status = 2 AND a.fulfillment_status = 1 THEN 'Unscratched'
  WHEN a.status = 1 AND a.fulfillment_status = 1 THEN 'Pending'
END as status_classification,
CASE 
  WHEN a.redemption_type = 'coins' THEN (a.amount/166.67)
  WHEN a.redemption_type = 'goldcoins' THEN (a.amount/100)
  WHEN a.redemption_type = 'upi' THEN (a.amount + 0.2478)
  ELSE a.amount
END as cashburn_amount




## UPI  - Daily by Created Date Campaign Wise Burn Summary

This metric tracks daily UPI SuperCash campaign performance by measuring unique user engagement and total cash burn across different campaigns, statuses, wallets, and redemption types. It calculates normalized cash burn values using conversion rates for different redemption methods (coins at 1/166.67 rate, goldcoins at 1/100 rate, UPI with 0.2478 surcharge). The analysis focuses on current month data filtering for valid task statuses (1,2) and fulfillment statuses (1,2,3), providing insights into campaign effectiveness, user participation rates, and actual cash expenditure across different wallet providers and redemption channels for performance optimization and budget tracking.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 scts
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data analysis scope
scts.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- valid task statuses for active campaigns
scts.status IN (1, 2) AND
--- valid fulfillment statuses for processing
scts.fulfillment_status IN (1, 2, 3) AND
--- current month created tasks
date(scts.created_at) >= date_trunc('month', current_date - interval '1' day) AND
--- recent campaign metadata for wallet mapping
cs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- none specified for this chart

--- calculation_logic
count(distinct scts.user_id) as unique_users,
sum(case
  when scts.redemption_type = 'coins' then (scts.amount/166.67)
  when scts.redemption_type = 'goldcoins' then (scts.amount/100)
  when scts.redemption_type = 'upi' then (scts.amount + 0.2478)
  else scts.amount
end) as total_cashburn,
case
  when scts.status = 1 and scts.fulfillment_status = 3 then 'Given'
  when scts.status = 1 and scts.fulfillment_status = 2 then 'Processing'
  when scts.status = 2 and scts.fulfillment_status = 1 then 'Unscratched'
  when scts.status = 1 and scts.fulfillment_status = 1 then 'Pending'
end as status_classification






================================================================================
## Dashboard 511
================================================================================

## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 729
================================================================================

## UPI  - MTD Daily Cashback

This metric tracks the daily count of unique users who received UPI cashback within the current month, providing insights into cashback distribution patterns and user engagement. The measurement focuses on users with processed cashback tasks (status 1 or 2, fulfillment_status 1-3) and applies month-to-date filtering to analyze current month performance against historical trends. The cashback amounts are normalized based on redemption type, with specific conversion rates for coins (166.67), goldcoins (100), and UPI (+0.2478). This metric helps monitor the effectiveness of UPI cashback campaigns and user adoption of the cashback program on a daily basis.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 scts
hive.code.campaign_snapshot_v3 ccs

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to current month data for MTD analysis
scts.updated_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND scts.updated_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- include only valid cashback tasks
scts.status IN (1, 2) AND
--- include all fulfillment stages
scts.fulfillment_status IN (1, 2, 3) AND
--- month-to-date flag for period comparison
scts.is_mtd_u = true AND
--- recent campaign data for wallet mapping
ccs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- historical data partition for supercash tasks
scts.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
COUNT(DISTINCT scts.user_id) as unique_cashback_users,
date_trunc('day', CAST(scts.updated_at AS TIMESTAMP)) as daily_grouping,
CASE 
  WHEN scts.redemption_type = 'coins' THEN (scts.amount/166.67)
  WHEN scts.redemption_type = 'goldcoins' THEN (scts.amount/100)
  WHEN scts.redemption_type = 'upi' THEN (scts.amount+0.2478)
  ELSE scts.amount
END as normalized_cashburn_amount




## UPI  - MTD Cashback

This metric tracks the total UPI SuperCash cashback amount burned (given to users) on a month-to-date basis, aggregated hourly. It measures the financial impact of cashback campaigns by converting different redemption types (coins, goldcoins, UPI) to standardized cashburn values using specific conversion rates. The metric filters for current month transactions with valid status conditions (status 1 or 2, fulfillment_status 1-3) to capture legitimate cashback burns. This helps monitor daily cashback expenditure patterns and campaign performance within the UPI ecosystem, providing insights into user engagement and promotional costs across different redemption mechanisms.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 st
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month temporal filter for MTD analysis
st.created_at >= date_trunc('month', current_date) AND
st.created_at < date_trunc('month', current_date) + interval '1' month AND
--- valid transaction status filters
st.status IN (1, 2) AND
st.fulfillment_status IN (1, 2, 3) AND
--- recent campaign data for wallet mapping
cs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- MTD flag for month-to-date calculations
st.is_mtd_u = true

--- calculation_logic
CASE 
  WHEN st.redemption_type = 'coins' THEN (st.amount/166.67)
  WHEN st.redemption_type = 'goldcoins' THEN (st.amount/100)
  WHEN st.redemption_type = 'upi' THEN (st.amount + 0.2478)
  ELSE st.amount
END AS cashburn,
SUM(cashburn) grouped by date_trunc('hour', updated_at)




## UPI  - MTD Gratified Users

This metric measures the count of distinct users who have been gratified (received cashback rewards) in the UPI SuperCash program during the current month. It tracks user engagement with the cashback reward system by identifying unique users who have participated in promotional campaigns and received benefits. The metric applies month-to-date filtering to show progressive user acquisition within the current reporting period. The underlying logic handles complex cashback calculations with different redemption types (coins at 1/166.67 rate, goldcoins at 1/100 rate, UPI with 0.2478 adjustment) and categorizes fulfillment status into business-meaningful states like 'Given', 'Processing', 'Pending', and 'Unscratched'. This enables monitoring of user satisfaction and campaign effectiveness in the SuperCash ecosystem.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 sct
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to current month data for MTD reporting
sct.created_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND sct.created_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- ensure valid status and fulfillment status combinations
sct.status IN (1,2) AND sct.fulfillment_status IN (1,2,3) AND
--- MTD user qualification flag
is_mtd_u = true

--- specific filters
--- data freshness requirement for campaign lookup
cs.dl_last_updated >= current_date - interval '62' day

--- calculation_logic
COUNT(DISTINCT sct.user_id) as gratified_users,
CASE 
  WHEN sct.redemption_type = 'coins' THEN sct.amount/166.67
  WHEN sct.redemption_type = 'goldcoins' THEN sct.amount/100
  WHEN sct.redemption_type = 'upi' THEN sct.amount + 0.2478
  ELSE sct.amount
END as cashburn_amount,
CASE
  WHEN sct.status = 1 AND sct.fulfillment_status = 3 THEN 'Given'
  WHEN sct.status = 1 AND sct.fulfillment_status = 2 THEN 'Processing'
  WHEN sct.status = 2 AND sct.fulfillment_status = 1 THEN 'Unscratched'
  WHEN sct.status = 1 AND sct.fulfillment_status = 1 THEN 'Pending'
END as status_category




## UPI  - MTD Daily Users

This metric tracks the count of distinct users engaging with UPI SuperCash campaigns on a daily basis within the current month. It measures daily user activity in the SuperCash burn program by counting unique user_ids from supercash task records, providing insights into user engagement patterns and campaign adoption rates. The metric filters for active tasks (status 1,2) with various fulfillment statuses (1,2,3) and applies month-to-date temporal filtering on the updated_at timestamp. This helps monitor daily user participation trends and identify peak engagement periods within the UPI SuperCash ecosystem for performance tracking and campaign optimization.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 sc
hive.code.campaign_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for active supercash tasks
sc.status IN (1, 2) AND
--- filter for valid fulfillment statuses
sc.fulfillment_status IN (1, 2, 3) AND
--- data freshness filter for campaign lookup
c.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- month-to-date filtering for current month analysis
sc.updated_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND
sc.updated_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- data partition filter for supercash tasks
sc.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
count(distinct sc.user_id) as daily_unique_users,
date_trunc('day', cast(sc.updated_at as timestamp)) as day_dimension




## UPI  - Daily Updated Campaign Wise Burn summary

This metric tracks UPI supercash campaign burn performance by measuring unique users and total cash burn amounts across different campaign statuses, wallet types, and redemption methods. The analysis includes complex cash burn calculations that vary by redemption type - coins divided by 166.67, goldcoins by 100, and UPI with 0.2478 added. Status classification distinguishes between Given, Processing, Pending, and Unscratched states based on status and fulfillment_status combinations. The metric enables campaign performance monitoring by providing daily granular visibility into user participation and actual cash expenditure across different promotional campaigns, helping optimize campaign effectiveness and budget allocation decisions.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 a
hive.code.campaign_snapshot_v3 b

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data quality by including only active and processable records
a.status IN (1, 2) AND
--- include only valid fulfillment states for burn calculation
a.fulfillment_status IN (1, 2, 3) AND
--- ensure campaign metadata is recent for accurate wallet mapping
b.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- temporal range for supercash task data starting from previous month
a.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month)

--- calculation_logic
CASE 
  WHEN a.status = 1 AND a.fulfillment_status = 3 THEN 'Given'
  WHEN a.status = 1 AND a.fulfillment_status = 2 THEN 'Processing'
  WHEN a.status = 2 AND a.fulfillment_status = 1 THEN 'Unscratched'
  WHEN a.status = 1 AND a.fulfillment_status = 1 THEN 'Pending'
END as status_classification,
CASE 
  WHEN a.redemption_type = 'coins' THEN (a.amount/166.67)
  WHEN a.redemption_type = 'goldcoins' THEN (a.amount/100)
  WHEN a.redemption_type = 'upi' THEN (a.amount + 0.2478)
  ELSE a.amount
END as cashburn_amount




## UPI  - Daily by Created Date Campaign Wise Burn Summary

This metric tracks daily UPI SuperCash campaign performance by measuring unique user engagement and total cash burn across different campaigns, statuses, wallets, and redemption types. It calculates normalized cash burn values using conversion rates for different redemption methods (coins at 1/166.67 rate, goldcoins at 1/100 rate, UPI with 0.2478 surcharge). The analysis focuses on current month data filtering for valid task statuses (1,2) and fulfillment statuses (1,2,3), providing insights into campaign effectiveness, user participation rates, and actual cash expenditure across different wallet providers and redemption channels for performance optimization and budget tracking.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 scts
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data analysis scope
scts.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- valid task statuses for active campaigns
scts.status IN (1, 2) AND
--- valid fulfillment statuses for processing
scts.fulfillment_status IN (1, 2, 3) AND
--- current month created tasks
date(scts.created_at) >= date_trunc('month', current_date - interval '1' day) AND
--- recent campaign metadata for wallet mapping
cs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- none specified for this chart

--- calculation_logic
count(distinct scts.user_id) as unique_users,
sum(case
  when scts.redemption_type = 'coins' then (scts.amount/166.67)
  when scts.redemption_type = 'goldcoins' then (scts.amount/100)
  when scts.redemption_type = 'upi' then (scts.amount + 0.2478)
  else scts.amount
end) as total_cashburn,
case
  when scts.status = 1 and scts.fulfillment_status = 3 then 'Given'
  when scts.status = 1 and scts.fulfillment_status = 2 then 'Processing'
  when scts.status = 2 and scts.fulfillment_status = 1 then 'Unscratched'
  when scts.status = 1 and scts.fulfillment_status = 1 then 'Pending'
end as status_classification






================================================================================
## Dashboard 511
================================================================================

## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## Overall SR_511

This metric measures the overall success rate of UPI transactions, calculated as the percentage of transactions with DEEMED or SUCCESS status relative to total transaction attempts. It tracks payment reliability across the UPI ecosystem for the current month, filtered to include only transactions where the payer is one of the major PSPs (Paytm, Yes Bank, Axis, HDFC, SBI). The metric focuses on core UPI flows including P2P (VPA to VPA/Account) and P2M (VPA to Merchant) transactions through PAY and COLLECT transaction types. This success rate indicator helps monitor transaction processing efficiency and identify potential issues in payment success across different PSP partnerships and transaction categories.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data window for performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- data freshness constraint
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- core UPI payment operations
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- VPA-based transaction flows (P2P and P2M)
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- major PSP ecosystem focus for payer side analysis
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) as success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## P2P P2M SR_511

This metric tracks the success rate (SR) for UPI transactions within the Paytm ecosystem, segmented by transaction type (P2P vs P2M). It measures the percentage of transactions that achieve successful completion (status of either 'DEEMED' or 'SUCCESS') out of all attempted transactions. The analysis focuses specifically on transactions where the payer operates through Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and covers both peer-to-peer transfers (P2P) and peer-to-merchant payments (P2M). Data is filtered to the current month and grouped by day to enable daily trend analysis of transaction success rates across different payment flows.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data recency for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transaction types only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- limit to relevant UPI transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data only for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P' WHEN category IN ('VPA2MERCHANT') THEN 'P2M' ELSE NULL END as P2P_P2M,
day(day_id) as Day,
date_trunc('month', day_id) as Month




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category





================================================================================
## Dashboard 729
================================================================================

## UPI  - MTD Daily Cashback

This metric tracks the daily count of unique users who received UPI cashback within the current month, providing insights into cashback distribution patterns and user engagement. The measurement focuses on users with processed cashback tasks (status 1 or 2, fulfillment_status 1-3) and applies month-to-date filtering to analyze current month performance against historical trends. The cashback amounts are normalized based on redemption type, with specific conversion rates for coins (166.67), goldcoins (100), and UPI (+0.2478). This metric helps monitor the effectiveness of UPI cashback campaigns and user adoption of the cashback program on a daily basis.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 scts
hive.code.campaign_snapshot_v3 ccs

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to current month data for MTD analysis
scts.updated_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND scts.updated_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- include only valid cashback tasks
scts.status IN (1, 2) AND
--- include all fulfillment stages
scts.fulfillment_status IN (1, 2, 3) AND
--- month-to-date flag for period comparison
scts.is_mtd_u = true AND
--- recent campaign data for wallet mapping
ccs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- historical data partition for supercash tasks
scts.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
COUNT(DISTINCT scts.user_id) as unique_cashback_users,
date_trunc('day', CAST(scts.updated_at AS TIMESTAMP)) as daily_grouping,
CASE 
  WHEN scts.redemption_type = 'coins' THEN (scts.amount/166.67)
  WHEN scts.redemption_type = 'goldcoins' THEN (scts.amount/100)
  WHEN scts.redemption_type = 'upi' THEN (scts.amount+0.2478)
  ELSE scts.amount
END as normalized_cashburn_amount




## UPI  - MTD Cashback

This metric tracks the total UPI SuperCash cashback amount burned (given to users) on a month-to-date basis, aggregated hourly. It measures the financial impact of cashback campaigns by converting different redemption types (coins, goldcoins, UPI) to standardized cashburn values using specific conversion rates. The metric filters for current month transactions with valid status conditions (status 1 or 2, fulfillment_status 1-3) to capture legitimate cashback burns. This helps monitor daily cashback expenditure patterns and campaign performance within the UPI ecosystem, providing insights into user engagement and promotional costs across different redemption mechanisms.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 st
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month temporal filter for MTD analysis
st.created_at >= date_trunc('month', current_date) AND
st.created_at < date_trunc('month', current_date) + interval '1' month AND
--- valid transaction status filters
st.status IN (1, 2) AND
st.fulfillment_status IN (1, 2, 3) AND
--- recent campaign data for wallet mapping
cs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- MTD flag for month-to-date calculations
st.is_mtd_u = true

--- calculation_logic
CASE 
  WHEN st.redemption_type = 'coins' THEN (st.amount/166.67)
  WHEN st.redemption_type = 'goldcoins' THEN (st.amount/100)
  WHEN st.redemption_type = 'upi' THEN (st.amount + 0.2478)
  ELSE st.amount
END AS cashburn,
SUM(cashburn) grouped by date_trunc('hour', updated_at)




## UPI  - MTD Gratified Users

This metric measures the count of distinct users who have been gratified (received cashback rewards) in the UPI SuperCash program during the current month. It tracks user engagement with the cashback reward system by identifying unique users who have participated in promotional campaigns and received benefits. The metric applies month-to-date filtering to show progressive user acquisition within the current reporting period. The underlying logic handles complex cashback calculations with different redemption types (coins at 1/166.67 rate, goldcoins at 1/100 rate, UPI with 0.2478 adjustment) and categorizes fulfillment status into business-meaningful states like 'Given', 'Processing', 'Pending', and 'Unscratched'. This enables monitoring of user satisfaction and campaign effectiveness in the SuperCash ecosystem.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 sct
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to current month data for MTD reporting
sct.created_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND sct.created_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- ensure valid status and fulfillment status combinations
sct.status IN (1,2) AND sct.fulfillment_status IN (1,2,3) AND
--- MTD user qualification flag
is_mtd_u = true

--- specific filters
--- data freshness requirement for campaign lookup
cs.dl_last_updated >= current_date - interval '62' day

--- calculation_logic
COUNT(DISTINCT sct.user_id) as gratified_users,
CASE 
  WHEN sct.redemption_type = 'coins' THEN sct.amount/166.67
  WHEN sct.redemption_type = 'goldcoins' THEN sct.amount/100
  WHEN sct.redemption_type = 'upi' THEN sct.amount + 0.2478
  ELSE sct.amount
END as cashburn_amount,
CASE
  WHEN sct.status = 1 AND sct.fulfillment_status = 3 THEN 'Given'
  WHEN sct.status = 1 AND sct.fulfillment_status = 2 THEN 'Processing'
  WHEN sct.status = 2 AND sct.fulfillment_status = 1 THEN 'Unscratched'
  WHEN sct.status = 1 AND sct.fulfillment_status = 1 THEN 'Pending'
END as status_category




## UPI  - MTD Daily Users

This metric tracks the count of distinct users engaging with UPI SuperCash campaigns on a daily basis within the current month. It measures daily user activity in the SuperCash burn program by counting unique user_ids from supercash task records, providing insights into user engagement patterns and campaign adoption rates. The metric filters for active tasks (status 1,2) with various fulfillment statuses (1,2,3) and applies month-to-date temporal filtering on the updated_at timestamp. This helps monitor daily user participation trends and identify peak engagement periods within the UPI SuperCash ecosystem for performance tracking and campaign optimization.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 sc
hive.code.campaign_snapshot_v3 c

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for active supercash tasks
sc.status IN (1, 2) AND
--- filter for valid fulfillment statuses
sc.fulfillment_status IN (1, 2, 3) AND
--- data freshness filter for campaign lookup
c.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- month-to-date filtering for current month analysis
sc.updated_at >= TIMESTAMP '2025-11-01 00:00:00.000000' AND
sc.updated_at < TIMESTAMP '2025-12-01 00:00:00.000000' AND
--- data partition filter for supercash tasks
sc.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
count(distinct sc.user_id) as daily_unique_users,
date_trunc('day', cast(sc.updated_at as timestamp)) as day_dimension




## UPI  - Daily Updated Campaign Wise Burn summary

This metric tracks UPI supercash campaign burn performance by measuring unique users and total cash burn amounts across different campaign statuses, wallet types, and redemption methods. The analysis includes complex cash burn calculations that vary by redemption type - coins divided by 166.67, goldcoins by 100, and UPI with 0.2478 added. Status classification distinguishes between Given, Processing, Pending, and Unscratched states based on status and fulfillment_status combinations. The metric enables campaign performance monitoring by providing daily granular visibility into user participation and actual cash expenditure across different promotional campaigns, helping optimize campaign effectiveness and budget allocation decisions.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 a
hive.code.campaign_snapshot_v3 b

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data quality by including only active and processable records
a.status IN (1, 2) AND
--- include only valid fulfillment states for burn calculation
a.fulfillment_status IN (1, 2, 3) AND
--- ensure campaign metadata is recent for accurate wallet mapping
b.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- temporal range for supercash task data starting from previous month
a.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month)

--- calculation_logic
CASE 
  WHEN a.status = 1 AND a.fulfillment_status = 3 THEN 'Given'
  WHEN a.status = 1 AND a.fulfillment_status = 2 THEN 'Processing'
  WHEN a.status = 2 AND a.fulfillment_status = 1 THEN 'Unscratched'
  WHEN a.status = 1 AND a.fulfillment_status = 1 THEN 'Pending'
END as status_classification,
CASE 
  WHEN a.redemption_type = 'coins' THEN (a.amount/166.67)
  WHEN a.redemption_type = 'goldcoins' THEN (a.amount/100)
  WHEN a.redemption_type = 'upi' THEN (a.amount + 0.2478)
  ELSE a.amount
END as cashburn_amount




## UPI  - Daily by Created Date Campaign Wise Burn Summary

This metric tracks daily UPI SuperCash campaign performance by measuring unique user engagement and total cash burn across different campaigns, statuses, wallets, and redemption types. It calculates normalized cash burn values using conversion rates for different redemption methods (coins at 1/166.67 rate, goldcoins at 1/100 rate, UPI with 0.2478 surcharge). The analysis focuses on current month data filtering for valid task statuses (1,2) and fulfillment statuses (1,2,3), providing insights into campaign effectiveness, user participation rates, and actual cash expenditure across different wallet providers and redemption channels for performance optimization and budget tracking.

-- tables_involved
hive.promocard.supercash_task_snapshot_v3 scts
hive.code.campaign_snapshot_v3 cs

--- standard filters to be applied unless specifically requested for a different categorical value
--- current month data analysis scope
scts.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- valid task statuses for active campaigns
scts.status IN (1, 2) AND
--- valid fulfillment statuses for processing
scts.fulfillment_status IN (1, 2, 3) AND
--- current month created tasks
date(scts.created_at) >= date_trunc('month', current_date - interval '1' day) AND
--- recent campaign metadata for wallet mapping
cs.dl_last_updated >= current_date - interval '62' day

--- specific filters
--- none specified for this chart

--- calculation_logic
count(distinct scts.user_id) as unique_users,
sum(case
  when scts.redemption_type = 'coins' then (scts.amount/166.67)
  when scts.redemption_type = 'goldcoins' then (scts.amount/100)
  when scts.redemption_type = 'upi' then (scts.amount + 0.2478)
  else scts.amount
end) as total_cashburn,
case
  when scts.status = 1 and scts.fulfillment_status = 3 then 'Given'
  when scts.status = 1 and scts.fulfillment_status = 2 then 'Processing'
  when scts.status = 2 and scts.fulfillment_status = 1 then 'Unscratched'
  when scts.status = 1 and scts.fulfillment_status = 1 then 'Pending'
end as status_classification






================================================================================
## Dashboard 476
================================================================================

## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## #Handle wise MAU distribution

This metric tracks Monthly Active Users (MAU) distribution across customer lifecycle stages, measuring engagement patterns by handle ownership and account diversity. MAU is defined as users with at least one transaction use case in the current month (use_case_mtd > 0). The analysis segments customers by lifecycle stages including dormant, reactivated, and overall populations, with additional dimensions for handle counts and account ownership patterns. The metric calculates both absolute MAU counts and percentage distribution within each lifecycle partition, providing insights into user engagement depth across different customer maturity levels. This supports product strategy decisions around user activation, retention, and cross-selling opportunities across the UPI ecosystem.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr
user_paytm_payments.upi_flow_wise_base_cm mtd_flow
user_paytm_payments.upi_flow_wise_base lmtd_flow

--- standard filters to be applied unless specifically requested for a different categorical value
--- active accounts only for current user base
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
DATE(a.created_on) <= current_date - interval '1' day AND
--- paytm ecosystem PSPs only
u.dl_last_updated IS NOT NULL AND
u.psp_id IN (6, 7, 8, 9) AND
u.type = 'PERSON' AND
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- lifecycle data for current month analysis
date(nrr.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day

--- specific filters
--- current month transaction analysis for MAU calculation
mtd_flow.final_category NOT IN ('Others', 'others') AND
mtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- previous month comparison data
lmtd_flow.final_category NOT IN ('Others', 'others') AND
lmtd_flow.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day - interval '1' month

--- calculation_logic
MAU: sum(users) filter(where use_case_mtd > 0),
percentage: format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100),
lifecycle_consolidation: if(lifecycle in ('c:react 1-3', 'c:react 3+'), 'c:react', lifecycle),
account_buckets: case when accounts < 2 then 'a.=1_acc' when accounts = 2 then 'b.=2_acc' when accounts > 2 then 'c.>2_acc' end




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## MAU by Usecase Distribution

MAU by Use Case Distribution tracks monthly active users segmented by customer lifecycle stages and their engagement diversity across UPI use cases. This metric measures user retention and engagement depth by counting distinct customers who used varying numbers of UPI categories (P2P, P2M, etc.) within the current month-to-date (MTD) versus last month-to-date (LMTD) periods. The analysis excludes 'Others' category transactions and includes both lifecycle-specific segments (derived from customer lifecycle snapshots) and an overall aggregated view. This helps identify user engagement patterns and lifecycle progression based on use case adoption, providing insights into customer behavior evolution and platform stickiness across different user maturity stages.

-- tables_involved
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_snap
hive.user_paytm_payments.upi_flow_wise_base_partitioned flow_part
hive.user_paytm_payments.upi_flow_wise_base_cm flow_cm
hive.user_paytm_payments.upi_flow_wise_base flow_base

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unclassified transaction categories
flow_part.final_category NOT IN ('Others','others') AND
flow_cm.final_category NOT IN ('Others','others') AND
flow_base.final_category NOT IN ('Others','others')

--- specific filters
--- lifecycle snapshot date range for customer classification
date(lifecycle_snap.ft_date) BETWEEN date_trunc('month', current_date - interval '1' day) AND current_date - interval '1' day AND
--- transaction date range for MTD/LMTD comparison with day alignment
flow_part.day_id BETWEEN date_trunc('month', current_date - interval '1' day - interval '1' month) AND current_date - interval '1' day AND
day(flow_part.day_id) <= day(current_date - interval '1' day)

--- calculation_logic
pattern: temporal_mtd_comparison
base_metric: count(distinct customer_id)
temporal_flags: MTD vs LMTD based on date_trunc month comparison
aggregation_logic: count distinct use_cases per customer, then count users per use_case_count




## #back acc wise MAU distribution

This metric tracks Monthly Active User distribution segmented by bank account ownership patterns within the UPI ecosystem. It measures total user count, MAU (users with transaction activity in current month), and percentage distribution across account segments. The analysis categorizes users into three groups: single account holders (=1_acc), dual account holders (=2_acc), and multi-account holders (>2_acc), providing insights into how banking relationship complexity correlates with UPI engagement levels. The metric helps understand user activation patterns and identifies which account ownership segments drive higher transaction activity, supporting strategic decisions around user acquisition and engagement initiatives.

-- tables_involved
hive.tpap_pms.account_snapshot_v3 a
hive.tpap_pms.user_snapshot_v3 u
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
user_paytm_payments.upi_flow_wise_base_cm mtd_txn
user_paytm_payments.upi_flow_wise_base lmtd_txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- active account status filter
a.dl_last_updated IS NOT NULL AND
a.status = 'ACTIVE' AND
--- account creation cutoff for current analysis period
DATE(a.created_on) <= current_date + interval '-1' day AND
--- user data quality filter
u.dl_last_updated IS NOT NULL AND
--- paytm ecosystem PSP scope
u.psp_id IN (6, 7, 8, 9) AND
--- active or dormant with comments user status
(u.status = 'ACTIVE' OR (u.status = 'DORMANT' AND u.comments IS NOT NULL)) AND
--- person type users only
u.type = 'PERSON' AND
--- lifecycle data period filter
date(lifecycle.ft_date) between date_trunc('month', current_date - interval '1' day) and current_date - interval '1' day

--- specific filters
--- valid account data requirement
accounts IS NOT NULL

--- calculation_logic
sum(users) as total_users,
sum(users) filter(where use_case_mtd > 0) as mau_count,
format('%.2f%%', (sum(users) filter(where use_case_mtd > 0) * 1.0000) / (sum(sum(users) filter(where use_case_mtd > 0)) over(partition by max(lifecycle)) * 1.0000) * 100) as mau_percentage,
account_categorization: CASE WHEN accounts < 2 THEN 'a.=1_acc' WHEN accounts = 2 THEN 'b.=2_acc' WHEN accounts > 2 THEN 'c.>2_acc' END




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## DAU MAU Txns by T20 Cities

This metric tracks daily active users (DAU), monthly active users (MAU), transaction volumes, and transactions per user (TPU) segmented by India's top 20 metropolitan cities including New Delhi, Bangalore, Hyderabad, Mumbai, Chennai, and others. It measures user engagement and transaction intensity across major urban centers to understand geographic distribution of UPI usage patterns. The analysis filters for customers with defined lifecycle stages and focuses on successful UPI transactions within the Paytm ecosystem. Cities not in the top 20 list are grouped as 'Other' for comparative analysis. This helps identify high-performing markets and user behavior variations across different metropolitan areas.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 profile
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude customers without lifecycle classification
lifecycle IS NOT NULL AND
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- transaction type filtering for payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- UPI category filtering
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- top 20 cities categorization with fallback to Other
CASE 
  WHEN upper(profile.popular_city) IN (
    'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI',
    'NOIDA','GURGAON','GHAZIABAD','AHMEDABAD','PUNE','FARIDABAD',
    'INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','PATNA','LUDHIANA'
  ) 
  THEN profile.popular_city 
  ELSE 'Other' 
END as t20city
--- temporal filtering for recent months
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null)) as DAU,
count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null)) as MAU,
sum(txns) as total_transactions,
sum(txns)*1.00/sum(dau) as transactions_per_user




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by NRR

This metric tracks daily and monthly active users, transaction volumes, and user productivity metrics (transactions per user and GMV per user) segmented by user lifecycle stages (New, Retained, Resurrected users). It analyzes UPI payment behavior across different user retention cohorts to understand engagement patterns and transaction intensity. The analysis focuses on Paytm ecosystem transactions (paytm, ptyes, ptaxis, pthdfc, ptsbi PSPs) for successful payments including VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. The temporal filter allows flexible date range selection while excluding users without lifecycle classification. This enables product teams to assess user engagement quality and transaction productivity across different user maturity segments.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- successful UPI transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSPs for comprehensive coverage
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI payment categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- payment and collection transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude users without lifecycle classification
lifecycle IS NOT NULL

--- specific filters
--- temporal range selection (configurable via UI)
--- day_id TEMPORAL_RANGE (No filter - allows user selection)
--- data freshness constraint for reliable metrics
txn.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
--- analysis window constraint
txn.transaction_date_key >= date_trunc('month',current_date+interval'-1' day)-interval '1' month AND
txn.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct if(row_number() over(partition by payer_cust_id,day_id order by day_id)=1, payer_cust_id, null))
MAU: count(distinct if(row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id)=1, payer_cust_id, null))
TXNs: sum(txns)
TPU: sum(txns)*1.00/sum(DAU)
GPU: sum(GMV)*1.00/sum(DAU)




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## UPI Overall Retention: Monthly

UPI Overall Retention tracks monthly cohort retention rates to measure user engagement persistence over time. This metric calculates what percentage of users active in a given base month continue to be active in subsequent months, creating a cohort analysis across different time intervals. The analysis segments users by lifecycle categories (reactive users grouped as 'c:react') and tracks retention patterns across a 4-month rolling window from the current date. The retention rate is calculated as the ratio of users active in both the base month and retention month to the total users in the base month, providing insights into user stickiness and long-term engagement trends in the UPI ecosystem.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 4-month analysis window from current date
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- user lifecycle categorization for reactive users
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END

--- specific filters
--- temporal range filter on base month (configurable)
--- base_month temporal range (currently set to no filter)

--- calculation_logic
WITH cohort_base AS (
  SELECT date_trunc('month', a.dt) as mt, a.cust_id as scope_cust_id,
         CASE WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react' ELSE a.user_type END as lifecycle
),
retention_analysis AS (
  SELECT date_diff('month', a.mt, b.mt) as diff,
         a.mt as base_month, b.mt as retention_month,
         count(distinct b.scope_cust_id) as users
  FROM cohort_base a
  LEFT JOIN cohort_base b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
  GROUP BY 1, 2, 3
)
SELECT base_month, diff, 
       users * 1.0000 / MAX(users) OVER (PARTITION BY base_month ORDER BY base_month) as retention




## DAU MAU Txns by States

This metric tracks user engagement and transaction activity across Indian states, measuring Daily Active Users (DAU), Monthly Active Users (MAU), total transactions, and Transactions Per User (TPU). It combines UPI transaction data with user demographic information and lifecycle segmentation to provide geographic insights into user behavior patterns. The analysis focuses on successful UPI transactions (PAY/COLLECT) across major payment handles including Paytm ecosystem PSPs. It filters for users with defined lifecycle stages (New/Returning/Reactivated) and enables temporal analysis. This metric helps identify regional performance variations, user concentration patterns, and transaction intensity across different states, supporting geographic expansion strategies and regional market analysis for UPI payment services.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 fact_upi
hive.midgar.engage_data_snapshot_v3 engage
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure user has valid lifecycle classification for proper segmentation
lifecycle IS NOT NULL AND
--- restrict to successful UPI transactions only
fact_upi.status IN ('SUCCESS', 'DEEMED') AND
--- focus on core transaction types
fact_upi.transaction_type IN ('PAY', 'COLLECT') AND
--- include primary UPI categories
fact_upi.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- limit to Paytm ecosystem payment service providers
fact_upi.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- temporal range filter for transaction analysis period
--- default: current month and previous month data
fact_upi.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) - interval '1' month AND
fact_upi.transaction_date_key < current_date

--- calculation_logic
DAU: count(distinct case when row_number() over(partition by payer_cust_id, day_id order by day_id) = 1 then payer_cust_id end)
MAU: count(distinct case when row_number() over(partition by payer_cust_id, year(day_id), month(day_id) order by day_id) = 1 then payer_cust_id end)
TXNs: sum(transaction_count)
TPU: sum(txns) * 1.00 / sum(DAU)




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-New

This metric tracks UPI user retention rates specifically for new users (lifecycle = 'a:new') across monthly cohorts. It measures what percentage of new users from a given base month remain active in subsequent months, providing insights into user engagement and product stickiness for newly acquired UPI customers. The retention calculation normalizes current month active users against the peak users in each cohort, enabling comparison across different base months. The analysis filters for non-null base months and focuses exclusively on the 'a:new' user lifecycle segment, helping understand how effectively Paytm retains newly onboarded UPI users over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude records with null base month to ensure data quality
base_month IS NOT NULL AND
--- focus analysis on new user lifecycle segment
lifecycle = 'a:new'

--- specific filters
--- date range constraint for analysis window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- ensure base months are in the past for complete retention tracking
mt < current_date

--- calculation_logic
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
COUNT(DISTINCT b.scope_cust_id) AS users,
date_diff('month', a.mt, b.mt) AS diff




## UPI Retention-Repeat

This metric tracks UPI user retention rates for repeat users, measuring the percentage of users who continue transacting in subsequent months after their initial cohort month. It calculates Net Retention Rate (NRR) by comparing active users in each retention period to the total users in their base month cohort. The analysis is filtered to focus specifically on repeat users (lifecycle = 'b:repeat') and excludes null values for base months and retention periods. This retention analysis helps understand user engagement patterns and lifecycle value for the repeat user segment within the UPI ecosystem, providing insights into user stickiness and platform loyalty over time.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on repeat users only for retention analysis
vt.lifecycle = 'b:repeat' AND
--- ensure valid base month data exists
vt.Base_month IS NOT NULL AND
--- exclude records without retention period calculation
vt.diff IS NOT NULL

--- specific filters
--- time window for cohort analysis (4 months back from current date)
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
         IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention_cohort AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) diff, a.mt base_month, b.mt retention_month,
         COUNT(DISTINCT b.scope_cust_id) users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI Retention-Reactivated

This metric tracks UPI user retention rates specifically for reactivated customers (lifecycle = 'c:react'). It measures the percentage of users from a base month who remain active in subsequent months, calculated using a Net Revenue Retention methodology. The analysis focuses on reactivated users who were previously inactive but returned to using UPI services, providing insights into customer re-engagement effectiveness. The retention calculation compares user counts across different month intervals (diff) from the base month, showing how well Paytm retains users after they've been successfully reactivated. This helps evaluate the long-term value and stickiness of reactivation strategies.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters
--- focus on reactivated user segment for retention analysis
lifecycle = 'c:react' AND
--- exclude null values for temporal analysis
Base_month IS NOT NULL AND
--- ensure valid month difference calculations
diff IS NOT NULL AND
--- limit analysis to recent 4-month window
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
a.mt < current_date

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id,
    IF(a.user_type IN ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) user_type
),
retention AS (
  SELECT a.lifecycle, date_diff('month', a.mt, b.mt) AS diff, a.mt AS base_month,
    COUNT(DISTINCT b.scope_cust_id) AS users
  FROM upi a LEFT JOIN upi b ON b.scope_cust_id = a.scope_cust_id AND b.mt >= a.mt
)
SELECT users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention




## UPI flow Wise SR

This metric tracks UPI transaction success rates segmented by flow category (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT) to monitor payment ecosystem performance across different transaction types. It measures the percentage of successful transactions (including deemed successful) against total attempted transactions (success, deemed, failure, pending) for major PSP participants including Paytm, Yes Bank, Axis, HDFC, and SBI. The analysis focuses on PAY and COLLECT transaction types over a rolling 2+ month period, providing insights into payment flow reliability and identifying performance variations across merchant payments, peer-to-peer transfers, and account-based transactions within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for snapshot table
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- transaction date range for 2+ months historical analysis
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types for payment flows
a.transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- UPI flow categories for comprehensive coverage
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) as Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) as Overall_txn,
cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' as success_rate




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## UPI Retention- M0 MAU

This metric tracks UPI Monthly Active Users (MAU) in their initial month of activity (M0) across different user lifecycle segments, measuring both absolute user counts and month-over-month growth percentages. The analysis calculates retention patterns by comparing user activity across consecutive months, with the diff=0 filter specifically isolating new user acquisition metrics. The business purpose is to monitor user onboarding effectiveness and growth trends in the UPI ecosystem, helping identify whether new user acquisition is accelerating or declining over time. The metric provides insights into user lifecycle management and platform growth dynamics.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent 4-month period for performance and relevance
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude current incomplete month
date_trunc('month', a.dt) < current_date AND
--- focus on M0 MAU (initial month users) 
diff = 0

--- specific filters
--- temporal range filter for base_month analysis period
--- base_month temporal range (configurable via dashboard filter)

--- calculation_logic
WITH upi AS (
  SELECT date_trunc('month', a.dt) mt, a.cust_id scope_cust_id, a.user_type lifecycle
  FROM hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
),
retention_analysis AS (
  SELECT base_month, lifecycle, COUNT(DISTINCT scope_cust_id) users,
         LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) prev_month_users,
         (users - prev_month_users) mom_growth
  FROM upi GROUP BY base_month, lifecycle
)
SELECT SUM(users) MAU, SUM(mom_growth*1.0000)/SUM(users) growth_percentage




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI Retention NRR MAU

This metric tracks Monthly Active Users (MAU) segmented by user lifecycle categories for UPI retention analysis. It measures the count of unique users in their base month (month of initial activity) across different lifecycle stages including combined reactive users ('c:react' consolidating 3+ and 1-3 reactive segments) and other user types. The analysis focuses on current month MAU by filtering for diff=0 (base month retention) and excludes records with null base months. This provides insights into user acquisition patterns and lifecycle distribution, supporting retention strategy development by showing how many users are in each lifecycle stage during their initial month of UPI activity.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to recent 4 months of data for current retention analysis
a.dt >= date_trunc('month', current_date + interval '-1' day) - interval '4' month AND
--- exclude future dates from analysis
a.mt < current_date AND
--- focus on base month MAU (users in their initial month)
diff = 0 AND
--- exclude records with missing base month data
base_month IS NOT NULL

--- specific filters
--- lifecycle categorization with reactive user consolidation
CASE 
  WHEN a.user_type IN ('c:react 3+', 'c:react 1-3') THEN 'c:react'
  ELSE a.user_type
END AS lifecycle

--- calculation_logic
COUNT(DISTINCT scope_cust_id) AS users,
date_trunc('month', a.dt) AS mt,
users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
(users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## UPI LMTD Retention

UPI LMTD Retention tracks user retention from the previous month to the current month, measuring how many users from different lifecycle stages (such as c:react for reactive users) who were active in the last month continued to perform UPI transactions in the current month. The analysis segments users by their behavioral lifecycle classification and calculates both absolute retention numbers and retention percentages. Base users are identified from MAU data for the previous month, while retained users are those who conducted successful UPI transactions (PAY/COLLECT) in the current month through Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi handles across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 a
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters for last month MAU data
--- extract users from previous month for base retention calculation
a.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-2' month AND
a.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' month + interval '-1' day AND
--- consolidate reactive user types for lifecycle analysis
if(a.user_type in ('c:react 3+', 'c:react 1-3'), 'c:react', a.user_type) as lifecycle

--- standard filters for current month transaction data
--- ensure data freshness and current month scope
a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
    and current_date + interval '-1' day + interval '-1' month AND
--- successful transaction types only
a.transaction_type in ('PAY', 'COLLECT') AND
a.status in ('SUCCESS', 'DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
count(distinct lm.scope_cust_id) as Base_users,
count(distinct cmtd.scope_cust_id) as Reatined_users,
SUM(Reatined_users) * 1.0000 / SUM(Base_users) as retention_rate




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## UPI MTD Retention

UPI MTD Retention tracks user retention by measuring what percentage of users who transacted in the previous month also transacted in the current month-to-date, segmented by user lifecycle categories. This metric helps assess user engagement consistency and identifies which user segments maintain active transaction behavior month-over-month. The analysis focuses on Paytm ecosystem PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and includes successful PAY/COLLECT transactions across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users are identified from the complete previous month, while retained users are those who have transacted from the start of current month until yesterday, providing insights into ongoing user engagement patterns.

-- tables_involved
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- paytm ecosystem psp transactions only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transaction status
txn.status IN ('SUCCESS','DEEMED') AND
--- standard upi transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- major upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base users: previous month complete period
mau.dt >= date_trunc('month', current_date + interval '-1' day) + interval '-1' month AND
mau.dt <= date_trunc('month', current_date + interval '-1' day) + interval '-1' day AND
--- retained users: current month to date period
txn.transaction_date_key >= date_trunc('month', current_date + interval '-1' day) AND
txn.transaction_date_key <= current_date + interval '-1' day AND
txn.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) AND
txn.dl_last_updated <= current_date + interval '-1' day

--- calculation_logic
base_users: count(distinct scope_cust_id) from previous month MAU data
retained_users: count(distinct scope_cust_id) from current MTD transactions
retention_rate: sum(retained_users * 1.0000) / sum(base_users)
lifecycle_segmentation: case when user_type in ('c:react 3+','c:react 1-3') then 'c:react' else user_type end




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag




## RMG Retentions

This metric tracks user retention rates for gaming merchants within the Paytm UPI ecosystem, measuring the percentage of Monthly Active Users from one period who remain transactionally active in the subsequent month. The analysis segments users by lifecycle categories (reactive users with different engagement levels) and gaming merchant participation status. It compares retention across two specific month pairs: August to September and September to October 2025. The metric helps understand user stickiness and engagement patterns specifically for gaming merchant customers, providing insights into customer lifecycle management and the effectiveness of gaming merchant offerings in maintaining user activity on the platform.

-- tables_involved
hive.user_paytm_payments.gaming_merchant_5816_analysis gma
hive.user_paytm_payments.paytm_upi_mau_final_nrr_1 mau
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different analysis periods
--- gaming merchant identification period
gma.mnt >= date'2025-05-01' AND gma.mnt <= date'2025-08-31' AND
--- gaming merchant classification filter
gma.gaming_merc = 'Gaming merc' AND
--- upi transaction success criteria
txn.transaction_type IN ('PAY','COLLECT') AND
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- transaction category scope
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- base period definition for aug to sep analysis
mau.dt >= date'2025-08-01' AND mau.dt <= date'2025-08-31' AND
--- retention period for aug to sep analysis  
txn.dl_last_updated BETWEEN date'2025-09-01' AND date'2025-09-30' AND
txn.transaction_date_key >= date'2025-09-01' AND txn.transaction_date_key <= date'2025-09-30' AND
--- month-to-date comparison filter
day(txn.transaction_date_key) < day(current_date) AND
--- lifecycle categorization logic
CASE WHEN mau.user_type IN ('c:react 3+','c:react 1-3') THEN 'c:react' ELSE mau.user_type END

--- calculation_logic
count(distinct mau.cust_id) as users,
count(distinct txn.customer_id_payer) as retained_users,
sum(retained_users*1.0000)*100/sum(users)*1.0000 as retention_percentage,
if(gma.customer_id is not null, 1, 0) as gaming_merchant_flag




## UPI SR DoD Overall Line Trend

This metric tracks daily UPI transaction success rates to monitor payment ecosystem health and performance trends. It measures the percentage of successful transactions (including deemed successful) against total valid transactions across major Payment Service Providers including Paytm, Yes Bank, Axis Bank, HDFC Bank, and SBI. The chart applies standard UPI transaction filters for PAY and COLLECT transaction types across VPA-to-merchant, VPA-to-VPA, and VPA-to-account categories. It provides day-over-day trend analysis within the current month timeframe, enabling stakeholders to identify performance patterns, detect anomalies, and assess the overall reliability of the UPI payment infrastructure across participating banks and payment providers.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness and completeness
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- current month temporal range for trend analysis
transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month and current_date + interval '-1' day AND
--- standard UPI transaction types for payment operations
transaction_type in ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
payer_handle in ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category in ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- current month date range from Superset temporal filter
"Date" >= DATE '2025-10-01' AND "Date" < DATE '2025-11-30'

--- calculation_logic
sum(COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)) as Success,
sum(COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)) as Overall,
cast(round(SUM(success_txn*1.00)*100/SUM(overall_txn), 2) as int) as SR




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the comparative performance between P2P (person-to-person) and P2M (person-to-merchant) transactions segmented by user lifecycle stages. It measures three key ratios: DAU (Daily Active Users), transaction count, and GMV (Gross Merchandise Value) comparing P2P to P2M activity within each lifecycle category. The analysis focuses on Paytm ecosystem PSPs and includes time-based comparison between current month-to-date and last month-to-date periods. This helps understand user behavior patterns across different lifecycle stages, identifying whether users in specific lifecycle phases prefer P2P or P2M transactions, and how these preferences impact overall transaction volumes and values.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 nrr

--- standard filters to be applied unless specifically requested for a different categorical value
--- transaction success filter for reliable metrics
a.status IN ('SUCCESS','DEEMED') AND
--- transaction type filter for payment flows
a.transaction_type IN ('PAY','COLLECT') AND
--- paytm ecosystem psp filter
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- upi transaction category filter
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current date exclusion for complete day data
a.transaction_date_key < current_date AND
--- lifecycle data availability filter
lifecycle IS NOT NULL AND
--- day comparison filter for mtd analysis
day(day_id) < day(current_date)

--- specific filters
--- month-to-date time range for current and previous month comparison
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                      AND current_date + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                          AND current_date + interval '-1' day AND
--- lifecycle snapshot date range
date(ft_date) >= date_trunc('month',(current_Date - interval '01' day )) - interval '01' month

--- calculation_logic
LAG(sum(metric)) OVER(PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag) * 1.000000 / sum(metric)
CASE flow categorization: WHEN is_p2p=True THEN 'P2P' WHEN is_p2m=True THEN 'P2M' ELSE flow_category END
Month flag logic: CASE WHEN day_id >= date_trunc('month', current_date) THEN 'CMTD' WHEN day_id >= date_trunc('month', current_date)+interval '-1' month THEN 'LMTD' END




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## RMG TPU GPU

This metric tracks monthly active users segmented by gaming behavior and UPI use case diversity patterns. Users are classified as either Gaming (those with transactions to gaming merchants) or Non-gaming based on activity in the gaming merchant analysis table. They are further categorized by use case engagement: single use case (users engaging with only one UPI flow category like P2P, SnP, Online, or Onus) versus multi-use case (2+ categories). The analysis covers transactions from Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. This segmentation helps understand user engagement patterns and identify opportunities for cross-selling UPI services to single-category users while analyzing gaming user behavior across different payment flows.

-- tables_involved
user_paytm_payments.gaming_merchant_5816_analysis rmg_analysis
hive.cdo.fact_upi_transactions_snapshot_v3 upi_txn

--- standard filters to be applied unless specifically requested for different values
--- limit to paytm ecosystem PSPs for internal analysis
upi_txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate user behavior analysis
upi_txn.status IN ('SUCCESS','DEEMED') AND
--- core transaction types for payment flow analysis
upi_txn.transaction_type IN ('PAY','COLLECT') AND
--- standard UPI categories for merchant and P2P flows
upi_txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- current month minus 1 day to previous month date range for monthly analysis
upi_txn.dl_last_updated BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND current_date AND
upi_txn.transaction_date_key BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month)) AND (current_date - interval '01' day)

--- specific filters
--- gaming merchant identification for user segmentation
rmg_analysis.mnt BETWEEN date'2025-05-01' AND date'2025-08-31' AND
rmg_analysis.gaming_merc = 'Gaming merc'

--- calculation_logic
CASE WHEN flow_category IN ('P2P') THEN 'P2P'
     WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
     WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online'
     WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus'
END as final_category,
COUNT(DISTINCT final_category) as use_case_count,
IF(use_case_count = 1, '1', '2+') as use_case_segment,
IF(rmg.customer_id IS NULL, 'Non_gaming', 'Gaming') as gaming_flag,
COUNT(customer_id) as users




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## [Growth]TG CG tracking feature for New PTS Banner 2.0

This metric measures the total number of users who viewed PTS Banner 2.0 campaigns across various UPI payment features including bank linking, RuPay credit card linking, UPI Lite activation, statement downloads, widget additions, spend analytics, auto top-up, balance checking, custom VPA creation, and payment hiding. The tracking system correlates banner impressions with subsequent feature adoption to measure campaign effectiveness. The data encompasses multiple feature types promoted through banner campaigns, providing insights into user engagement with Paytm's payment feature discovery initiatives. This helps evaluate which banner-driven features generate the most user interest and drive feature adoption within the UPI ecosystem.

-- tables_involved
hive.team_measurement.banner_campaigns_customer_v1 banner
hive.user_paytm_payments.bank_link bank_link
hive.user_paytm_payments.cc_all_linkages cc_link
hive.user_paytm_payments.lite_active lite
hive.user_paytm_payments.upi_statement_download_V1 stmt
hive.user_paytm_payments.widget_added_rec_money_ER_daily rec_widget
hive.user_paytm_payments.widget_added_snp_ER_daily snp_widget
hive.user_paytm_payments.spend_analytics spend
hive.user_paytm_payments.lite_auto_topup auto_topup
hive.user_paytm_payments.check_balance balance
hive.user_paytm_payments.customer_vpa vpa
hive.user_paytm_payments.hide_payments hide
hive.user_paytm_payments.mapper mapper

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure data completeness
bank_link.dt < current_date AND
cc_link.dt < current_date AND
lite.lite_dt < current_date AND
stmt.dt < current_date AND
rec_widget.dl_last_updated < current_date AND
snp_widget.dl_last_updated < current_date AND
spend.dt < current_date AND
auto_topup.dt < current_date AND
balance.dt < current_date AND
vpa.dt < current_date AND
hide.dt < current_date AND
mapper.dt < current_date

--- specific filters
--- PTS Banner 2.0 campaign identification
banner.banner_id IN ('3159810','3159843','3159842','3159841','3159987','3159988','3159989','3160634','3159986','3041990','3159992','3159993','3159994','3159995')

--- calculation_logic
SUM(banner.users_viewed_banner) as total_users_viewed




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rate trends segmented by flow category to monitor payment ecosystem performance over time. Success rate is calculated as the percentage of successful and deemed transactions against total transaction volume including failures and pending transactions. The analysis focuses on core UPI flows (P2P, P2M merchant payments, and account transfers) while excluding mandate-based and onus transactions. Filtering is applied to major PSP partners including Paytm, Yes Bank, Axis, HDFC, and SBI for comprehensive ecosystem coverage. The day-over-day trending capability enables identification of performance patterns and anomalies across different transaction flow categories within the UPI network.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to core payment transaction types
a.transaction_type IN ('PAY','COLLECT') AND
--- focus on major PSP ecosystem partners
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- include primary UPI flow categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') AND
--- exclude mandate and onus transaction flows
Flow_category NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M') AND
--- data freshness constraint for incremental processing
a.dl_last_updated >= date_trunc('month',current_date+interval'-1' day)-interval '2' month

--- specific filters
--- temporal range for monthly trending analysis
--- transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month and current_date+interval'-1' day
Date >= DATE '2025-10-01' AND Date < DATE '2025-11-30'

--- calculation_logic
SUM(success_txn*1.0000)/SUM(overall_txn) AS success_rate
WHERE success_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END)
AND overall_txn = COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END)




## UPI SR Flow wise DoD Overall Line Trend

This metric tracks UPI transaction success rates segmented by flow category with day-over-day trend analysis. Success rate is calculated as the ratio of successful transactions (status: success or deemed) to total attempted transactions (status: success, deemed, failure, or pending). The analysis focuses on core UPI payment flows (PAY and COLLECT transaction types) processed through major PSP handles including Paytm, Yes Bank, Axis, HDFC, and SBI. It excludes mandate-related flows and other P2M categories to concentrate on primary VPA-to-VPA, VPA-to-merchant, and VPA-to-account transactions. This metric helps monitor payment system reliability and identify performance variations across different transaction flow categories over time.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for incremental processing
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal range for analysis period
a.transaction_date_key between date_trunc('month', current_date + interval '-1' day) - interval '2' month
  and current_date + interval '-1' day AND
--- core UPI transaction types
a.transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP handles focus
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- primary UPI flow categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- specific filters
--- exclude mandate and specialized flow categories
"Flow_category" NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M') AND
--- chart-specific temporal filter
"Date" >= DATE '2025-10-01' AND "Date" < DATE '2025-11-30'

--- calculation_logic
success_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END),
overall_txn: COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END),
success_rate: SUM(success_txn * 1.0000) / SUM(overall_txn)




## UPI SR DoD Overall Line Trend

This metric tracks UPI transaction success rate trends over time, measuring the percentage of successful transactions (success/deemed status) against total attempted transactions (success/deemed/failure/pending). It focuses on core UPI payment flows including PAY and COLLECT transaction types across major PSP handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) and standard UPI categories (VPA2MERCHANT, VPA2VPA, VPA2ACCOUNT). The success rate calculation provides daily insights into UPI ecosystem health and performance stability. Data spans approximately two months from the previous month start to yesterday, enabling day-over-day trend analysis for operational monitoring and performance benchmarking across the UPI network.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness control for reliable metrics
a.dl_last_updated >= date_trunc('month', current_date + interval '-1' day) - interval '2' month AND
--- temporal range covering approximately 2 months for trend analysis
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month 
AND current_date + interval '-1' day AND
--- core UPI payment transaction types
a.transaction_type IN ('PAY', 'COLLECT') AND
--- major PSP ecosystem participants
a.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- standard UPI transaction categories
a.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT')

--- calculation_logic
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id END) AS Success_txn,
COUNT(CASE WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id END) AS Overall_txn,
CAST(ROUND(SUM(success_txn * 1.00) * 100 / SUM(overall_txn), 2) AS int) AS SR




## UPI Retention TPU wise LMTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) frequency buckets for Last Month To Date comparison. It measures how many users from the previous complete month continue transacting in the current month up to the same day, providing insights into user engagement patterns across different transaction frequency segments. The analysis includes lifecycle categorization (returning vs fresh users) and TPU buckets ranging from single transactions to 20+ transactions. This retention analysis helps identify which user segments demonstrate stronger engagement and loyalty patterns, enabling targeted retention strategies for different user behavior profiles within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI ecosystem analysis
--- paytm group psp handles only
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful and deemed transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- pay and collect transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- core upi categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters for retention analysis
--- last month complete period for base users (LlM CTE)
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current month up to same day for retained users (lMTD CTE)
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                         AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
WITH base_users: COUNT(DISTINCT customer_id_payer) FROM last_month_complete,
retained_users: COUNT(DISTINCT CASE WHEN current_month_user EXISTS THEN base_user END),
retention_rate: SUM(retained_users*1.0000)/SUM(base_users),
tpu_buckets: CASE tpu WHEN 1 THEN 'a.1' WHEN 2 THEN 'b.2' WHEN 3 THEN 'c.3' WHEN 4-10 THEN 'd.4-10' WHEN 11-20 THEN 'e.11-20' ELSE 'f.20+' END




## UPI Retention TPU wise MTD

This metric tracks UPI user retention rates segmented by Transaction Per User (TPU) frequency buckets from the previous month, measuring what percentage of users continue transacting in the current month-to-date period. It analyzes user stickiness across different engagement levels, from single-transaction users (TPU=1) to highly active users (TPU=20+), providing insights into retention patterns by user activity segments. The metric includes both lifecycle-specific retention breakdowns and overall retention rates, helping identify which user engagement levels show stronger month-over-month retention. Base users represent the total addressable cohort from last month, while retained users are those who successfully transacted in the current MTD period, with retention calculated as the ratio between them.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- UPI transaction scope for successful payment flows
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transaction status only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSP handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month cohort period for base users
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
--- current month-to-date period for retention measurement
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day)
                              AND current_date + interval '-1' day AND
--- data freshness alignment
txn.dl_last_updated BETWEEN respective_period_start AND respective_period_end

--- calculation_logic
-- TPU buckets: CASE WHEN tpu = 1 THEN 'a.1', tpu = 2 THEN 'b.2', tpu = 3 THEN 'c.3', tpu BETWEEN 4 AND 10 THEN 'd.4-10', tpu BETWEEN 11 AND 20 THEN 'e.11-20', tpu > 20 THEN 'f.20+'
-- Base users: COUNT(DISTINCT customer_id_payer) from last month
-- Retained users: COUNT(DISTINCT CASE WHEN current_mtd_user EXISTS THEN last_month_user END)
-- Retention rate: SUM(Retained_users*1.0000)/SUM(Base_users)




## [Upi Profile wise] P2P P2M Ratio

This metric tracks the comparative performance between P2P and P2M transaction flows across customer lifecycle segments, measuring Daily Active Users, transaction counts, and Gross Merchandise Value ratios. The analysis segments users by their lifecycle stage and compares current month-to-date performance against last month-to-date periods. It calculates P2P-to-P2M ratios using window functions to understand the relative adoption and usage patterns between peer-to-peer and peer-to-merchant transactions. The metric helps identify which customer segments prefer P2P vs P2M flows and how these preferences shift over time periods, providing insights for product strategy and user engagement optimization across different lifecycle stages.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to successful UPI transactions only
txn.status IN ('SUCCESS', 'DEEMED') AND
--- limit to PAY and COLLECT transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI payment categories
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- include only PSP ecosystem transactions
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi') AND
--- exclude future transactions
txn.transaction_date_key < current_date AND
--- ensure lifecycle data availability
lifecycle.lifecycle IS NOT NULL

--- specific filters
--- month-over-month comparison window
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                         AND current_date - interval '1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                              AND current_date - interval '1' day AND
--- lifecycle snapshot temporal alignment
lifecycle.ft_date >= date_trunc('month', current_date - interval '1' day) - interval '1' month AND
--- day-of-month alignment for fair comparison
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
LAG(sum(base_metric)) OVER (PARTITION BY lifecycle, mt_flag ORDER BY p2m_p2p_flag) * 1.0 / sum(base_metric)
base_metrics: DAU (count distinct payer_cust_id), Txns (count distinct txn_id), Amount (sum amount)
p2m_p2p_flag: CASE WHEN is_p2p=True THEN 'P2P' WHEN is_p2m=True THEN 'P2M' ELSE flow_category END
mt_flag: CASE WHEN day_id >= date_trunc('month', current_date) THEN 'CMTD' 
              WHEN day_id >= date_trunc('month', current_date) - interval '1' month THEN 'LMTD' END




## UPI Retention TPU wise LMTD

This metric tracks UPI user retention rates by analyzing how many users from the previous month continue transacting in the current month-to-date period, segmented by TPU (Transactions Per User) buckets and customer lifecycle stages. It measures engagement persistence by comparing last month's active user base against current month's activity, providing insights into user stickiness across different transaction frequency segments (1, 2, 3, 4-10, 11-20, 20+ TPU) and lifecycle categories including fresh users. The analysis helps identify retention patterns across user engagement levels and lifecycle stages, enabling targeted retention strategies for different user segments in the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
hive.default.virtual_table virtual

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
a.transaction_type IN ('PAY','COLLECT') AND
--- successful transaction statuses only
a.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- core upi transaction categories
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month full period for base users (llm cte)
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
--- current mtd period for retained users (lmtd cte)  
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
--- ensure mtd comparison excludes future days
day(transaction_date_key) < day(current_date)

--- calculation_logic
Base_users: COUNT(DISTINCT customer_id_payer) from last month,
Retained_users: COUNT(DISTINCT CASE WHEN current_month_user EXISTS THEN customer_id_payer END),
retention_percentage: SUM(Retained_users*1.0000)/SUM(Base_users),
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' ... WHEN tpu>20 THEN 'f.20+' END,
lifecycle_segmentation: customer lifecycle categories plus overall aggregation




## UPI Retention TPU wise MTD

This metric tracks UPI user retention from last month to current month-to-date, segmented by TPU (Transactions Per User) buckets to understand retention patterns across different user activity levels. Base users are those who transacted in the last complete month, categorized into TPU buckets (1, 2, 3, 4-10, 11-20, 20+) based on their transaction frequency. Retained users are those base users who also transacted in the current month-to-date period. The retention rate reveals how well different user segments are retained month-over-month, with segmentation by customer lifecycle stages and an overall aggregate view. This analysis helps identify which transaction frequency segments have higher retention rates and inform targeted retention strategies.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi ecosystem transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- successful transactions only
txn.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp handles
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- standard upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month date range for base user identification
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                              AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
--- current month-to-date range for retained user identification  
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day)
                              AND current_date + interval '-1' day AND
--- lifecycle snapshot date range
lifecycle.ft_date BETWEEN date_trunc('month',(current_date - interval '01' day - interval '01' month))
                       AND date_trunc('month',current_date)- interval '01' day

--- calculation_logic
pattern: monthly_retention_analysis
base_users: COUNT(DISTINCT last_month_users)
retained_users: COUNT(DISTINCT CASE WHEN current_month_activity IS NOT NULL THEN last_month_users END)
retention_rate: SUM(retained_users*1.0000)/SUM(base_users)
tpu_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' ... END




## State wise flow wise

This metric tracks UPI ecosystem performance by measuring Daily Active Users (DAU), transaction volumes, and transaction amounts segmented by customer lifecycle stage, state, and transaction flow type (P2P vs P2M). It provides operational insights into regional user engagement patterns and transaction behavior across different customer maturity stages. The analysis combines transaction data with customer geography and lifecycle information to enable performance monitoring at state level. Data is filtered to show recent activity (last 3 days) and focuses on successful UPI transactions within the Paytm ecosystem including partner PSPs (ptyes, ptaxis, pthdfc, ptsbi). This enables business teams to identify regional growth opportunities and understand how different customer segments contribute to overall UPI performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
hive.midgar.engage_data_snapshot_v3 geo

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent transactional activity for operational monitoring
day_id >= current_date - interval '3' day AND
--- ensure transaction data freshness and completeness
txn.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
txn.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND current_date + interval '-1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- focus on completed transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
txn.status IN ('SUCCESS', 'DEEMED') AND
--- limit to UPI ecosystem transactions
txn.category IN ('VPA2MERCHANT', 'VPA2VPA', 'VPA2ACCOUNT') AND
--- paytm ecosystem PSPs only
txn.payer_handle IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- lifecycle data alignment with transaction month
lifecycle.ft_date >= date_trunc('month', current_date - interval '1' day) - interval '1' month

--- calculation_logic
count(distinct payer_cust_id) as DAU,
sum(txns) as Txns,
sum(amount) as Amount,
CASE WHEN txn.is_p2p = True THEN 'P2P' WHEN txn.is_p2m = True THEN 'P2M' ELSE flow_category END as p2m_p2p_flag,
coalesce(geo.popular_state, 'Other') as state




## UPI Retention GPU wise MTD

This metric tracks UPI user retention rates from the previous month to the current month-to-date period, segmented by GMV transaction value buckets and customer lifecycle stages. It measures how many users who were active in the last month continue to perform UPI transactions in the current month, providing insights into user engagement and loyalty patterns. The analysis includes TPU bucketing (1, 2, 3, 4-10, 11-20, 20+) and GMV ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) to understand retention behavior across different user value segments. The metric calculates base users from last month's activity and retained users who appear in both periods, with an overall retention percentage.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters for UPI transaction analysis
--- transaction type scope for payment flows
a.transaction_type IN ('PAY','COLLECT') AND
--- successful transaction status filtering
a.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem PSP handles only
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- upi category filtering for standard flows
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- current month-to-date period for retention measurement
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) AND current_date + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) AND current_date + interval '-1' day
--- last month period for base user identification
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month AND date_trunc('month', current_date + interval '-1' day) - interval '1' day

--- calculation_logic
SUM(Base_users) as base_users_total,
SUM(Retained_users) as retained_users_total,
SUM(Retained_users*1.0000)/SUM(Base_users) as retention_rate




## State wise flow wise

This metric tracks daily active users, transaction volumes, and transaction amounts for UPI payments segmented by customer lifecycle stage, geographic state, and payment flow type (P2P vs P2M). It provides operational insights into user engagement patterns across different customer maturity stages and geographic regions within the Paytm UPI ecosystem. The analysis focuses on recent activity (last 3 days) and includes both peer-to-peer and peer-to-merchant transaction flows. The geographic segmentation helps identify state-wise adoption patterns, while lifecycle segmentation reveals how user behavior varies across different customer journey stages from new to retained users.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle
hive.midgar.engage_data_snapshot_v3 geo
hive.default.virtual_table vt

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent operational data for performance monitoring
vt.day_id >= current_date - interval '3' day AND
--- paytm ecosystem psp focus for internal analytics
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- successful transactions only for accurate business metrics
txn.status IN ('SUCCESS','DEEMED') AND
--- upi payment types excluding refunds and reversals
txn.transaction_type IN ('PAY','COLLECT') AND
--- standard upi transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- data freshness constraint for snapshot tables
txn.dl_last_updated BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND current_date - interval '1' day AND
--- transaction date range for monthly analysis window
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month AND current_date - interval '1' day AND
--- exclude future dated transactions
txn.transaction_date_key < current_date AND
--- lifecycle data alignment with transaction month
lifecycle.ft_date >= date_trunc('month', current_date - interval '1' day) - interval '1' month

--- calculation_logic
sum(vt.dau) as total_dau,
sum(vt.txns) as total_transactions, 
sum(vt.amount) as total_amount,
segmented by lifecycle.lifecycle, vt.state, vt.p2m_p2p_flag, vt.flow_category




## UPI Retention GPU wise MTD

This metric measures UPI user retention rates segmented by GMV buckets (ranging from 1-1k to 20k+) and customer lifecycle categories from the previous month. It tracks what percentage of users who were active in the last month continue to transact in the current month-to-date period. The analysis focuses on UPI transactions (PAY/COLLECT) with SUCCESS/DEEMED status through major PSP handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) across VPA2MERCHANT, VPA2VPA, and VPA2ACCOUNT categories. Base users represent the cohort from last month, while retained users are those who remain active in the current MTD period. The metric provides both lifecycle-specific retention rates and an overall retention summary, enabling analysis of user engagement patterns across different value segments and user maturity stages.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for different values
--- restrict to successful UPI transactions only
txn.transaction_type IN ('PAY','COLLECT') AND
--- include only completed transactions
txn.status IN ('SUCCESS','DEEMED') AND
--- focus on major PSP ecosystem partners
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover primary UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- temporal filtering for retention analysis
--- last month period: date_trunc('month', current_date - interval '1 day') - interval '1' month to date_trunc('month', current_date - interval '1 day') - interval '1' day
--- current MTD period: date_trunc('month', current_date - interval '1 day') to current_date - interval '1 day
txn.dl_last_updated BETWEEN [period_start] AND [period_end] AND
txn.transaction_date_key BETWEEN [period_start] AND [period_end] AND
--- lifecycle snapshot filtering for customer segmentation
lifecycle.ft_date BETWEEN date_trunc('month', current_date - interval '1 day' - interval '1 month') AND date_trunc('month', current_date) - interval '1 day'

--- calculation_logic
-- Base users: COUNT(DISTINCT customer_id_payer) from last month with TPU and GMV calculations
-- Retained users: COUNT(DISTINCT customer_id_payer) who appear in both last month and current MTD
-- Retention rate: SUM(Retained_users*1.0000)/SUM(Base_users)
-- GMV bucketing: CASE statement for ranges (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+)
-- TPU bucketing: CASE statement for transaction frequency (1, 2, 3, 4-10, 11-20, 20+)




## UPI Retention GPU wise LMTD

This metric measures UPI user retention rates segmented by GMV buckets for Last Month-To-Date analysis, tracking how many users from the previous full month continue transacting in the current month up to the same day. It analyzes customer stickiness across different spending tiers (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+) and lifecycle stages including fresh users. The retention calculation compares previous month's complete user base against current month-to-date active users, providing insights into customer engagement patterns across value segments. This helps identify which GMV segments show stronger retention behavior and supports targeted retention strategies for different customer value tiers within the UPI ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 a
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle_table
hive.default.virtual_table virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- upi transaction type filtering for payment flows
a.transaction_type IN ('PAY','COLLECT') AND
--- successful transaction status filtering
a.status IN ('SUCCESS','DEEMED') AND
--- paytm ecosystem psp filtering
a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- upi transaction category filtering
a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month-to-date date range for current period cohort
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' day AND
--- same day comparison constraint
day(transaction_date_key) < day(current_date) AND
--- previous full month date range for base cohort
a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                       AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day AND
a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                           AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day

--- calculation_logic
pattern: mtd_retention_cohort_analysis
base_metric: count(distinct customer_id_payer)
retention_logic: left_join_cohort_matching
gmv_segmentation: case_when_tiered_buckets
lifecycle_integration: left_join_lifecycle_snapshot




## UPI Retention GPU wise LMTD

This metric measures UPI user retention rates by analyzing what percentage of last month's active users remained active in the current month-to-date period, segmented by customer lifecycle stage (returning vs fresh users), transaction frequency buckets (TPU: 1, 2, 3, 4-10, 11-20, 20+), and GMV value bands (1-1k, 1k-3k, 3k-5k, 5k-10k, 10k-20k, 20k+). The analysis helps understand user engagement patterns and retention behavior across different customer segments and spending levels. It focuses on successful UPI transactions (PAY/COLLECT) with SUCCESS/DEEMED status across major PSP handles, providing insights into customer stickiness and engagement depth for product and retention strategy optimization.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn
hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 lifecycle

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to successful UPI payment transactions
txn.transaction_type IN ('PAY','COLLECT') AND
--- include only completed transactions
txn.status IN ('SUCCESS','DEEMED') AND
--- focus on major PSP ecosystem
txn.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- cover primary UPI transaction categories
txn.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')

--- specific filters
--- last month complete period for base user calculation
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '2' month
                              AND date_trunc('month', current_date - interval '1' day) - interval '1' month - interval '1' day AND
--- current month-to-date for retention calculation (excluding current day)
txn.transaction_date_key BETWEEN date_trunc('month', current_date - interval '1' day) - interval '1' month
                              AND date_trunc('month', current_date - interval '1' day) - interval '1' day AND
day(txn.transaction_date_key) < day(current_date)

--- calculation_logic
Base_users: COUNT(DISTINCT last_month_users.customer_id_payer),
Retained_users: COUNT(DISTINCT CASE WHEN current_mtd_users.customer_id_payer IS NOT NULL THEN last_month_users.customer_id_payer END),
Retention_rate: SUM(Retained_users*1.0000)/SUM(Base_users),
TPU_buckets: CASE WHEN tpu=1 THEN 'a.1' WHEN tpu=2 THEN 'b.2' WHEN tpu=3 THEN 'c.3' WHEN tpu BETWEEN 4 AND 10 THEN 'd.4-10' WHEN tpu BETWEEN 11 AND 20 THEN 'e.11-20' WHEN tpu>20 THEN 'f.20+' END,
GMV_buckets: CASE WHEN gmv BETWEEN 1 AND 999 THEN 'A: 11k' WHEN gmv BETWEEN 1000 AND 2999 THEN 'B: 1k3k' WHEN gmv BETWEEN 3000 AND 4999 THEN 'C: 3k5k' WHEN gmv BETWEEN 5000 AND 9999 THEN 'D: 5k10k' WHEN gmv BETWEEN 10000 AND 19999 THEN 'E: 10k20k' WHEN gmv>=20000 THEN 'F: 20k+' END






================================================================================
## Dashboard 511
================================================================================

## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Category SR_511

This metric tracks the Success Rate (SR) for UPI transactions in Online, Onus, and Scan & Pay (SnP) flow categories, segmented by day of the month within the Paytm ecosystem. Success Rate is calculated as the percentage of transactions with DEEMED or SUCCESS status out of total transactions. The analysis focuses on transactions where the payer belongs to Paytm's partner PSPs (paytm, ptyes, ptaxis, pthdfc, ptsbi) and excludes P2P transactions to concentrate on merchant and online payment scenarios. Data is filtered to the current month starting from the first day, providing daily trend analysis for non-P2P transaction success rates across different payment flow categories within the Paytm ecosystem.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different flow categories
--- restrict to current month data for trend analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- include recent transaction data for up-to-date analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month) AND
--- focus on payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- exclude P2P transactions to focus on merchant payments
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- limit to Paytm ecosystem payers
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- focus on non-P2P flow categories for merchant payment analysis
txn.final_category IN ('Online', 'Onus', 'SnP')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Handle SR_511

This metric tracks the Success Rate (SR) for UPI transactions segmented by payer PSP handles including ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), and ptsbi (SBI). The success rate is calculated as the ratio of successful transactions (those with DEEMED or SUCCESS status) to total transactions, providing insight into payment service provider performance. The metric filters for current month data and focuses on P2P, P2M transaction categories (VPA2ACCOUNT, VPA2VPA, VPA2MERCHANT) with PAY and COLLECT transaction types. This enables monitoring of partner PSP reliability and identifying performance variations across different banking partners for operational and business relationship management.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- limit to payment transactions only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- focus on core UPI transaction flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT')

--- specific filters
--- current month data for timely performance monitoring
txn.day_id >= date_trunc('month', current_date - interval '1' day) AND
--- segment by payer PSP for partner performance analysis
--- parameter values: ptyes (Yes Bank), ptaxis (Axis Bank), pthdfc (HDFC Bank), ptsbi (SBI)
txn.payer_handle IN ({payer_psp}: ptyes, ptaxis, pthdfc, ptsbi)

--- calculation_logic
(count(txn.txn_id) FILTER(WHERE txn.status IN ('DEEMED', 'SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## Flowwise SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that achieve 'SUCCESS' or 'DEEMED' status out of total transaction attempts. It segments performance by flow category (P2P, 3P QR, Paytm QR, Intent, P2M Collect, Mandate types) and day of month to identify patterns in transaction success across different payment methods and time periods. The analysis focuses specifically on transactions where Paytm acts as the payer PSP, excluding refund transactions (purpose code 14), and provides daily granular insights into operational performance for the current month to support real-time monitoring and troubleshooting efforts.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for different categorical values
--- restrict to current month transactions for real-time monitoring
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on Paytm ecosystem as payer PSP
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- exclude refund transactions
txn.purpose_code != '14' AND
--- include only relevant transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- focus on core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- ensure data freshness for current analysis
txn.dl_last_updated >= date_trunc('month', current_date - interval '01' day - interval '01' month)

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0000) / (count(txn_id)*1.0000) as success_rate,
grouped by Day(day_id) and flow_category




## P2P P2M SR_511

This metric tracks the success rate of UPI transactions within the Paytm ecosystem, segmented by P2P (person-to-person) and P2M (person-to-merchant) transaction types. It calculates the percentage of transactions with successful outcomes (DEEMED or SUCCESS status) against total transaction attempts. The analysis focuses on current month performance, excluding bill payment transactions, and is filtered to Paytm ecosystem PSPs including paytm, ptyes, ptaxis, pthdfc, and ptsbi. The metric provides daily granular insights into transaction reliability across different payment flows, enabling performance monitoring and trend analysis for both peer-to-peer transfers and merchant payments within the Paytm network infrastructure.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude bill payment transactions from success rate calculation
txn.purpose_code != '14' AND
--- limit to current month transactions for performance analysis
txn.day_id >= date_trunc('month', current_date - interval '01' day) AND
--- focus on paytm ecosystem transactions only
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- include only relevant transaction types for P2P/P2M analysis
txn.transaction_type IN ('PAY','COLLECT') AND
--- filter to core UPI transaction categories
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS'))*1.0) / (count(txn_id)*1.0) as success_rate,
CASE 
    WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P'
    WHEN category IN ('VPA2MERCHANT') THEN 'P2M'
    ELSE NULL 
END as transaction_flow




## Overall SR_511

Overall Success Rate (SR) measures the percentage of UPI transactions that complete successfully (including both SUCCESS and DEEMED status) out of total transaction attempts. This metric provides critical insight into payment system reliability and user experience quality for the Paytm ecosystem. The calculation filters out purpose code '14' transactions and focuses on current month data to track real-time performance. It specifically analyzes transactions where Paytm ecosystem handles (paytm, ptyes, ptaxis, pthdfc, ptsbi) are the payer, covering PAY and COLLECT transaction types across VPA2ACCOUNT, VPA2VPA, and VPA2MERCHANT categories. The metric is segmented by day and month to enable temporal performance analysis and identify daily success rate trends within monthly periods.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- focus on primary UPI transaction types
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- include all VPA-based transaction categories
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- restrict to Paytm ecosystem as payer
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- exclude refund/reversal transactions (purpose_code 14)
txn.purpose_code != '14' AND
--- current month data only for real-time monitoring
txn.transaction_date_key >= date_trunc('month', current_date - interval '1' day)

--- calculation_logic
(count(txn.txn_id) filter(where txn.status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn.txn_id) * 1.0000) AS success_rate




## Overall SR_511

Overall SR tracks the success rate of UPI transactions within the Paytm ecosystem, measuring the percentage of transactions that complete successfully (including both SUCCESS and DEEMED status) out of total transaction attempts. This metric provides daily granular visibility into transaction performance across the current month, helping monitor operational excellence and identify potential issues in payment processing. The analysis focuses on core UPI payment flows (P2P via VPA2ACCOUNT/VPA2VPA and P2M via VPA2MERCHANT) while excluding cash withdrawal transactions and limiting scope to transactions where Paytm ecosystem handles act as payers, providing insights into Paytm's transaction success performance.

-- tables_involved
hive.cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit to core UPI payment transaction types
txn.transaction_type IN ('PAY','COLLECT') AND
--- exclude cash withdrawal transactions
txn.purpose_code != '14' AND
--- focus on VPA-based transactions (P2P and P2M flows)
txn.category IN ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT') AND
--- restrict to Paytm ecosystem as payer
lower(txn.payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi') AND
--- ensure data freshness for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month)

--- specific filters
--- analyze current month performance from previous day onwards
txn.day_id >= date_trunc('month', current_date - interval '1' day)

--- calculation_logic
count(txn_id) FILTER(WHERE status IN ('DEEMED','SUCCESS')) * 1.0000 / count(txn_id) * 1.0000 AS success_rate,
grouped by DAY(day_id), date_trunc('month', day_id)




## P2P P2M SR_511

This metric tracks the success rate (SR) of UPI transactions for Paytm ecosystem PSPs, measuring the percentage of transactions that achieve DEEMED or SUCCESS status out of total attempted transactions. The analysis is segmented between P2P (person-to-person via VPA2ACCOUNT, VPA2VPA) and P2M (person-to-merchant via VPA2MERCHANT) transaction flows. The metric filters for current month data, excludes purpose code 14 transactions, and focuses specifically on Paytm ecosystem payer handles (paytm, ptyes, ptaxis, pthdfc, ptsbi). This provides insights into transaction processing reliability and user experience quality across different payment flows within the Paytm PSP network, enabling performance monitoring and operational optimization.

-- tables_involved
cdo.fact_upi_transactions_snapshot_v3 txn

--- standard filters to be applied unless specifically requested for a different categorical value
--- data freshness filter for current analysis period
txn.dl_last_updated >= date_trunc('month', current_date - interval '1' day - interval '1' month) AND
--- transaction scope filter for payment flows only
txn.transaction_type IN ('PAY', 'COLLECT') AND
--- category filter for P2P and P2M flows
txn.category IN ('VPA2ACCOUNT', 'VPA2VPA', 'VPA2MERCHANT') AND
--- payer ecosystem filter for Paytm PSPs
lower(txn.payer_handle) IN ('paytm', 'ptyes', 'ptaxis', 'pthdfc', 'ptsbi')

--- specific filters
--- current month data filter for month-to-date analysis
txn.transaction_date_key >= date_trunc('month', current_date - interval '1' day) AND
--- exclude purpose code 14 transactions (likely specific merchant category exclusion)
txn.purpose_code != '14'

--- calculation_logic
(count(txn_id) filter(where status in('DEEMED','SUCCESS')) * 1.0000) / (count(txn_id) * 1.0000) as SR,
CASE WHEN category IN ('VPA2ACCOUNT','VPA2VPA') THEN 'P2P'
     WHEN category IN ('VPA2MERCHANT') THEN 'P2M'
     ELSE NULL END AS P2P_P2M







================================================================================
## Dashboard 55
================================================================================

## Bot Tickets Counts (Includes Dropoff)

This metric tracks the total volume of bot-generated support tickets across different lines of business (LOB), including tickets where customers may have dropped off during the bot interaction. It serves as a key operational indicator for customer service teams to understand bot engagement patterns and support volume distribution across business segments. The count includes all bot tickets regardless of resolution status, providing visibility into the overall demand on automated support systems. This metric helps identify which LOBs generate the most bot interactions and can inform resource allocation and bot optimization strategies.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all time periods and LOBs

--- specific filters
--- temporal filter set to include all dates
--- no additional filters specified

--- calculation_logic
sum(virtual_table.bot_ticket_count) as total_bot_tickets
group by virtual_table.lob




## Bot Tickets Counts (Includes Dropoff)

This metric tracks the total volume of bot-generated support tickets across different lines of business (LOB), including tickets where customers may have dropped off during the bot interaction. It serves as a key operational indicator for customer service teams to understand bot engagement patterns and support volume distribution across business segments. The count includes all bot tickets regardless of resolution status, providing visibility into the overall demand on automated support systems. This metric helps identify which LOBs generate the most bot interactions and can inform resource allocation and bot optimization strategies.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all time periods and LOBs

--- specific filters
--- temporal filter set to include all dates
--- no additional filters specified

--- calculation_logic
sum(virtual_table.bot_ticket_count) as total_bot_tickets
group by virtual_table.lob




## QS_SB Pendency_final_substage_eventtime

This metric tracks the distribution and volume of QR code service requests (SB cases) across different pendency time buckets, processing stages, and substages within the Care Dashboard system. It measures how cases are aging by counting total case IDs grouped by days_bucket (likely representing how long cases have been pending), final_stage (current processing stage), and substage (detailed sub-process within each stage). This analysis helps identify bottlenecks in case resolution workflows, monitor service level agreements, and optimize resource allocation across different processing stages. The metric provides operational insights for care team management to understand where cases are accumulating and which stages require attention to improve overall case resolution efficiency.

-- tables_involved
team_servicesone.QR_SB_Daily_Pendency_Superset qsdp

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter currently set to no filter, showing all available case data
qsdp.case_date IS NOT NULL

--- specific filters
--- no additional specific filters applied in this chart

--- calculation_logic
count(qsdp.id) as case_count
group by qsdp.days_bucket, qsdp.final_stage, qsdp.substage
order by case_count desc




## QS_SB Pendency_final_substage_eventtime

This metric tracks the distribution of QR code and soundbox support cases by counting total cases across pendency age buckets, final processing stages, and sub-stages. It serves as a comprehensive view for customer care teams to understand case volume patterns and identify bottlenecks in the support workflow. The analysis groups cases by days_bucket (showing how long cases have been pending), final_stage (current processing stage), and substage (detailed sub-categories within each stage). With no temporal filters applied, it provides a complete snapshot of all cases in the system, helping prioritize resource allocation and process improvements. The data comes from a dedicated pendency tracking table that consolidates QR and soundbox case information for operational dashboards.

-- tables_involved
team_servicesone.QR_SB_Daily_Pendency_Superset virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter available but currently set to no filter (all dates included)
virtual_table.case_date IS NOT NULL

--- specific filters
--- none applied - showing all case statuses and stages

--- calculation_logic
count(virtual_table.id) as case_count
group by virtual_table.days_bucket, virtual_table.final_stage, virtual_table.substage




## QS_SB Pendency_final_stage_eventtime

This metric tracks the count of Quick Settlement Soundbox (QS_SB) merchant support cases categorized by their final processing stage at event time. It measures merchant support case pendency across various workflow stages including callback attempts, service team assignments, courier logistics, KYC/MCC updates, and merchant dependencies. The classification system transforms raw status codes into business-meaningful categories like "Call Back Cases", "Pending with Service", "KYC Update", "Merchant Dependency", and "Pending with Courier" to enable operational monitoring of case resolution workflows. The temporal filter on case_date allows analysis across different time periods to track support case volume and stage distribution trends.

-- tables_involved
{schema.table_name} cases

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter on case creation date - currently set to show all periods
cases.case_date TEMPORAL_RANGE 'No filter'

--- calculation_logic
count(cases.id) as case_count,
CASE cases.status
  WHEN '129' THEN 'Pending for Callback'
  WHEN '130' THEN 'CallAttempted' 
  WHEN '145' THEN 'OTHER ISSUES'
  WHEN '152' THEN 'Parked to Merchant Loan IO team'
  ELSE cases.status
END AS status_mapped,
CASE
  WHEN cases.assign__c IN ('Merchant Setup', 'Gold Investment Plan', 'MHD-Riskops-QR', 'MHD Offline Chargeback cases') 
    THEN 'Merchant Setup/Risk_ops/Chargeback/Gold Investment'
  WHEN cases.status = 'Details pending from Merchant' THEN 'Merchant Dependency'
  WHEN cases.status IN ('Pending with Other Department', 'Responded from Department') 
    THEN 'Pending with other Department'
  WHEN cases.status = 'Re-Open' THEN 'Re-Open'
  WHEN cases.status = 'Merchant Response Received' THEN 'Merchant Response Received'
  WHEN cases.status = 'Pending for Resolution' AND cases.issue_L1 IN ('Payout & Settlement', 'Merchant Profile') AND cases.assign__c = 'Confirmation Pending'
    THEN 'DIY'
  WHEN cases.status = 'Pending for Resolution' AND cases.issue_L1 = 'Business Loan' AND cases.assign__c = 'Confirmation Pending'
    THEN 'Pending for Loan Disbursement'
  [Additional complex CASE logic for workflow stage categorization]
END AS final_stage_category




## Bot Tickets Count (Active Sessions)

This metric tracks the total count of active tickets being handled by bots across different lines of business (LOB). It provides visibility into bot workload distribution and operational capacity utilization within the customer care system. The metric aggregates all active bot sessions by summing bot_active_ticket_count values and segments results by LOB to enable comparison of bot utilization across business units. This helps identify which business lines have higher bot engagement and supports resource allocation decisions for automated customer service operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - showing all LOB segments

--- specific filters  
--- no specific filters applied - complete view across all business lines

--- calculation_logic
sum(bot_active_ticket_count) as total_bot_tickets,
group by lob




## Bot Tickets Count (Active Sessions)

This metric tracks the total count of active bot tickets across different lines of business within the Care Dashboard for MHD operations. It measures the current workload of automated customer service bots by summing active ticket counts, providing visibility into bot utilization and capacity across various business segments. The metric helps operations teams monitor real-time bot performance, identify peak usage periods, and ensure adequate automated support coverage. By segmenting data by LOB, it enables comparison of bot effectiveness and ticket volume distribution across different business areas, supporting resource allocation and operational decision-making for customer care automation.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all active bot tickets across all LOBs

--- specific filters
--- no specific filters applied - aggregates all records

--- calculation_logic
sum(bot_active_ticket_count) as total_active_bot_tickets,
grouped by lob (line of business)




## Bot MSAT (%)

Bot MSAT (%) measures the mean satisfaction rate of bot interactions by calculating the percentage of positive bot responses out of total bot responses across different lines of business. This metric helps evaluate chatbot effectiveness and customer satisfaction with automated support interactions. The calculation uses NULLIF to prevent division by zero errors when there are no bot responses recorded. Results are segmented by line of business (lob) to enable performance comparison across different business units and identify areas where bot performance may need improvement.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all bot interactions

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs

--- calculation_logic
100 * SUM(bot_positive_response) / NULLIF(SUM(bot_total_responses), 0) as bot_msat_percentage




## Bot MSAT (%)

Bot MSAT percentage measures chatbot satisfaction rates by calculating the proportion of positive responses to total bot interactions, expressed as a percentage. This metric serves as a key performance indicator for automated customer service effectiveness across different Lines of Business (LOB). The calculation uses nullif to handle cases where total responses might be zero, ensuring robust percentage calculations. The metric is segmented by LOB to enable comparison of chatbot performance across different business units, helping identify which areas have more effective automated customer interactions and where improvements may be needed.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied

--- specific filters
--- no specific filters applied

--- calculation_logic
100 * SUM(bot_positive_response) / NULLIF(SUM(bot_total_responses), 0) AS bot_msat_percentage,
lob AS line_of_business




## Bot Passthrough (%)

Bot Passthrough (%) measures the escalation rate from automated bot interactions to human agents across different lines of business (LOB). This metric calculates what percentage of bot-active tickets required agent intervention, serving as an inverse indicator of bot effectiveness - lower percentages indicate better bot performance. The calculation takes the sum of tickets that bots escalated to agents divided by the total number of bot-active tickets, multiplied by 100 for percentage format. No specific filters are applied, providing a comprehensive view across all LOBs. This metric helps customer service teams evaluate chatbot performance, identify areas where bot training may be needed, and optimize the balance between automated and human support to improve operational efficiency and customer satisfaction.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - showing all data

--- specific filters
--- no specific filters applied

--- calculation_logic
100 * SUM(agent_ticket_count_bot) / NULLIF(SUM(bot_active_ticket_count), 0) as bot_passthrough_percentage
GROUP BY lob




## QS_SB Pendency_final_stage_eventtime

This metric tracks the count of merchant help desk cases that are pending at their final resolution stage, categorized by service type and current status. It measures operational efficiency by showing how many cases are stuck in different buckets like callback attempts, service team assignments, courier operations, KYC/MCC updates, and merchant dependencies. The complex categorization logic groups similar statuses into business-meaningful segments to help identify bottlenecks in the merchant support workflow. Cases are filtered by case date to show pendency within a specific time period, enabling teams to monitor resolution progress and allocate resources effectively across different service categories.

-- tables_involved
{unknown_table} cases

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for case analysis period
cases.case_date TEMPORAL_RANGE 'No filter'

--- calculation_logic
count(cases.id) as case_count,
CASE status
  WHEN '129' THEN 'Pending for Callback'
  WHEN '130' THEN 'CallAttempted'
  WHEN '145' THEN 'OTHER ISSUES'
  WHEN '152' THEN 'Parked to Merchant Loan IO team'
  ELSE status
END AS normalized_status,
CASE
  WHEN assign__c IN ('Merchant Setup', 'Gold Investment Plan', 'MHD-Riskops-QR', 'MHD Offline Chargeback cases') 
    THEN 'Merchant Setup/Risk_ops/Chargeback/Gold Investment'
  WHEN status = 'Details pending from Merchant' THEN 'Merchant Dependency'
  WHEN status IN ('Pending with Other Department', 'Responded from Department') 
    THEN 'Pending with other Department'
  WHEN status = 'Re-Open' THEN 'Re-Open'
  WHEN status = 'Merchant Response Received' THEN 'Merchant Response Received'
  WHEN status = 'Pending for Resolution' AND issue_L1 IN ('Payout & Settlement', 'Merchant Profile') AND assign__c = 'Confirmation Pending'
    THEN 'DIY'
  WHEN status = 'Pending for Resolution' AND issue_L1 = 'Business Loan' AND assign__c = 'Confirmation Pending'
    THEN 'Pending for Loan Disbursement'
  WHEN assign__c = 'P2P - Assigned to Retention' AND fsm_status__c IS NULL
    THEN 'Assign to retention'
  WHEN status IN ('Callback 1st Attempt Done', 'Callback 2nd Attempt Done', 'Callback 3rd Attempt Done', 'CallAttempted', 'Pending for Callback', 'Merchant Uncontactable', 'Language Barrier', 'Callback Required', 'Callback needed post getting exact solution', 'Bank Account Change - Details Pending')
    THEN CASE WHEN fsm_status__c IS NULL OR fsm_status__c IN ('Resolved by Service Agent', 'Assigned to Service Agent', 'OTHER ISSUES', 'Pending with Service Team', 'Pending with Courier Team') THEN 'Call Back Cases' WHEN fsm_status__c = 'Merchant Uncontactable' THEN 'NSTP Calling' ELSE 'Call Back Cases' END
  WHEN status = 'Pending With Agent' AND issue_L3 = 'Paytm handle disabled_FSE visit required'
    THEN 'KYC Update'
  WHEN service_request_type__c = 'KYC Update' AND status IN ('Pending with Service Team', 'Assigned to Service Agent', '145', 'Pending for Self-ship', 'Pending with Courier Team')
    THEN 'KYC Update'
  WHEN service_request_type__c = 'MCC Update' AND status IN ('Pending with Service Team', 'Assigned to Service Agent', '145', 'Pending for Self-ship', 'Pending with Courier Team')
    THEN 'MCC Update'
  WHEN status IN ('Assigned to Service Agent', '145', 'Pending with Service Team') AND fsm_status__c IN ('OTHER ISSUES', 'Assigned to Service Agent', 'Merchant Uncontactable', 'Pending with Service Team', 'Resolved by Service Agent', 'Pending for Self-ship', 'Pending with Courier Team')
    THEN 'Pending with Service'
  WHEN status IN ('Pickup Done by Courier', 'Reverse Pickup Under Process', 'New Soundbox mapped & shipped', 'Pending with Courier Team') AND fsm_status__c IN ('Pending with Courier Team', 'Pending for Self-ship', 'Resolved by Service Agent', 'Merchant Uncontactable', 'Pending with Service Team', 'Assigned to Service Agent')
    THEN 'Pending with Courier'
END AS business_category




## Bot Passthrough (%)

Bot Passthrough percentage measures the efficiency of automated customer service by calculating what percentage of bot-active tickets ultimately required human agent intervention. This metric helps evaluate bot performance and identify areas where automation can be improved. The calculation divides agent-handled bot tickets by total bot-active tickets, multiplied by 100 for percentage format. Results are segmented by line of business (LOB) to enable performance comparison across different service categories. Lower percentages indicate better bot performance as fewer tickets required escalation to human agents.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied

--- specific filters
--- no specific filters applied

--- calculation_logic
100*SUM(agent_ticket_count_bot)/NULLIF(SUM(bot_active_ticket_count),0) as bot_passthrough_pct,
GROUP BY lob




## IVR Calls Count

This metric tracks the total volume of IVR (Interactive Voice Response) calls segmented by line of business (lob) to understand call distribution across different business units in the care operations. It provides visibility into which business lines generate the most IVR activity, helping with resource allocation and capacity planning for automated call handling systems. The metric represents raw call volume without any time-based or categorical filters, giving a comprehensive view of IVR usage patterns across the organization's various service lines for operational planning and performance monitoring purposes.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied

--- specific filters  
--- no specific filters applied

--- calculation_logic
sum(ivr_calls) as total_ivr_calls
group by lob




## Ticket Count (MHD+Service)

This metric tracks the total volume of support tickets across different Lines of Business, combining both MHD and Service ticket categories. It provides a high-level view of ticket distribution across business units to help identify which LOBs generate the most support requests. The aggregation sums pre-calculated ticket counts from a combined dataset, enabling stakeholders to understand support workload allocation and resource planning needs across different business segments. This is an unfiltered view showing all LOBs and their respective ticket volumes.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOBs and ticket types

--- specific filters
--- no specific filters applied - comprehensive view across all categories

--- calculation_logic
sum(virtual_table.total_ticket_count) as ticket_count
group by virtual_table.lob




## Ticket Count (MHD+Service)

This metric tracks the total volume of customer service tickets across different lines of business, combining both MHD and general service ticket categories. It provides a high-level summary of ticket volumes by aggregating pre-calculated ticket counts from the combined data source. The metric serves as a primary KPI for understanding overall customer service workload distribution across business segments, helping teams identify which lines of business generate the most support requests. No filters are applied, giving a complete view of all ticket activity in the system for operational planning and resource allocation decisions.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd cd

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all ticket data

--- specific filters
--- no specific filters applied - aggregates all available data

--- calculation_logic
sum(cd.total_ticket_count) grouped by cd.lob




## IVR Calls Count

This metric tracks the total count of Interactive Voice Response (IVR) calls segmented by line of business (lob) within the Care Dashboard for operational monitoring. It measures customer service call volume through automated phone systems, providing insights into service demand distribution across different business units. The metric aggregates all IVR call interactions without any temporal or categorical filters, representing comprehensive call volume data. This information supports resource allocation decisions, capacity planning, and understanding customer engagement patterns across various business lines in the organization's customer care operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all IVR calls across all time periods and categories

--- specific filters
--- no specific filters applied - comprehensive view of all IVR calls

--- calculation_logic
sum(virtual_table.ivr_calls) as total_ivr_calls,
grouped by virtual_table.lob




## Ticket Count (MHD Agent)

This metric tracks the total number of support tickets handled by agents within the MHD (customer service) system, segmented by line of business (LOB). It measures operational workload and support volume across different business units, helping managers understand ticket distribution and resource allocation needs. The metric aggregates all agent-handled tickets without date or status filters, providing a comprehensive view of support activity. This is typically used for capacity planning, performance monitoring, and identifying which business lines generate the most support requests requiring agent intervention.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all ticket data across all time periods and statuses

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs

--- calculation_logic
sum(agent_ticket_count) as total_tickets,
grouped by lob (line of business)




## Ticket Count (MHD Agent)

This metric tracks the total number of tickets handled by MHD (Medical Help Desk) agents, segmented by Line of Business (LOB). It serves as a key operational indicator for care teams to monitor ticket volume distribution across different business units and assess agent workload allocation. The metric aggregates agent ticket counts without any date or status filters, providing a comprehensive view of overall ticket handling activity. This helps management understand which LOBs generate the most support requests and enables resource planning and performance evaluation across different business segments within the care operations framework.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd AS virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - showing all ticket data across all LOBs

--- specific filters
--- no specific filters applied - comprehensive view across all business lines

--- calculation_logic
sum(agent_ticket_count) AS ticket_count,
lob AS line_of_business




## Ticket Count (Service)

This metric tracks the total volume of service tickets across different lines of business (lob) within the Care Dashboard for MHD operations. It provides a high-level overview of service request distribution by aggregating all service ticket counts from the combined data source. The metric helps identify which lines of business generate the most service volume, enabling resource allocation and capacity planning decisions. With no filters applied, it represents the complete picture of service ticket activity across all business segments, making it useful for executive reporting and operational oversight of customer service operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all service tickets across all lines of business

--- specific filters
--- no specific filters applied - comprehensive view of all service ticket activity

--- calculation_logic
sum(service_ticket_count) as total_tickets
group by lob




## MSAT(%) Agent

Agent MSAT (Mean Satisfaction) Percentage measures customer satisfaction with agent performance across different Lines of Business. This metric calculates the percentage of agent tickets that received satisfactory ratings by dividing the count of satisfied agent tickets by the total feedback received, multiplied by 100. The analysis excludes Retail Mid-Market, Enterprise, and Government LOBs to focus on core business segments. The metric helps evaluate agent performance quality and customer service effectiveness across business lines, providing insights into service delivery standards and areas requiring improvement.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd cd

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude enterprise and government segments to focus on core business lines
cd.lob NOT IN ('06. RETAIL MID-MARKET', '07. ENTERPRISE', '08. GOVERNMENT')

--- calculation_logic
100 * SUM(cd.agent_tickets_msat_received) / NULLIF(SUM(cd.agent_tickets_feedback_received), 0) as msat_percentage




## Ticket Count (Service)

This metric tracks the total volume of service tickets aggregated by line of business (LOB) within the MHD care operations. It provides visibility into service demand distribution across different business segments, enabling care teams to understand workload allocation, identify high-volume LOBs requiring additional support resources, and monitor service ticket patterns for operational planning. The metric sums all service tickets without any temporal or categorical filters, giving a comprehensive view of total service volume by business line. This helps care managers assess service load distribution and make informed decisions about resource allocation and capacity planning across different lines of business.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all service tickets

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs

--- calculation_logic
sum(service_ticket_count) as total_service_tickets,
grouped by lob (line of business)




## MSAT(%) Agent

This metric tracks agent satisfaction percentage (MSAT) across different lines of business, measuring the ratio of satisfied agent interactions to total feedback received. It serves as a quality indicator for customer service performance, calculating what percentage of agent-handled tickets resulted in positive satisfaction feedback. The metric excludes retail mid-market, enterprise, and government LOBs to focus on core business segments. This helps management assess agent effectiveness and customer satisfaction levels across various business lines, enabling targeted improvements in service quality and agent training programs.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude specific enterprise and government segments to focus on core business lines
virtual_table.lob NOT IN ('06. RETAIL MID-MARKET', '07. ENTERPRISE', '08. GOVERNMENT')

--- calculation_logic
100 * SUM(agent_tickets_msat_received) / NULLIF(SUM(agent_tickets_feedback_received), 0) AS msat_percentage




## MSAT (%) (MHD+Service)

MSAT (Merchant Satisfaction) percentage measures customer satisfaction for MHD (Merchant Help Desk) and Service operations by calculating the ratio of tickets receiving positive satisfaction responses to total tickets receiving any feedback response. This metric is segmented by Line of Business to analyze satisfaction performance across different business segments. The calculation excludes retail mid-market, enterprise, and government LOBs to focus on core merchant segments. The percentage helps identify which business lines deliver superior customer service experiences and where satisfaction improvement initiatives should be prioritized for maximum impact on merchant retention and relationship quality.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd AS virtual_table

--- standard filters to exclude non-core merchant segments
--- exclude enterprise and government segments to focus on core merchant business
virtual_table.lob NOT IN ('06. RETAIL MID-MARKET', '07. ENTERPRISE', '08. GOVERNMENT')

--- calculation_logic
100 * SUM(total_tickets_msat_received) / NULLIF(SUM(total_tickets_feedback_received), 0) AS msat_percentage,
GROUP BY lob




## MSAT (%) (MHD+Service)

This metric tracks the Monthly Service Assurance Team (MSAT) satisfaction percentage for customer service operations, measuring the ratio of tickets that received positive MSAT feedback to total tickets that received any feedback. It provides insights into service quality performance across different lines of business. The metric excludes Retail Mid-Market, Enterprise, and Government segments to focus on core business areas. The percentage calculation helps identify service quality trends and areas needing improvement in the customer care function, enabling management to assess service delivery effectiveness and make data-driven decisions for service optimization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude high-tier business segments to focus on core service areas
virtual_table.lob NOT IN ('06. RETAIL MID-MARKET', '07. ENTERPRISE', '08. GOVERNMENT')

--- calculation_logic
100 * SUM(total_tickets_msat_received) / NULLIF(SUM(total_tickets_feedback_received), 0) as msat_percentage




## MSAT(%) Service

This metric tracks the MSAT (Merchant/Customer Satisfaction) percentage for service tickets across different lines of business within the Care Dashboard. It measures service quality by calculating the percentage of service tickets that received satisfactory feedback, computed as the ratio of MSAT-received tickets to total feedback-received tickets multiplied by 100. The analysis excludes Enterprise, Retail Mid-Market, and Government business segments, focusing on other LOB categories to provide targeted insights into customer satisfaction performance across core business lines for service optimization and quality monitoring.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude enterprise and mid-market segments to focus on core business lines
virtual_table.lob NOT IN ('07. ENTERPRISE', '06. RETAIL MID-MARKET', '08. GOVERNMENT')

--- calculation_logic
100 * SUM(service_tickets_msat_received) / NULLIF(SUM(service_tickets_feedback_received), 0) AS msat_percentage




## MSAT(%) Service

This metric tracks Monthly Satisfaction (MSAT) percentage for service tickets across different lines of business, measuring service quality and customer satisfaction rates. It calculates the percentage of service tickets that received MSAT satisfaction feedback out of the total tickets that received any feedback response. The metric excludes Enterprise, Retail Mid-Market, and Government LOBs to focus on core business segments. This helps service teams monitor satisfaction trends, identify underperforming business lines, and track service quality improvements across different customer segments in the care dashboard.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude specific business segments from analysis
virtual_table.lob NOT IN ('07. ENTERPRISE', '06. RETAIL MID-MARKET', '08. GOVERNMENT')

--- calculation_logic
100 * SUM(service_tickets_msat_received) / NULLIF(SUM(service_tickets_feedback_received), 0) as msat_percentage




## Avg TAT (Days) Human Agent

This metric measures the average turnaround time in days for human agent support ticket resolution, segmented by line of business. It calculates the mean time between ticket creation and resolution by dividing total TAT days by the number of tickets that have TAT denominators. The metric helps evaluate customer service performance and identify which business lines may need process improvements or additional resources. This operational KPI is essential for service level agreement monitoring and customer satisfaction management across different product or service categories within the organization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOBs and time periods

--- specific filters
--- no specific filters applied

--- calculation_logic
sum(sum_tat_days) / nullif(sum(tat_denominatior_tickets), 0) as avg_tat_days
GROUP BY lob




## Avg TAT (Days) Human Agent

This metric measures the average turnaround time in days for human agents to resolve customer service tickets, segmented by line of business. It calculates a weighted average by dividing the total TAT days by the number of tickets with valid TAT measurements, using nullif to prevent division by zero errors. The metric provides insights into agent efficiency and service quality across different business lines, helping identify performance variations and areas needing improvement. No filters are applied, giving a comprehensive view of all LOBs in the care dashboard system.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all data

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs

--- calculation_logic
sum(sum_tat_days) / nullif(sum(tat_denominatior_tickets), 0) as avg_tat_days,
group by lob




## Unique Merchant Count - Bot

This metric tracks unique merchant counts for bot interactions within the care support system, measuring both total bot engagements and active session completions. The total bot count includes merchants who initiated bot sessions regardless of completion status (active plus dropoff), while active sessions specifically measures merchants who successfully completed their bot interactions. This enables monitoring of bot effectiveness and merchant engagement patterns, helping identify support automation success rates and potential areas where merchants are dropping off during bot interactions. The weekly aggregation provides trend analysis for bot performance optimization and merchant experience improvement initiatives.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd cd

--- standard filters to be applied unless specifically requested for a different categorical value
--- default temporal range filter (no specific constraints shown)
cd.created_date IS NOT NULL

--- calculation_logic
sum(cd.bot_merchant_count) as total_bot_merchants,
sum(cd.bot_active_merchant_count) as active_bot_sessions,
date_trunc('week', cast(cd.created_date as timestamp)) as week_period




## Top Issue on Bot 

This metric tracks the total volume of active tickets currently being handled by automated bot systems, segmented by issue type categories. It provides visibility into which types of customer service issues are most commonly processed through automated channels, helping teams understand bot workload distribution and identify high-volume issue categories that may benefit from further automation optimization. The metric aggregates all active bot tickets without time or categorical filters, representing the current state of automated ticket processing across the entire customer service ecosystem.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all bot ticket activity

--- specific filters
--- no specific filters applied - represents complete bot ticket distribution

--- calculation_logic
sum(virtual_table.bot_active_ticket_count) as total_bot_tickets
group by virtual_table.issue_mapping




## Unique Merchant Count - Bot

Bot merchant engagement tracking measures the count of unique merchants interacting with automated bot services within the care dashboard system. This metric serves two purposes: monitoring overall bot adoption through total merchant count (including both successful active sessions and dropoff cases) and measuring engagement quality through active session counts specifically. The data is aggregated weekly to identify trends in bot utilization and merchant engagement patterns. This helps the care team understand bot effectiveness, identify potential issues with merchant dropoffs, and optimize automated service delivery for better merchant experience and support efficiency.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different time range
--- temporal filter allows flexible date range selection for trend analysis
virtual_table.created_date (temporal range filter available)

--- calculation_logic
sum(virtual_table.bot_merchant_count) as total_bot_merchants,
sum(virtual_table.bot_active_merchant_count) as active_bot_sessions,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_grouping




## Agent Ticket Count - Bot (MHD & Service)

This metric tracks customer support ticket volumes segmented by handling channel within the Care Dashboard for MHD operations. It measures two distinct support flows: tickets handled by MHD (Mental Health Department) agents and tickets that escalated from bot interactions to human service representatives. The data is aggregated weekly to show trends in support workload distribution and bot-to-human escalation patterns. This helps operations teams understand channel effectiveness, identify periods of high escalation, and optimize support resource allocation between automated and human channels. The temporal filter allows analysis across different time periods to track seasonal patterns and operational efficiency.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for analysis period (currently set to show all data)
virtual_table.created_date IS NOT NULL

--- calculation_logic
sum(virtual_table.agent_ticket_count_bot) as mhd_agent_tickets,
sum(virtual_table.bot_to_service_ticket_count) as service_escalation_tickets,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_grouping




## Top Issue on Bot 

This metric tracks the total number of active tickets handled by bots across different issue categories to identify the most common issues requiring bot intervention. The analysis groups bot active ticket counts by issue mapping to reveal which specific issues generate the highest bot workload, helping the care team understand bot utilization patterns and identify areas where automated support is most heavily engaged. This information is valuable for optimizing bot capabilities and understanding customer service demand patterns across different issue types without any applied filters, showing comprehensive bot activity data.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - showing all bot active tickets

--- specific filters
--- no specific filters applied - comprehensive view of all issue mappings

--- calculation_logic
sum(bot_active_ticket_count) as total_bot_tickets,
grouped by issue_mapping




## Agent Ticket Count - Bot (MHD & Service)

This metric tracks weekly ticket volumes in the care operations workflow, measuring both tickets handled directly by MHD (Mental Health Department) agents and tickets that escalated from bot interactions to human service agents. The chart aggregates agent_ticket_count_bot as "MHD Agent" workload and bot_to_service_ticket_count as "Service" escalations, providing visibility into care ticket distribution patterns. Results are grouped by week and ordered by MHD agent volume to prioritize mental health support capacity planning. This supports operational decision-making for staffing allocation and bot effectiveness evaluation in the customer care ecosystem.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for ticket creation analysis
virtual_table.created_date >= {start_date} AND
virtual_table.created_date <= {end_date}

--- specific filters
--- no additional categorical filters applied

--- calculation_logic
sum(virtual_table.agent_ticket_count_bot) as mhd_agent_tickets,
sum(virtual_table.bot_to_service_ticket_count) as service_escalation_tickets,
date_trunc('week', cast(virtual_table.created_date as timestamp)) as week_grouping




## Unique Merchant Counts - Bot (MHD & Service)

This metric tracks the weekly count of unique merchants who engage with customer support through two distinct bot-driven channels: MHD Agent (merchant help desk agent interactions) and Service (bot-to-service escalations). The purpose is to monitor merchant engagement patterns across different support touchpoints and understand the distribution of merchant queries between automated agent assistance and service escalations. Data is aggregated by week to show trends in merchant support utilization, helping identify peak periods and channel preferences. The metric helps support teams optimize resource allocation and understand merchant behavior in seeking assistance through bot-enabled support channels.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for date range selection (configurable)
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP))

--- calculation_logic
sum(virtual_table.agent_ticket_merchant_count_bot) as mhd_agent_count,
sum(virtual_table.bot_to_service_ticket_merchant_count) as service_count




## Unique Merchant Counts - Bot (MHD & Service)

This metric tracks unique merchant engagement with MHD support channels by counting distinct merchants who created tickets through bot automation versus human service escalation paths. The MHD Agent metric represents merchants whose tickets were handled entirely by the automated bot system, while the Service metric captures merchants whose tickets required escalation from bot to human agents. Data is aggregated weekly to show merchant support engagement patterns and channel effectiveness. This helps understand merchant support needs distribution between automated and human-assisted resolution paths, enabling resource planning and bot optimization decisions based on actual merchant usage patterns across the support ecosystem.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter allows flexible date selection
virtual_table.created_date >= {start_date} AND
virtual_table.created_date <= {end_date}

--- calculation_logic
sum(virtual_table.agent_ticket_merchant_count_bot) as mhd_agent_merchants,
sum(virtual_table.bot_to_service_ticket_merchant_count) as service_escalation_merchants,
date_trunc('week', cast(virtual_table.created_date as timestamp)) as week_period




## Bot Passthrough % (MHD & Service)

Bot Passthrough Percentage tracks the escalation rates from automated bot interactions to human support channels in the MHD customer care system. This metric measures operational efficiency by showing what percentage of bot-handled tickets require human intervention, segmented into two escalation paths: MHD Agent (direct agent escalation) and Service (service team escalation). The percentages are calculated weekly to identify trends in bot effectiveness and support load distribution. Higher passthrough rates may indicate bot limitations or complex customer issues requiring human expertise, while lower rates suggest effective bot resolution capabilities.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for data analysis period
created_date (temporal range - no specific constraints)

--- specific filters
--- no additional specific filters applied

--- calculation_logic
MHD Agent: 100 * SUM(agent_ticket_count_bot) / NULLIF(SUM(bot_active_ticket_count), 0)
Service: 100 * SUM(bot_to_service_ticket_count) / NULLIF(SUM(bot_active_ticket_count), 0)
GROUP BY: date_trunc('week', CAST(created_date AS TIMESTAMP))




## Bot Passthrough % (MHD & Service)

Bot Passthrough % (MHD & Service) measures the distribution of bot-initiated support tickets between MHD agents and service teams as percentages of total active bot tickets. This metric helps evaluate the effectiveness of bot triage and routing decisions in the care system. The MHD Agent percentage shows tickets successfully handled by mental health specialists, while Service percentage represents tickets requiring broader service team intervention. Data is aggregated weekly to track routing patterns over time, enabling optimization of bot escalation logic and resource allocation between specialized MHD support and general service teams.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for ticket creation date (configurable range)
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP))

--- calculation_logic
100*SUM(virtual_table.agent_ticket_count_bot)/nullif(sum(virtual_table.bot_active_ticket_count),0) as mhd_agent_pct,
100*SUM(virtual_table.bot_to_service_ticket_count)/nullif(sum(virtual_table.bot_active_ticket_count),0) as service_pct




## Feedback % - Bot

Bot Performance Feedback tracks customer service automation effectiveness through two complementary metrics: Response Rate measuring bot engagement (percentage of active tickets receiving bot responses) and MSAT measuring customer satisfaction (percentage of positive feedback among bot responses). These metrics are aggregated weekly to identify trends in bot performance and customer satisfaction over time. The data helps evaluate chatbot effectiveness, identify periods of suboptimal performance, and guide improvements to automated customer service capabilities. Applied with temporal filtering to analyze performance patterns across different time periods.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for analysis period
virtual_table.created_date >= {start_date} AND virtual_table.created_date <= {end_date}

--- calculation_logic
Response Rate: 100*SUM(bot_total_responses)/NULLIF(SUM(bot_active_ticket_count),0)
MSAT: 100*SUM(bot_positive_response)/NULLIF(SUM(bot_total_responses),0)
Weekly aggregation: date_trunc('week', CAST(created_date AS TIMESTAMP))




## Feedback % (Human Agent)

This metric tracks human agent feedback performance through two key indicators: Response Rate and MSAT (Mean Satisfaction) percentage. Response Rate measures the percentage of tickets that received any feedback response out of total tickets eligible for response, indicating agent responsiveness. MSAT measures the percentage of tickets receiving satisfaction feedback out of all tickets that received feedback, indicating quality measurement coverage. The data is aggregated weekly to show performance trends over time, helping managers monitor both agent response consistency and feedback quality tracking effectiveness. This enables identification of periods with low response rates or gaps in satisfaction measurement collection for performance improvement initiatives.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter on ticket creation date (configurable via dashboard)
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
100 * SUM(total_tickets_feedback_received) / NULLIF(SUM(total_tickets_for_response), 0) AS response_rate,
100 * SUM(total_tickets_msat_received) / NULLIF(SUM(total_tickets_feedback_received), 0) AS msat_percentage




## Feedback % (Human Agent)

This chart measures customer service performance for human agents by tracking two critical feedback metrics: Response Rate and MSAT (customer satisfaction). Response Rate calculates the percentage of support tickets that received customer feedback out of all tickets eligible for response, indicating customer engagement with the feedback process. MSAT measures the percentage of satisfied customers among those who provided feedback, representing service quality effectiveness. The metrics are aggregated weekly to show trends in both customer response behavior and satisfaction levels. This analysis helps evaluate human agent performance, identify service quality patterns, and monitor customer engagement with the feedback collection process over time.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter currently set to no filter (all available dates)
--- note: created_date temporal range can be applied when specific time periods are needed

--- calculation_logic
response_rate: 100*SUM(total_tickets_feedback_received)/NULLIF(SUM(total_tickets_for_response),0)
msat: 100 * SUM(total_tickets_msat_received) / NULLIF(SUM(total_tickets_feedback_received), 0)
aggregation: GROUP BY date_trunc('week', CAST(created_date AS TIMESTAMP))




## Feedback % - Bot

Bot Performance Feedback tracks customer service automation effectiveness for mental health support tickets through two key satisfaction metrics. Response Rate measures the percentage of active tickets that received automated bot responses, calculated as total bot responses divided by active ticket count. MSAT (Mean Satisfaction) represents the percentage of positive feedback among all bot responses received. The metrics are aggregated weekly and filtered by configurable date ranges to analyze bot performance trends over time. This enables care teams to monitor automated response coverage and customer satisfaction with bot interactions, helping optimize the balance between automated and human support in mental health services.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for analysis period selection
date_trunc('week', CAST(created_date AS TIMESTAMP))

--- specific filters
--- configurable date range filter
created_date IN ({date_range}: temporal_range_selection)

--- calculation_logic
Response Rate: 100*SUM(bot_total_responses)/nullif(sum(bot_active_ticket_count),0)
MSAT: 100*SUM(bot_positive_response)/nullif(SUM(bot_total_responses),0)
GROUP BY date_trunc('week', CAST(created_date AS TIMESTAMP))




## Feedback % - MHD Agent 

This metric tracks MHD agent customer service performance through two key indicators: Response Rate measuring the percentage of agent tickets that received customer feedback out of total tickets requiring response, and MSAT (satisfaction) measuring the percentage of tickets receiving satisfactory ratings out of those with feedback received. The data is aggregated weekly to identify performance trends and patterns over time. This enables care team managers to monitor agent responsiveness and customer satisfaction levels, helping identify training needs and performance improvement opportunities. The temporal filter allows analysis across different time periods to assess performance consistency and seasonal variations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different date range
--- temporal filter for performance analysis period
created_date TEMPORAL_RANGE (configurable date range)

--- calculation_logic
Response Rate: 100 * SUM(agent_tickets_feedback_received) / NULLIF(SUM(agent_tickets_for_response), 0)
MSAT: 100 * SUM(agent_tickets_msat_received) / NULLIF(SUM(agent_tickets_feedback_received), 0)
GROUP BY: date_trunc('week', CAST(created_date AS TIMESTAMP))




## Feedback % - MHD Agent 

This metric tracks customer service performance for MHD (Mental Health Department) agents through two key indicators: Response Rate measuring the percentage of agent tickets that received customer feedback out of those requiring responses, and MSAT measuring the percentage of satisfied customers among those who provided feedback. The data is aggregated weekly to identify trends in customer engagement and satisfaction levels. This dual-metric approach provides insights into both the effectiveness of feedback collection processes and actual customer satisfaction outcomes, enabling performance monitoring and improvement initiatives for mental health customer service operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for analysis period selection
date_trunc('week', CAST(created_date AS TIMESTAMP)) >= {start_date} AND
date_trunc('week', CAST(created_date AS TIMESTAMP)) <= {end_date}

--- calculation_logic
100 * SUM(agent_tickets_feedback_received) / NULLIF(SUM(agent_tickets_for_response), 0) as response_rate,
100 * SUM(agent_tickets_msat_received) / NULLIF(SUM(agent_tickets_feedback_received), 0) as msat_rate,
GROUP BY date_trunc('week', CAST(created_date AS TIMESTAMP))




## Feedback % - Service

This metric tracks service feedback performance through two key indicators: Response Rate measuring the percentage of service tickets that received customer feedback out of those requiring a response, and MSAT (Mean Satisfaction) measuring the percentage of tickets receiving satisfaction feedback out of those that received any feedback. The metrics are calculated weekly and help monitor customer engagement and satisfaction trends in the Care Dashboard for MHD operations. Both calculations use NULLIF protection to handle division by zero scenarios and are presented as percentages for easy interpretation by service teams.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter available but currently set to no filter (all dates included)
--- can be filtered by created_date for specific time periods

--- calculation_logic
Response Rate: 100 * SUM(service_tickets_feedback_received) / NULLIF(SUM(service_tickets_for_response), 0)
MSAT: 100 * SUM(service_tickets_msat_received) / NULLIF(SUM(service_tickets_feedback_received), 0)
GROUP BY: date_trunc('week', CAST(created_date AS TIMESTAMP))




## Feedback % - Service

This metric tracks service ticket feedback performance through two key indicators: Response Rate measuring the percentage of service tickets that received customer feedback out of all tickets eligible for response, and MSAT (satisfaction rate) measuring the percentage of tickets with positive satisfaction scores among those that provided feedback. The data is aggregated weekly to show trends in customer engagement and satisfaction with service support. This metric helps the care team monitor both the effectiveness of their feedback collection process and the quality of service delivery as perceived by customers. The temporal filter allows analysis across different time periods to identify patterns and improvements in service performance.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for analysis period selection
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) IS NOT NULL

--- specific filters
--- no additional specific filters applied - shows all service ticket types and categories

--- calculation_logic
Response Rate: 100 * SUM(service_tickets_feedback_received) / NULLIF(SUM(service_tickets_for_response), 0)
MSAT: 100 * SUM(service_tickets_msat_received) / NULLIF(SUM(service_tickets_feedback_received), 0)




## Avg TAT (Days) - Human Agent

This metric tracks the average turnaround time in days for tickets handled by human agents in the customer care system. It measures operational efficiency by calculating the mean resolution time across all qualifying support tickets. The calculation uses sum_tat_days (total days across all tickets) divided by tat_denominator_tickets (count of tickets with valid TAT calculations) to provide an accurate average that excludes incomplete or invalid cases. The metric is aggregated weekly to identify performance trends and patterns in agent response times. A temporal filter enables analysis across different time periods to monitor service level improvements or deterioration over time.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for flexible date analysis
virtual_table.created_date [temporal_range filter applied]

--- specific filters
--- no additional specific filters applied

--- calculation_logic
sum(virtual_table.sum_tat_days) / nullif(sum(virtual_table.tat_denominatior_tickets), 0)




## Avg TAT (Days) - Human Agent

This metric tracks the average Turn Around Time (TAT) in days for tickets handled by human agents in the mental health department. It calculates a weighted average by dividing the total TAT days by the number of tickets that have TAT measurements, providing insight into agent efficiency and customer service response times. The metric is aggregated weekly to show trends in resolution speed over time. A temporal range filter on created_date allows analysis of specific time periods. This KPI helps management monitor service quality, identify performance bottlenecks, and ensure customer inquiries are resolved within acceptable timeframes.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for analyzing specific time periods
virtual_table.created_date >= {start_date} AND
virtual_table.created_date <= {end_date}

--- specific filters
--- none specified - uses default temporal range

--- calculation_logic
sum(sum_tat_days) / nullif(SUM(tat_denominatior_tickets), 0) as avg_tat_days,
date_trunc('week', CAST(created_date AS TIMESTAMP)) as week_period




## Avg TAT (Days) - MHD Agent

This metric measures the average turnaround time in days for MHD (Mental Health Department) agents to resolve tickets. It calculates a weighted average by dividing the total sum of TAT days across all tickets by the count of tickets that have valid TAT calculations, providing insight into agent efficiency and service quality. The data is aggregated weekly using date truncation to show trends over time, helping management monitor performance patterns and identify periods requiring attention. The metric uses nullif protection to handle cases where no tickets have TAT calculations, ensuring mathematical accuracy in the calculation.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter on ticket creation date (default range applied)
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(virtual_table.sum_mhd_tat_days) / nullif(SUM(virtual_table.mhd_tat_denominatior_tickets), 0) as avg_tat_days,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_period




## Avg TAT (Days) - MHD Agent

This metric tracks the average turnaround time in days for MHD (Medical Health Department) agents handling customer service tickets. It measures operational efficiency by calculating a weighted average of resolution times across all tickets within specified time periods. The metric uses sum of TAT days divided by the count of tickets to provide an accurate average that accounts for ticket volume. Data is typically grouped by week to show temporal trends in agent performance. This helps management monitor service quality, identify performance bottlenecks, and ensure compliance with service level agreements in healthcare support operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter on ticket creation date (configurable)
virtual_table.created_date >= {start_date} AND virtual_table.created_date <= {end_date}

--- calculation_logic
sum(sum_mhd_tat_days) / nullif(sum(mhd_tat_denominatior_tickets), 0) as avg_tat_days




## Avg TAT - Service Agent

This metric tracks the average turnaround time (TAT) in days for service agent ticket resolution within the care dashboard operations. It measures operational efficiency by calculating the weighted average of service resolution times, dividing total service TAT days by the number of tickets that contribute to the denominator. The metric is aggregated weekly to show trends in service performance over time. It includes null protection to handle cases where no qualifying tickets exist for a time period. This KPI helps management monitor service quality, identify performance bottlenecks, and assess whether service level agreements are being met across the customer care operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter on ticket creation date (default: no filter, shows all available data)
virtual_table.created_date IS NOT NULL

--- calculation_logic
sum(virtual_table.sum_service_tat_days) / nullif(sum(virtual_table.service_tat_denominatior_tickets), 0) as avg_service_tat_days




## Avg TAT - Service Agent

This metric measures the average turnaround time in days for service agents handling tickets in the MHD care system. The calculation uses a weighted average approach, dividing the sum of service TAT days by the total count of tickets that have TAT denominators (excluding null values to prevent division errors). The metric is grouped by week to show trending patterns in service response times. This helps track service agent performance and identify periods where response times may be deteriorating, enabling proactive management interventions to maintain service quality standards.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for created date (default range applied)
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(virtual_table.sum_service_tat_days) / nullif(SUM(virtual_table.service_tat_denominatior_tickets), 0) as avg_tat_days




## Top L1 Issues - Human Agent

This metric tracks the total volume of Level 1 support tickets handled by human agents, segmented by issue type categories. It measures the distribution of customer service workload across different problem areas to help identify the most common issues requiring human intervention. The aggregation sums all ticket counts by issue mapping categories, providing visibility into support volume patterns and helping prioritize resource allocation for human agents. This data supports operational decisions around staffing, training focus areas, and potential automation opportunities for frequently occurring L1 issues.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all L1 issues handled by human agents

--- specific filters
--- no specific filters applied - comprehensive view of all issue types

--- calculation_logic
sum(virtual_table.total_ticket_count) as total_tickets,
virtual_table.issue_mapping as issue_category




## Top L1 Issues - Human Agent

This metric tracks the total volume of L1 support tickets handled by human agents, segmented by issue type mapping categories. It provides operational visibility into the distribution of customer care workload across different issue categories within the MHD (Mental Health Department) services. The metric aggregates all ticket counts without any temporal or categorical filters, giving a comprehensive view of issue volume patterns. This helps care teams identify the most common L1 issues requiring human agent intervention, enabling better resource allocation and process optimization for customer support operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all L1 issues across all categories

--- specific filters
--- no specific filters applied - comprehensive view of all ticket volumes

--- calculation_logic
sum(virtual_table.total_ticket_count) as ticket_volume,
virtual_table.issue_mapping as issue_category




## Ticket Counts - Bot

This metric tracks bot interaction volume within the mental health department's customer care system. It measures two key aspects of bot engagement: total bot tickets (including both completed active sessions and user drop-offs) and specifically active bot sessions where users remained engaged. The data is aggregated weekly to identify trends in automated support utilization and user engagement patterns. This helps assess bot effectiveness by comparing total interactions against successful active sessions, providing insights into user behavior and bot performance for mental health support services.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter available but currently set to no filter
--- can be applied to created_date for specific time periods

--- specific filters
--- no additional filters currently applied

--- calculation_logic
sum(virtual_table.bot_ticket_count) as total_bot_tickets,
sum(virtual_table.bot_active_ticket_count) as active_bot_sessions,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_period




## Ticket Counts - Bot

This metric tracks bot interaction volume in the customer care system, measuring both total bot tickets (including active sessions and drop-offs) and specifically active bot sessions. The chart aggregates data weekly to show trends in bot engagement over time, helping monitor the effectiveness of automated customer support. Total bot tickets represent all interactions initiated with the bot system, while active sessions indicate successful ongoing engagements. The data includes all available time periods with no specific date filtering applied, providing a comprehensive view of bot performance trends for operational monitoring and capacity planning purposes.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter set to include all available data
virtual_table.created_date IS NOT NULL

--- specific filters
--- no additional filters applied - chart shows all bot ticket data

--- calculation_logic
sum(virtual_table.bot_ticket_count) as total_bot_tickets,
sum(virtual_table.bot_active_ticket_count) as active_bot_sessions,
date_trunc('week', cast(virtual_table.created_date as timestamp)) as week_period




## Bot Contact Ratio (%)

Bot Contact Ratio measures the percentage of customer service tickets handled by automated bots relative to the total contact base, segmented by line of business (lob). This operational efficiency metric helps evaluate the effectiveness of automation in customer care operations across different business segments. The ratio is calculated as (bot ticket count / contact ratio base count) * 100, providing insights into how well bot automation is performing in each business line. Higher ratios indicate greater automation success, which typically correlates with reduced operational costs and improved response times for routine customer inquiries.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter on ticket creation date (currently set to no filter, may use dashboard-level filtering)
virtual_table.created_date {temporal_range_filter}

--- specific filters
--- none specified for this metric

--- calculation_logic
100 * SUM(bot_ticket_count) / NULLIF(MAX(cr_base_count), 0) AS bot_contact_ratio_pct
GROUP BY lob




## Bot Contact Ratio (%)

Bot Contact Ratio measures the percentage of customer support tickets handled by automated bots versus total contact volume, segmented by line of business (lob). This metric helps assess the effectiveness of automation in customer care operations and identifies which business lines have higher bot resolution rates. The calculation divides total bot ticket counts by the maximum contact ratio base count and multiplies by 100 to get a percentage. It provides insights into automation adoption and efficiency across different service areas, enabling teams to optimize bot deployment and improve self-service capabilities while reducing manual support workload.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd cd

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter on ticket creation date (default range applied)
cd.created_date >= {default_start_date} AND
cd.created_date <= {default_end_date}

--- specific filters
--- no additional specific filters applied

--- calculation_logic
100 * SUM(cd.bot_ticket_count) / NULLIF(MAX(cd.cr_base_count), 0) AS bot_contact_ratio_pct




## Total Volume (IVR Calls+Bot Tickets)

This metric tracks total customer service interaction volume by combining automated bot tickets and IVR calls across different lines of business. It provides a comprehensive view of customer support demand by aggregating two primary self-service channels, enabling teams to understand overall service volume distribution across business units. The metric helps in capacity planning, resource allocation, and identifying which LOBs generate the highest customer service demand. By combining both digital (bot) and voice (IVR) interactions, it offers a holistic perspective on customer service utilization patterns for operational and strategic decision-making.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOBs

--- specific filters
--- no specific filters applied - includes all available data

--- calculation_logic
sum(bot_ticket_count) + sum(ivr_calls) as total_volume,
grouped by lob




## Total Volume (IVR Calls+Bot Tickets)

This metric tracks the total customer service volume by combining bot-generated support tickets and inbound IVR (Interactive Voice Response) calls, segmented by line of business. It provides a comprehensive view of customer service demand across different business units, helping operations teams understand service load distribution and capacity planning needs. The metric aggregates two primary customer service channels to give a holistic picture of support volume, enabling cross-LOB comparisons and resource allocation decisions for the care team.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all LOBs and time periods

--- specific filters
--- no specific filters applied

--- calculation_logic
sum(bot_ticket_count) + sum(ivr_calls) as total_volume,
group by lob




## Contact Ratio (%)

Contact Ratio tracks the percentage of customers who actively reach out for support through digital channels (bot tickets) and voice channels (IVR calls) relative to the total eligible customer base. This metric helps the Care team understand customer engagement patterns and support utilization rates across different Lines of Business (LOB). The calculation combines both automated bot interactions and traditional phone-based inquiries to provide a comprehensive view of customer contact behavior. By segmenting results by LOB, the dashboard enables comparison of support engagement levels across various business units, helping identify which areas generate higher customer contact volumes and may require additional support resources or process improvements.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - metric calculated across all available data

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs

--- calculation_logic
100 * (SUM(bot_ticket_count) + SUM(ivr_calls)) / NULLIF(MAX(cr_base_count), 0) AS contact_ratio_percent




## Contact Ratio (%)

Contact Ratio measures the percentage of customer service interactions (bot tickets and IVR calls combined) relative to the baseline contact count, segmented by Line of Business. This metric helps customer service teams understand interaction volume patterns across different business units and assess the proportion of automated versus total potential contacts. The ratio is calculated as a percentage using combined bot ticket count and IVR calls divided by the maximum baseline contact count, with null handling to prevent division errors. This provides insights into customer engagement patterns and service channel utilization across different LOBs for operational planning and resource allocation decisions.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied

--- specific filters
--- no specific filters applied

--- calculation_logic
100 * (SUM(bot_ticket_count) + SUM(ivr_calls)) / NULLIF(MAX(cr_base_count), 0) as contact_ratio_percent,
grouped by lob




## MSAT (%)

MSAT (%) measures overall customer satisfaction percentage across both automated bot interactions and manual ticket handling channels. The metric combines positive bot responses and satisfied manual tickets as the numerator, divided by total feedback received from both channels, then multiplied by 100 for percentage representation. This composite satisfaction score provides a unified view of customer experience quality across different service delivery methods, segmented by line of business. The calculation handles cases where no feedback is received by using NULLIF to prevent division by zero errors, ensuring robust metric computation across all business segments.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows satisfaction across all lines of business

--- specific filters
--- no specific filters applied

--- calculation_logic
(SUM(bot_positive_response) + SUM(total_tickets_msat_received)) / NULLIF((SUM(bot_total_responses) + SUM(total_tickets_feedback_received)), 0) * 100
grouped by: lob




## MSAT (%)

MSAT percentage measures overall customer satisfaction across both bot interactions and human agent tickets, segmented by Line of Business. The metric combines bot positive responses and tickets receiving positive MSAT feedback as the numerator, divided by total bot responses and total tickets with feedback received. This provides a comprehensive satisfaction score that accounts for both automated and human customer service channels. The calculation uses nullif to handle division by zero cases and multiplies by 100 to express results as percentages. Results are grouped by LOB to enable business line comparison and identify areas needing satisfaction improvement across the customer care ecosystem.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all data across all LOBs

--- specific filters
--- no specific filters applied

--- calculation_logic
100*((SUM(bot_positive_response)+SUM(total_tickets_msat_received)))/nullif((SUM(bot_total_responses)+SUM(total_tickets_feedback_received)),0)
grouped by: lob




## IVR Contact Ratio (%)

IVR Contact Ratio measures the percentage of customers who use Interactive Voice Response (IVR) systems relative to the total contact base for each line of business. This metric helps evaluate the adoption and utilization of automated voice services across different business segments. The calculation divides total IVR calls by the maximum contact ratio base count to determine penetration rates. It includes safeguards against division by zero through nullif function and presents results as percentages for easy interpretation. The metric is segmented by line of business to enable comparative analysis of IVR usage patterns across different service areas.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd cd

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all lines of business

--- specific filters
--- no specific filters applied

--- calculation_logic
100 * sum(cd.ivr_calls) / nullif(max(cd.cr_base_count), 0) as ivr_contact_ratio_pct
group by cd.lob




## IVR Contact Ratio (%)

The IVR Contact Ratio measures the percentage of customer interactions that utilize Interactive Voice Response (IVR) systems relative to the total contact base count across different lines of business. This metric helps assess channel preference and IVR system utilization effectiveness for customer service operations. The ratio is calculated as total IVR calls divided by the maximum contact ratio base count, multiplied by 100 to express as a percentage. Results are segmented by line of business to enable comparative analysis across different business units and identify which LOBs have higher IVR adoption rates, supporting strategic decisions about customer service channel optimization and resource allocation.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd cd

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all available data

--- specific filters
--- no specific filters applied - includes all lines of business

--- calculation_logic
100 * sum(cd.ivr_calls) / nullif(max(cd.cr_base_count), 0) as ivr_contact_ratio_pct




## Avg TAT (Days) Service Agent

This metric measures the average turnaround time in days for service agents to resolve customer service requests, segmented by line of business (LOB). It calculates a weighted average by dividing the total service TAT days by the count of tickets that have valid TAT measurements, ensuring accurate performance assessment across different business units. The metric helps identify performance variations between LOBs and enables targeted improvements in service delivery. It uses nullif protection to handle cases where no tickets exist for TAT calculation, providing a reliable measure of agent efficiency and customer service quality across the organization's different business segments.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOBs

--- specific filters
--- no specific filters applied

--- calculation_logic
sum(sum_service_tat_days) / nullif(sum(service_tat_denominatior_tickets), 0) as avg_tat_days
group by lob




## Avg TAT (Days) Service Agent

This metric measures the average turnaround time in days for service agents handling customer requests across different lines of business. It calculates a weighted average by dividing the total service TAT days by the number of tickets that have TAT data, using nullif to handle zero denominators. The metric is segmented by line of business (lob) to enable performance comparison across different business units. This operational efficiency indicator helps identify service delivery bottlenecks and track agent performance improvements over time. The measurement provides insights into customer service quality and helps management optimize resource allocation and process improvements across various business segments.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all available service data

--- specific filters
--- no specific filters applied - comprehensive view across all records

--- calculation_logic
sum(sum_service_tat_days) / nullif(sum(service_tat_denominatior_tickets), 0) as avg_tat_days
group by lob




## Bot Contact Ratio (%)

Bot Contact Ratio tracks the percentage of customer care interactions handled by automated bot systems versus total customer contacts. This metric measures digital transformation effectiveness in customer service by showing bot adoption rates and engagement success. The ratio includes both active bot sessions and dropoff scenarios to provide comprehensive bot utilization insights. Data is aggregated monthly to identify trends in automation adoption and customer preference for self-service options. The base count represents total customer contact volume, making this a key performance indicator for care operations efficiency and customer experience optimization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter applied based on user selection
date_trunc('month', CAST(virtual_table.created_date AS TIMESTAMP))

--- calculation_logic
100*SUM(bot_ticket_count)/nullif(max(cr_base_count),0) as bot_total_ratio,
100*SUM(bot_active_ticket_count)/nullif(max(cr_base_count),0) as bot_active_ratio




## Avg TAT (Days) MHD Agent

This metric measures the average turnaround time in days for MHD agent ticket resolution, segmented by line of business (lob). It serves as a key performance indicator for service efficiency, helping identify which business lines experience longer resolution times. The calculation uses a weighted average approach, dividing the total TAT days by the total number of tickets eligible for TAT calculation, ensuring accurate averages even when ticket volumes vary significantly across LOBs. This metric enables service managers to benchmark performance across different business units and prioritize improvement efforts where TAT exceeds acceptable thresholds. No specific filters are applied, providing a comprehensive view of all MHD agent performance across the organization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOBs and time periods

--- specific filters
--- no specific filters applied

--- calculation_logic
sum(sum_mhd_tat_days) / nullif(SUM(mhd_tat_denominatior_tickets), 0) as avg_tat_days
GROUP BY lob




## Avg TAT (Days) MHD Agent

This metric measures the average turnaround time in days for Multi-Helpdesk (MHD) agents across different lines of business. It calculates a weighted average by dividing the total sum of TAT days by the total number of tickets with TAT data, segmented by LOB to enable performance comparison across business units. The metric helps identify service delivery efficiency and potential bottlenecks in customer support operations. It uses NULLIF protection to handle cases where no tickets exist for a particular LOB, ensuring reliable calculations across all business segments.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd mhd

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOB performance

--- specific filters
--- no specific filters applied - comprehensive view across all data

--- calculation_logic
sum(mhd.sum_mhd_tat_days) / nullif(sum(mhd.mhd_tat_denominatior_tickets), 0) as avg_tat_days,
mhd.lob




## Bot Contact Ratio (%)

Bot Contact Ratio tracks the percentage of customer service interactions handled by automated bots versus total contact volume, serving as a key efficiency metric for customer care operations. The metric includes two variants: total bot interactions (including both active sessions and dropoffs where customers abandoned the bot interaction) and active bot sessions only (successful bot engagements). Both metrics are calculated monthly and use the same base denominator (cr_base_count) representing total contact volume. This helps care teams measure automation effectiveness, identify trends in bot adoption, and optimize the balance between automated and human support channels.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - showing all available data

--- specific filters
--- temporal range filter set to "No filter" - includes all time periods

--- calculation_logic
100 * SUM(bot_ticket_count) / NULLIF(MAX(cr_base_count), 0) AS bot_total_ratio,
100 * SUM(bot_active_ticket_count) / NULLIF(MAX(cr_base_count), 0) AS bot_active_ratio




## Top Bot L2 Issues

This metric tracks the distribution of active support tickets across different L2 bot categories within the MHD care system. It measures bot_active_ticket_count summed by bot_l2 groupings to identify which L2 bot issues have the highest volume of open tickets. The analysis helps support teams understand workload distribution across bot-related L2 issues and prioritize resolution efforts. With no active temporal filters applied, it provides a current snapshot of all active bot tickets across L2 categories. This visibility enables support managers to allocate resources effectively and identify problematic bot categories requiring immediate attention.

-- tables_involved
hive.team_servicesone.Bot_issue_l2_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter available but currently set to "No filter"
--- created_date TEMPORAL_RANGE (configurable)

--- specific filters
--- none applied in current configuration

--- calculation_logic
sum(bot_active_ticket_count) as total_active_tickets,
grouped by bot_l2




## Top Bot L2 Issues

This metric tracks the total count of active bot-related support tickets aggregated by L2 issue categories within the ServicesOne support system for MHD operations. It provides visibility into bot performance issues and support ticket volumes across different second-level categorizations, helping support teams identify problematic bot functionalities and prioritize resolution efforts. The metric sums all active ticket counts without temporal restrictions, giving a current snapshot of bot-related support burden by issue type for operational monitoring and resource allocation decisions.

-- tables_involved
hive.team_servicesone.Bot_issue_l2_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no temporal restrictions applied (filter set to "No filter")

--- specific filters
--- none specified

--- calculation_logic
sum(bot_active_ticket_count) as total_active_tickets,
grouped by bot_l2




## Top DSAT Reason -  Bot

This metric tracks the total count of negative bot responses segmented by bot L2 categories to identify primary sources of bot-related customer dissatisfaction. It serves as a key performance indicator for bot effectiveness in customer service interactions, helping teams prioritize bot improvement efforts by highlighting which specific bot interaction types generate the most negative customer feedback. The analysis aggregates all negative bot responses without time or categorical filters, providing a comprehensive view of bot performance issues across different interaction categories within the MHD (likely referring to a specific service domain or geography) care dashboard ecosystem.

-- tables_involved
hive.team_servicesone.Bot_issue_l2_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all bot interactions

--- specific filters
--- no specific filters applied - comprehensive view across all bot L2 categories

--- calculation_logic
sum(bot_negative_response) as negative_response_count,
group by bot_l2




## Top L2 Issues - Human Agent

This metric tracks the volume of L2 support issues handled by human agents across all categories in the MHD care system. It aggregates total ticket counts by L2 issue type to identify the most prevalent support problems requiring human intervention. The data comes from a servicesone project view that categorizes support tickets by their L2 classification level. This analysis helps support managers understand workload distribution, identify recurring problem areas, and optimize resource allocation for human agents. The metric can be filtered by date ranges to analyze trends over specific time periods, though currently shows all-time aggregated data.

-- tables_involved
hive.team_servicesone.MHD_Agent_issue_l2_project_servicesone virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all L2 issues across all time periods

--- specific filters
--- temporal filter for date range analysis (currently set to no filter)
--- created_date temporal range filter available for time-based segmentation

--- calculation_logic
sum(total_ticket_count) grouped by issue_l2




## Top DSAT Reason -  Bot

This metric tracks the total count of negative responses generated by bot interactions, segmented by Level 2 (L2) bot categories within the customer care ecosystem. It serves as a dissatisfaction indicator to help customer service teams identify which specific bot functionalities or conversation flows are generating the most negative user experiences. The analysis focuses on bot performance issues that require attention from the MHD (likely Mobile Handset Device) services team. By aggregating negative responses across different L2 bot categories, this metric enables prioritization of bot improvement efforts and helps measure the impact of bot-related customer service issues on overall satisfaction levels.

-- tables_involved
hive.team_servicesone.Bot_issue_l2_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all bot L2 categories

--- specific filters
--- no specific filters applied - comprehensive view across all categories

--- calculation_logic
sum(bot_negative_response) as negative_response_count,
grouped by bot_l2 category




## Top L2 Issues - Human Agent

This metric tracks the total volume of support tickets categorized by Level 2 (L2) issue types handled by human agents within the Care Dashboard system. It aggregates ticket counts across all time periods to provide a comprehensive view of issue distribution patterns. The metric serves to identify the most frequent L2 issue categories, enabling support management to allocate resources effectively, prioritize training programs, and implement targeted process improvements. By understanding which issue types generate the highest ticket volumes, teams can focus on root cause analysis and preventive measures for the most impactful problems affecting customer experience.

-- tables_involved
hive.team_servicesone.MHD_Agent_issue_l2_project_servicesone virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter available but currently disabled (No filter applied)
virtual_table.created_date IS NOT NULL

--- specific filters
--- none applied - showing all L2 issue categories across all time periods

--- calculation_logic
SUM(virtual_table.total_ticket_count) grouped by virtual_table.issue_l2




## Intent wise Final MSAT %

This metric measures customer satisfaction percentage by calculating the ratio of positive (happy) feedback to total feedback given, expressed as a percentage. It serves as a key performance indicator for customer experience quality across different customer service entities. The metric applies a temporal filter for the last week and excludes IVR merchant interactions to focus on human-assisted customer service performance. When no feedback is collected, it defaults to 0% to avoid division errors. This helps customer service teams track satisfaction trends and identify entities that may need improvement in service delivery.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude IVR merchant interactions to focus on human-assisted service
msat.cst_entity <> 'ivr-merchant' AND
--- temporal filter for recent performance analysis
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02'

--- calculation_logic
CASE 
  WHEN SUM(feedback_given) = 0.00 THEN 0.00
  ELSE SUM(happy) * 100.00 / SUM(feedback_given)
END




## Bot to Service Passthrough (%)

Bot to Service Passthrough tracks the percentage of bot interactions that are escalated to human service agents, calculated as the ratio of bot-to-service ticket transfers to total bot active tickets multiplied by 100. This metric helps measure the effectiveness of automated customer service systems and identifies areas where bot capabilities may need improvement. The metric is segmented by line of business (lob) to enable performance comparison across different business units and service categories. A higher passthrough rate may indicate either complex customer issues requiring human intervention or opportunities to enhance bot intelligence and response capabilities.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all bot interactions across all LOBs

--- specific filters
--- no specific filters applied - comprehensive view of all bot escalations

--- calculation_logic
100 * SUM(bot_to_service_ticket_count) / NULLIF(SUM(bot_active_ticket_count), 0) AS passthrough_percentage
GROUP BY lob




## Intent wise Final MSAT %

This metric tracks the customer satisfaction percentage (MSAT) by measuring the proportion of positive feedback responses across different customer service entities. The Final MSAT % represents happy feedback count as a percentage of total feedback received, with proper handling for cases where no feedback was provided (returning 0%). The metric is filtered to exclude IVR merchant interactions and focuses on the most recent week's performance, providing insights into customer satisfaction trends across various service touchpoints within the care dashboard ecosystem.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude IVR merchant interactions to focus on human-assisted service channels
msat.cst_entity <> 'ivr-merchant' AND
--- temporal filter for recent performance analysis
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02'

--- calculation_logic
CASE 
  WHEN SUM(feedback_given) = 0.00 THEN 0.00
  ELSE SUM(happy) * 100.00 / SUM(feedback_given)
END




## Function Call SR%

This metric tracks success rates across multiple customer care functions within the Merchant Help Desk system, measuring operational efficiency for service request handling, settlement inquiries, agent transfers, hardware diagnostics, and broadcast testing. Each function calculates the percentage of successful attempts out of total attempts, providing visibility into system performance and identifying potential bottlenecks in customer support operations. The metrics are filtered to show recent performance over the last 10 days, enabling teams to monitor current operational health and respond quickly to degrading service levels across different support functions.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 dashboard

--- standard filters to be applied unless specifically requested for a different time range
--- recent performance monitoring - last 10 days of operational data
dashboard.date_ >= CURRENT_DATE - INTERVAL '10' DAY

--- calculation_logic
pattern: success_rate_calculation
base_metrics: {function_name}_success, {function_name}_attempts
functions: [raiseservicerequest, get_settlement_and_payment_info, agent_handover, checksoundboxhardware, testbroadcast]




## Function Call SR%

This metric tracks success rates for various customer service request types in the MHD care system, measuring operational efficiency across different service functions. The success rate is calculated as the percentage of successful requests against total attempts, providing insight into system performance and customer service quality. Functions monitored include raising service requests, retrieving settlement and payment information, agent handover processes, soundbox hardware checks, and test broadcasts. Data is filtered to show the last 10 days of performance, allowing teams to monitor recent trends and identify service delivery issues across different operational areas.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 dashboard

--- standard filters to be applied unless specifically requested for a different time range
--- recent performance monitoring window
dashboard.date_ >= CURRENT_DATE - INTERVAL '10' DAY

--- calculation_logic
pattern: success_rate_calculation
base_metrics: [raiseservicerequest, get_settlement_and_payment_info, agent_handover, checksoundboxhardware, testbroadcast]
aggregation: daily (date_trunc('day', CAST(date_ AS TIMESTAMP)))




## Bot to Service Passthrough (%)

This metric tracks the Bot to Service Passthrough percentage, measuring the rate at which customer interactions handled by chatbots get escalated to human service agents. The percentage is calculated by dividing the number of tickets transferred from bot to service by the total number of active bot tickets, then multiplying by 100. This KPI is segmented by Line of Business (lob) to provide insights into bot effectiveness and escalation patterns across different business units. A lower percentage indicates better bot performance and self-service capability, while higher percentages may signal areas where bot training or workflows need improvement. This metric helps optimize the balance between automated and human-assisted customer service.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied

--- specific filters
--- no specific filters applied - shows all LOB data

--- calculation_logic
100 * SUM(bot_to_service_ticket_count) / NULLIF(SUM(bot_active_ticket_count), 0) as passthrough_percentage
GROUP BY lob




## MHD Agent Tickets count (IVR)

This metric tracks the total volume of support tickets handled by agents through phone/IVR channels, segmented by line of business (LOB). It measures customer service workload distribution across different business units, helping identify which LOBs generate the highest phone support demand. The metric aggregates ticket counts to provide visibility into agent phone interaction volume for capacity planning and resource allocation. This supports operational monitoring of customer care efficiency and helps management understand phone support patterns across different business segments within the MHD services organization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all LOB data

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs

--- calculation_logic
sum(agent_ticket_count_phone) as phone_ticket_count
group by lob




## MHD Agent Tickets count (IVR)

This metric tracks the total number of customer service tickets handled by MHD (Merchant Help Desk) agents through the phone/IVR channel, segmented by line of business (LOB). It measures the operational workload distribution across different business units for phone-based customer support interactions. The metric aggregates all phone ticket counts without time-based or categorical filters, providing a comprehensive view of agent ticket volume by business line. This helps operations teams understand support demand patterns across different product lines and allocate agent resources accordingly for phone-based customer service channels.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all data

--- specific filters
--- no specific filters applied - comprehensive view across all LOBs and time periods

--- calculation_logic
sum(agent_ticket_count_phone) as total_phone_tickets,
group by lob




## Service Tickets Count (IVR)

This metric tracks the total count of service tickets generated from IVR (Interactive Voice Response) calls, segmented by line of business. It measures customer service demand originating from automated phone interactions, helping identify which business units receive the most IVR-generated support requests. The data aggregates all IVR call-to-ticket conversions without any date or categorical filters applied, providing a comprehensive view of service ticket volume across all lines of business. This metric supports capacity planning and resource allocation decisions for customer care teams by showing the distribution of IVR-originated service requests.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all IVR service tickets across all time periods

--- specific filters
--- no specific filters applied - comprehensive view across all dimensions

--- calculation_logic
sum(ivr_call_to_service_ticket) as total_ivr_tickets
group by lob




## Service Tickets Count (IVR)

This metric tracks the total count of IVR (Interactive Voice Response) calls that escalated to service tickets, segmented by Line of Business (LOB). It measures customer service operational efficiency by identifying which business lines generate the most service tickets from automated phone interactions. The metric helps assess IVR system effectiveness and customer self-service success rates across different product lines or business units. Higher counts may indicate either higher call volumes or less effective IVR systems that require human intervention. This data supports capacity planning, system optimization decisions, and resource allocation across different business lines within the customer care organization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd combined

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all LOBs and time periods

--- specific filters
--- no specific filters applied - comprehensive view across all business lines

--- calculation_logic
sum(combined.ivr_call_to_service_ticket) as ticket_count
group by combined.lob




## IVR Calls Count

This metric tracks the total volume of IVR (Interactive Voice Response) calls aggregated by week for the Care Dashboard MHD system. It measures customer service workload and call center activity by summing all IVR call interactions within weekly periods. The data comes from the combined services dataset and provides insights into call volume trends and patterns over time. The metric helps operations teams understand customer engagement levels, plan staffing requirements, and identify peak periods of customer service demand. No specific filters are applied, giving a complete view of all IVR call activity across the entire dataset timeframe.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter available but currently set to no filter
virtual_table.created_date IS NOT NULL

--- specific filters
--- none applied - showing all IVR call data

--- calculation_logic
SUM(virtual_table.ivr_calls) AS total_ivr_calls,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) AS week_period




## IVR Calls Count

This metric tracks the total volume of IVR (Interactive Voice Response) calls aggregated on a weekly basis for customer service operations monitoring. It measures customer engagement through automated phone systems, helping identify call volume patterns and trends over time. The metric sums all IVR calls from the combined service data and groups them by week, providing insights into customer service demand and system usage. This data supports capacity planning, staffing decisions, and understanding customer behavior patterns in the MHD business unit's care operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter allows flexible date range selection
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(virtual_table.ivr_calls) as total_ivr_calls,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_period




## Unique Merchant Count - IVR

This metric tracks the total count of unique merchants utilizing IVR (Interactive Voice Response) services, aggregated on a weekly basis. It serves as a key indicator for measuring merchant adoption and engagement with voice-based customer service channels. The data is sourced from the combined MHD (Merchant Help Desk) dataset and provides insights into merchant service utilization patterns over time. The weekly aggregation helps identify trends in IVR service usage, supporting capacity planning and service optimization decisions for merchant support operations.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - displays all available time periods

--- specific filters
--- temporal filter shows "No filter" - no date restrictions applied

--- calculation_logic
sum(ivr_merchant_count) as merchant_count,
date_trunc('week', CAST(created_date AS TIMESTAMP)) as time_dimension




## IVR Contact Ratio (%)

IVR Contact Ratio measures the percentage of interactions that utilize Interactive Voice Response systems relative to the total available contact opportunities. This metric helps assess customer preference for automated voice systems versus other contact channels and indicates the effectiveness of IVR deployment in the customer service ecosystem. The calculation divides total IVR calls by the maximum base count to determine penetration rate, with results aggregated monthly to track trends over time. This percentage-based metric enables comparison across different time periods and helps identify patterns in customer behavior regarding automated voice interaction preferences within the Care Dashboard MHD system.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for date range selection
virtual_table.created_date IS NOT NULL

--- specific filters
--- no additional specific filters beyond temporal range

--- calculation_logic
100 * SUM(virtual_table.ivr_calls) / NULLIF(MAX(virtual_table.cr_base_count), 0) AS ivr_contact_ratio_pct
GROUP BY date_trunc('month', CAST(virtual_table.created_date AS TIMESTAMP))




## Unique Merchant Count - IVR

This metric tracks the unique count of merchants utilizing IVR (Interactive Voice Response) services within the Care Dashboard ecosystem, providing insights into merchant adoption and engagement with voice-based support channels. The data is aggregated weekly to show trends in merchant participation over time, helping assess the effectiveness and reach of IVR services. The metric represents pre-calculated merchant counts that are summed across the specified time period, offering stakeholders visibility into merchant service utilization patterns and supporting operational planning for IVR infrastructure and support capacity.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - temporal range set to "No filter"

--- specific filters
--- weekly aggregation for trend analysis
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP))

--- calculation_logic
sum(virtual_table.ivr_merchant_count) as merchant_count




## MHD Agent Ticket Count - IVR

This metric tracks weekly ticket volumes for Mental Health Department (MHD) operations through IVR channels, measuring both agent-handled tickets and service-routed tickets. The MHD Agent metric counts phone tickets handled directly by agents, while the Service metric tracks tickets routed to service channels through IVR automation. This helps monitor call center performance, workload distribution, and the effectiveness of IVR routing decisions. The data is aggregated by week to identify trends in ticket volumes and the balance between human agent intervention versus automated service routing, enabling capacity planning and operational efficiency improvements for mental health support services.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter allows all time periods (no filter applied)
1 = 1

--- specific filters
--- no specific filters applied for this base metric

--- calculation_logic
sum(agent_ticket_count_phone) as mhd_agent_tickets,
sum(ivr_to_service_ticket_count) as service_routed_tickets,
date_trunc('week', cast(created_date as timestamp)) as week_period




## IVR Contact Ratio (%)

The IVR Contact Ratio tracks the percentage of customer interactions that utilize Interactive Voice Response systems relative to the total contact base count, aggregated monthly. This metric helps assess the effectiveness and adoption of automated customer service channels versus other contact methods. The calculation uses a safe division approach with NULLIF to prevent division by zero errors, ensuring robust reporting even when base counts are zero. The monthly aggregation provides trend analysis for contact center management to optimize resource allocation between automated and human-assisted customer service channels, enabling strategic decisions about IVR system investments and capacity planning.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter on creation date (default range applied)
date_trunc('month', CAST(virtual_table.created_date AS TIMESTAMP)) IS NOT NULL

--- specific filters
--- no additional specific filters applied

--- calculation_logic
100 * SUM(virtual_table.ivr_calls) / NULLIF(MAX(virtual_table.cr_base_count), 0) AS ivr_contact_ratio_pct,
GROUP BY date_trunc('month', CAST(virtual_table.created_date AS TIMESTAMP)),
ORDER BY ivr_contact_ratio_pct DESC




## Unique Merchant Count - MHD Agent (IVR)

This metric tracks unique merchant counts accessing MHD (Merchant Help Desk) support services through two primary channels: phone-based agent support and IVR (Interactive Voice Response) self-service. The business purpose is to monitor support channel utilization and merchant engagement patterns to optimize resource allocation and service delivery. Data is aggregated weekly to show trends in merchant support needs across different service channels. The metric helps identify whether merchants prefer human agent assistance or automated IVR services, enabling strategic decisions about support infrastructure and staffing. This operational dashboard supports the Care team in understanding merchant behavior and service demand patterns for the MHD platform.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for analysis period selection
virtual_table.created_date TEMPORAL_RANGE (configurable date range)

--- calculation_logic
SUM(virtual_table.agent_ticket_merchant_count_phone) as mhd_agent_count,
SUM(virtual_table.ivr_to_service_ticket_merchant_count) as service_count




## Unique Merchant Count - MHD Agent (IVR)

This metric tracks unique merchant counts seeking support through MHD (Merchant Help Desk) channels, specifically phone-based agent interactions and IVR-to-service ticket conversions. It measures merchant engagement with customer support services by counting distinct merchants who created tickets through each channel. The data is aggregated weekly to show trends in merchant support needs and channel preference over time. The MHD Agent metric captures merchants who directly contacted phone support, while the Service metric tracks merchants who escalated from IVR systems to service tickets. This helps identify support volume patterns and channel utilization for merchant assistance programs.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter (currently no specific filter applied)
virtual_table.created_date IS NOT NULL

--- specific filters
--- no additional filters specified

--- calculation_logic
SUM(virtual_table.agent_ticket_merchant_count_phone) as mhd_agent_count,
SUM(virtual_table.ivr_to_service_ticket_merchant_count) as service_count,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_period




## MHD Agent Ticket Count - IVR

This metric tracks MHD (Mobile Help Desk) ticket volumes specifically for the IVR channel, measuring both agent-handled phone tickets and service tickets that originate from IVR interactions. The chart aggregates data weekly to show trends in customer support ticket creation through voice channels. The "MHD Agent" metric captures tickets that require direct agent intervention via phone, while the "Service" metric tracks tickets routed to service teams from IVR systems. This analysis helps evaluate IVR channel effectiveness, agent workload distribution, and service ticket routing patterns. The weekly aggregation provides insights into support volume trends and helps identify peak periods for resource planning and IVR system optimization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different time range
--- temporal filter with default range (specific range not specified in metadata)
CAST(virtual_table.created_date AS TIMESTAMP) >= {default_start_date} AND
CAST(virtual_table.created_date AS TIMESTAMP) <= {default_end_date}

--- calculation_logic
sum(virtual_table.agent_ticket_count_phone) as mhd_agent_tickets,
SUM(virtual_table.ivr_to_service_ticket_count) as service_tickets,
date_trunc('week', CAST(virtual_table.created_date AS TIMESTAMP)) as week_period




## Monthly AVG Latency (seconds)

This metric tracks the monthly average system latency in seconds, providing insights into service performance trends across different months of the year. It calculates the mean response time from the overall latency analysis data, excluding January from the analysis period. The visualization helps identify seasonal patterns, performance degradation, or improvements in system responsiveness over time. This is essential for service level monitoring and capacity planning, allowing teams to correlate latency spikes with business cycles, system changes, or load variations throughout the year.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude january data from monthly analysis
ola.month_ > 1

--- calculation_logic
AVG(ola.all_avg_latency) as avg_latency,
CASE ola.month_
    WHEN 1 THEN 'January'
    WHEN 2 THEN 'February'
    WHEN 3 THEN 'March'
    WHEN 4 THEN 'April'
    WHEN 5 THEN 'May'
    WHEN 6 THEN 'June'
    WHEN 7 THEN 'July'
    WHEN 8 THEN 'August'
    WHEN 9 THEN 'September'
    WHEN 10 THEN 'October'
    WHEN 11 THEN 'November'
    WHEN 12 THEN 'December'
    ELSE 'Invalid'
END as month_name




## Monthly AVG Latency (seconds)

This metric tracks the monthly average system latency in seconds for MHD Care Dashboard operations, providing insights into service performance trends over time. The analysis excludes January data to focus on operational months, helping teams monitor system responsiveness and identify performance patterns. The latency measurement serves as a key performance indicator for system health, enabling proactive identification of performance degradation and supporting capacity planning decisions. This metric supports operational excellence by providing visibility into response times that directly impact user experience and service quality.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude january data from analysis
ola.month_ > 1

--- calculation_logic
AVG(ola.all_avg_latency) as avg_latency,
CASE ola.month_
  WHEN 1 THEN 'January'
  WHEN 2 THEN 'February'
  WHEN 3 THEN 'March'
  WHEN 4 THEN 'April'
  WHEN 5 THEN 'May'
  WHEN 6 THEN 'June'
  WHEN 7 THEN 'July'
  WHEN 8 THEN 'August'
  WHEN 9 THEN 'September'
  WHEN 10 THEN 'October'
  WHEN 11 THEN 'November'
  WHEN 12 THEN 'December'
  ELSE 'Invalid'
END as month_name,
MAX(ola.year_) * 100 + MAX(ola.month_) as year_month_sort




## Monthly Median Latency

This metric tracks average median latency performance across months to identify seasonal patterns and performance trends in system response times. It measures the monthly aggregation of median latency values from the overall latency analysis, excluding January data to focus on operational months. The metric helps the MHD team monitor system performance consistency, detect performance degradation patterns, and identify months with optimal or suboptimal latency characteristics. By averaging median values rather than using raw latency data, it provides a stable view of typical monthly performance while filtering out extreme outliers that could skew traditional mean calculations.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude January data from analysis
ola.month_ > 1

--- calculation_logic
AVG(ola.median_latency) as median_latency,
CASE ola.month_
  WHEN 1 THEN 'January' WHEN 2 THEN 'February' WHEN 3 THEN 'March'
  WHEN 4 THEN 'April' WHEN 5 THEN 'May' WHEN 6 THEN 'June'
  WHEN 7 THEN 'July' WHEN 8 THEN 'August' WHEN 9 THEN 'September'
  WHEN 10 THEN 'October' WHEN 11 THEN 'November' WHEN 12 THEN 'December'
  ELSE 'Invalid'
END as month_name




## Monthly Median Latency

Monthly Median Latency tracks the average of median latency values across different months to identify seasonal performance trends in the MHD care system. This metric helps operations teams understand latency patterns throughout the year by aggregating median response times on a monthly basis. The analysis excludes January data to focus on operational months (February through December), suggesting either incomplete January data or specific business requirements. The metric provides insights into system performance consistency and helps identify months with higher or lower latency trends for capacity planning and performance optimization initiatives.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude january data from analysis
ola.month_ > 1

--- calculation_logic
AVG(ola.median_latency) as median_latency,
CASE ola.month_
  WHEN 2 THEN 'February'
  WHEN 3 THEN 'March'
  WHEN 4 THEN 'April'
  WHEN 5 THEN 'May'
  WHEN 6 THEN 'June'
  WHEN 7 THEN 'July'
  WHEN 8 THEN 'August'
  WHEN 9 THEN 'September'
  WHEN 10 THEN 'October'
  WHEN 11 THEN 'November'
  WHEN 12 THEN 'December'
END AS month_name,
MAX(ola.year_) * 100 + MAX(ola.month_) AS year_month_sort




## Monthly P95 Latency

This metric tracks the average P95 latency performance across months to monitor system response time trends. P95 latency represents the 95th percentile response time, meaning 95% of requests complete faster than this threshold. The analysis excludes January data, focusing on operational months from February onwards. This metric helps identify performance degradation patterns, seasonal variations, and supports capacity planning decisions. The monthly aggregation provides a high-level view of system performance stability over time, enabling teams to detect long-term trends and correlate performance changes with system modifications or load variations.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 latency

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude january data (potentially incomplete or baseline month)
latency.month_ > 1

--- calculation_logic
AVG(latency.p95_latency) as P95,
CASE latency.month_
  WHEN 1 THEN 'January'
  WHEN 2 THEN 'February'
  WHEN 3 THEN 'March'
  WHEN 4 THEN 'April'
  WHEN 5 THEN 'May'
  WHEN 6 THEN 'June'
  WHEN 7 THEN 'July'
  WHEN 8 THEN 'August'
  WHEN 9 THEN 'September'
  WHEN 10 THEN 'October'
  WHEN 11 THEN 'November'
  WHEN 12 THEN 'December'
  ELSE 'Invalid'
END AS month_name




## Monthly P99 Latency

Monthly P99 Latency tracks the average 99th percentile response time performance across months, providing insights into system performance trends and identifying seasonal patterns in latency. This metric helps monitor service quality and detect performance degradation over time. The analysis excludes January data to focus on consistent operational periods, potentially avoiding holiday-period anomalies or incomplete data collection. P99 latency represents the response time threshold that 99% of requests complete under, making it a critical indicator for user experience quality. This dashboard serves the Care team for MHD product monitoring and performance optimization decisions.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude january data for consistent analysis
ola.month_ > 1

--- calculation_logic
AVG(ola.p99_latency) as p99_avg




## Monthly P90 Latency

This metric tracks monthly P90 latency performance by averaging P90 latency values across each month, excluding January from the analysis. P90 latency represents the 90th percentile response time, meaning 90% of requests complete faster than this threshold. The metric helps monitor system performance trends over time and identify seasonal patterns or degradation in service quality. It's particularly useful for SLA monitoring and capacity planning in the Care Dashboard context, where consistent low latency is critical for customer support operations.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude January from monthly analysis
ola.month_ > 1

--- calculation_logic
AVG(ola.p90_latency) AS p90_avg,
CASE ola.month_
    WHEN 1 THEN 'January'
    WHEN 2 THEN 'February'
    WHEN 3 THEN 'March'
    WHEN 4 THEN 'April'
    WHEN 5 THEN 'May'
    WHEN 6 THEN 'June'
    WHEN 7 THEN 'July'
    WHEN 8 THEN 'August'
    WHEN 9 THEN 'September'
    WHEN 10 THEN 'October'
    WHEN 11 THEN 'November'
    WHEN 12 THEN 'December'
END AS month_name




## Monthly P95 Latency

This metric tracks the average P95 latency performance across months to monitor system responsiveness and identify performance trends. P95 latency represents the 95th percentile of response times, meaning 95% of requests complete faster than this threshold. The analysis excludes January data to focus on operational months, likely for seasonal business reasons or data quality considerations. This metric serves as a key performance indicator for system health monitoring, enabling teams to detect performance degradation, assess the impact of system changes, and maintain service level agreements. The monthly aggregation provides insights into long-term performance trends and seasonal patterns in system behavior.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 lat

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude January data from analysis (operational requirement)
lat.month_ > 1

--- calculation_logic
AVG(lat.p95_latency) as p95_average,
CASE lat.month_
  WHEN 2 THEN 'February' WHEN 3 THEN 'March' WHEN 4 THEN 'April'
  WHEN 5 THEN 'May' WHEN 6 THEN 'June' WHEN 7 THEN 'July'
  WHEN 8 THEN 'August' WHEN 9 THEN 'September' WHEN 10 THEN 'October'
  WHEN 11 THEN 'November' WHEN 12 THEN 'December'
  ELSE 'Invalid'
END as month_name,
MAX(lat.year_) * 100 + MAX(lat.month_) as sort_key




## Monthly P90 Latency

Monthly P90 Latency tracks the average 90th percentile response time performance across months, providing insights into system performance trends and latency distribution patterns. This metric helps identify seasonal performance variations and long-term latency trends by aggregating P90 latency measurements monthly. The analysis excludes January data to focus on operational months, likely avoiding holiday or year-start anomalies. The metric serves as a key performance indicator for system reliability and user experience monitoring within the Care Dashboard MHD context, enabling performance optimization decisions based on historical latency patterns.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude January data to focus on operational performance periods
ola.month_ > 1

--- calculation_logic
AVG(ola.p90_latency) as P90,
CASE ola.month_
  WHEN 1 THEN 'January'
  WHEN 2 THEN 'February'
  WHEN 3 THEN 'March'
  WHEN 4 THEN 'April'
  WHEN 5 THEN 'May'
  WHEN 6 THEN 'June'
  WHEN 7 THEN 'July'
  WHEN 8 THEN 'August'
  WHEN 9 THEN 'September'
  WHEN 10 THEN 'October'
  WHEN 11 THEN 'November'
  WHEN 12 THEN 'December'
  ELSE 'Invalid'
END AS month_name,
MAX(ola.year_) * 100 + MAX(ola.month_) AS year_month_sort




## Monthly P99 Latency

This metric tracks the average 99th percentile latency performance across months, providing critical insight into system performance consistency for the MHD (likely customer service or product) team. The P99 latency represents the response time threshold that 99% of requests complete under, making it essential for identifying performance degradation and ensuring service quality standards. The monthly aggregation enables trend analysis and performance tracking over time, while excluding January data suggests either incomplete data collection or baseline establishment. This metric is crucial for capacity planning, SLA monitoring, and identifying seasonal performance patterns that could impact customer experience.

-- tables_involved
hive.team_cst_mhd_product.overall_latency_analysis1 ola

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude january data (possibly incomplete or baseline period)
ola.month_ > 1

--- calculation_logic
AVG(ola.p99_latency) as p99_avg




## MHD Language Select - Last Week

This metric tracks MHD (Merchant Help Desk) support ticket sessions segmented by customer language preferences to optimize support resource allocation and language coverage. It measures distinct support tickets created by merchants over the last week, categorized by the language used in conversations (English, Hindi, Telugu, Tamil, Marathi, Kannada, Gujarati, Bengali, Malayalam, Punjabi). The analysis focuses specifically on MHD role type users and excludes conversations marked as 'Others' language to provide clear insights into primary language usage patterns. This data helps support teams understand merchant communication preferences and ensure adequate language support coverage across different regions and user segments.

-- tables_involved
hive.crm_cst.support_ticket_details_snapshot_v3 std
hive.crm_cst.ticket_session_conversation_snapshot_v3 tsc

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance optimization
std.dl_last_updated >= CURRENT_DATE - INTERVAL '30' DAY AND
tsc.dl_last_updated >= CURRENT_DATE - INTERVAL '30' DAY AND
--- focus on ticket creation timeframe
DATE(std.created_at) >= CURRENT_DATE - INTERVAL '30' DAY AND
DATE(tsc.created_at) >= CURRENT_DATE - INTERVAL '30' DAY AND
--- ensure valid ticket records
std.id IS NOT NULL AND
--- filter for customer service and merchant help desk roles
std.role_type IN (1, 2) AND
--- restrict to specific source system
std.source = 100

--- specific filters
--- temporal filter for last week analysis
DATE(tsc.created_at) >= CURRENT_DATE - INTERVAL '7' DAY AND
DATE(tsc.created_at) < CURRENT_DATE AND
--- focus on MHD (Merchant Help Desk) interactions
std.type1 = 'MHD' AND
--- exclude unspecified languages for cleaner analysis
tsc.question_language_code IS NOT NULL AND
tsc.question_language_code <> 'Others'

--- calculation_logic
COUNT(DISTINCT tsc.ticket_id) as tickets,
CASE tsc.question_language_code 
  WHEN 'en' THEN 'English'
  WHEN 'hi' THEN 'Hindi' 
  WHEN 'te' THEN 'Telugu'
  WHEN 'mr' THEN 'Marathi'
  WHEN 'ta' THEN 'Tamil'
  WHEN 'kn' THEN 'Kannada'
  WHEN 'gu' THEN 'Gujarati'
  WHEN 'bn' THEN 'Bengali'
  WHEN 'ml' THEN 'Malayalam'
  WHEN 'pa' THEN 'Punjabi'
  ELSE 'Others'
END AS question_language_code




## MSAT + Fedback Given %

This metric tracks customer feedback engagement and satisfaction rates for MHD (Mobile Health Dashboard) care services. Feedback Received % measures the proportion of active sessions where users provided feedback, calculated as feedback_given divided by active_sessions. MSAT % (Mobile Satisfaction) measures the quality of that feedback, calculated as happy responses divided by total feedback_given. Both metrics include zero-division protection and are rounded to 2 decimal places. The metrics are typically filtered to show recent performance (last week by default) and help the care team understand both user engagement with feedback requests and overall satisfaction levels with the service experience.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 virtual_table

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for recent performance analysis
virtual_table.date_ >= DATE '2025-11-25' AND virtual_table.date_ < DATE '2025-12-02'

--- calculation_logic
CASE
  WHEN SUM(active_sessions) = 0 THEN 0
  ELSE ROUND(SUM(feedback_given) * 100.0 / SUM(active_sessions), 2)
END AS "Feedback Received %",
CASE
  WHEN SUM(feedback_given) = 0 THEN 0
  ELSE ROUND(SUM(happy) * 100.0 / SUM(feedback_given), 2)
END AS "MSAT %"




## MHD Language Select - Last Week

This metric tracks MHD (Merchant Help Desk) support ticket language selection patterns over the last week period. It measures the count of distinct support tickets segmented by question language including English, Hindi, Telugu, Marathi, Tamil, Kannada, Gujarati, Bengali, Malayalam, and Punjabi. The analysis focuses specifically on MHD role type sessions (merchants seeking support) and excludes generic 'Others' language category to provide clear visibility into specific regional language preferences. This helps understand merchant demographic patterns and language support demand, enabling better resource allocation for multilingual customer service teams and identifying which regional languages require enhanced support capabilities.

-- tables_involved
hive.crm_cst.support_ticket_details_snapshot_v3 std
hive.crm_cst.ticket_session_conversation_snapshot_v3 tsc

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to recent data for performance and relevance
std.dl_last_updated >= CURRENT_DATE - INTERVAL '30' DAY AND
DATE(std.created_at) >= CURRENT_DATE - INTERVAL '30' DAY AND
tsc.dl_last_updated >= CURRENT_DATE - INTERVAL '30' DAY AND
DATE(tsc.created_at) >= CURRENT_DATE - INTERVAL '30' DAY AND
--- exclude null ticket ids to ensure valid session data
std.id IS NOT NULL AND
--- filter for valid role types (CST=1, MHD=2)
std.role_type IN (1, 2) AND
--- source system filter for consistency
std.source = 100

--- specific filters
--- temporal range filter for last week analysis
DATE(tsc.created_at) >= CURRENT_DATE - INTERVAL '7' DAY AND
--- focus on MHD (merchant) support sessions only
std.role_type = 2 AND
--- exclude generic language category to focus on specific languages
tsc.question_language_code IS NOT NULL AND
tsc.question_language_code <> 'Others'

--- calculation_logic
COUNT(DISTINCT tsc.ticket_id) as tickets,
CASE tsc.question_language_code
  WHEN 'en' THEN 'English'
  WHEN 'hi' THEN 'Hindi' 
  WHEN 'te' THEN 'Telugu'
  WHEN 'mr' THEN 'Marathi'
  WHEN 'ta' THEN 'Tamil'
  WHEN 'kn' THEN 'Kannada'
  WHEN 'gu' THEN 'Gujarati'
  WHEN 'bn' THEN 'Bengali'
  WHEN 'ml' THEN 'Malayalam'
  WHEN 'pa' THEN 'Punjabi'
  ELSE 'Others'
END AS question_language_code




## Agent Ticket Inflow

This metric tracks customer care ticket inflow and performance across different issue categories for the MHD care team. It measures total ticket volume, distribution between agent-handled and service tickets, average turnaround time (TAT) in days for resolution, and customer satisfaction (MSAT) percentages. The analysis focuses on actionable ticket categories by excluding generic, duplicate, or non-service related issues from both L1 and L2 classifications. This enables care teams to identify high-volume issue areas, monitor resolution efficiency, and track customer satisfaction across different support channels and issue types for operational optimization and resource allocation decisions.

-- tables_involved
hive.team_servicesone.MHD_Agent_issue_l2_project_servicesone vt

--- standard filters to exclude non-actionable ticket categories
--- exclude generic and non-service L1 issue types
vt.issue_l1 NOT IN ('outbound call done', 'non risk hold queries', 'Others', 'sr - miscellaneous', 'others', 'corporate - others', 'p2p - other issues_mid', 'sr- other issues_mid', 'pspl - not related to pspl', 'pg - duplicate ticket', 'technical - staging issue web', 'contactless - other', 'pg-junk', 'agent missed to tag', 'junk', 'retail - non- contactable', 'pspl - call drop', 'retail - others', 'sr - no issue found', 'retail - requested call back', 'refund - other', 'dhd - issue not clear', 'technical - other', 'retail - other', 'bsr - prohibited lob', 'onus_hd - others_edu', 'ee - outbound activity', 'mit - others', 'erm:intro/engagement call', 'other iss', 'other issues', 'chd - other issues_mid') AND
--- exclude generic and untagged L2 issue types
NOT (vt.issue_l2 IS NULL OR vt.issue_l2 IN ('N/A', 'other issues', 'language barrier', 'prohibited issues', 'tag not available', 'others'))

--- specific filters
--- temporal filter available but currently set to no filter
--- vt.created_date temporal range filter (configurable)

--- calculation_logic
SUM(total_ticket_count) as total_tickets,
SUM(agent_ticket_count) as agent_tickets,
SUM(service_ticket_count) as service_tickets,
SUM(sum_tat_days) / NULLIF(SUM(tat_denominatior_tickets), 0) as avg_tat_days,
SUM(sum_mhd_tat_days) / NULLIF(SUM(mhd_tat_denominatior_tickets), 0) as mhd_tat_days,
SUM(sum_service_tat_days) / NULLIF(SUM(service_tat_denominatior_tickets), 0) as service_tat_days,
100 * SUM(total_tickets_msat_received) / NULLIF(SUM(total_tickets_feedback_received), 0) as overall_msat_pct,
100 * SUM(agent_tickets_msat_received) / NULLIF(SUM(agent_tickets_feedback_received), 0) as agent_msat_pct,
100 * SUM(service_tickets_msat_received) / NULLIF(SUM(service_tickets_feedback_received), 0) as service_msat_pct




## Agent Ticket Inflow

This metric tracks customer service ticket inflow analytics for the Mobile Help Desk (MHD) system, measuring ticket volumes, resolution efficiency, and customer satisfaction across different issue categories. It segments tickets by L1 and L2 issue classifications while filtering out non-actionable categories like junk tickets, miscellaneous issues, and various "others" classifications to focus on meaningful business problems. The analysis includes total ticket counts, channel-specific breakdowns (MHD Agent vs Service), turnaround time calculations for each channel, and customer satisfaction scores (MSAT) to provide comprehensive operational insights for customer care management and performance optimization.

-- tables_involved
hive.team_servicesone.MHD_Agent_issue_l2_project_servicesone virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude non-actionable L1 issue categories (junk, miscellaneous, others)
virtual_table.issue_l1 NOT IN ('outbound call done', 'non risk hold queries', 'Others', 'sr - miscellaneous', 'others', 'corporate - others', 'p2p - other issues_mid', 'sr- other issues_mid', 'pspl - not related to pspl', 'pg - duplicate ticket', 'technical - staging issue web', 'contactless - other', 'pg-junk', 'agent missed to tag', 'junk', 'retail - non- contactable', 'pspl - call drop', 'retail - others', 'sr - no issue found', 'retail - requested call back', 'refund - other', 'dhd - issue not clear', 'technical - other', 'retail - other', 'bsr - prohibited lob', 'onus_hd - others_edu', 'ee - outbound activity', 'mit - others', 'erm:intro/engagement call', 'other iss', 'other issues', 'chd - other issues_mid') AND
--- exclude non-actionable L2 issue categories (null, N/A, generic others)
NOT (virtual_table.issue_l2 IS NULL OR virtual_table.issue_l2 IN ('N/A', 'other issues', 'language barrier', 'prohibited issues', 'tag not available', 'others'))

--- specific filters
--- temporal filter for date range selection
--- virtual_table.created_date {temporal_range} (No filter currently applied)

--- calculation_logic
sum(total_ticket_count) as total_tickets,
sum(agent_ticket_count) as mhd_agent_tickets,
sum(service_ticket_count) as service_tickets,
sum(sum_tat_days)/nullif(sum(tat_denominatior_tickets),0) as overall_tat_days,
sum(sum_mhd_tat_days)/nullif(sum(mhd_tat_denominatior_tickets),0) as mhd_tat_days,
sum(sum_service_tat_days)/nullif(sum(service_tat_denominatior_tickets),0) as service_tat_days,
100 * sum(total_tickets_msat_received) / nullif(sum(total_tickets_feedback_received), 0) as overall_msat_percent,
100 * sum(agent_tickets_msat_received) / nullif(sum(agent_tickets_feedback_received), 0) as agent_msat_percent,
100 * sum(service_tickets_msat_received) / nullif(sum(service_tickets_feedback_received), 0) as service_msat_percent




## MSAT + Fedback Given %

This metric tracks customer satisfaction and feedback collection rates for MHD (Mobile Health Diagnostics) services within the care dashboard. It measures two key indicators: Feedback Received % calculates the proportion of active sessions where customers provided feedback, while MSAT % measures satisfaction levels among those who gave feedback (percentage rating service as "happy"). The metrics are filtered to show last week's data and grouped by day to track daily performance trends. Both calculations include zero-division protection to handle cases where no sessions or feedback occurred, ensuring reliable percentage reporting for care team performance monitoring.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for recent performance tracking
virtual_table.date_ >= DATE '2025-11-25' AND virtual_table.date_ < DATE '2025-12-02'

--- calculation_logic
CASE WHEN SUM(active_sessions) = 0 THEN 0 
     ELSE ROUND(SUM(feedback_given) * 100.0 / SUM(active_sessions), 2) END as feedback_received_pct,
CASE WHEN SUM(feedback_given) = 0 THEN 0 
     ELSE ROUND(SUM(happy) * 100.0 / SUM(feedback_given), 2) END as msat_pct




## Intent wise Tickets Creation %

This metric tracks the percentage of tickets that are successfully resolved on the first day (FD) for different customer service intents within the Care Dashboard. It measures operational efficiency by calculating what proportion of total tickets for each business category (Business Loan, Profile, Wealth, Soundbox Service, Soundbox Agent Handover, and Payout & Settlement) are resolved within the first day of creation. The metric helps identify which service areas have better first-day resolution rates, enabling teams to focus improvement efforts on underperforming categories. Data is filtered to show the most recent 7 days of activity, providing current operational insights for customer care performance management across different product verticals.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 dashboard

--- standard filters to be applied unless specifically requested for a different time period
--- recent activity analysis for current operational insights
dashboard.date_ >= CURRENT_DATE - INTERVAL '7' DAY

--- calculation_logic
pattern: first_day_resolution_percentage
base_metrics: {intent}_fd_tickets, {intent}_tickets
categories: [businessloan, profile, wealth, soundbox, payoutandsettlement]




## Intent wise Tickets Creation %

This metric measures the percentage of tickets that are successfully deflected or resolved through first-day resolution (FD) across different product and service categories including Business Loan, Profile, Wealth, SoundBox Service, SoundBox Agent Handover, and Payout & Settlement. The calculation represents the ticket deflection rate by dividing FD tickets by total tickets for each category and multiplying by 100. This helps the care team understand which product areas have better self-service or automated resolution capabilities. The metric is filtered to show the last 7 days of performance and provides insights into operational efficiency across different customer intents and service categories.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 dash

--- standard filters to be applied unless specifically requested for a different time period
--- last 7 days temporal filter for recent performance tracking
dash.date_ >= CURRENT_DATE - INTERVAL '7' DAY

--- specific filters
--- segmented by product/service category for intent-wise analysis
--- parameter values: p4bbusinessloan, p4bprofile, p4bwealth, p4bsoundbox, p4bpayoutandsettlement
{category}_tickets > 0 AND {category}_fd_tickets IS NOT NULL

--- calculation_logic
pattern: ticket_deflection_percentage
base_metrics: {category}_fd_tickets, {category}_tickets
formula: CASE WHEN SUM({category}_tickets) = 0 THEN NULL ELSE SUM({category}_fd_tickets) * 100/SUM({category}_tickets) END




## Function Calls #

This metric tracks daily function call volumes across six key merchant help desk operations over the past 7 days. It measures system usage for critical support functions including merchant detail fetching, agent handover processes, service request creation, settlement and payment information retrieval, soundbox hardware diagnostics, and test broadcast functionality. The data helps monitor operational load distribution across different MHD services, identify usage patterns, and assess system capacity needs. Each function serves distinct merchant support workflows, providing visibility into which services are most frequently accessed and helping optimize resource allocation for customer service operations.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 mhd

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for recent operational data analysis
mhd.date_ >= CURRENT_DATE - INTERVAL '7' DAY

--- calculation_logic
sum(mhd.fetch_merchant_sessions) as FetchMerchantDetails,
sum(mhd.agent_handover_attempts) as AgentHandover,
sum(mhd.raiseservicerequest_attempts) as RaiseServiceRequest,
sum(mhd.get_settlement_and_payment_info_attempts) as SettlementAndPaymentInfo,
sum(mhd.checksoundboxhardware_attempts) as CheckSoundboxHardware,
sum(mhd.testbroadcast_attempts) as TestBroadcast
GROUP BY date_trunc('day', CAST(mhd.date_ AS TIMESTAMP))




## Function Calls #

Function Calls tracks the volume of API function call attempts across six key merchant help desk operations: fetching merchant details, agent handover processes, service request creation, settlement and payment information retrieval, soundbox hardware diagnostics, and test broadcast functionality. This metric provides operational visibility into system usage patterns and function-specific demand over a rolling 7-day period. The data is aggregated daily to show trends in merchant support system utilization, helping identify peak usage periods and potential system performance bottlenecks across different operational functions.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 mhd

--- standard filters to be applied unless specifically requested for a different categorical value
--- rolling 7-day lookback for recent operational trends
mhd.date_ >= CURRENT_DATE - INTERVAL '7' DAY

--- calculation_logic
sum(mhd.fetch_merchant_sessions) as FetchMerchantDetails,
sum(mhd.agent_handover_attempts) as AgentHandover,
sum(mhd.raiseservicerequest_attempts) as RaiseServiceRequest,
sum(mhd.get_settlement_and_payment_info_attempts) as SettlementAndPaymentInfo,
sum(mhd.checksoundboxhardware_attempts) as CheckSoundboxHardware,
sum(mhd.testbroadcast_attempts) as TestBroadcast




## Language Change Metrics

Language Change Metrics tracks the frequency of language transitions made by users within the care/support system. This metric measures how often users switch from one language to another during their interactions, providing insights into multilingual user behavior and language preference patterns. The data excludes the current date to ensure only complete daily records are analyzed, and results are ordered by transition frequency to identify the most common language switches. This information helps optimize language support capabilities and understand user language preferences in customer care scenarios.

-- tables_involved
hive.team_cst_mhd_product.langauge_transition_base lt

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure complete daily data only
lt.date_ < CURRENT_DATE

--- specific filters
--- no additional specific filters applied

--- calculation_logic
sum(lt.transition_count) as language_change_count,
grouped by lt.language_transition




## Language Change Metrics

Language Change Metrics tracks the volume of language transitions made by users, measuring how frequently customers switch between different language preferences in the system. This metric aggregates transition counts by language transition type, providing insights into multilingual user behavior and language preference changes. The analysis focuses on historical data excluding the current date to ensure complete daily data capture. Results are ranked by transition volume to identify the most common language switching patterns, helping customer service teams understand language usage trends and optimize multilingual support capabilities.

-- tables_involved
hive.team_cst_mhd_product.langauge_transition_base lt

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current date to ensure complete daily data
lt.date_ < CURRENT_DATE

--- specific filters
--- no additional specific filters applied

--- calculation_logic
sum(lt.transition_count) as language_change_count,
group by lt.language_transition,
order by language_change_count desc,
limit 10




## Intent wise Bot MSAT %

Bot MSAT % measures merchant satisfaction with bot interactions by calculating the percentage of positive feedback (bot_happy) out of total feedback provided (bot_feedback_given). This metric helps evaluate bot performance and merchant experience quality in customer service interactions. The calculation includes safeguards against division by zero, returning 0% when no feedback is available. Data is filtered to exclude IVR merchant entities and focuses on recent performance over the last week timeframe, providing insights into current bot effectiveness across different customer service entities.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude IVR merchant interactions from satisfaction analysis
msat.cst_entity <> 'ivr-merchant' AND
--- temporal filter for recent performance analysis
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02'

--- calculation_logic
CASE 
  WHEN SUM(bot_feedback_given) = 0.00 THEN 0.00
  ELSE SUM(bot_happy) * 100.00 / SUM(bot_feedback_given)
END




## Intent wise Bot MSAT %

Bot MSAT % measures merchant satisfaction with bot interactions by calculating the percentage of positive feedback received. This metric divides the sum of happy bot interactions by total bot feedback given, multiplied by 100, with a zero-division safety check. It's filtered to exclude IVR merchant entities and typically analyzed over the last week period. The metric helps evaluate bot performance in customer service scenarios within the Care Dashboard, providing insights into how well automated interactions are meeting merchant expectations and identifying areas for bot improvement.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude IVR merchant interactions from satisfaction analysis
msat.cst_entity <> 'ivr-merchant'

--- specific filters
--- temporal filter for recent analysis period
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02'

--- calculation_logic
CASE 
  WHEN SUM(bot_feedback_given) = 0.00 THEN 0.00
  ELSE SUM(bot_happy) * 100.00 / SUM(bot_feedback_given)
END




## Bot MSAT + Fedback Rate %

This metric tracks bot customer satisfaction performance by measuring both feedback collection effectiveness and customer satisfaction rates. The Feedback Received percentage shows what proportion of active bot sessions resulted in user feedback, indicating engagement levels. The MSAT (Mean Satisfaction) percentage shows what proportion of collected feedback was positive, measuring actual satisfaction. These metrics are filtered to show last week's performance with daily granularity, helping monitor bot performance trends and identify areas for improvement in the mental health care chatbot service.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 virtual_table

--- standard filters to be applied unless specifically requested for a different time period
--- temporal range filter for recent performance analysis
date_ >= DATE '2025-11-25' AND date_ < DATE '2025-12-02'

--- calculation_logic
-- Feedback Collection Rate
CASE
  WHEN SUM(active_sessions) = 0
  THEN 0
  ELSE ROUND(
    SUM(bot_feedback_given) * 100.0
    /
    SUM(active_sessions),
    2
  )
END AS "Feedback Received %"

-- Customer Satisfaction Rate  
CASE
  WHEN SUM(bot_feedback_given) = 0
  THEN 0
  ELSE ROUND(
    SUM(bot_happy) * 100.0
    /
    SUM(feedback_given),
    2
  )
END AS "MSAT %"




## Bot MSAT + Fedback Rate %

This chart tracks customer satisfaction metrics for the MHD (MyHealth Dashboard) care service by measuring feedback engagement and satisfaction rates. The Feedback Received % indicates what proportion of active user sessions resulted in feedback submission, measuring customer engagement with the feedback system. The MSAT % (Most Satisfied) represents the percentage of submitted feedback that was positive, indicating customer satisfaction levels. Both metrics are calculated with zero-division protection and filtered to show the last week's performance with daily breakdowns. These metrics help evaluate both the effectiveness of feedback collection mechanisms and overall customer satisfaction trends for care services.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 virtual_table

--- standard filters to be applied unless specifically requested for a different time range
--- temporal filter for recent performance analysis
date_ >= DATE '2025-11-25' AND date_ < DATE '2025-12-02'

--- calculation_logic
CASE
  WHEN SUM(active_sessions) = 0
  THEN 0
  ELSE ROUND(SUM(bot_feedback_given) * 100.0 / SUM(active_sessions), 2)
END AS feedback_received_pct,
CASE
  WHEN SUM(bot_feedback_given) = 0
  THEN 0
  ELSE ROUND(SUM(bot_happy) * 100.0 / SUM(feedback_given), 2)
END AS msat_pct




## Ticket MSAT + Feedback Rate %

This metric tracks customer feedback effectiveness and satisfaction in the care support system. It measures two key performance indicators: the percentage of support tickets that received agent feedback from customers, and the percentage of positive satisfaction (MSAT) among those who provided feedback. The metrics help evaluate both the feedback collection process efficiency and actual customer satisfaction with agent support. Data is filtered to show the last week's performance and is aggregated daily to track trends. The calculations include zero-division protection to ensure robust reporting even when no tickets or feedback are recorded on specific days.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for recent performance tracking (last week by default)
msat.date_ >= CURRENT_DATE - INTERVAL '7' DAY AND
msat.date_ < CURRENT_DATE

--- calculation_logic
CASE
  WHEN SUM(msat.fd_tickets) = 0 THEN 0
  ELSE ROUND(SUM(msat.agent_feedback_given) * 100.0 / SUM(msat.fd_tickets), 2)
END AS feedback_received_pct,
CASE
  WHEN SUM(msat.agent_feedback_given) = 0 THEN 0
  ELSE ROUND(SUM(msat.agent_happy) * 100.0 / SUM(msat.agent_feedback_given), 2)
END AS msat_pct




## Ticket MSAT + Feedback Rate %

This metric tracks customer service feedback collection effectiveness and satisfaction rates for MHD (customer care). Feedback Received % measures what portion of total tickets received agent feedback, while MSAT % shows the satisfaction rate among customers who provided feedback. The metrics are filtered to last week's data and grouped by day to show daily trends. Both calculations include zero-division protection to handle cases where no tickets exist or no feedback was given. This helps customer care teams monitor both their feedback collection process efficiency and actual customer satisfaction levels, providing insights into service quality and engagement rates.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for recent performance analysis
msat.date_ >= CURRENT_DATE - INTERVAL '7' DAY AND
msat.date_ < CURRENT_DATE

--- calculation_logic
CASE
  WHEN SUM(fd_tickets) = 0 THEN 0
  ELSE ROUND(SUM(agent_feedback_given) * 100.0 / SUM(fd_tickets), 2)
END AS feedback_received_pct,
CASE
  WHEN SUM(agent_feedback_given) = 0 THEN 0
  ELSE ROUND(SUM(agent_happy) * 100.0 / SUM(agent_feedback_given), 2)
END AS msat_pct




## Intent wise Ticket Only MSAT %

Bot MSAT % measures the mean satisfaction percentage for bot interactions across different customer service entities in the MHD (Merchant Help Desk) system. This metric tracks agent satisfaction by calculating the ratio of positive feedback (agent_happy) to total feedback received (agent_feedback_given), expressed as a percentage. The analysis focuses on bot performance over the last week and excludes non-relevant entities like IVR merchant services, P4B soundbox, and wealth management channels. This helps identify which customer service entities are delivering satisfactory bot experiences and enables performance optimization across different service channels within the care ecosystem.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for recent performance analysis
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02' AND

--- specific filters
--- exclude non-bot service channels that are not relevant for bot satisfaction analysis
msat.cst_entity NOT IN ('ivr-merchant', 'p4bsoundbox', 'all_others', 'p4bwealth')

--- calculation_logic
CASE 
  WHEN SUM(agent_feedback_given) = 0.00 THEN 0.00
  ELSE SUM(agent_happy) * 100.00 / SUM(agent_feedback_given)
END as bot_msat_percentage




## Service Ticket MSAT + Feedback Rate %

This metric tracks customer service performance through two key indicators: feedback collection rate and customer satisfaction scores. The Feedback Received % measures what proportion of service tickets (fd_tickets) result in customer feedback (service_feedback_given), while MSAT % calculates the satisfaction rate among customers who provided feedback (service_happy divided by service_feedback_given). Both percentages include zero-division protection and are rounded to two decimal places. The analysis is typically filtered to recent time periods (last week by default) and grouped by day to show daily trends in customer service engagement and satisfaction levels.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for recent service performance analysis
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02'

--- specific filters
--- exclude future dates to ensure data accuracy
msat.date_ < CURRENT_DATE

--- calculation_logic
CASE WHEN SUM(fd_tickets) = 0 THEN 0 ELSE ROUND(SUM(service_feedback_given) * 100.0 / SUM(fd_tickets), 2) END as feedback_received_pct,
CASE WHEN SUM(service_feedback_given) = 0 THEN 0 ELSE ROUND(SUM(service_happy) * 100.0 / SUM(service_feedback_given), 2) END as msat_pct




## Intent wise Ticket Only MSAT %

This metric tracks Bot MSAT (Merchant Satisfaction) percentage across different customer entities, measuring the ratio of positive agent feedback to total feedback given. It calculates satisfaction as a percentage where agent_happy responses are divided by total agent_feedback_given, with zero-division protection returning 0% when no feedback exists. The analysis focuses on the previous week's performance and excludes non-merchant entities like IVR merchant, soundbox services, and wealth products to maintain focus on core merchant satisfaction metrics. This KPI helps evaluate bot performance effectiveness in resolving merchant queries and maintaining satisfaction levels across different customer segments.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different time period
--- temporal filter for weekly performance analysis
msat.date_ >= DATE(CURRENT_DATE - INTERVAL '7' DAY) AND msat.date_ < CURRENT_DATE AND

--- standard filters to focus on relevant merchant entities
--- exclude non-merchant services and miscellaneous categories
msat.cst_entity NOT IN ('ivr-merchant', 'p4bsoundbox', 'all_others', 'p4bwealth')

--- calculation_logic
CASE 
  WHEN SUM(agent_feedback_given) = 0.00 THEN 0.00
  ELSE SUM(agent_happy) * 100.00 / SUM(agent_feedback_given)
END as bot_msat_percentage




## Service Ticket MSAT + Feedback Rate %

This metric tracks customer service performance through two complementary KPIs for the Care Dashboard-MHD system. The "Feedback Received %" measures the percentage of service tickets (fd_tickets) that received customer feedback (service_feedback_given), indicating the effectiveness of feedback collection processes. The "MSAT %" (satisfaction rate) calculates the percentage of positive responses (service_happy) among customers who provided feedback, measuring actual customer satisfaction levels. Both metrics include zero-division protection and are typically viewed for recent time periods to monitor service quality trends. These metrics help evaluate both the reach of feedback collection efforts and the quality of service delivery, providing insights into customer experience and service team performance.

-- tables_involved
hive.team_cst_mhd_product.mhd_msat_monthly_dashboard1 msat

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for recent performance analysis
msat.date_ >= DATE '2025-11-25' AND msat.date_ < DATE '2025-12-02'

--- calculation_logic
CASE
  WHEN SUM(fd_tickets) = 0 THEN 0
  ELSE ROUND(SUM(service_feedback_given) * 100.0 / SUM(fd_tickets), 2)
END AS feedback_received_pct,
CASE
  WHEN SUM(service_feedback_given) = 0 THEN 0
  ELSE ROUND(SUM(service_happy) * 100.0 / SUM(service_feedback_given), 2)
END AS msat_pct




## Bot CTR % (Distinct User Level)

This metric measures Call-to-Action (CTA) click-through rates at the distinct user level for the MHD care dashboard, tracking user engagement with different CTA types. It calculates the percentage of users who clicked on CTAs out of those who were shown them, providing insights into CTA effectiveness. The analysis is filtered to MHD client type and covers the last week's data, segmented by CTA type (event_label2). This helps identify which CTAs are most effective at driving user interaction and can inform UX optimization decisions. The metric prevents division by zero and returns null when no users were shown a particular CTA.

-- tables_involved
hive.team_cst_mhd_product.cst_mhd_ctr virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to MHD client type for care dashboard context
virtual_table.client_type = 'MHD' AND
--- temporal filter for recent performance analysis
virtual_table.date_ >= DATE '2025-11-25' AND virtual_table.date_ < DATE '2025-12-02'

--- specific filters
--- group by CTA type for segmented analysis
GROUP BY virtual_table.event_label2

--- calculation_logic
sum(virtual_table.users_shown) as cta_displayed,
sum(virtual_table.users_clicked) as cta_clicked,
CASE 
  WHEN SUM(virtual_table.users_shown) = 0 THEN NULL
  ELSE CAST((SUM(virtual_table.users_clicked) * 100) AS DOUBLE)/ CAST(SUM(virtual_table.users_shown) AS DOUBLE)
END as ctr_percentage




## Bot CTR % (Distinct User Level)

Bot CTR % measures click-through rate effectiveness for call-to-action elements within the MHD mobile health application at the distinct user level. This metric calculates the percentage of users who clicked on specific CTAs after being displayed them, providing insights into user engagement and interface effectiveness. The analysis is filtered to MHD client type and covers the last week's performance data. Results are segmented by CTA type (event_label2) and ranked by display volume to prioritize high-traffic CTAs. The metric includes safeguards against division by zero and presents three complementary measurements: total users shown CTAs, users who clicked, and the resulting conversion percentage for optimizing user experience design.

-- tables_involved
hive.team_cst_mhd_product.cst_mhd_ctr ctr

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to Mobile Health Dashboard client application
ctr.client_type = 'MHD' AND
--- temporal scope for weekly performance analysis
ctr.date_ >= DATE '2025-11-25' AND ctr.date_ < DATE '2025-12-02'

--- calculation_logic
sum(ctr.users_shown) as cta_displayed_count,
sum(ctr.users_clicked) as cta_clicked_count,
CASE 
  WHEN SUM(ctr.users_shown) = 0 THEN NULL
  ELSE CAST((SUM(ctr.users_clicked) * 100) AS DOUBLE) / CAST(SUM(ctr.users_shown) AS DOUBLE)
END as ctr_percentage




## Weekly_Metrics_Insights_MHD

This metric provides a comprehensive weekly overview of MHD (Multi-Channel Help Desk) performance across all customer service channels including IVR calls, bot interactions, and human agent support. It tracks key operational metrics such as contact ratios (percentage of customers using each channel relative to the base customer count), customer satisfaction scores (MSAT), feedback response rates, and escalation patterns between service tiers. The metrics help evaluate the effectiveness of automated channels (IVR and bot) versus human agents, measure customer satisfaction levels, and analyze how tickets flow from bot interactions to either MHD agents or specialized service teams. This comprehensive view enables performance monitoring and optimization of the entire customer support ecosystem.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - includes all MHD data

--- specific filters
--- no specific filters applied - comprehensive view of all weekly metrics

--- calculation_logic
pattern: percentage_ratio_with_nullif_protection
pattern: contact_ratio_calculation
pattern: satisfaction_percentage_calculation




## Weekly_Metrics_Insights_MHD

This metric provides comprehensive weekly insights into MHD (Multi-Channel Help Desk) performance across multiple customer service channels including IVR calls, bot interactions, and agent support. It tracks key operational metrics such as contact volumes, customer satisfaction scores (MSAT), feedback response rates, and escalation patterns between bot and human agents. The analysis includes contact ratios calculated against a base count, passthrough rates showing escalation from bot to MHD agents or service teams, and satisfaction percentages for both bot and agent interactions. This consolidated view enables management to monitor service quality, channel effectiveness, and customer experience trends on a weekly basis for strategic decision-making and operational optimization.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no specific filters applied - includes all available data

--- specific filters
--- no additional filters specified

--- calculation_logic
pattern: contact_ratio_calculation
pattern: satisfaction_percentage_calculation  
pattern: passthrough_rate_calculation
week_dimension: min(created_week)
volume_metrics: sum(ivr_calls), sum(bot_ticket_count), sum(agent_ticket_count_bot), sum(bot_to_service_ticket_count)
combined_agent_tickets: sum(agent_ticket_count_bot) + sum(bot_to_service_ticket_count)




## Weekly_Metrics_Insights_1_MHD

This comprehensive weekly customer service metrics dashboard tracks the complete MHD operational funnel from initial customer contact through resolution and satisfaction measurement. It monitors contact volumes via IVR calls and bot tickets, calculates contact ratios normalized against base counts, tracks escalation pathways including bot-to-MHD and bot-to-service passthrough rates, and measures customer satisfaction through feedback collection percentages and MSAT scores for both bot and human agent interactions. The metrics provide operational insights into channel efficiency, escalation patterns, and service quality across the multi-channel help desk ecosystem, enabling performance optimization and resource allocation decisions.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no specific filters applied - shows all available data

--- specific filters
--- no additional filters specified

--- calculation_logic
pattern: weekly_customer_service_metrics
base_metrics: SUM(ivr_calls), SUM(bot_ticket_count), SUM(agent_ticket_count_bot), SUM(bot_to_service_ticket_count)
ratio_calculations: contact_ratio_percentage, passthrough_percentage, feedback_percentage, msat_percentage
time_dimension: MIN(created_week)




## Monthly_Metrics_Insights_MHD

Monthly MHD Metrics Insights tracks comprehensive customer service performance across multiple channels including IVR calls, bot interactions, and human agent support. This dashboard aggregates monthly data to measure contact ratios (IVR and bot volume relative to customer base), satisfaction scores (MSAT percentages), feedback collection rates, and escalation patterns from bot to human agents. The metrics provide insights into customer service efficiency, channel effectiveness, and quality measurements through satisfaction feedback. Key performance indicators include bot-to-agent passthrough rates, feedback collection percentages, and satisfaction scores across different service touchpoints, enabling management to assess overall service quality and channel optimization opportunities.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - chart shows all monthly data

--- specific filters
--- no specific filters applied - aggregates all available monthly data

--- calculation_logic
pattern: contact_ratio_percentage
pattern: satisfaction_percentage_calculation
pattern: passthrough_percentage_calculation
SUM(agent_ticket_count_bot) + SUM(bot_to_service_ticket_count) as combined_agent_tickets




## Weekly_Metrics_Insights_1_MHD

Weekly MHD Metrics Insights tracks comprehensive customer service operations across multiple channels including IVR, chatbot, and human agent interactions. The metrics measure contact volume, service efficiency ratios calculated against a base count denominator, customer satisfaction through feedback percentages and MSAT scores, and operational flow tracking bot-to-agent passthrough rates. This consolidated view enables monitoring of the entire customer support funnel from initial contact through resolution, helping identify bottlenecks and optimization opportunities in the MHD service delivery model across weekly time periods.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no specific filters applied - captures all MHD service data

--- specific filters
--- no additional filtering - comprehensive weekly aggregation

--- calculation_logic
pattern: contact_ratio_calculation
pattern: feedback_satisfaction_metrics
pattern: passthrough_rate_calculation
specific: SUM(agent_ticket_count_bot)+SUM(bot_to_service_ticket_count) as combined_agent_tickets




## Monthly_Metrics_Insights_MHD

This comprehensive MHD customer service dashboard tracks the complete customer support journey across multiple touchpoints including IVR calls, bot interactions, and human agent escalations. It measures key performance indicators such as contact ratios (percentage of customers using each channel), satisfaction scores (MSAT), feedback collection rates, and channel passthrough percentages (bot to human agent escalation rates). The metrics provide monthly aggregated insights into customer service efficiency, channel effectiveness, and satisfaction outcomes. All calculations use null-safe ratio formulas to ensure accurate percentage computations even when denominators are zero, enabling reliable month-over-month performance tracking and identifying optimization opportunities across the customer service ecosystem.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no additional filters applied - shows all monthly data

--- specific filters
--- no specific filters applied

--- calculation_logic
pattern: percentage_ratio_calculation
base_metrics: sum(ivr_calls), sum(bot_ticket_count), sum(bot_total_responses), sum(bot_positive_response), sum(agent_ticket_count_bot), sum(bot_to_service_ticket_count), sum(agent_tickets_feedback_received), sum(agent_tickets_msat_received)
denominators: max(cr_base_count), sum(bot_active_ticket_count), sum(bot_total_responses), sum(agent_tickets_for_response)
additional: min(created_month) for time dimension, combined ticket counts for total escalations




## Monthly_Metrics_Insights_MHD

Monthly MHD Insights tracks comprehensive customer support performance metrics including IVR call volumes, bot interaction statistics, agent ticket counts, and satisfaction scores across different support channels. The metrics provide visibility into contact ratios (how many customers use IVR/bot relative to the base), bot effectiveness through MSAT scores and passthrough rates, and agent performance through feedback percentages. Key performance indicators include bot-to-human handoff rates for both MHD agents and service teams, customer satisfaction percentages, and overall ticket volumes to assess support channel efficiency and customer experience quality month over month.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all monthly data

--- specific filters
--- no specific filters applied - comprehensive monthly view

--- calculation_logic
pattern: percentage_with_nullif_protection
pattern: contact_ratio_calculation
pattern: satisfaction_score_calculation




## Monthly_Metrics_Insights_MHD

This comprehensive monthly metrics dashboard tracks customer care performance across multiple service channels including IVR, chatbot, and human agents. It measures contact volumes (IVR calls, bot tickets), contact ratios as percentages of the customer base, customer satisfaction metrics (feedback rates and MSAT scores), and operational efficiency through passthrough rates between service tiers. The metrics provide insights into channel utilization, customer engagement levels, service quality through satisfaction scores, and operational flow efficiency from bot to human agents. This enables monitoring of overall customer care ecosystem health, identifying bottlenecks in service delivery, and measuring both quantitative performance (volumes, ratios) and qualitative outcomes (customer satisfaction) across the integrated support infrastructure.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd combined_data

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - shows all monthly data

--- specific filters
--- no specific filters applied - comprehensive monthly view

--- calculation_logic
pattern: contact_ratio_calculation
pattern: feedback_percentage_calculation
pattern: satisfaction_percentage_calculation
pattern: passthrough_rate_calculation
SUM(agent_ticket_count_bot) + SUM(bot_to_service_ticket_count) as combined_agent_tickets,
MIN(created_month) as month_identifier




## Monthly Sessions + Agent Handover + Service Tickets

This chart tracks three essential customer care operational metrics on a monthly basis for the MHD (Mental Health Dashboard) care system. Active Sessions measures the total volume of customer interactions or support sessions handled each month, providing insight into customer engagement levels and support demand. Agent Tickets represents the number of support cases escalated to human agents, indicating complex issues requiring personalized assistance. Service Tickets captures the total volume of service requests or technical issues raised by customers. The temporal filter restricts analysis to current year data starting from February 2025, enabling teams to monitor monthly trends in customer support workload, escalation patterns, and service request volumes to optimize staffing and identify operational improvements.

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 dashboard

--- standard filters to be applied unless specifically requested for a different temporal range
--- temporal filter for current year analysis starting from February 2025
dashboard.date_ >= DATE '2025-02-01' AND
--- upper bound filter to current date for real-time analysis
dashboard.date_ < DATE '2025-12-02'

--- calculation_logic
sum(dashboard.active_sessions) as active_sessions,
sum(dashboard.agent_tickets) as agent_tickets, 
sum(dashboard.service_tickets) as service_tickets




## Monthly_Metrics_Insights_MHD_

This dashboard tracks monthly customer service performance metrics across multiple channels including IVR calls, bot interactions, and human agent escalations. It measures contact ratios showing volume relative to customer base, bot effectiveness through feedback percentages and satisfaction scores (MSAT), escalation patterns from bot to both MHD agents and service teams, and overall agent performance metrics. The data provides operational insights for optimizing customer service delivery, identifying bottlenecks in the support funnel, and monitoring satisfaction trends across automated and human-assisted service channels. All metrics are aggregated at monthly level without additional filters applied.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no specific filters applied - showing all available monthly data

--- specific filters
--- no additional filtering conditions

--- calculation_logic
pattern: percentage_ratio_calculations
base_metrics: SUM(ivr_calls), SUM(bot_ticket_count), SUM(bot_total_responses), SUM(bot_positive_response), SUM(agent_ticket_count_bot), SUM(bot_to_service_ticket_count), SUM(agent_tickets_feedback_received), SUM(agent_tickets_msat_received)
denominators: MAX(cr_base_count), SUM(bot_active_ticket_count), SUM(bot_total_responses), SUM(agent_tickets_for_response)




## Monthly_Metrics_Insights_MHD_

This metric tracks comprehensive monthly performance across the MHD care ecosystem, measuring customer support effectiveness from initial contact through resolution. It encompasses IVR call volumes, bot interaction metrics including ticket counts and satisfaction scores, agent handoff rates from bot to both MHD and service teams, and feedback collection rates. The metrics provide a complete view of support channel performance including contact ratios (percentage of customers using each channel), satisfaction rates (MSAT percentages), and operational efficiency through passthrough rates showing how often automated channels escalate to human agents. This enables monthly performance tracking and optimization of the multi-channel support funnel.

-- tables_involved
hive.team_servicesone.combined_data_project_servicesone_mhd virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- no standard filters applied - organization-wide monthly aggregation

--- specific filters
--- no specific filters applied - comprehensive monthly view

--- calculation_logic
pattern: monthly_care_metrics_aggregation
base_metrics: [ivr_calls, bot_ticket_count, agent_ticket_count_bot, bot_to_service_ticket_count]
ratio_calculations: contact_ratios, feedback_percentages, satisfaction_scores, passthrough_rates
time_dimension: created_month (MIN for grouping)




## Monthly Sessions + Agent Handover + Service Tickets

This metric tracks monthly customer care activity across three key dimensions: active user sessions, agent-handled tickets, and service tickets. It provides a comprehensive view of customer support volume and engagement patterns for the MHD product area. The data is aggregated monthly to show trends in customer interaction levels, support demand, and service delivery capacity. This consolidated view helps care teams understand seasonal patterns, resource allocation needs, and overall customer engagement health by combining self-service activity (sessions) with assisted support metrics (agent and service tickets).

-- tables_involved
hive.team_cst_mhd_product.mhd_monthly_dashboard1 dashboard

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal filter for current year data
dashboard.date_ >= DATE '2025-02-01' AND dashboard.date_ < current_date + interval '1' day

--- calculation_logic
sum(dashboard.active_sessions) as active_sessions,
sum(dashboard.agent_tickets) as agent_tickets,
sum(dashboard.service_tickets) as service_tickets,
date_trunc('month', dashboard.date_) as month





================================================================================
## Dashboard 72
================================================================================

## LLM L1 Metrics

This metric tracks comprehensive LLM chatbot performance across multiple dimensions including operational volume, quality scores, user satisfaction, and failure rates. It measures active sessions as the base volume metric, along with quality indicators like evaluation scores, response relevance, empathy, and resolution achievement rates (all averaged and converted to percentages). User satisfaction is captured through MSAT percentage and positive sentiment change. Failure detection includes bad evaluation share, intent detection failures, bot repetition issues, function call failures, and topic drift metrics. The analysis is segmented by problem description categories and filtered for specific CST entities (p4bsoundbox and p4bAIBot), excluding unanalyzed data, providing stakeholders with a holistic view of AI system performance for optimization and quality assurance purposes.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for different entities
--- limit data to previous days only, excluding current day for data completeness
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY AND
--- filter for specific CST entities in scope for this analysis
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- exclude records that haven't been properly analyzed
eval.description != 'Not Analyzed'

--- specific filters
--- group by problem description to analyze performance by issue category
GROUP BY eval.out_key_problem_desc

--- calculation_logic
SUM(active_sessions) as volume_base,
AVG(avg_eval_score) * 100 as quality_score_pct,
AVG(avg_response_relevance_score) * 100 as relevance_score_pct,
AVG(avg_empathy_score) * 100 as empathy_score_pct,
AVG(avg_resolution_achieved) * 100 as resolution_score_pct,
AVG(avg_topic_drift) * 100 as topic_drift_score_pct,
pattern: satisfaction_percentage_with_null_check,
pattern: failure_rate_percentage_with_null_check




## LLM L1 Metrics

This metric tracks comprehensive LLM chatbot performance across multiple dimensions including operational volume, quality scores, user satisfaction, and failure rates. It measures active sessions as the base volume metric, along with quality indicators like evaluation scores, response relevance, empathy, and resolution achievement rates (all averaged and converted to percentages). User satisfaction is captured through MSAT percentage and positive sentiment change. Failure detection includes bad evaluation share, intent detection failures, bot repetition issues, function call failures, and topic drift metrics. The analysis is segmented by problem description categories and filtered for specific CST entities (p4bsoundbox and p4bAIBot), excluding unanalyzed data, providing stakeholders with a holistic view of AI system performance for optimization and quality assurance purposes.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for different entities
--- limit data to previous days only, excluding current day for data completeness
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY AND
--- filter for specific CST entities in scope for this analysis
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- exclude records that haven't been properly analyzed
eval.description != 'Not Analyzed'

--- specific filters
--- group by problem description to analyze performance by issue category
GROUP BY eval.out_key_problem_desc

--- calculation_logic
SUM(active_sessions) as volume_base,
AVG(avg_eval_score) * 100 as quality_score_pct,
AVG(avg_response_relevance_score) * 100 as relevance_score_pct,
AVG(avg_empathy_score) * 100 as empathy_score_pct,
AVG(avg_resolution_achieved) * 100 as resolution_score_pct,
AVG(avg_topic_drift) * 100 as topic_drift_score_pct,
pattern: satisfaction_percentage_with_null_check,
pattern: failure_rate_percentage_with_null_check




## Daily Quality Metrics Trend (%)

This metric tracks daily quality performance indicators for customer service operations, measuring evaluation scores, bot containment effectiveness, customer satisfaction, and quality issues as percentage trends. The analysis focuses on soundbox and AI bot entities (p4bsoundbox, p4bAIBot) to monitor service quality over time. Bot containment measures how well automated systems handle queries without escalation to human agents, while MSAT tracks customer satisfaction based on happy/sad feedback. Average evaluation score reflects overall service quality ratings, and bad evaluation share identifies the proportion of negative assessments. These metrics provide comprehensive quality monitoring for customer service optimization and performance management.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for different entities
--- customer service entity filtering for soundbox and AI bot operations
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND

--- specific filters
--- temporal range filter available but no default applied
--- date range can be specified using date_ column

--- calculation_logic
pattern: percentage_with_null_handling
metrics: avg_eval_score * 100, bot_containment_rate, satisfaction_rate, bad_eval_share
aggregation: daily (date_trunc('day', date_))




## Analyzed + Eval Completed % - Complete Day

This metric tracks the completion rates of customer support evaluation processes for soundbox and AI bot entities. It measures two key performance indicators: the percentage of active sessions that were analyzed (Analyzed %) and the percentage of analyzed sessions that completed evaluation (Eval Completed %). The analysis is filtered to include only p4bsoundbox and p4bAIBot entities, providing insights into the efficiency of the evaluation pipeline. The metric aggregates data by complete day to show daily performance trends, helping teams monitor whether sessions are progressing through the analysis and evaluation stages effectively. Both percentages include null handling to avoid division by zero errors when no sessions are present.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed se

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to soundbox and AI bot customer support entities
se.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- aggregate data by complete day for daily trend analysis
date_trunc('day', CAST(se.date_ AS TIMESTAMP))

--- specific filters
--- temporal filter can be applied as needed
--- se.date_ within specified date range

--- calculation_logic
CASE WHEN SUM(se.active_sessions) = 0 THEN NULL
ELSE SUM(se.analyzed_sessions) * 100 / SUM(se.active_sessions)
END AS analyzed_percentage,
CASE WHEN SUM(se.analyzed_sessions) = 0 THEN NULL
ELSE SUM(se.eval_completed) * 100 / SUM(se.analyzed_sessions)
END AS eval_completed_percentage




## Daily Quality Metrics Trend (%)

This metric tracks daily quality performance indicators for customer service operations, measuring evaluation scores, bot containment effectiveness, customer satisfaction, and quality issues as percentage trends. The analysis focuses on soundbox and AI bot entities (p4bsoundbox, p4bAIBot) to monitor service quality over time. Bot containment measures how well automated systems handle queries without escalation to human agents, while MSAT tracks customer satisfaction based on happy/sad feedback. Average evaluation score reflects overall service quality ratings, and bad evaluation share identifies the proportion of negative assessments. These metrics provide comprehensive quality monitoring for customer service optimization and performance management.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for different entities
--- customer service entity filtering for soundbox and AI bot operations
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND

--- specific filters
--- temporal range filter available but no default applied
--- date range can be specified using date_ column

--- calculation_logic
pattern: percentage_with_null_handling
metrics: avg_eval_score * 100, bot_containment_rate, satisfaction_rate, bad_eval_share
aggregation: daily (date_trunc('day', date_))




## Analyzed + Eval Completed % - Complete Day

This metric tracks the completion rates of customer support evaluation processes for soundbox and AI bot entities. It measures two key performance indicators: the percentage of active sessions that were analyzed (Analyzed %) and the percentage of analyzed sessions that completed evaluation (Eval Completed %). The analysis is filtered to include only p4bsoundbox and p4bAIBot entities, providing insights into the efficiency of the evaluation pipeline. The metric aggregates data by complete day to show daily performance trends, helping teams monitor whether sessions are progressing through the analysis and evaluation stages effectively. Both percentages include null handling to avoid division by zero errors when no sessions are present.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed se

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to soundbox and AI bot customer support entities
se.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- aggregate data by complete day for daily trend analysis
date_trunc('day', CAST(se.date_ AS TIMESTAMP))

--- specific filters
--- temporal filter can be applied as needed
--- se.date_ within specified date range

--- calculation_logic
CASE WHEN SUM(se.active_sessions) = 0 THEN NULL
ELSE SUM(se.analyzed_sessions) * 100 / SUM(se.active_sessions)
END AS analyzed_percentage,
CASE WHEN SUM(se.analyzed_sessions) = 0 THEN NULL
ELSE SUM(se.eval_completed) * 100 / SUM(se.analyzed_sessions)
END AS eval_completed_percentage




## Final User Sentiment Analysis

This metric tracks user sentiment distribution across P4B customer service channels including Soundbox and AI Bot interactions. It calculates the percentage breakdown of positive, negative, and neutral user sentiments to monitor customer satisfaction and service quality. The analysis is filtered to include only P4B Soundbox and P4B AI Bot entities, providing insights into how users perceive these automated customer service tools. Each sentiment category is expressed as a percentage of total sentiment responses, helping identify trends in customer experience and satisfaction levels over time for performance monitoring and improvement initiatives.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to P4B customer service entities only
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- temporal range filter (configurable, defaults to no filter)
eval.hour_timestamp >= {start_date} AND eval.hour_timestamp <= {end_date}

--- calculation_logic
CASE WHEN (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment)) = 0 
     THEN NULL
     ELSE SUM({sentiment_type}_user_sentiment) * 100 / 
          (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment))
END AS "{sentiment_type}_change_percent"




## Final User Sentiment #

Final User Sentiment tracks daily aggregated counts of user sentiment changes across three categories - positive, neutral, and negative feedback. This metric measures customer satisfaction and sentiment trends for specific customer service touchpoints including P4B Soundbox and AI Bot interactions. The data is filtered to include only p4bsoundbox and p4bAIBot entities, providing insights into how users perceive these automated customer service channels. The metric helps identify sentiment patterns over time, enabling teams to assess the effectiveness of customer service improvements and detect periods of increased negative feedback that may require immediate attention. Daily aggregation allows for trend analysis and performance monitoring of customer experience initiatives.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to specific customer service entities for P4B touchpoints
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot')

--- calculation_logic
sum(eval.neutral_user_sentiment) as neutral_change_count,
sum(eval.positive_user_sentiment) as positive_change_count,  
sum(eval.negative_user_sentiment) as negative_change_count,
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP)) as daily_period




## Final User Sentiment Analysis

This metric tracks user sentiment distribution across P4B customer service channels including Soundbox and AI Bot interactions. It calculates the percentage breakdown of positive, negative, and neutral user sentiments to monitor customer satisfaction and service quality. The analysis is filtered to include only P4B Soundbox and P4B AI Bot entities, providing insights into how users perceive these automated customer service tools. Each sentiment category is expressed as a percentage of total sentiment responses, helping identify trends in customer experience and satisfaction levels over time for performance monitoring and improvement initiatives.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to P4B customer service entities only
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- temporal range filter (configurable, defaults to no filter)
eval.hour_timestamp >= {start_date} AND eval.hour_timestamp <= {end_date}

--- calculation_logic
CASE WHEN (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment)) = 0 
     THEN NULL
     ELSE SUM({sentiment_type}_user_sentiment) * 100 / 
          (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment))
END AS "{sentiment_type}_change_percent"




## Final User Sentiment #

Final User Sentiment tracks daily aggregated counts of user sentiment changes across three categories - positive, neutral, and negative feedback. This metric measures customer satisfaction and sentiment trends for specific customer service touchpoints including P4B Soundbox and AI Bot interactions. The data is filtered to include only p4bsoundbox and p4bAIBot entities, providing insights into how users perceive these automated customer service channels. The metric helps identify sentiment patterns over time, enabling teams to assess the effectiveness of customer service improvements and detect periods of increased negative feedback that may require immediate attention. Daily aggregation allows for trend analysis and performance monitoring of customer experience initiatives.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to specific customer service entities for P4B touchpoints
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot')

--- calculation_logic
sum(eval.neutral_user_sentiment) as neutral_change_count,
sum(eval.positive_user_sentiment) as positive_change_count,  
sum(eval.negative_user_sentiment) as negative_change_count,
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP)) as daily_period




## Bot Performance Metrics

Bot Performance Metrics track the failure rates of P4B Soundbox and AI Bot systems across three critical performance dimensions. The metrics measure bot repetition percentage (when the bot repeats responses inappropriately), bot function call failure percentage (when API or function calls fail during bot operations), and intent detection failure percentage (when the bot fails to correctly identify user intent). These metrics are calculated as percentages of total completed evaluations and are essential for monitoring conversational AI quality and reliability. The data is aggregated daily and filtered specifically for P4B Soundbox and AI Bot entities to focus on core chatbot performance within the customer service technology stack.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B Soundbox and AI Bot entities only
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- temporal filter allows flexible date range selection
eval.hour_timestamp BETWEEN {start_date} AND {end_date}

--- calculation_logic
Bot Repetition %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(agent_response_repetition) * 100.0 / SUM(eval_completed) END,
Bot Failed %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(function_call_failed) * 100.0 / SUM(eval_completed) END,
Intent Detection Failed %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(intent_incoherence_count) * 100.0 / SUM(eval_completed) END




## Bot Performance Metrics

Bot Performance Metrics track the failure rates of P4B Soundbox and AI Bot systems across three critical performance dimensions. The metrics measure bot repetition percentage (when the bot repeats responses inappropriately), bot function call failure percentage (when API or function calls fail during bot operations), and intent detection failure percentage (when the bot fails to correctly identify user intent). These metrics are calculated as percentages of total completed evaluations and are essential for monitoring conversational AI quality and reliability. The data is aggregated daily and filtered specifically for P4B Soundbox and AI Bot entities to focus on core chatbot performance within the customer service technology stack.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B Soundbox and AI Bot entities only
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND
--- temporal filter allows flexible date range selection
eval.hour_timestamp BETWEEN {start_date} AND {end_date}

--- calculation_logic
Bot Repetition %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(agent_response_repetition) * 100.0 / SUM(eval_completed) END,
Bot Failed %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(function_call_failed) * 100.0 / SUM(eval_completed) END,
Intent Detection Failed %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(intent_incoherence_count) * 100.0 / SUM(eval_completed) END




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks daily customer service quality performance across three key dimensions: empathy, resolution achievement, and response relevance for AI-powered customer service channels. The metrics measure how well the AI systems (Soundbox and AIBot) perform in customer interactions, with each score averaged daily and converted to percentage format for easy interpretation. The empathy score evaluates emotional intelligence in responses, resolution achieved measures problem-solving effectiveness, and response relevance assesses how well responses address customer queries. This consolidated view helps monitor AI customer service quality trends and identify areas for improvement in automated customer support systems.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to AI-powered customer service entities
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot')

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## Overall Summary

Overall Summary tracks comprehensive customer service performance metrics for soundbox and AI bot operations, providing a holistic view of service delivery effectiveness. The summary includes volume indicators (active sessions, analyzed sessions, completed evaluations), customer satisfaction feedback (happy and sad responses), support escalation metrics (agent handover tickets and service tickets), and key performance ratios (feedback rate, agent handover percentage, and service ticket percentage). This consolidated view enables stakeholders to assess overall service health, customer engagement levels, and operational efficiency across the soundbox and AI bot customer service channels, supporting data-driven decisions for service optimization and resource allocation.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to soundbox and AI bot customer service entities only
virtual_table.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND

--- specific filters
--- temporal filter can be applied as needed
virtual_table.date_ {temporal_range_filter}

--- calculation_logic
sum(active_sessions) as active_sessions,
sum(analyzed_sessions) as analyzed_sessions,
sum(eval_completed) as eval_completed,
sum(happy) as happy_feedback,
sum(sad) as sad_feedback,
sum(ah_tickets) as agent_tickets,
sum(service_tickets) as service_tickets,
pattern: percentage_with_null_handling
base_metric: (sum(happy) + sum(sad)) * 100
denominator: sum(active_sessions)
result: feedback_rate_percent,
pattern: percentage_with_null_handling
base_metric: sum(ah_tickets) * 100
denominator: sum(active_sessions)
result: agent_handover_percent,
pattern: percentage_with_null_handling
base_metric: sum(service_tickets) * 100
denominator: sum(active_sessions)
result: service_ticket_percent




## Overall Summary

Overall Summary tracks comprehensive customer service performance metrics for soundbox and AI bot operations, providing a holistic view of service delivery effectiveness. The summary includes volume indicators (active sessions, analyzed sessions, completed evaluations), customer satisfaction feedback (happy and sad responses), support escalation metrics (agent handover tickets and service tickets), and key performance ratios (feedback rate, agent handover percentage, and service ticket percentage). This consolidated view enables stakeholders to assess overall service health, customer engagement levels, and operational efficiency across the soundbox and AI bot customer service channels, supporting data-driven decisions for service optimization and resource allocation.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to soundbox and AI bot customer service entities only
virtual_table.cst_entity IN ('p4bsoundbox', 'p4bAIBot') AND

--- specific filters
--- temporal filter can be applied as needed
virtual_table.date_ {temporal_range_filter}

--- calculation_logic
sum(active_sessions) as active_sessions,
sum(analyzed_sessions) as analyzed_sessions,
sum(eval_completed) as eval_completed,
sum(happy) as happy_feedback,
sum(sad) as sad_feedback,
sum(ah_tickets) as agent_tickets,
sum(service_tickets) as service_tickets,
pattern: percentage_with_null_handling
base_metric: (sum(happy) + sum(sad)) * 100
denominator: sum(active_sessions)
result: feedback_rate_percent,
pattern: percentage_with_null_handling
base_metric: sum(ah_tickets) * 100
denominator: sum(active_sessions)
result: agent_handover_percent,
pattern: percentage_with_null_handling
base_metric: sum(service_tickets) * 100
denominator: sum(active_sessions)
result: service_ticket_percent




## Analyzed + Eval Completed % - Complete Day

This metric tracks the evaluation completion funnel for soundbox sessions, measuring both analysis coverage and evaluation completion rates on a daily basis. The "Analyzed %" shows what percentage of active sessions were successfully analyzed, while "Eval Completed %" indicates the completion rate of evaluations among analyzed sessions. This provides visibility into the evaluation pipeline efficiency and helps identify bottlenecks in the process. The metric is filtered to focus on the p4bpayoutandsettlement entity, allowing stakeholders to monitor evaluation performance for this specific business unit and track daily progress in completing soundbox evaluations.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bpayoutandsettlement entity
virtual_table.cst_entity IN ('p4bpayoutandsettlement')

--- calculation_logic
Analyzed %: CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE SUM(analyzed_sessions) * 100 / SUM(active_sessions) END
Eval Completed %: CASE WHEN SUM(analyzed_sessions) = 0 THEN NULL ELSE SUM(eval_completed) * 100 / SUM(analyzed_sessions) END




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks daily customer service quality performance across three key dimensions: empathy, resolution achievement, and response relevance for AI-powered customer service channels. The metrics measure how well the AI systems (Soundbox and AIBot) perform in customer interactions, with each score averaged daily and converted to percentage format for easy interpretation. The empathy score evaluates emotional intelligence in responses, resolution achieved measures problem-solving effectiveness, and response relevance assesses how well responses address customer queries. This consolidated view helps monitor AI customer service quality trends and identify areas for improvement in automated customer support systems.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- limit analysis to AI-powered customer service entities
eval.cst_entity IN ('p4bsoundbox', 'p4bAIBot')

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## Analyzed + Eval Completed % - Complete Day

This metric tracks the evaluation completion funnel for soundbox sessions, measuring both analysis coverage and evaluation completion rates on a daily basis. The "Analyzed %" shows what percentage of active sessions were successfully analyzed, while "Eval Completed %" indicates the completion rate of evaluations among analyzed sessions. This provides visibility into the evaluation pipeline efficiency and helps identify bottlenecks in the process. The metric is filtered to focus on the p4bpayoutandsettlement entity, allowing stakeholders to monitor evaluation performance for this specific business unit and track daily progress in completing soundbox evaluations.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bpayoutandsettlement entity
virtual_table.cst_entity IN ('p4bpayoutandsettlement')

--- calculation_logic
Analyzed %: CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE SUM(analyzed_sessions) * 100 / SUM(active_sessions) END
Eval Completed %: CASE WHEN SUM(analyzed_sessions) = 0 THEN NULL ELSE SUM(eval_completed) * 100 / SUM(analyzed_sessions) END




## Daily Quality Metrics Trend (%)

Tracks daily quality metrics trends as percentages for customer support operations in the MHD evaluation system. Measures four key performance indicators: average evaluation score percentage showing overall quality assessment, bot containment percentage indicating automation effectiveness by calculating sessions resolved without human intervention, customer satisfaction (MSAT) percentage based on happy versus sad feedback ratios, and bad evaluation share percentage representing the proportion of negative evaluations. All metrics are filtered specifically for the p4bpayoutandsettlement entity and calculated with zero-division protection using conditional logic to ensure data integrity when denominators are zero.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for specific customer support entity
eval.cst_entity = 'p4bpayoutandsettlement' AND
--- temporal filter typically applied for date range selection
eval.date_ BETWEEN {start_date} AND {end_date}

--- calculation_logic
AVG(eval.avg_eval_score) * 100 as avg_eval_score_pct,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL 
     ELSE (SUM(eval.active_sessions) - SUM(eval.fd_tickets)) * 100 / SUM(eval.active_sessions) 
END as bot_containment_pct,
CASE WHEN (SUM(eval.sad) + SUM(eval.happy)) = 0 THEN NULL 
     ELSE SUM(eval.happy) * 100 / (SUM(eval.sad) + SUM(eval.happy)) 
END as msat_pct,
CASE WHEN (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) = 0 THEN NULL 
     ELSE SUM(eval.eval_score_bad) * 100 / (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) 
END as bad_eval_share_pct




## Daily Quality Metrics Trend (%)

Tracks daily quality metrics trends as percentages for customer support operations in the MHD evaluation system. Measures four key performance indicators: average evaluation score percentage showing overall quality assessment, bot containment percentage indicating automation effectiveness by calculating sessions resolved without human intervention, customer satisfaction (MSAT) percentage based on happy versus sad feedback ratios, and bad evaluation share percentage representing the proportion of negative evaluations. All metrics are filtered specifically for the p4bpayoutandsettlement entity and calculated with zero-division protection using conditional logic to ensure data integrity when denominators are zero.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for specific customer support entity
eval.cst_entity = 'p4bpayoutandsettlement' AND
--- temporal filter typically applied for date range selection
eval.date_ BETWEEN {start_date} AND {end_date}

--- calculation_logic
AVG(eval.avg_eval_score) * 100 as avg_eval_score_pct,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL 
     ELSE (SUM(eval.active_sessions) - SUM(eval.fd_tickets)) * 100 / SUM(eval.active_sessions) 
END as bot_containment_pct,
CASE WHEN (SUM(eval.sad) + SUM(eval.happy)) = 0 THEN NULL 
     ELSE SUM(eval.happy) * 100 / (SUM(eval.sad) + SUM(eval.happy)) 
END as msat_pct,
CASE WHEN (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) = 0 THEN NULL 
     ELSE SUM(eval.eval_score_bad) * 100 / (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) 
END as bad_eval_share_pct




## Final User Sentiment #

This metric tracks daily user sentiment changes for the P4B Payout and Settlement service, measuring positive, negative, and neutral sentiment shifts from soundbox evaluation data. The business purpose is to monitor customer satisfaction trends and identify sentiment patterns over time for the payout and settlement functionality. The data is filtered specifically for the 'p4bpayoutandsettlement' entity and aggregated by day to provide daily sentiment change counts. This helps the product team understand user experience trends, identify periods of satisfaction or dissatisfaction, and correlate sentiment changes with product updates or service issues in the payout and settlement domain.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different entity
--- restrict analysis to P4B payout and settlement service only
eval.cst_entity IN ('p4bpayoutandsettlement') AND

--- specific filters
--- temporal range filter available but currently set to no filter (all periods)
eval.hour_timestamp IS NOT NULL

--- calculation_logic
sum(eval.neutral_user_sentiment) as neutral_change_count,
sum(eval.positive_user_sentiment) as positive_change_count,
sum(eval.negative_user_sentiment) as negative_change_count,
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP)) as day_grouping




## Final User Sentiment #

This metric tracks daily user sentiment changes for the P4B Payout and Settlement service, measuring positive, negative, and neutral sentiment shifts from soundbox evaluation data. The business purpose is to monitor customer satisfaction trends and identify sentiment patterns over time for the payout and settlement functionality. The data is filtered specifically for the 'p4bpayoutandsettlement' entity and aggregated by day to provide daily sentiment change counts. This helps the product team understand user experience trends, identify periods of satisfaction or dissatisfaction, and correlate sentiment changes with product updates or service issues in the payout and settlement domain.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different entity
--- restrict analysis to P4B payout and settlement service only
eval.cst_entity IN ('p4bpayoutandsettlement') AND

--- specific filters
--- temporal range filter available but currently set to no filter (all periods)
eval.hour_timestamp IS NOT NULL

--- calculation_logic
sum(eval.neutral_user_sentiment) as neutral_change_count,
sum(eval.positive_user_sentiment) as positive_change_count,
sum(eval.negative_user_sentiment) as negative_change_count,
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP)) as day_grouping




## Final User Sentiment Analysis

Final User Sentiment Analysis tracks the percentage distribution of user sentiment across positive, negative, and neutral categories for P4B payout and settlement operations. This metric measures customer satisfaction and experience quality by analyzing sentiment feedback aggregated at daily intervals. The analysis is filtered specifically for the p4bpayoutandsettlement entity to focus on payment processing sentiment. Each percentage represents the proportion of that sentiment type relative to total sentiment responses, providing insights into customer experience trends and helping identify periods of improved or deteriorated user satisfaction. The metric handles cases where no sentiment data exists by returning null values.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 sentiment

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B payout and settlement entity operations
sentiment.cst_entity = 'p4bpayoutandsettlement' AND
--- temporal grouping by day for trend analysis
date_trunc('day', CAST(sentiment.hour_timestamp AS TIMESTAMP))

--- specific filters
--- temporal range filter (configurable, defaults to no filter)
sentiment.hour_timestamp TEMPORAL_RANGE ({time_range}: No filter)

--- calculation_logic
pattern: sentiment_percentage_distribution
base_metrics: [positive_user_sentiment, negative_user_sentiment, neutral_user_sentiment]
calculation: CASE WHEN total_sentiment = 0 THEN NULL ELSE category_sentiment * 100 / total_sentiment END




## Bot Performance Metrics

Bot Performance Metrics tracks the failure rates of chatbot interactions within the MHD (Merchant Help Desk) evaluation system for the payout and settlement entity. It measures three critical performance indicators: bot repetition percentage (when the bot repeats responses inappropriately), bot failure percentage (when function calls fail during interaction), and intent detection failure percentage (when the bot fails to understand user intent). These metrics are calculated as percentages of completed evaluations, providing insights into bot reliability and user experience quality. The data is aggregated daily and filtered specifically for p4bpayoutandsettlement operations, enabling stakeholders to monitor and improve automated customer service performance over time.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on payout and settlement entity operations
eval.cst_entity IN ('p4bpayoutandsettlement') AND
--- temporal aggregation by day
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP))

--- specific filters
--- no additional specific filters beyond entity restriction

--- calculation_logic
Bot Repetition %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(agent_response_repetition) * 100.0 / SUM(eval_completed) END,
Bot Failed %: CASE WHEN SUM(function_call_failed) = 0 THEN NULL ELSE SUM(function_call_failed) * 100.0 / SUM(eval_completed) END,
Intent Detection Failed %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(intent_incoherence_count) * 100.0 / SUM(eval_completed) END




## Final User Sentiment Analysis

Final User Sentiment Analysis tracks the percentage distribution of user sentiment across positive, negative, and neutral categories for P4B payout and settlement operations. This metric measures customer satisfaction and experience quality by analyzing sentiment feedback aggregated at daily intervals. The analysis is filtered specifically for the p4bpayoutandsettlement entity to focus on payment processing sentiment. Each percentage represents the proportion of that sentiment type relative to total sentiment responses, providing insights into customer experience trends and helping identify periods of improved or deteriorated user satisfaction. The metric handles cases where no sentiment data exists by returning null values.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 sentiment

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B payout and settlement entity operations
sentiment.cst_entity = 'p4bpayoutandsettlement' AND
--- temporal grouping by day for trend analysis
date_trunc('day', CAST(sentiment.hour_timestamp AS TIMESTAMP))

--- specific filters
--- temporal range filter (configurable, defaults to no filter)
sentiment.hour_timestamp TEMPORAL_RANGE ({time_range}: No filter)

--- calculation_logic
pattern: sentiment_percentage_distribution
base_metrics: [positive_user_sentiment, negative_user_sentiment, neutral_user_sentiment]
calculation: CASE WHEN total_sentiment = 0 THEN NULL ELSE category_sentiment * 100 / total_sentiment END




## Bot Performance Metrics

Bot Performance Metrics tracks the failure rates of chatbot interactions within the MHD (Merchant Help Desk) evaluation system for the payout and settlement entity. It measures three critical performance indicators: bot repetition percentage (when the bot repeats responses inappropriately), bot failure percentage (when function calls fail during interaction), and intent detection failure percentage (when the bot fails to understand user intent). These metrics are calculated as percentages of completed evaluations, providing insights into bot reliability and user experience quality. The data is aggregated daily and filtered specifically for p4bpayoutandsettlement operations, enabling stakeholders to monitor and improve automated customer service performance over time.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on payout and settlement entity operations
eval.cst_entity IN ('p4bpayoutandsettlement') AND
--- temporal aggregation by day
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP))

--- specific filters
--- no additional specific filters beyond entity restriction

--- calculation_logic
Bot Repetition %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(agent_response_repetition) * 100.0 / SUM(eval_completed) END,
Bot Failed %: CASE WHEN SUM(function_call_failed) = 0 THEN NULL ELSE SUM(function_call_failed) * 100.0 / SUM(eval_completed) END,
Intent Detection Failed %: CASE WHEN SUM(eval_completed) = 0 THEN NULL ELSE SUM(intent_incoherence_count) * 100.0 / SUM(eval_completed) END




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks three core customer service quality dimensions for the p4bpayoutandsettlement entity from soundbox evaluations. Average Empathy Score measures the emotional intelligence and understanding demonstrated in customer interactions, converted to percentage scale. Average Resolution Achieved tracks the effectiveness of problem-solving and issue closure rates. Average Response Relevance Score evaluates how well responses address customer queries and concerns. These metrics are aggregated daily to monitor customer service performance trends and identify areas for improvement in automated or human-assisted customer support systems. The data specifically focuses on payout and settlement related customer service interactions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for payout and settlement entity customer service data
eval.cst_entity = 'p4bpayoutandsettlement'

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks three core customer service quality dimensions for the p4bpayoutandsettlement entity from soundbox evaluations. Average Empathy Score measures the emotional intelligence and understanding demonstrated in customer interactions, converted to percentage scale. Average Resolution Achieved tracks the effectiveness of problem-solving and issue closure rates. Average Response Relevance Score evaluates how well responses address customer queries and concerns. These metrics are aggregated daily to monitor customer service performance trends and identify areas for improvement in automated or human-assisted customer support systems. The data specifically focuses on payout and settlement related customer service interactions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for payout and settlement entity customer service data
eval.cst_entity = 'p4bpayoutandsettlement'

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## Overall Summary

This summary dashboard tracks key performance indicators for soundbox evaluation sessions within the MHD evaluation system. It measures operational metrics including total active sessions, sessions that underwent analysis, completed evaluations, customer satisfaction feedback (happy/sad counts), and agent intervention requirements. The data is filtered specifically for the p4bpayoutandsettlement entity to focus on payment and settlement related evaluations. Two calculated metrics provide insight into system performance: feedback rate percentage shows customer engagement levels, while agent handover percentage indicates when automated evaluation requires human intervention. This comprehensive view enables monitoring of evaluation system effectiveness, customer satisfaction trends, and operational efficiency across the payment settlement domain.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different entity
--- filter for payment and settlement entity evaluations
eval.cst_entity IN ('p4bpayoutandsettlement') AND
--- temporal filter for daily aggregation
date_trunc('day', CAST(eval.date_ AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions,
sum(eval.eval_completed) as eval_completed,
sum(eval.happy) as happy_feedback,
sum(eval.sad) as sad_feedback,
sum(eval.ah_tickets) as agent_tickets,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
ELSE (SUM(eval.happy) + SUM(eval.sad)) * 100 / SUM(eval.active_sessions)
END as feedback_rate_percent,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
ELSE SUM(eval.ah_tickets) * 100 / SUM(eval.active_sessions)
END as agent_handover_percent




## LLM L1 Metrics

LLM L1 Metrics tracks comprehensive evaluation performance of customer service chatbot interactions for soundbox payment issues. This dashboard measures conversation quality through multiple dimensions including evaluation completion rates, response relevance scores, customer satisfaction (MSAT), sentiment analysis, empathy scoring, and various failure modes like intent detection errors and bot repetition. The metrics are segmented by problem description to identify specific issue types requiring attention. Data is filtered to p4bpayoutandsettlement entity operations and excludes current day data to ensure completeness. This enables customer service teams to monitor chatbot effectiveness, identify areas for improvement, and track resolution quality across different problem categories in the soundbox payment ecosystem.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current day data to ensure data completeness
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY AND
--- filter to payout and settlement entity operations
eval.cst_entity IN ('p4bpayoutandsettlement')

--- specific filters
--- segment by problem description for issue-specific analysis
GROUP BY eval.out_key_problem_desc

--- calculation_logic
Active Sessions: SUM(eval.active_sessions)
Eval Completed %: SUM(eval.eval_completed) * 100 / SUM(eval.active_sessions)
AVG Eval Score: AVG(eval.avg_eval_score) * 100
AVG Response Relevance: AVG(eval.avg_response_relevance_score) * 100
MSAT %: CASE WHEN (SUM(eval.happy) + SUM(eval.sad)) = 0 THEN NULL ELSE (SUM(eval.happy) * 100.0) / (SUM(eval.happy) + SUM(eval.sad)) END
AVG Empathy Score: AVG(eval.avg_empathy_score) * 100
+ve Sentiment Change %: pattern: sentiment_percentage_calculation
AVG Resolution Achieved: AVG(eval.avg_resolution_achieved) * 100
Bad Eval Share %: pattern: binary_share_percentage
Intent Detection Failed %: pattern: failure_rate_percentage, metric: intent_incoherence_count
Bot Repetition %: pattern: failure_rate_percentage, metric: agent_response_repetition
Bot Failed %: pattern: failure_rate_percentage, metric: function_call_failed
AVG Topic Drift: AVG(eval.avg_topic_drift) * 100




## Overall Summary

This summary dashboard tracks key performance indicators for soundbox evaluation sessions within the MHD evaluation system. It measures operational metrics including total active sessions, sessions that underwent analysis, completed evaluations, customer satisfaction feedback (happy/sad counts), and agent intervention requirements. The data is filtered specifically for the p4bpayoutandsettlement entity to focus on payment and settlement related evaluations. Two calculated metrics provide insight into system performance: feedback rate percentage shows customer engagement levels, while agent handover percentage indicates when automated evaluation requires human intervention. This comprehensive view enables monitoring of evaluation system effectiveness, customer satisfaction trends, and operational efficiency across the payment settlement domain.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different entity
--- filter for payment and settlement entity evaluations
eval.cst_entity IN ('p4bpayoutandsettlement') AND
--- temporal filter for daily aggregation
date_trunc('day', CAST(eval.date_ AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions,
sum(eval.eval_completed) as eval_completed,
sum(eval.happy) as happy_feedback,
sum(eval.sad) as sad_feedback,
sum(eval.ah_tickets) as agent_tickets,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
ELSE (SUM(eval.happy) + SUM(eval.sad)) * 100 / SUM(eval.active_sessions)
END as feedback_rate_percent,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
ELSE SUM(eval.ah_tickets) * 100 / SUM(eval.active_sessions)
END as agent_handover_percent




## LLM L1 Metrics

LLM L1 Metrics tracks comprehensive evaluation performance of customer service chatbot interactions for soundbox payment issues. This dashboard measures conversation quality through multiple dimensions including evaluation completion rates, response relevance scores, customer satisfaction (MSAT), sentiment analysis, empathy scoring, and various failure modes like intent detection errors and bot repetition. The metrics are segmented by problem description to identify specific issue types requiring attention. Data is filtered to p4bpayoutandsettlement entity operations and excludes current day data to ensure completeness. This enables customer service teams to monitor chatbot effectiveness, identify areas for improvement, and track resolution quality across different problem categories in the soundbox payment ecosystem.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude current day data to ensure data completeness
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY AND
--- filter to payout and settlement entity operations
eval.cst_entity IN ('p4bpayoutandsettlement')

--- specific filters
--- segment by problem description for issue-specific analysis
GROUP BY eval.out_key_problem_desc

--- calculation_logic
Active Sessions: SUM(eval.active_sessions)
Eval Completed %: SUM(eval.eval_completed) * 100 / SUM(eval.active_sessions)
AVG Eval Score: AVG(eval.avg_eval_score) * 100
AVG Response Relevance: AVG(eval.avg_response_relevance_score) * 100
MSAT %: CASE WHEN (SUM(eval.happy) + SUM(eval.sad)) = 0 THEN NULL ELSE (SUM(eval.happy) * 100.0) / (SUM(eval.happy) + SUM(eval.sad)) END
AVG Empathy Score: AVG(eval.avg_empathy_score) * 100
+ve Sentiment Change %: pattern: sentiment_percentage_calculation
AVG Resolution Achieved: AVG(eval.avg_resolution_achieved) * 100
Bad Eval Share %: pattern: binary_share_percentage
Intent Detection Failed %: pattern: failure_rate_percentage, metric: intent_incoherence_count
Bot Repetition %: pattern: failure_rate_percentage, metric: agent_response_repetition
Bot Failed %: pattern: failure_rate_percentage, metric: function_call_failed
AVG Topic Drift: AVG(eval.avg_topic_drift) * 100




## Daily Quality Metrics Trend (%)

Daily Quality Metrics Trend tracks four key customer service performance indicators as percentages over time for the P4B Business Loan entity. The metrics include average evaluation score percentage measuring agent performance quality, bot containment percentage indicating automated resolution effectiveness by calculating sessions not escalated to human agents, MSAT (Mobile Satisfaction) percentage representing customer satisfaction based on happy vs sad feedback ratios, and bad evaluation share percentage showing the proportion of poor quality interactions. All metrics are filtered specifically for the p4bbusinessloan customer service entity and aggregated daily to show trending patterns. The dashboard enables monitoring of service quality degradation or improvement across multiple dimensions simultaneously.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B Business Loan customer service entity
eval.cst_entity = 'p4bbusinessloan' AND
--- temporal grouping by day
date_trunc('day', CAST(eval.date_ AS TIMESTAMP))

--- calculation_logic
AVG Eval Score %: (AVG(avg_eval_score)) * 100
Bot Containment %: CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE (SUM(active_sessions) - SUM(fd_tickets)) * 100 / SUM(active_sessions) END
MSAT %: CASE WHEN (SUM(sad)+SUM(happy)) = 0 THEN NULL ELSE SUM(happy) * 100 /(SUM(sad)+SUM(happy)) END
Bad Eval Share %: CASE WHEN (SUM(eval_score_good) + SUM(eval_score_bad)) = 0 THEN NULL ELSE SUM(eval_score_bad) * 100 / (SUM(eval_score_good) + SUM(eval_score_bad)) END




## Analyzed + Eval Completed % - Complete Day

This metric tracks the operational efficiency of soundbox evaluation processes for business loan applications within the MHD system. It measures two sequential performance indicators: the analysis completion rate (percentage of active sessions that get analyzed) and the evaluation completion rate (percentage of analyzed sessions where evaluation is fully completed). The data is filtered specifically to business loan CST entity (p4bbusinessloan) to focus on this product vertical. These metrics help monitor the evaluation pipeline effectiveness, identifying bottlenecks between session activation, analysis completion, and final evaluation. The percentages provide insight into operational capacity and process optimization opportunities for the business loan evaluation workflow.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed sb

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to business loan CST entity for product-specific analysis
sb.cst_entity = 'p4bbusinessloan'

--- specific filters
--- temporal range filter available but currently set to show all data
--- sb.date_ [temporal filter - currently "No filter"]

--- calculation_logic
analyzed_percentage: SUM(analyzed_sessions) * 100 / SUM(active_sessions),
eval_completed_percentage: SUM(eval_completed) * 100 / SUM(analyzed_sessions)




## Analyzed + Eval Completed % - Complete Day

This metric tracks the operational efficiency of soundbox evaluation processes for business loan applications within the MHD system. It measures two sequential performance indicators: the analysis completion rate (percentage of active sessions that get analyzed) and the evaluation completion rate (percentage of analyzed sessions where evaluation is fully completed). The data is filtered specifically to business loan CST entity (p4bbusinessloan) to focus on this product vertical. These metrics help monitor the evaluation pipeline effectiveness, identifying bottlenecks between session activation, analysis completion, and final evaluation. The percentages provide insight into operational capacity and process optimization opportunities for the business loan evaluation workflow.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed sb

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to business loan CST entity for product-specific analysis
sb.cst_entity = 'p4bbusinessloan'

--- specific filters
--- temporal range filter available but currently set to show all data
--- sb.date_ [temporal filter - currently "No filter"]

--- calculation_logic
analyzed_percentage: SUM(analyzed_sessions) * 100 / SUM(active_sessions),
eval_completed_percentage: SUM(eval_completed) * 100 / SUM(analyzed_sessions)




## Final User Sentiment Analysis

This metric tracks user sentiment distribution percentages for P4B Business Loan, showing the relative proportion of positive, neutral, and negative sentiment feedback over time. The analysis calculates each sentiment category as a percentage of total sentiment responses, providing insights into customer satisfaction trends and sentiment patterns. Data is aggregated daily from soundbox evaluation summaries, filtered specifically for the P4B Business Loan product entity. The percentage-based approach enables comparison of sentiment balance across different time periods and helps identify shifts in customer perception. Null values are returned when no sentiment data is available for a given period.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to P4B Business Loan product entity for focused sentiment analysis
eval.cst_entity IN ('p4bbusinessloan') AND
--- temporal filter (no specific range applied, defaults to all available data)
eval.hour_timestamp IS NOT NULL

--- specific filters
--- no additional specific filters applied beyond entity filtering

--- calculation_logic
pattern: sentiment_percentage_distribution
base_metrics: positive_user_sentiment, neutral_user_sentiment, negative_user_sentiment
aggregation: SUM with percentage calculation and null handling




## Final User Sentiment Analysis

This metric tracks user sentiment distribution percentages for P4B Business Loan, showing the relative proportion of positive, neutral, and negative sentiment feedback over time. The analysis calculates each sentiment category as a percentage of total sentiment responses, providing insights into customer satisfaction trends and sentiment patterns. Data is aggregated daily from soundbox evaluation summaries, filtered specifically for the P4B Business Loan product entity. The percentage-based approach enables comparison of sentiment balance across different time periods and helps identify shifts in customer perception. Null values are returned when no sentiment data is available for a given period.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to P4B Business Loan product entity for focused sentiment analysis
eval.cst_entity IN ('p4bbusinessloan') AND
--- temporal filter (no specific range applied, defaults to all available data)
eval.hour_timestamp IS NOT NULL

--- specific filters
--- no additional specific filters applied beyond entity filtering

--- calculation_logic
pattern: sentiment_percentage_distribution
base_metrics: positive_user_sentiment, neutral_user_sentiment, negative_user_sentiment
aggregation: SUM with percentage calculation and null handling




## Daily Quality Metrics Trend (%)

Daily Quality Metrics Trend tracks four key customer service performance indicators as percentages over time for the P4B Business Loan entity. The metrics include average evaluation score percentage measuring agent performance quality, bot containment percentage indicating automated resolution effectiveness by calculating sessions not escalated to human agents, MSAT (Mobile Satisfaction) percentage representing customer satisfaction based on happy vs sad feedback ratios, and bad evaluation share percentage showing the proportion of poor quality interactions. All metrics are filtered specifically for the p4bbusinessloan customer service entity and aggregated daily to show trending patterns. The dashboard enables monitoring of service quality degradation or improvement across multiple dimensions simultaneously.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B Business Loan customer service entity
eval.cst_entity = 'p4bbusinessloan' AND
--- temporal grouping by day
date_trunc('day', CAST(eval.date_ AS TIMESTAMP))

--- calculation_logic
AVG Eval Score %: (AVG(avg_eval_score)) * 100
Bot Containment %: CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE (SUM(active_sessions) - SUM(fd_tickets)) * 100 / SUM(active_sessions) END
MSAT %: CASE WHEN (SUM(sad)+SUM(happy)) = 0 THEN NULL ELSE SUM(happy) * 100 /(SUM(sad)+SUM(happy)) END
Bad Eval Share %: CASE WHEN (SUM(eval_score_good) + SUM(eval_score_bad)) = 0 THEN NULL ELSE SUM(eval_score_bad) * 100 / (SUM(eval_score_good) + SUM(eval_score_bad)) END




## Final User Sentiment #

Final User Sentiment tracks the daily distribution of customer sentiment changes across three categories (positive, negative, neutral) for P4B business loan interactions captured through the soundbox evaluation system. This metric measures customer satisfaction trends by aggregating sentiment feedback counts, helping assess the impact of product changes and service quality on user experience. The data is filtered specifically to P4B business loan entities, providing focused insights into this product vertical's customer sentiment patterns over time for business intelligence and product improvement decisions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 sentiment

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to P4B business loan entity for focused product analysis
sentiment.cst_entity IN ('p4bbusinessloan')

--- specific filters
--- temporal range filter (configurable, currently no filter applied)
--- sentiment.hour_timestamp TEMPORAL_RANGE (no current restriction)

--- calculation_logic
sum(sentiment.positive_user_sentiment) as positive_changes,
sum(sentiment.negative_user_sentiment) as negative_changes,
sum(sentiment.neutral_user_sentiment) as neutral_changes,
date_trunc('day', cast(sentiment.hour_timestamp as timestamp)) as day_grouping




## Final User Sentiment #

Final User Sentiment tracks the daily distribution of customer sentiment changes across three categories (positive, negative, neutral) for P4B business loan interactions captured through the soundbox evaluation system. This metric measures customer satisfaction trends by aggregating sentiment feedback counts, helping assess the impact of product changes and service quality on user experience. The data is filtered specifically to P4B business loan entities, providing focused insights into this product vertical's customer sentiment patterns over time for business intelligence and product improvement decisions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 sentiment

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to P4B business loan entity for focused product analysis
sentiment.cst_entity IN ('p4bbusinessloan')

--- specific filters
--- temporal range filter (configurable, currently no filter applied)
--- sentiment.hour_timestamp TEMPORAL_RANGE (no current restriction)

--- calculation_logic
sum(sentiment.positive_user_sentiment) as positive_changes,
sum(sentiment.negative_user_sentiment) as negative_changes,
sum(sentiment.neutral_user_sentiment) as neutral_changes,
date_trunc('day', cast(sentiment.hour_timestamp as timestamp)) as day_grouping




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks customer service quality performance for the p4bbusinessloan entity across three key dimensions: empathy, resolution achievement, and response relevance. The empathy score measures how well customer service representatives demonstrate understanding and compassion during interactions. Resolution achieved tracks the percentage of customer issues that are successfully resolved. Response relevance evaluates how well responses address the specific customer concerns raised. All scores are converted to percentages for easy interpretation. This comprehensive quality assessment helps monitor and improve customer service effectiveness by providing a multi-dimensional view of agent performance and customer satisfaction levels on a daily basis.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bbusinessloan customer service entity
eval.cst_entity IN ('p4bbusinessloan')

--- specific filters
--- no additional specific filters - temporal filters set to "No filter"

--- calculation_logic
AVG(avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(avg_response_relevance_score) * 100 as avg_response_relevance_pct




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks customer service quality performance for the p4bbusinessloan entity across three key dimensions: empathy, resolution achievement, and response relevance. The empathy score measures how well customer service representatives demonstrate understanding and compassion during interactions. Resolution achieved tracks the percentage of customer issues that are successfully resolved. Response relevance evaluates how well responses address the specific customer concerns raised. All scores are converted to percentages for easy interpretation. This comprehensive quality assessment helps monitor and improve customer service effectiveness by providing a multi-dimensional view of agent performance and customer satisfaction levels on a daily basis.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bbusinessloan customer service entity
eval.cst_entity IN ('p4bbusinessloan')

--- specific filters
--- no additional specific filters - temporal filters set to "No filter"

--- calculation_logic
AVG(avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(avg_response_relevance_score) * 100 as avg_response_relevance_pct




## Bot Performance Metrics

This metric tracks bot performance quality indicators for the MHD evaluation system, specifically measuring three key failure modes: bot response repetition, function call failures, and intent detection incoherence. Each percentage represents the failure rate calculated as the number of specific errors divided by total completed evaluations, multiplied by 100. The metrics are filtered to focus on the p4bbusinessloan customer service entity and aggregated by day to show daily performance trends. These indicators help identify bot quality issues and track improvement over time, with null values returned when no evaluations are completed to avoid misleading zero percentages.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for p4bbusinessloan customer service entity
eval.cst_entity IN ('p4bbusinessloan') AND
--- temporal filter configurable via dashboard parameter
eval.hour_timestamp >= {start_date} AND eval.hour_timestamp <= {end_date}

--- specific filters
--- none beyond standard entity and temporal filters

--- calculation_logic
pattern: performance_percentage_with_null_safety
error_counts: [agent_response_repetition, function_call_failed, intent_incoherence_count]
base_denominator: SUM(eval_completed)




## Bot Performance Metrics

This metric tracks bot performance quality indicators for the MHD evaluation system, specifically measuring three key failure modes: bot response repetition, function call failures, and intent detection incoherence. Each percentage represents the failure rate calculated as the number of specific errors divided by total completed evaluations, multiplied by 100. The metrics are filtered to focus on the p4bbusinessloan customer service entity and aggregated by day to show daily performance trends. These indicators help identify bot quality issues and track improvement over time, with null values returned when no evaluations are completed to avoid misleading zero percentages.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for p4bbusinessloan customer service entity
eval.cst_entity IN ('p4bbusinessloan') AND
--- temporal filter configurable via dashboard parameter
eval.hour_timestamp >= {start_date} AND eval.hour_timestamp <= {end_date}

--- specific filters
--- none beyond standard entity and temporal filters

--- calculation_logic
pattern: performance_percentage_with_null_safety
error_counts: [agent_response_repetition, function_call_failed, intent_incoherence_count]
base_denominator: SUM(eval_completed)




## LLM L1 Metrics

This comprehensive LLM evaluation dashboard tracks 13 key performance indicators for the P4B Business Loan customer service system, analyzing bot interaction quality and effectiveness. The metrics include session volume (Active Sessions), evaluation completion rates, quality assessments (evaluation scores, response relevance, empathy), user satisfaction (MSAT percentage), sentiment analysis (positive sentiment change), resolution achievement rates, and failure mode detection (bad evaluations, intent detection failures, bot repetition and failures, topic drift). Data is segmented by problem description categories to identify performance variations across different customer issue types. The analysis excludes unanalyzed interactions and current-day incomplete data, providing a complete view of LLM performance for operational optimization and quality assurance in automated customer service delivery.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unanalyzed interactions from evaluation metrics
eval.description != 'Not Analyzed' AND
--- focus on P4B business loan customer service entity
eval.cst_entity IN ('p4bbusinessloan') AND
--- exclude current day data to ensure complete evaluation cycles
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY

--- specific filters
--- configurable temporal range filter (defaults to "No filter")
--- eval.date_ TEMPORAL_RANGE ({time_range})

--- calculation_logic
Active Sessions: SUM(eval.active_sessions)
Eval Completed %: SUM(eval.eval_completed) * 100 / SUM(eval.active_sessions)
AVG Eval Score: AVG(eval.avg_eval_score) * 100
AVG Response Relevance: AVG(eval.avg_response_relevance_score) * 100
MSAT %: CASE WHEN (SUM(eval.happy) + SUM(eval.sad)) = 0 THEN NULL ELSE (SUM(eval.happy) * 100.0) / (SUM(eval.happy) + SUM(eval.sad)) END
AVG Empathy Score: AVG(eval.avg_empathy_score) * 100
+ve Sentiment Change %: CASE WHEN (SUM(eval.positive_user_sentiment)+SUM(eval.negative_user_sentiment)+SUM(eval.neutral_user_sentiment)) = 0 THEN NULL ELSE SUM(eval.positive_user_sentiment) * 100 / (SUM(eval.positive_user_sentiment)+SUM(eval.negative_user_sentiment)+SUM(eval.neutral_user_sentiment)) END
AVG Resolution Achieved: AVG(eval.avg_resolution_achieved) * 100
Bad Eval Share %: CASE WHEN (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) = 0 THEN NULL ELSE SUM(eval.eval_score_bad) * 100 / (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) END
Intent Detection Failed %: CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL ELSE SUM(eval.intent_incoherence_count) * 100 / SUM(eval.active_sessions) END
Bot Repetition %: CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL ELSE SUM(eval.agent_response_repetition) * 100 / SUM(eval.active_sessions) END
Bot Failed %: CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL ELSE SUM(eval.function_call_failed) * 100 / SUM(eval.active_sessions) END
AVG Topic Drift: AVG(eval.avg_topic_drift) * 100




## Analyzed + Eval Completed % - Complete Day

This metric tracks the completion rates of soundbox evaluation processes for the p4bprofile entity. The Analyzed percentage measures what portion of active sessions have been successfully analyzed, calculated as analyzed sessions divided by total active sessions. The Eval Completed percentage measures the completion rate of evaluations among analyzed sessions, showing how many analyzed sessions have completed the full evaluation process. This operational metric helps monitor the efficiency and throughput of the soundbox evaluation pipeline, identifying potential bottlenecks in either the analysis phase or the evaluation completion phase. The metric is specifically scoped to p4bprofile entity operations and can be filtered by date ranges for temporal analysis of evaluation performance trends.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed sb

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bprofile entity for focused evaluation tracking
sb.cst_entity = 'p4bprofile' AND

--- specific filters
--- temporal filter for date-based analysis (configurable)
--- date range filter applied on date_ column when specified
sb.date_ {temporal_operator} {date_range}

--- calculation_logic
SUM(sb.analyzed_sessions) * 100 / SUM(sb.active_sessions) AS analyzed_percentage,
SUM(sb.eval_completed) * 100 / SUM(sb.analyzed_sessions) AS eval_completed_percentage




## Overall Summary

This metric provides a comprehensive daily summary of soundbox evaluation performance for the p4bbusinessloan entity within the MHD evaluation system. It tracks key operational metrics including total active sessions, sessions that underwent analysis, completed evaluations, customer feedback (both positive and negative), and tickets requiring agent intervention. The summary also calculates derived performance indicators such as feedback rate percentage (proportion of sessions receiving feedback) and agent handover percentage (proportion of sessions escalated to human agents). This consolidated view enables stakeholders to monitor overall system health, customer satisfaction levels, and operational efficiency on a daily basis, providing essential insights for performance optimization and resource allocation decisions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- entity filter for p4bbusinessloan business unit
virtual_table.cst_entity IN ('p4bbusinessloan') AND
--- temporal grouping by day for daily aggregation
date_trunc('day', CAST(virtual_table.date_ AS TIMESTAMP))

--- specific filters
--- temporal range filter (configurable via dashboard)
virtual_table.date_ {temporal_range_operator} {date_range}

--- calculation_logic
sum(virtual_table.active_sessions) as "Active Sessions",
sum(virtual_table.analyzed_sessions) as "Analyzed Sessions", 
sum(virtual_table.eval_completed) as "Eval Completed",
sum(virtual_table.happy) as "Happy Feedback",
sum(virtual_table.sad) as "Sad Feedback",
sum(virtual_table.ah_tickets) as "Agent Tickets",
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL 
     ELSE (SUM(virtual_table.happy) + SUM(virtual_table.sad)) * 100 / SUM(virtual_table.active_sessions) 
END as "Feedback Rate %",
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL 
     ELSE SUM(virtual_table.ah_tickets) * 100 / SUM(virtual_table.active_sessions) 
END as "Agent Handover %"




## Overall Summary

This metric provides a comprehensive daily summary of soundbox evaluation performance for the p4bbusinessloan entity within the MHD evaluation system. It tracks key operational metrics including total active sessions, sessions that underwent analysis, completed evaluations, customer feedback (both positive and negative), and tickets requiring agent intervention. The summary also calculates derived performance indicators such as feedback rate percentage (proportion of sessions receiving feedback) and agent handover percentage (proportion of sessions escalated to human agents). This consolidated view enables stakeholders to monitor overall system health, customer satisfaction levels, and operational efficiency on a daily basis, providing essential insights for performance optimization and resource allocation decisions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- entity filter for p4bbusinessloan business unit
virtual_table.cst_entity IN ('p4bbusinessloan') AND
--- temporal grouping by day for daily aggregation
date_trunc('day', CAST(virtual_table.date_ AS TIMESTAMP))

--- specific filters
--- temporal range filter (configurable via dashboard)
virtual_table.date_ {temporal_range_operator} {date_range}

--- calculation_logic
sum(virtual_table.active_sessions) as "Active Sessions",
sum(virtual_table.analyzed_sessions) as "Analyzed Sessions", 
sum(virtual_table.eval_completed) as "Eval Completed",
sum(virtual_table.happy) as "Happy Feedback",
sum(virtual_table.sad) as "Sad Feedback",
sum(virtual_table.ah_tickets) as "Agent Tickets",
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL 
     ELSE (SUM(virtual_table.happy) + SUM(virtual_table.sad)) * 100 / SUM(virtual_table.active_sessions) 
END as "Feedback Rate %",
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL 
     ELSE SUM(virtual_table.ah_tickets) * 100 / SUM(virtual_table.active_sessions) 
END as "Agent Handover %"




## LLM L1 Metrics

This comprehensive LLM evaluation dashboard tracks 13 key performance indicators for the P4B Business Loan customer service system, analyzing bot interaction quality and effectiveness. The metrics include session volume (Active Sessions), evaluation completion rates, quality assessments (evaluation scores, response relevance, empathy), user satisfaction (MSAT percentage), sentiment analysis (positive sentiment change), resolution achievement rates, and failure mode detection (bad evaluations, intent detection failures, bot repetition and failures, topic drift). Data is segmented by problem description categories to identify performance variations across different customer issue types. The analysis excludes unanalyzed interactions and current-day incomplete data, providing a complete view of LLM performance for operational optimization and quality assurance in automated customer service delivery.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unanalyzed interactions from evaluation metrics
eval.description != 'Not Analyzed' AND
--- focus on P4B business loan customer service entity
eval.cst_entity IN ('p4bbusinessloan') AND
--- exclude current day data to ensure complete evaluation cycles
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY

--- specific filters
--- configurable temporal range filter (defaults to "No filter")
--- eval.date_ TEMPORAL_RANGE ({time_range})

--- calculation_logic
Active Sessions: SUM(eval.active_sessions)
Eval Completed %: SUM(eval.eval_completed) * 100 / SUM(eval.active_sessions)
AVG Eval Score: AVG(eval.avg_eval_score) * 100
AVG Response Relevance: AVG(eval.avg_response_relevance_score) * 100
MSAT %: CASE WHEN (SUM(eval.happy) + SUM(eval.sad)) = 0 THEN NULL ELSE (SUM(eval.happy) * 100.0) / (SUM(eval.happy) + SUM(eval.sad)) END
AVG Empathy Score: AVG(eval.avg_empathy_score) * 100
+ve Sentiment Change %: CASE WHEN (SUM(eval.positive_user_sentiment)+SUM(eval.negative_user_sentiment)+SUM(eval.neutral_user_sentiment)) = 0 THEN NULL ELSE SUM(eval.positive_user_sentiment) * 100 / (SUM(eval.positive_user_sentiment)+SUM(eval.negative_user_sentiment)+SUM(eval.neutral_user_sentiment)) END
AVG Resolution Achieved: AVG(eval.avg_resolution_achieved) * 100
Bad Eval Share %: CASE WHEN (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) = 0 THEN NULL ELSE SUM(eval.eval_score_bad) * 100 / (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) END
Intent Detection Failed %: CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL ELSE SUM(eval.intent_incoherence_count) * 100 / SUM(eval.active_sessions) END
Bot Repetition %: CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL ELSE SUM(eval.agent_response_repetition) * 100 / SUM(eval.active_sessions) END
Bot Failed %: CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL ELSE SUM(eval.function_call_failed) * 100 / SUM(eval.active_sessions) END
AVG Topic Drift: AVG(eval.avg_topic_drift) * 100




## Analyzed + Eval Completed % - Complete Day

This metric tracks the completion rates of soundbox evaluation processes for the p4bprofile entity. The Analyzed percentage measures what portion of active sessions have been successfully analyzed, calculated as analyzed sessions divided by total active sessions. The Eval Completed percentage measures the completion rate of evaluations among analyzed sessions, showing how many analyzed sessions have completed the full evaluation process. This operational metric helps monitor the efficiency and throughput of the soundbox evaluation pipeline, identifying potential bottlenecks in either the analysis phase or the evaluation completion phase. The metric is specifically scoped to p4bprofile entity operations and can be filtered by date ranges for temporal analysis of evaluation performance trends.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed sb

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bprofile entity for focused evaluation tracking
sb.cst_entity = 'p4bprofile' AND

--- specific filters
--- temporal filter for date-based analysis (configurable)
--- date range filter applied on date_ column when specified
sb.date_ {temporal_operator} {date_range}

--- calculation_logic
SUM(sb.analyzed_sessions) * 100 / SUM(sb.active_sessions) AS analyzed_percentage,
SUM(sb.eval_completed) * 100 / SUM(sb.analyzed_sessions) AS eval_completed_percentage




## Final User Sentiment #

This metric tracks daily user sentiment distribution for P4B profile entities within the soundbox evaluation system. It measures the count of positive, neutral, and negative user sentiment changes aggregated by day, providing insights into user experience trends and satisfaction levels. The metric is filtered specifically for 'p4bprofile' entities to focus on business payment profile feedback. This helps stakeholders monitor sentiment patterns over time, identify potential issues affecting user satisfaction, and measure the impact of product changes or improvements on user perception within the payments for business ecosystem.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B profile entities only
eval.cst_entity IN ('p4bprofile') AND
--- temporal filter - no specific range applied (configurable)
eval.hour_timestamp IS NOT NULL

--- calculation_logic
sum(eval.neutral_user_sentiment) as neutral_change_count,
sum(eval.positive_user_sentiment) as positive_change_count,
sum(eval.negative_user_sentiment) as negative_change_count,
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP)) as day_date




## Final User Sentiment Analysis

This metric tracks the distribution of user sentiment feedback across positive, negative, and neutral categories for the p4bprofile customer service entity. It calculates the percentage breakdown of each sentiment type relative to total sentiment volume, providing insights into customer satisfaction trends over time. The analysis includes null handling for periods with zero sentiment data and groups results by day to show temporal patterns. This helps customer service teams monitor satisfaction levels and identify periods requiring attention or investigation into service quality issues.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 soundbox

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to p4bprofile customer service entity
soundbox.cst_entity IN ('p4bprofile') AND
--- temporal filter with no restrictions (configurable)
soundbox.hour_timestamp IS NOT NULL

--- specific filters
--- none - uses standard entity filter only

--- calculation_logic
CASE WHEN (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment)) = 0 THEN NULL
ELSE SUM({sentiment_type}_user_sentiment) * 100 / (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment))
END
where {sentiment_type} = positive, negative, or neutral




## Daily Quality Metrics Trend (%)

This metric tracks daily quality performance indicators for customer support operations, specifically for the p4bprofile entity. It measures four key aspects: average evaluation score percentage showing overall quality assessment, bot containment percentage indicating automated resolution effectiveness, MSAT percentage reflecting customer satisfaction rates, and bad evaluation share percentage highlighting quality issues. The metrics are calculated daily with proper null handling to avoid division by zero errors, providing trend analysis for support quality management. This comprehensive view enables monitoring of support performance across multiple quality dimensions over time.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for specific customer support entity
eval.cst_entity IN ('p4bprofile')

--- specific filters
--- temporal filter for daily trend analysis (configurable range)
eval.date_ BETWEEN {start_date} AND {end_date}

--- calculation_logic
AVG(eval.avg_eval_score) * 100 as avg_eval_score_pct,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL 
     ELSE (SUM(eval.active_sessions) - SUM(eval.fd_tickets)) * 100 / SUM(eval.active_sessions) 
END as bot_containment_pct,
CASE WHEN (SUM(eval.sad) + SUM(eval.happy)) = 0 THEN NULL 
     ELSE SUM(eval.happy) * 100 / (SUM(eval.sad) + SUM(eval.happy)) 
END as msat_pct,
CASE WHEN (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) = 0 THEN NULL 
     ELSE SUM(eval.eval_score_bad) * 100 / (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) 
END as bad_eval_share_pct




## Final User Sentiment #

This metric tracks daily user sentiment distribution for P4B profile entities within the soundbox evaluation system. It measures the count of positive, neutral, and negative user sentiment changes aggregated by day, providing insights into user experience trends and satisfaction levels. The metric is filtered specifically for 'p4bprofile' entities to focus on business payment profile feedback. This helps stakeholders monitor sentiment patterns over time, identify potential issues affecting user satisfaction, and measure the impact of product changes or improvements on user perception within the payments for business ecosystem.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for P4B profile entities only
eval.cst_entity IN ('p4bprofile') AND
--- temporal filter - no specific range applied (configurable)
eval.hour_timestamp IS NOT NULL

--- calculation_logic
sum(eval.neutral_user_sentiment) as neutral_change_count,
sum(eval.positive_user_sentiment) as positive_change_count,
sum(eval.negative_user_sentiment) as negative_change_count,
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP)) as day_date




## Bot Performance Metrics

Bot Performance Metrics tracks the failure rates of conversational AI systems within the MHD evaluation framework. This measures bot repetition percentage (when agents provide repetitive responses), bot function call failure percentage (when programmatic functions fail to execute), and intent detection failure percentage (when the system fails to correctly identify user intentions). The metrics are filtered to the 'p4bprofile' customer service entity and aggregated daily to monitor bot quality and reliability over time. Each percentage represents the ratio of specific failure events to total completed evaluations, providing insights into different aspects of bot performance degradation and helping identify areas needing improvement in the conversational AI system.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bprofile customer service entity
eval.cst_entity IN ('p4bprofile') AND
--- temporal aggregation by day
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP))

--- specific filters
--- optional temporal range filter (configurable in dashboard)
eval.hour_timestamp TEMPORAL_RANGE (configurable)

--- calculation_logic
pattern: failure_rate_percentage
base_metrics: [agent_response_repetition, function_call_failed, intent_incoherence_count]
denominator: eval_completed
aggregation: SUM




## Final User Sentiment Analysis

This metric tracks the distribution of user sentiment feedback across positive, negative, and neutral categories for the p4bprofile customer service entity. It calculates the percentage breakdown of each sentiment type relative to total sentiment volume, providing insights into customer satisfaction trends over time. The analysis includes null handling for periods with zero sentiment data and groups results by day to show temporal patterns. This helps customer service teams monitor satisfaction levels and identify periods requiring attention or investigation into service quality issues.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 soundbox

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to p4bprofile customer service entity
soundbox.cst_entity IN ('p4bprofile') AND
--- temporal filter with no restrictions (configurable)
soundbox.hour_timestamp IS NOT NULL

--- specific filters
--- none - uses standard entity filter only

--- calculation_logic
CASE WHEN (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment)) = 0 THEN NULL
ELSE SUM({sentiment_type}_user_sentiment) * 100 / (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment))
END
where {sentiment_type} = positive, negative, or neutral




## Daily Quality Metrics Trend (%)

This metric tracks daily quality performance indicators for customer support operations, specifically for the p4bprofile entity. It measures four key aspects: average evaluation score percentage showing overall quality assessment, bot containment percentage indicating automated resolution effectiveness, MSAT percentage reflecting customer satisfaction rates, and bad evaluation share percentage highlighting quality issues. The metrics are calculated daily with proper null handling to avoid division by zero errors, providing trend analysis for support quality management. This comprehensive view enables monitoring of support performance across multiple quality dimensions over time.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for specific customer support entity
eval.cst_entity IN ('p4bprofile')

--- specific filters
--- temporal filter for daily trend analysis (configurable range)
eval.date_ BETWEEN {start_date} AND {end_date}

--- calculation_logic
AVG(eval.avg_eval_score) * 100 as avg_eval_score_pct,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL 
     ELSE (SUM(eval.active_sessions) - SUM(eval.fd_tickets)) * 100 / SUM(eval.active_sessions) 
END as bot_containment_pct,
CASE WHEN (SUM(eval.sad) + SUM(eval.happy)) = 0 THEN NULL 
     ELSE SUM(eval.happy) * 100 / (SUM(eval.sad) + SUM(eval.happy)) 
END as msat_pct,
CASE WHEN (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) = 0 THEN NULL 
     ELSE SUM(eval.eval_score_bad) * 100 / (SUM(eval.eval_score_good) + SUM(eval.eval_score_bad)) 
END as bad_eval_share_pct




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks three core customer service quality dimensions for Soundbox evaluations within the p4bprofile entity: empathy score measuring emotional intelligence in customer interactions, resolution achieved indicating successful problem-solving rates, and response relevance assessing the appropriateness of responses to customer queries. All metrics are calculated as daily averages and converted to percentage format for standardized reporting. This consolidated view enables comprehensive assessment of customer service performance across multiple quality dimensions, helping identify areas for improvement in customer support operations and tracking overall service quality trends over time.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bprofile entity for focused analysis
eval.cst_entity = 'p4bprofile' AND
--- temporal filters available but not applied (No filter set)
eval.date_ IS NOT NULL

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks three core customer service quality dimensions for Soundbox evaluations within the p4bprofile entity: empathy score measuring emotional intelligence in customer interactions, resolution achieved indicating successful problem-solving rates, and response relevance assessing the appropriateness of responses to customer queries. All metrics are calculated as daily averages and converted to percentage format for standardized reporting. This consolidated view enables comprehensive assessment of customer service performance across multiple quality dimensions, helping identify areas for improvement in customer support operations and tracking overall service quality trends over time.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bprofile entity for focused analysis
eval.cst_entity = 'p4bprofile' AND
--- temporal filters available but not applied (No filter set)
eval.date_ IS NOT NULL

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## Bot Performance Metrics

Bot Performance Metrics tracks the failure rates of conversational AI systems within the MHD evaluation framework. This measures bot repetition percentage (when agents provide repetitive responses), bot function call failure percentage (when programmatic functions fail to execute), and intent detection failure percentage (when the system fails to correctly identify user intentions). The metrics are filtered to the 'p4bprofile' customer service entity and aggregated daily to monitor bot quality and reliability over time. Each percentage represents the ratio of specific failure events to total completed evaluations, providing insights into different aspects of bot performance degradation and helping identify areas needing improvement in the conversational AI system.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bprofile customer service entity
eval.cst_entity IN ('p4bprofile') AND
--- temporal aggregation by day
date_trunc('day', CAST(eval.hour_timestamp AS TIMESTAMP))

--- specific filters
--- optional temporal range filter (configurable in dashboard)
eval.hour_timestamp TEMPORAL_RANGE (configurable)

--- calculation_logic
pattern: failure_rate_percentage
base_metrics: [agent_response_repetition, function_call_failed, intent_incoherence_count]
denominator: eval_completed
aggregation: SUM




## LLM L1 Metrics

This metric suite tracks comprehensive LLM assistant performance across multiple quality dimensions for customer support evaluation. It measures session volume, evaluation completion rates, average quality scores (evaluation, response relevance, empathy, resolution achievement, topic drift), customer satisfaction indicators (MSAT percentage, positive sentiment change), and failure analysis metrics (bad evaluation share, intent detection failures, bot repetition and failure rates). The analysis is segmented by problem description categories and focuses on analyzed interactions for the p4bprofile entity, excluding unprocessed items. These metrics enable monitoring of AI assistant effectiveness, identifying performance gaps, and tracking improvement trends across different customer issue types.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unanalyzed interactions to focus on processed evaluations
eval.description != 'Not Analyzed' AND
--- entity scope filter for p4bprofile operations
eval.cst_entity IN ('p4bprofile') AND
--- temporal filter for completed day analysis
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY

--- specific filters
--- grouping dimension for problem categorization
eval.out_key_problem_desc

--- calculation_logic
-- Volume: SUM(active_sessions)
-- Completion Rate: SUM(eval_completed) * 100 / SUM(active_sessions)
-- Quality Scores: AVG(score_field) * 100 for avg_eval_score, avg_response_relevance_score, avg_empathy_score, avg_resolution_achieved, avg_topic_drift
-- Satisfaction Metrics: 
--   MSAT: CASE WHEN (SUM(happy) + SUM(sad)) = 0 THEN NULL ELSE (SUM(happy) * 100.0) / (SUM(happy) + SUM(sad)) END
--   Sentiment: SUM(positive_user_sentiment) * 100 / (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment))
-- Failure Analysis:
--   Bad Eval: SUM(eval_score_bad) * 100 / (SUM(eval_score_good) + SUM(eval_score_bad))
--   Intent/Bot Failures: SUM(failure_count) * 100 / SUM(active_sessions) for intent_incoherence_count, agent_response_repetition, function_call_failed




## LLM L1 Metrics

This metric suite tracks comprehensive LLM assistant performance across multiple quality dimensions for customer support evaluation. It measures session volume, evaluation completion rates, average quality scores (evaluation, response relevance, empathy, resolution achievement, topic drift), customer satisfaction indicators (MSAT percentage, positive sentiment change), and failure analysis metrics (bad evaluation share, intent detection failures, bot repetition and failure rates). The analysis is segmented by problem description categories and focuses on analyzed interactions for the p4bprofile entity, excluding unprocessed items. These metrics enable monitoring of AI assistant effectiveness, identifying performance gaps, and tracking improvement trends across different customer issue types.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unanalyzed interactions to focus on processed evaluations
eval.description != 'Not Analyzed' AND
--- entity scope filter for p4bprofile operations
eval.cst_entity IN ('p4bprofile') AND
--- temporal filter for completed day analysis
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY

--- specific filters
--- grouping dimension for problem categorization
eval.out_key_problem_desc

--- calculation_logic
-- Volume: SUM(active_sessions)
-- Completion Rate: SUM(eval_completed) * 100 / SUM(active_sessions)
-- Quality Scores: AVG(score_field) * 100 for avg_eval_score, avg_response_relevance_score, avg_empathy_score, avg_resolution_achieved, avg_topic_drift
-- Satisfaction Metrics: 
--   MSAT: CASE WHEN (SUM(happy) + SUM(sad)) = 0 THEN NULL ELSE (SUM(happy) * 100.0) / (SUM(happy) + SUM(sad)) END
--   Sentiment: SUM(positive_user_sentiment) * 100 / (SUM(positive_user_sentiment) + SUM(negative_user_sentiment) + SUM(neutral_user_sentiment))
-- Failure Analysis:
--   Bad Eval: SUM(eval_score_bad) * 100 / (SUM(eval_score_good) + SUM(eval_score_bad))
--   Intent/Bot Failures: SUM(failure_count) * 100 / SUM(active_sessions) for intent_incoherence_count, agent_response_repetition, function_call_failed




## Analyzed + Eval Completed % - Complete Day

This metric tracks the evaluation completion funnel for soundbox sessions within the MHD (Merchant Hardware Device) evaluation system. It measures two key performance indicators: the percentage of active sessions that have been analyzed, and the percentage of analyzed sessions that have completed evaluation. The metrics are specifically filtered to the p4bwealth entity and represent daily completion rates. This helps monitor the efficiency of the evaluation pipeline and identify bottlenecks in the analysis or evaluation completion process. The dual percentage view provides visibility into both the analysis coverage rate and the evaluation completion rate within the analyzed subset.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed sb

--- standard filters to be applied unless specifically requested for a different categorical value
--- entity filter for p4bwealth operations
sb.cst_entity = 'p4bwealth' AND
--- temporal filter for date range (configurable)
sb.date_ BETWEEN {start_date} AND {end_date}

--- calculation_logic
analyzed_percentage: SUM(analyzed_sessions) * 100 / SUM(active_sessions),
eval_completed_percentage: SUM(eval_completed) * 100 / SUM(analyzed_sessions)




## Analyzed + Eval Completed % - Complete Day

This metric tracks the evaluation completion funnel for soundbox sessions within the MHD (Merchant Hardware Device) evaluation system. It measures two key performance indicators: the percentage of active sessions that have been analyzed, and the percentage of analyzed sessions that have completed evaluation. The metrics are specifically filtered to the p4bwealth entity and represent daily completion rates. This helps monitor the efficiency of the evaluation pipeline and identify bottlenecks in the analysis or evaluation completion process. The dual percentage view provides visibility into both the analysis coverage rate and the evaluation completion rate within the analyzed subset.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed sb

--- standard filters to be applied unless specifically requested for a different categorical value
--- entity filter for p4bwealth operations
sb.cst_entity = 'p4bwealth' AND
--- temporal filter for date range (configurable)
sb.date_ BETWEEN {start_date} AND {end_date}

--- calculation_logic
analyzed_percentage: SUM(analyzed_sessions) * 100 / SUM(active_sessions),
eval_completed_percentage: SUM(eval_completed) * 100 / SUM(analyzed_sessions)




## Overall Summary

This metric tracks comprehensive soundbox evaluation performance including session activity, analysis completion, customer feedback sentiment, and agent intervention rates. It measures operational efficiency by tracking active sessions against analyzed sessions, evaluation completions, and customer satisfaction through happy/sad feedback counts. The dashboard filters for p4bprofile entity to focus on specific business profile evaluation metrics. Key performance indicators include feedback participation rate (percentage of active sessions providing feedback) and agent handover rate (percentage of sessions requiring human agent intervention), providing insights into automated evaluation effectiveness and customer satisfaction trends.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- entity filtering for p4bprofile business profile
virtual_table.cst_entity IN ('p4bprofile') AND
--- temporal filtering with flexible date range capability
virtual_table.date_ {temporal_range_filter}

--- calculation_logic
sum(active_sessions) as active_sessions_total,
sum(analyzed_sessions) as analyzed_sessions_total,
sum(eval_completed) as eval_completed_total,
sum(happy) as happy_feedback_total,
sum(sad) as sad_feedback_total,
sum(ah_tickets) as agent_tickets_total,
CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE (SUM(happy) + SUM(sad)) * 100 / SUM(active_sessions) END as feedback_rate_percent,
CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE SUM(ah_tickets) * 100 / SUM(active_sessions) END as agent_handover_percent




## Daily Quality Metrics Trend (%)

Daily Quality Metrics Trend tracks four key performance indicators for MHD evaluation system effectiveness as percentage values over time. The metrics measure average evaluation score percentage, bot containment rate (percentage of sessions handled without escalating to human agents), customer satisfaction rate (MSAT percentage based on happy vs sad feedback), and bad evaluation share percentage. All calculations include null-safety logic to handle cases where denominators are zero. The data is filtered specifically for the p4bwealth entity and aggregated daily to show quality trends. These metrics collectively provide insights into customer service automation effectiveness, agent performance quality, and overall customer satisfaction levels.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval_summary

--- standard filters to be applied unless specifically requested for a different entity
--- filter for p4bwealth entity scope
eval_summary.cst_entity IN ('p4bwealth') AND
--- temporal filter for date range analysis
eval_summary.date_ IS NOT NULL

--- calculation_logic
AVG(eval_summary.avg_eval_score) * 100 as avg_eval_score_pct,
CASE WHEN SUM(eval_summary.active_sessions) = 0 THEN NULL 
     ELSE (SUM(eval_summary.active_sessions) - SUM(eval_summary.fd_tickets)) * 100 / SUM(eval_summary.active_sessions) 
END as bot_containment_pct,
CASE WHEN (SUM(eval_summary.sad) + SUM(eval_summary.happy)) = 0 THEN NULL 
     ELSE SUM(eval_summary.happy) * 100 / (SUM(eval_summary.sad) + SUM(eval_summary.happy)) 
END as msat_pct,
CASE WHEN (SUM(eval_summary.eval_score_good) + SUM(eval_summary.eval_score_bad)) = 0 THEN NULL
     ELSE SUM(eval_summary.eval_score_bad) * 100 / (SUM(eval_summary.eval_score_good) + SUM(eval_summary.eval_score_bad))
END as bad_eval_share_pct




## Daily Quality Metrics Trend (%)

Daily Quality Metrics Trend tracks four key performance indicators for MHD evaluation system effectiveness as percentage values over time. The metrics measure average evaluation score percentage, bot containment rate (percentage of sessions handled without escalating to human agents), customer satisfaction rate (MSAT percentage based on happy vs sad feedback), and bad evaluation share percentage. All calculations include null-safety logic to handle cases where denominators are zero. The data is filtered specifically for the p4bwealth entity and aggregated daily to show quality trends. These metrics collectively provide insights into customer service automation effectiveness, agent performance quality, and overall customer satisfaction levels.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval_summary

--- standard filters to be applied unless specifically requested for a different entity
--- filter for p4bwealth entity scope
eval_summary.cst_entity IN ('p4bwealth') AND
--- temporal filter for date range analysis
eval_summary.date_ IS NOT NULL

--- calculation_logic
AVG(eval_summary.avg_eval_score) * 100 as avg_eval_score_pct,
CASE WHEN SUM(eval_summary.active_sessions) = 0 THEN NULL 
     ELSE (SUM(eval_summary.active_sessions) - SUM(eval_summary.fd_tickets)) * 100 / SUM(eval_summary.active_sessions) 
END as bot_containment_pct,
CASE WHEN (SUM(eval_summary.sad) + SUM(eval_summary.happy)) = 0 THEN NULL 
     ELSE SUM(eval_summary.happy) * 100 / (SUM(eval_summary.sad) + SUM(eval_summary.happy)) 
END as msat_pct,
CASE WHEN (SUM(eval_summary.eval_score_good) + SUM(eval_summary.eval_score_bad)) = 0 THEN NULL
     ELSE SUM(eval_summary.eval_score_bad) * 100 / (SUM(eval_summary.eval_score_good) + SUM(eval_summary.eval_score_bad))
END as bad_eval_share_pct




## Final User Sentiment Analysis

This metric tracks the distribution of user sentiment feedback as percentages (positive, negative, neutral) for customer service touchpoints within the p4bwealth entity ecosystem. It measures sentiment analysis results from the soundbox evaluation system, providing daily aggregated views of customer satisfaction patterns. The metric calculates each sentiment category as a percentage of total sentiment responses, helping identify trends in customer experience and satisfaction levels. It serves as a key performance indicator for customer service quality monitoring and enables proactive identification of satisfaction issues or improvements in user experience across different time periods.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 sentiment

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth customer entity
sentiment.cst_entity IN ('p4bwealth')

--- specific filters
--- temporal range filter available but no default restriction applied
--- sentiment.hour_timestamp can be filtered using TEMPORAL_RANGE operator

--- calculation_logic
pattern: sentiment_percentage_distribution
base_metrics: [positive_user_sentiment, negative_user_sentiment, neutral_user_sentiment]
aggregation: daily (date_trunc('day', hour_timestamp))




## Final User Sentiment #

This metric tracks daily user sentiment changes across three categories (positive, negative, neutral) for the p4bwealth entity within the MHD evaluation system. It measures the volume of sentiment feedback by aggregating sentiment counts per day, providing insights into user satisfaction trends and reaction patterns. The metric is filtered specifically for p4bwealth operations to enable focused analysis of this particular business unit's user experience performance. This enables stakeholders to monitor sentiment distribution patterns, identify periods of positive or negative user feedback spikes, and assess overall user satisfaction trajectory for strategic decision-making and product improvement initiatives.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 soundbox

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth entity only
soundbox.cst_entity IN ('p4bwealth')

--- specific filters
--- no temporal restrictions applied (temporal range set to "No filter")
--- date grouping by day using hour_timestamp field
date_trunc('day', CAST(soundbox.hour_timestamp AS TIMESTAMP))

--- calculation_logic
sum(soundbox.neutral_user_sentiment) as neutral_change_count,
sum(soundbox.positive_user_sentiment) as positive_change_count,
sum(soundbox.negative_user_sentiment) as negative_change_count




## Overall Summary

This metric tracks comprehensive soundbox evaluation performance including session activity, analysis completion, customer feedback sentiment, and agent intervention rates. It measures operational efficiency by tracking active sessions against analyzed sessions, evaluation completions, and customer satisfaction through happy/sad feedback counts. The dashboard filters for p4bprofile entity to focus on specific business profile evaluation metrics. Key performance indicators include feedback participation rate (percentage of active sessions providing feedback) and agent handover rate (percentage of sessions requiring human agent intervention), providing insights into automated evaluation effectiveness and customer satisfaction trends.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- entity filtering for p4bprofile business profile
virtual_table.cst_entity IN ('p4bprofile') AND
--- temporal filtering with flexible date range capability
virtual_table.date_ {temporal_range_filter}

--- calculation_logic
sum(active_sessions) as active_sessions_total,
sum(analyzed_sessions) as analyzed_sessions_total,
sum(eval_completed) as eval_completed_total,
sum(happy) as happy_feedback_total,
sum(sad) as sad_feedback_total,
sum(ah_tickets) as agent_tickets_total,
CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE (SUM(happy) + SUM(sad)) * 100 / SUM(active_sessions) END as feedback_rate_percent,
CASE WHEN SUM(active_sessions) = 0 THEN NULL ELSE SUM(ah_tickets) * 100 / SUM(active_sessions) END as agent_handover_percent




## Final User Sentiment #

This metric tracks daily user sentiment changes across three categories (positive, negative, neutral) for the p4bwealth entity within the MHD evaluation system. It measures the volume of sentiment feedback by aggregating sentiment counts per day, providing insights into user satisfaction trends and reaction patterns. The metric is filtered specifically for p4bwealth operations to enable focused analysis of this particular business unit's user experience performance. This enables stakeholders to monitor sentiment distribution patterns, identify periods of positive or negative user feedback spikes, and assess overall user satisfaction trajectory for strategic decision-making and product improvement initiatives.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 soundbox

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth entity only
soundbox.cst_entity IN ('p4bwealth')

--- specific filters
--- no temporal restrictions applied (temporal range set to "No filter")
--- date grouping by day using hour_timestamp field
date_trunc('day', CAST(soundbox.hour_timestamp AS TIMESTAMP))

--- calculation_logic
sum(soundbox.neutral_user_sentiment) as neutral_change_count,
sum(soundbox.positive_user_sentiment) as positive_change_count,
sum(soundbox.negative_user_sentiment) as negative_change_count




## Final User Sentiment Analysis

This metric tracks the distribution of user sentiment feedback as percentages (positive, negative, neutral) for customer service touchpoints within the p4bwealth entity ecosystem. It measures sentiment analysis results from the soundbox evaluation system, providing daily aggregated views of customer satisfaction patterns. The metric calculates each sentiment category as a percentage of total sentiment responses, helping identify trends in customer experience and satisfaction levels. It serves as a key performance indicator for customer service quality monitoring and enables proactive identification of satisfaction issues or improvements in user experience across different time periods.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 sentiment

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth customer entity
sentiment.cst_entity IN ('p4bwealth')

--- specific filters
--- temporal range filter available but no default restriction applied
--- sentiment.hour_timestamp can be filtered using TEMPORAL_RANGE operator

--- calculation_logic
pattern: sentiment_percentage_distribution
base_metrics: [positive_user_sentiment, negative_user_sentiment, neutral_user_sentiment]
aggregation: daily (date_trunc('day', hour_timestamp))




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks three key customer service evaluation scores for the p4bwealth entity: empathy score measuring emotional support quality, resolution achieved rate indicating problem-solving effectiveness, and response relevance score assessing answer appropriateness. These metrics are calculated as daily averages and presented as percentages to evaluate customer support team performance. The data comes from Level 1 evaluation summaries and helps identify trends in service quality across different aspects of customer interaction. Results are ordered by empathy score to prioritize emotional support performance in the analysis.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth business entity
eval.cst_entity IN ('p4bwealth')

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## AVG Empathy Score + Resolution Achieved + Response Relevance

This metric tracks three key customer service evaluation scores for the p4bwealth entity: empathy score measuring emotional support quality, resolution achieved rate indicating problem-solving effectiveness, and response relevance score assessing answer appropriateness. These metrics are calculated as daily averages and presented as percentages to evaluate customer support team performance. The data comes from Level 1 evaluation summaries and helps identify trends in service quality across different aspects of customer interaction. Results are ordered by empathy score to prioritize emotional support performance in the analysis.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth business entity
eval.cst_entity IN ('p4bwealth')

--- calculation_logic
AVG(eval.avg_empathy_score) * 100 as avg_empathy_score_pct,
AVG(eval.avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
AVG(eval.avg_response_relevance_score) * 100 as avg_response_relevance_pct




## Bot Performance Metrics

Bot Performance Metrics track three critical quality indicators for chatbot interactions in the MHD evaluation system. Bot Repetition % measures how often the bot provides repetitive responses, Bot Failed % tracks function call failures during bot operations, and Intent Detection Failed % monitors cases where the bot fails to correctly identify user intent. These metrics are calculated as percentages of total completed evaluations and are filtered specifically for the p4bwealth entity. The metrics provide daily aggregated views to monitor bot performance trends and identify quality degradation patterns that may require intervention or model retraining.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth entity for focused evaluation scope
eval.cst_entity IN ('p4bwealth')

--- specific filters
--- temporal filtering available but set to 'No filter' by default
--- eval.hour_timestamp can be filtered using TEMPORAL_RANGE operator

--- calculation_logic
pattern: error_rate_percentage
base_denominator: SUM(eval_completed)
error_numerators: [SUM(agent_response_repetition), SUM(function_call_failed), SUM(intent_incoherence_count)]
grouping: date_trunc('day', CAST(hour_timestamp AS TIMESTAMP))




## Bot Performance Metrics

Bot Performance Metrics track three critical quality indicators for chatbot interactions in the MHD evaluation system. Bot Repetition % measures how often the bot provides repetitive responses, Bot Failed % tracks function call failures during bot operations, and Intent Detection Failed % monitors cases where the bot fails to correctly identify user intent. These metrics are calculated as percentages of total completed evaluations and are filtered specifically for the p4bwealth entity. The metrics provide daily aggregated views to monitor bot performance trends and identify quality degradation patterns that may require intervention or model retraining.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_l1_summary1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict analysis to p4bwealth entity for focused evaluation scope
eval.cst_entity IN ('p4bwealth')

--- specific filters
--- temporal filtering available but set to 'No filter' by default
--- eval.hour_timestamp can be filtered using TEMPORAL_RANGE operator

--- calculation_logic
pattern: error_rate_percentage
base_denominator: SUM(eval_completed)
error_numerators: [SUM(agent_response_repetition), SUM(function_call_failed), SUM(intent_incoherence_count)]
grouping: date_trunc('day', CAST(hour_timestamp AS TIMESTAMP))




## LLM L1 Metrics

This metric tracks comprehensive LLM evaluation performance across customer service interactions, segmented by problem description categories for the P4B Wealth entity. It measures session activity, evaluation completion rates, quality scores including evaluation accuracy and response relevance, customer satisfaction through MSAT percentages, sentiment analysis outcomes, resolution achievement rates, and various failure modes including intent detection failures, bot repetition, and function call failures. The metrics provide operational insights into LLM performance across different problem types, enabling identification of areas needing improvement. Data excludes unanalyzed sessions and current-day incomplete data to ensure accurate historical performance assessment. This consolidated view supports quality monitoring and performance optimization decisions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unanalyzed sessions from evaluation metrics
eval.description != 'Not Analyzed' AND
--- focus on P4B Wealth entity performance
eval.cst_entity IN ('p4bwealth') AND
--- exclude current day to avoid incomplete data in daily reporting
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY

--- specific filters
--- segment by problem description for category-wise analysis
GROUP BY eval.out_key_problem_desc

--- calculation_logic
SUM(active_sessions) as active_sessions_total,
SUM(eval_completed) * 100 / SUM(active_sessions) as eval_completion_rate,
AVG(avg_eval_score) * 100 as avg_eval_score_pct,
AVG(avg_response_relevance_score) * 100 as avg_response_relevance_pct,
CASE WHEN (SUM(happy) + SUM(sad)) = 0 THEN NULL ELSE (SUM(happy) * 100.0) / (SUM(happy) + SUM(sad)) END as msat_percentage,
AVG(avg_empathy_score) * 100 as avg_empathy_score_pct,
pattern: sentiment_distribution_percentage,
AVG(avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
pattern: binary_quality_percentage with eval_score_bad/eval_score_good,
pattern: failure_rate_percentage with intent_incoherence_count,
pattern: failure_rate_percentage with agent_response_repetition,
pattern: failure_rate_percentage with function_call_failed,
AVG(avg_topic_drift) * 100 as avg_topic_drift_pct




## LLM L1 Metrics

This metric tracks comprehensive LLM evaluation performance across customer service interactions, segmented by problem description categories for the P4B Wealth entity. It measures session activity, evaluation completion rates, quality scores including evaluation accuracy and response relevance, customer satisfaction through MSAT percentages, sentiment analysis outcomes, resolution achievement rates, and various failure modes including intent detection failures, bot repetition, and function call failures. The metrics provide operational insights into LLM performance across different problem types, enabling identification of areas needing improvement. Data excludes unanalyzed sessions and current-day incomplete data to ensure accurate historical performance assessment. This consolidated view supports quality monitoring and performance optimization decisions.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_llm_l1 eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- exclude unanalyzed sessions from evaluation metrics
eval.description != 'Not Analyzed' AND
--- focus on P4B Wealth entity performance
eval.cst_entity IN ('p4bwealth') AND
--- exclude current day to avoid incomplete data in daily reporting
eval.date_ <= CURRENT_DATE - INTERVAL '1' DAY

--- specific filters
--- segment by problem description for category-wise analysis
GROUP BY eval.out_key_problem_desc

--- calculation_logic
SUM(active_sessions) as active_sessions_total,
SUM(eval_completed) * 100 / SUM(active_sessions) as eval_completion_rate,
AVG(avg_eval_score) * 100 as avg_eval_score_pct,
AVG(avg_response_relevance_score) * 100 as avg_response_relevance_pct,
CASE WHEN (SUM(happy) + SUM(sad)) = 0 THEN NULL ELSE (SUM(happy) * 100.0) / (SUM(happy) + SUM(sad)) END as msat_percentage,
AVG(avg_empathy_score) * 100 as avg_empathy_score_pct,
pattern: sentiment_distribution_percentage,
AVG(avg_resolution_achieved) * 100 as avg_resolution_achieved_pct,
pattern: binary_quality_percentage with eval_score_bad/eval_score_good,
pattern: failure_rate_percentage with intent_incoherence_count,
pattern: failure_rate_percentage with agent_response_repetition,
pattern: failure_rate_percentage with function_call_failed,
AVG(avg_topic_drift) * 100 as avg_topic_drift_pct




## Overall Summary

Overall Summary tracks comprehensive customer service performance metrics for the p4bwealth entity including active sessions, analyzed sessions, evaluation completions, customer feedback (happy and sad responses), and agent handover tickets. The chart calculates derived metrics including feedback rate percentage (total feedback responses as percentage of active sessions) and agent handover percentage (agent tickets as percentage of active sessions). This summary view provides daily aggregated insights into customer service operational efficiency, customer satisfaction levels, and escalation patterns. Data is filtered specifically for the p4bwealth business entity and presents time-series analysis of key performance indicators for management oversight and operational decision-making.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bwealth business entity for focused analysis
eval.cst_entity IN ('p4bwealth') AND
--- temporal filter for date range analysis (configurable)
eval.date_ {temporal_range_condition}

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions, 
sum(eval.eval_completed) as eval_completed,
sum(eval.happy) as happy_feedback,
sum(eval.sad) as sad_feedback,
sum(eval.ah_tickets) as agent_tickets,
CASE WHEN sum(eval.active_sessions) = 0 THEN NULL
     ELSE (sum(eval.happy) + sum(eval.sad)) * 100 / sum(eval.active_sessions)
END as feedback_rate_percent,
CASE WHEN sum(eval.active_sessions) = 0 THEN NULL
     ELSE sum(eval.ah_tickets) * 100 / sum(eval.active_sessions)
END as agent_handover_percent




## Overall Summary

Overall Summary tracks comprehensive customer service performance metrics for the p4bwealth entity including active sessions, analyzed sessions, evaluation completions, customer feedback (happy and sad responses), and agent handover tickets. The chart calculates derived metrics including feedback rate percentage (total feedback responses as percentage of active sessions) and agent handover percentage (agent tickets as percentage of active sessions). This summary view provides daily aggregated insights into customer service operational efficiency, customer satisfaction levels, and escalation patterns. Data is filtered specifically for the p4bwealth business entity and presents time-series analysis of key performance indicators for management oversight and operational decision-making.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to p4bwealth business entity for focused analysis
eval.cst_entity IN ('p4bwealth') AND
--- temporal filter for date range analysis (configurable)
eval.date_ {temporal_range_condition}

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions, 
sum(eval.eval_completed) as eval_completed,
sum(eval.happy) as happy_feedback,
sum(eval.sad) as sad_feedback,
sum(eval.ah_tickets) as agent_tickets,
CASE WHEN sum(eval.active_sessions) = 0 THEN NULL
     ELSE (sum(eval.happy) + sum(eval.sad)) * 100 / sum(eval.active_sessions)
END as feedback_rate_percent,
CASE WHEN sum(eval.active_sessions) = 0 THEN NULL
     ELSE sum(eval.ah_tickets) * 100 / sum(eval.active_sessions)
END as agent_handover_percent




## Device Eval Summary

The Device Eval Summary tracks the complete evaluation funnel for mobile healthcare devices, measuring system performance across active sessions, analysis completion, and evaluation outcomes. This metric monitors operational efficiency by calculating the percentage of active sessions that get analyzed and the percentage of analyzed sessions that complete evaluation. The data is filtered to include only p4bsoundbox and p4bAIBot entities, providing focused insights into these specific device types. The summary enables monitoring of conversion rates through the evaluation pipeline, identifying bottlenecks in the analysis or evaluation completion processes, and ensuring quality assurance standards are maintained across the MHD ecosystem.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on specific CST entity types for targeted evaluation tracking
virtual_table.cst_entity IN ('p4bsoundbox', 'p4bAIBot')

--- specific filters
--- temporal range filter available for date-based analysis
--- virtual_table.date_ {temporal_range_filter}

--- calculation_logic
sum(virtual_table.active_sessions) as active_sessions,
sum(virtual_table.analyzed_sessions) as analyzed_sessions,
sum(virtual_table.eval_completed) as eval_completed,
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL
ELSE SUM(virtual_table.analyzed_sessions) * 100 / SUM(virtual_table.active_sessions)
END as analyzed_percentage,
CASE WHEN SUM(virtual_table.analyzed_sessions) = 0 THEN NULL
ELSE SUM(virtual_table.eval_completed) * 100 / SUM(virtual_table.analyzed_sessions)
END as eval_completed_percentage




## Payout & Settlement Eval Summary

Tracks evaluation funnel performance for the Payout & Settlement business unit within the MHD system, measuring the progression from active merchant sessions through analysis completion to final evaluation. The metric provides visibility into operational efficiency by showing how many active sessions are successfully analyzed and what percentage of analyzed sessions complete the full evaluation process. Data is filtered specifically to the Payout & Settlement entity (p4bpayoutandsettlement) and aggregated by day to track daily performance trends. The funnel includes conversion percentages calculated as analyzed sessions divided by active sessions, and eval completed divided by analyzed sessions, providing insights into process bottlenecks and completion rates for merchant help desk operations focused on payout and settlement issues.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to payout and settlement business unit evaluations
virtual_table.cst_entity IN ('p4bpayoutandsettlement')

--- calculation_logic
sum(active_sessions) as "Active Sessions",
sum(analyzed_sessions) as "Analyzed Sessions", 
sum(eval_completed) as "Eval Completed",
CASE WHEN SUM(active_sessions) = 0 THEN NULL
ELSE SUM(analyzed_sessions) * 100 / SUM(active_sessions)
END as "Analyzed %",
CASE WHEN SUM(analyzed_sessions) = 0 THEN NULL
ELSE SUM(eval_completed) * 100 / SUM(analyzed_sessions)
END as "Eval Completed %"




## Payout & Settlement Eval Summary

Tracks evaluation funnel performance for the Payout & Settlement business unit within the MHD system, measuring the progression from active merchant sessions through analysis completion to final evaluation. The metric provides visibility into operational efficiency by showing how many active sessions are successfully analyzed and what percentage of analyzed sessions complete the full evaluation process. Data is filtered specifically to the Payout & Settlement entity (p4bpayoutandsettlement) and aggregated by day to track daily performance trends. The funnel includes conversion percentages calculated as analyzed sessions divided by active sessions, and eval completed divided by analyzed sessions, providing insights into process bottlenecks and completion rates for merchant help desk operations focused on payout and settlement issues.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to payout and settlement business unit evaluations
virtual_table.cst_entity IN ('p4bpayoutandsettlement')

--- calculation_logic
sum(active_sessions) as "Active Sessions",
sum(analyzed_sessions) as "Analyzed Sessions", 
sum(eval_completed) as "Eval Completed",
CASE WHEN SUM(active_sessions) = 0 THEN NULL
ELSE SUM(analyzed_sessions) * 100 / SUM(active_sessions)
END as "Analyzed %",
CASE WHEN SUM(analyzed_sessions) = 0 THEN NULL
ELSE SUM(eval_completed) * 100 / SUM(analyzed_sessions)
END as "Eval Completed %"




## Device Eval Summary

The Device Eval Summary tracks the complete evaluation funnel for mobile healthcare devices, measuring system performance across active sessions, analysis completion, and evaluation outcomes. This metric monitors operational efficiency by calculating the percentage of active sessions that get analyzed and the percentage of analyzed sessions that complete evaluation. The data is filtered to include only p4bsoundbox and p4bAIBot entities, providing focused insights into these specific device types. The summary enables monitoring of conversion rates through the evaluation pipeline, identifying bottlenecks in the analysis or evaluation completion processes, and ensuring quality assurance standards are maintained across the MHD ecosystem.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- focus on specific CST entity types for targeted evaluation tracking
virtual_table.cst_entity IN ('p4bsoundbox', 'p4bAIBot')

--- specific filters
--- temporal range filter available for date-based analysis
--- virtual_table.date_ {temporal_range_filter}

--- calculation_logic
sum(virtual_table.active_sessions) as active_sessions,
sum(virtual_table.analyzed_sessions) as analyzed_sessions,
sum(virtual_table.eval_completed) as eval_completed,
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL
ELSE SUM(virtual_table.analyzed_sessions) * 100 / SUM(virtual_table.active_sessions)
END as analyzed_percentage,
CASE WHEN SUM(virtual_table.analyzed_sessions) = 0 THEN NULL
ELSE SUM(virtual_table.eval_completed) * 100 / SUM(virtual_table.analyzed_sessions)
END as eval_completed_percentage




## Profile Eval Summary

Profile Evaluation Summary tracks the evaluation funnel for soundbox profile analysis, measuring progression from active sessions through analysis to completion. This metric monitors active sessions that enter the evaluation process, how many get analyzed, and how many complete the full evaluation cycle. The data is filtered specifically for the p4bprofile entity and aggregated daily to show evaluation performance trends. Key performance indicators include the percentage of active sessions that get analyzed and the percentage of analyzed sessions that complete evaluation, providing insight into funnel efficiency and potential bottlenecks in the profile evaluation process.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for profile evaluation entity
eval.cst_entity IN ('p4bprofile') AND
--- temporal aggregation by day
date_trunc('day', CAST(eval.date_ AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(eval.active_sessions) as "Active Sessions",
sum(eval.analyzed_sessions) as "Analyzed Sessions", 
sum(eval.eval_completed) as "Eval Completed",
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
     ELSE SUM(eval.analyzed_sessions) * 100 / SUM(eval.active_sessions)
END as "Analyzed %",
CASE WHEN SUM(eval.analyzed_sessions) = 0 THEN NULL
     ELSE SUM(eval.eval_completed) * 100 / SUM(eval.analyzed_sessions)  
END as "Eval Completed %"




## Profile Eval Summary

Profile Evaluation Summary tracks the evaluation funnel for soundbox profile analysis, measuring progression from active sessions through analysis to completion. This metric monitors active sessions that enter the evaluation process, how many get analyzed, and how many complete the full evaluation cycle. The data is filtered specifically for the p4bprofile entity and aggregated daily to show evaluation performance trends. Key performance indicators include the percentage of active sessions that get analyzed and the percentage of analyzed sessions that complete evaluation, providing insight into funnel efficiency and potential bottlenecks in the profile evaluation process.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter for profile evaluation entity
eval.cst_entity IN ('p4bprofile') AND
--- temporal aggregation by day
date_trunc('day', CAST(eval.date_ AS TIMESTAMP)) IS NOT NULL

--- calculation_logic
sum(eval.active_sessions) as "Active Sessions",
sum(eval.analyzed_sessions) as "Analyzed Sessions", 
sum(eval.eval_completed) as "Eval Completed",
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
     ELSE SUM(eval.analyzed_sessions) * 100 / SUM(eval.active_sessions)
END as "Analyzed %",
CASE WHEN SUM(eval.analyzed_sessions) = 0 THEN NULL
     ELSE SUM(eval.eval_completed) * 100 / SUM(eval.analyzed_sessions)  
END as "Eval Completed %"




## MHD Overall Eval Summary

This metric tracks the MHD evaluation pipeline performance by measuring the progression from active sessions through analysis to completion. It provides both absolute counts (Active Sessions, Analyzed Sessions, Eval Completed) and conversion percentages (Analyzed % and Eval Completed %) to monitor the efficiency of the evaluation process. The data is aggregated daily from the soundbox evaluation system, allowing teams to monitor how well sessions are being processed through the analysis pipeline and how many evaluations are successfully completed. The percentage calculations include null-safe division to handle cases where denominators are zero, ensuring reliable reporting.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for date-based analysis
eval.date_ IS NOT NULL

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions,
sum(eval.eval_completed) as eval_completed,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
     ELSE SUM(eval.analyzed_sessions) * 100 / SUM(eval.active_sessions)
END as analyzed_percentage,
CASE WHEN SUM(eval.analyzed_sessions) = 0 THEN NULL
     ELSE SUM(eval.eval_completed) * 100 / SUM(eval.analyzed_sessions)
END as eval_completed_percentage




## MHD Overall Eval Summary

This metric tracks the MHD evaluation pipeline performance by measuring the progression from active sessions through analysis to completion. It provides both absolute counts (Active Sessions, Analyzed Sessions, Eval Completed) and conversion percentages (Analyzed % and Eval Completed %) to monitor the efficiency of the evaluation process. The data is aggregated daily from the soundbox evaluation system, allowing teams to monitor how well sessions are being processed through the analysis pipeline and how many evaluations are successfully completed. The percentage calculations include null-safe division to handle cases where denominators are zero, ensuring reliable reporting.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- temporal range filter for date-based analysis
eval.date_ IS NOT NULL

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions,
sum(eval.eval_completed) as eval_completed,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
     ELSE SUM(eval.analyzed_sessions) * 100 / SUM(eval.active_sessions)
END as analyzed_percentage,
CASE WHEN SUM(eval.analyzed_sessions) = 0 THEN NULL
     ELSE SUM(eval.eval_completed) * 100 / SUM(eval.analyzed_sessions)
END as eval_completed_percentage




## Wealth Eval Summary

Wealth Evaluation Summary tracks the complete evaluation funnel for the p4bwealth entity, measuring customer engagement progression from initial active sessions through analysis completion. The metrics monitor active sessions (total customer sessions), analyzed sessions (sessions that underwent evaluation), and eval completed (successful evaluation completions), along with conversion percentages at each stage. This provides insights into evaluation process efficiency and customer engagement rates. The data is filtered specifically to p4bwealth entity and aggregated daily to track performance trends over time, enabling monitoring of evaluation completion rates and identifying potential bottlenecks in the wealth evaluation workflow.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to p4bwealth entity for wealth-specific evaluation tracking
eval.cst_entity IN ('p4bwealth') AND
--- temporal aggregation by day for trend analysis
date_trunc('day', CAST(eval.date_ AS TIMESTAMP))

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions, 
sum(eval.eval_completed) as eval_completed,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
     ELSE SUM(eval.analyzed_sessions) * 100 / SUM(eval.active_sessions)
END as analyzed_percentage,
CASE WHEN SUM(eval.analyzed_sessions) = 0 THEN NULL
     ELSE SUM(eval.eval_completed) * 100 / SUM(eval.analyzed_sessions)
END as eval_completed_percentage




## Business Loan Eval Summary

This metric tracks the business loan evaluation funnel for P4B (Pay for Business) loan products, measuring the progression from initial active sessions through analysis completion. It provides key performance indicators including total active sessions, sessions that underwent analysis, completed evaluations, and conversion rates at each stage. The Analyzed % shows what portion of active sessions proceed to analysis, while Eval Completed % indicates the completion rate of analyzed sessions. This helps monitor the efficiency and bottlenecks in the loan evaluation process, enabling teams to identify where potential borrowers drop off and optimize the evaluation workflow for better conversion rates.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to business loan evaluation entity
virtual_table.cst_entity IN ('p4bbusinessloan') AND
--- temporal aggregation by day
date_trunc('day', CAST(virtual_table.date_ AS TIMESTAMP))

--- calculation_logic
sum(virtual_table.active_sessions) as active_sessions,
sum(virtual_table.analyzed_sessions) as analyzed_sessions,
sum(virtual_table.eval_completed) as eval_completed,
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL ELSE SUM(virtual_table.analyzed_sessions) * 100 / SUM(virtual_table.active_sessions) END as analyzed_percentage,
CASE WHEN SUM(virtual_table.analyzed_sessions) = 0 THEN NULL ELSE SUM(virtual_table.eval_completed) * 100 / SUM(virtual_table.analyzed_sessions) END as eval_completed_percentage




## Wealth Eval Summary

Wealth Evaluation Summary tracks the complete evaluation funnel for the p4bwealth entity, measuring customer engagement progression from initial active sessions through analysis completion. The metrics monitor active sessions (total customer sessions), analyzed sessions (sessions that underwent evaluation), and eval completed (successful evaluation completions), along with conversion percentages at each stage. This provides insights into evaluation process efficiency and customer engagement rates. The data is filtered specifically to p4bwealth entity and aggregated daily to track performance trends over time, enabling monitoring of evaluation completion rates and identifying potential bottlenecks in the wealth evaluation workflow.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed eval

--- standard filters to be applied unless specifically requested for a different categorical value
--- filter to p4bwealth entity for wealth-specific evaluation tracking
eval.cst_entity IN ('p4bwealth') AND
--- temporal aggregation by day for trend analysis
date_trunc('day', CAST(eval.date_ AS TIMESTAMP))

--- calculation_logic
sum(eval.active_sessions) as active_sessions,
sum(eval.analyzed_sessions) as analyzed_sessions, 
sum(eval.eval_completed) as eval_completed,
CASE WHEN SUM(eval.active_sessions) = 0 THEN NULL
     ELSE SUM(eval.analyzed_sessions) * 100 / SUM(eval.active_sessions)
END as analyzed_percentage,
CASE WHEN SUM(eval.analyzed_sessions) = 0 THEN NULL
     ELSE SUM(eval.eval_completed) * 100 / SUM(eval.analyzed_sessions)
END as eval_completed_percentage




## Business Loan Eval Summary

This metric tracks the business loan evaluation funnel for P4B (Pay for Business) loan products, measuring the progression from initial active sessions through analysis completion. It provides key performance indicators including total active sessions, sessions that underwent analysis, completed evaluations, and conversion rates at each stage. The Analyzed % shows what portion of active sessions proceed to analysis, while Eval Completed % indicates the completion rate of analyzed sessions. This helps monitor the efficiency and bottlenecks in the loan evaluation process, enabling teams to identify where potential borrowers drop off and optimize the evaluation workflow for better conversion rates.

-- tables_involved
hive.team_cst_mhd_product.soundbox_eval_completed virtual_table

--- standard filters to be applied unless specifically requested for a different categorical value
--- restrict to business loan evaluation entity
virtual_table.cst_entity IN ('p4bbusinessloan') AND
--- temporal aggregation by day
date_trunc('day', CAST(virtual_table.date_ AS TIMESTAMP))

--- calculation_logic
sum(virtual_table.active_sessions) as active_sessions,
sum(virtual_table.analyzed_sessions) as analyzed_sessions,
sum(virtual_table.eval_completed) as eval_completed,
CASE WHEN SUM(virtual_table.active_sessions) = 0 THEN NULL ELSE SUM(virtual_table.analyzed_sessions) * 100 / SUM(virtual_table.active_sessions) END as analyzed_percentage,
CASE WHEN SUM(virtual_table.analyzed_sessions) = 0 THEN NULL ELSE SUM(virtual_table.eval_completed) * 100 / SUM(virtual_table.analyzed_sessions) END as eval_completed_percentage




