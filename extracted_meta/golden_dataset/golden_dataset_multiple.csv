dashboard_id,chart_id,chart_name,user_query,sql_query
476,2458,#back acc wise MAU distribution,"How are our monthly active UPI users distributed across different lifecycle stages, and what percentage of users in each lifecycle category are actually active this month?","SELECT if(lifecycle is null,'d.Dormant',lifecycle) AS ""Lifecycle CM"", accounts AS accounts__, sum(users) AS ""#Users"", sum(users) filter(where use_case_mtd >0 ) AS ""MAU"", format('%.2f%%',
(sum(users) filter(where use_case_mtd >0 )*1.0000)/
(sum(sum(users) filter(where use_case_mtd >0 )) over(partition by max(lifecycle))*1.0000)*100) AS ""%"" 
FROM (with  all_accounts AS (
    SELECT user_id, created_on,--a.account_type,
    detail_2,
    account_type
    FROM hive.tpap_pms.account_snapshot_v3
    WHERE dl_last_updated IS NOT NULL 
    and status = 'ACTIVE'
      AND DATE(created_on) <= current_date+interval '-1' day 
),
users AS (
    SELECT customer_id,id,psp_id
    FROM hive.tpap_pms.user_snapshot_v3
    WHERE dl_last_updated IS NOT NULL
      AND psp_id IN (6, 7, 8, 9)
      AND (
        status = 'ACTIVE'
        OR (status = 'DORMANT' AND comments IS NOT NULL)
      )
      AND type = 'PERSON'
),
out as(
select customer_id,count(distinct account_key) accounts
from(
        select customer_id,dt,account_key
        -- ,row_number() over (partition by account_key order by dt asc) rn
            from( SELECT customer_id,
                        -- if(a.status = 'ACTIVE' AND mpin_set = 1,1 ,0) active_flag,
                        date(a.created_on) dt,--a.account_type,
                        CONCAT(u.customer_id, '-', a.detail_2, '-', a.account_type) AS account_key
                    FROM all_accounts a 
                    JOIN users u ON u.id = a.user_id 

    )   
)x 
-- where rn=1   
group by 1
),

use_cases_mtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base_cm
              where final_category not in('Others','others')
              and day_id 
              between date_trunc('month',(current_Date - interval '01' day))
              and (current_Date - interval '01' day)
              group by 1
),

use_cases_lmtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base
            where final_category not in('Others','others')
            and day_id 
            between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and (current_Date - interval '01' day - interval '01' month)
            group by 1
),

nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day ))
            and  current_Date - interval '01' day 
  )


SELECT if(lifecycle in ('c:react 1-3','c:react 3+'),'c:react',lifecycle)lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5

union all

SELECT 'e.Overall' lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5
) AS virtual_table 
WHERE accounts IS NOT NULL GROUP BY if(lifecycle is null,'d.Dormant',lifecycle), accounts ORDER BY max(concat(lifecycle,cast(accounts as varchar))) ASC
LIMIT 10000;

"
476,2458,#back acc wise MAU distribution,"How are our monthly active UPI users distributed across different user lifecycle stages, and what percentage of users in each lifecycle category are actively transacting?","SELECT if(lifecycle is null,'d.Dormant',lifecycle) AS ""Lifecycle CM"", accounts AS accounts__, sum(users) AS ""#Users"", sum(users) filter(where use_case_mtd >0 ) AS ""MAU"", format('%.2f%%',
(sum(users) filter(where use_case_mtd >0 )*1.0000)/
(sum(sum(users) filter(where use_case_mtd >0 )) over(partition by max(lifecycle))*1.0000)*100) AS ""%"" 
FROM (with  all_accounts AS (
    SELECT user_id, created_on,--a.account_type,
    detail_2,
    account_type
    FROM hive.tpap_pms.account_snapshot_v3
    WHERE dl_last_updated IS NOT NULL 
    and status = 'ACTIVE'
      AND DATE(created_on) <= current_date+interval '-1' day 
),
users AS (
    SELECT customer_id,id,psp_id
    FROM hive.tpap_pms.user_snapshot_v3
    WHERE dl_last_updated IS NOT NULL
      AND psp_id IN (6, 7, 8, 9)
      AND (
        status = 'ACTIVE'
        OR (status = 'DORMANT' AND comments IS NOT NULL)
      )
      AND type = 'PERSON'
),
out as(
select customer_id,count(distinct account_key) accounts
from(
        select customer_id,dt,account_key
        -- ,row_number() over (partition by account_key order by dt asc) rn
            from( SELECT customer_id,
                        -- if(a.status = 'ACTIVE' AND mpin_set = 1,1 ,0) active_flag,
                        date(a.created_on) dt,--a.account_type,
                        CONCAT(u.customer_id, '-', a.detail_2, '-', a.account_type) AS account_key
                    FROM all_accounts a 
                    JOIN users u ON u.id = a.user_id 

    )   
)x 
-- where rn=1   
group by 1
),

use_cases_mtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base_cm
              where final_category not in('Others','others')
              and day_id 
              between date_trunc('month',(current_Date - interval '01' day))
              and (current_Date - interval '01' day)
              group by 1
),

use_cases_lmtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base
            where final_category not in('Others','others')
            and day_id 
            between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and (current_Date - interval '01' day - interval '01' month)
            group by 1
),

nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day ))
            and  current_Date - interval '01' day 
  )


SELECT if(lifecycle in ('c:react 1-3','c:react 3+'),'c:react',lifecycle)lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5

union all

SELECT 'e.Overall' lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5
) AS virtual_table 
WHERE accounts IS NOT NULL GROUP BY if(lifecycle is null,'d.Dormant',lifecycle), accounts ORDER BY max(concat(lifecycle,cast(accounts as varchar))) ASC
LIMIT 10000;

"
476,2459,#Handle wise MAU distribution,"How are our monthly active UPI users distributed across different numbers of payment handles, and what does this distribution look like across different user lifecycle stages?","SELECT if(lifecycle is null,'d.Dormant',lifecycle) AS ""Lifecycle CM"", handles AS handles__, sum(users) AS ""#Users"", sum(users) filter(where use_case_mtd >0 ) AS ""MAU"", format('%.2f%%',
(sum(users) filter(where use_case_mtd >0 )*1.0000)/
(sum(sum(users) filter(where use_case_mtd >0 )) over(partition by max(lifecycle))*1.0000)*100) AS ""%"" 
FROM (with  all_accounts AS (
    SELECT user_id, created_on,--a.account_type,
    detail_2,
    account_type
    FROM hive.tpap_pms.account_snapshot_v3
    WHERE dl_last_updated IS NOT NULL 
    and status = 'ACTIVE'
      AND DATE(created_on) <= current_date+interval '-1' day 
),
users AS (
    SELECT customer_id,id,psp_id
    FROM hive.tpap_pms.user_snapshot_v3
    WHERE dl_last_updated IS NOT NULL
      AND psp_id IN (6, 7, 8, 9)
      AND (
        status = 'ACTIVE'
        OR (status = 'DORMANT' AND comments IS NOT NULL)
      )
      AND type = 'PERSON'
),
out as(
select customer_id,count(distinct account_key) accounts
from(
        select customer_id,dt,account_key
        -- ,row_number() over (partition by account_key order by dt asc) rn
            from( SELECT customer_id,
                        -- if(a.status = 'ACTIVE' AND mpin_set = 1,1 ,0) active_flag,
                        date(a.created_on) dt,--a.account_type,
                        CONCAT(u.customer_id, '-', a.detail_2, '-', a.account_type) AS account_key
                    FROM all_accounts a 
                    JOIN users u ON u.id = a.user_id 

    )   
)x 
-- where rn=1   
group by 1
),

use_cases_mtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base_cm
              where final_category not in('Others','others')
              and day_id 
              between date_trunc('month',(current_Date - interval '01' day))
              and (current_Date - interval '01' day)
              group by 1
),

use_cases_lmtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base
            where final_category not in('Others','others')
            and day_id 
            between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and (current_Date - interval '01' day - interval '01' month)
            group by 1
),

nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day ))
            and  current_Date - interval '01' day 
  )


SELECT if(lifecycle in ('c:react 1-3','c:react 3+'),'c:react',lifecycle)lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5

union all

SELECT 'e.Overall' lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5
) AS virtual_table GROUP BY if(lifecycle is null,'d.Dormant',lifecycle), handles ORDER BY max(concat(lifecycle,cast(handles as varchar))) ASC
LIMIT 10000;

"
476,2459,#Handle wise MAU distribution,What is the distribution of monthly active users across different lifecycle stages and handle counts in our UPI system?,"SELECT if(lifecycle is null,'d.Dormant',lifecycle) AS ""Lifecycle CM"", handles AS handles__, sum(users) AS ""#Users"", sum(users) filter(where use_case_mtd >0 ) AS ""MAU"", format('%.2f%%',
(sum(users) filter(where use_case_mtd >0 )*1.0000)/
(sum(sum(users) filter(where use_case_mtd >0 )) over(partition by max(lifecycle))*1.0000)*100) AS ""%"" 
FROM (with  all_accounts AS (
    SELECT user_id, created_on,--a.account_type,
    detail_2,
    account_type
    FROM hive.tpap_pms.account_snapshot_v3
    WHERE dl_last_updated IS NOT NULL 
    and status = 'ACTIVE'
      AND DATE(created_on) <= current_date+interval '-1' day 
),
users AS (
    SELECT customer_id,id,psp_id
    FROM hive.tpap_pms.user_snapshot_v3
    WHERE dl_last_updated IS NOT NULL
      AND psp_id IN (6, 7, 8, 9)
      AND (
        status = 'ACTIVE'
        OR (status = 'DORMANT' AND comments IS NOT NULL)
      )
      AND type = 'PERSON'
),
out as(
select customer_id,count(distinct account_key) accounts
from(
        select customer_id,dt,account_key
        -- ,row_number() over (partition by account_key order by dt asc) rn
            from( SELECT customer_id,
                        -- if(a.status = 'ACTIVE' AND mpin_set = 1,1 ,0) active_flag,
                        date(a.created_on) dt,--a.account_type,
                        CONCAT(u.customer_id, '-', a.detail_2, '-', a.account_type) AS account_key
                    FROM all_accounts a 
                    JOIN users u ON u.id = a.user_id 

    )   
)x 
-- where rn=1   
group by 1
),

use_cases_mtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base_cm
              where final_category not in('Others','others')
              and day_id 
              between date_trunc('month',(current_Date - interval '01' day))
              and (current_Date - interval '01' day)
              group by 1
),

use_cases_lmtd as (
            select payer_cust_id customer_id, count(Distinct final_category) use_case from  user_paytm_payments.upi_flow_wise_base
            where final_category not in('Others','others')
            and day_id 
            between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and (current_Date - interval '01' day - interval '01' month)
            group by 1
),

nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day ))
            and  current_Date - interval '01' day 
  )


SELECT if(lifecycle in ('c:react 1-3','c:react 3+'),'c:react',lifecycle)lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5

union all

SELECT 'e.Overall' lifecycle,
         a.handles,b.accounts,c.use_case use_case_mtd,
        d.use_case use_case_lmtd, count(a.customer_id) users
from (select customer_id,count(distinct psp_id) handles from users GROUP by 1) a
left join nrr x on a.customer_id= x.custid
left join (select customer_id, case when accounts<2 then 'a.=1_acc'
                        when accounts=2 then 'b.=2_acc' 
                        when accounts>2 then 'c.>2_acc' 
                        else null end accounts
                      from out   )b on a.customer_id = b.customer_id
left join use_cases_mtd c on a.customer_id = c.customer_id
left join use_cases_lmtd d on a.customer_id = d.customer_id
group by lifecycle,2,3,4,5
) AS virtual_table GROUP BY if(lifecycle is null,'d.Dormant',lifecycle), handles ORDER BY max(concat(lifecycle,cast(handles as varchar))) ASC
LIMIT 10000;

"
476,2464,MAU by Usecase Distribution,"How are our monthly active UPI users distributed across different use cases and customer lifecycle stages, comparing current month performance to the same period last month?","SELECT lifecycle AS ""Lifecycle CM"", use_case AS use_case__, SUM(users)filter(where MTD_flag = 'LMTD') AS ""LMTD - MAU"", SUM(users)filter(where MTD_flag = 'MTD') AS ""MTD - MAU"" 
FROM (with nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day))
            and  current_Date- interval '01' day 
  ),
  outt as (  select day_id,payer_cust_id,final_category 
          from user_paytm_payments.upi_flow_wise_base_partitioned
            where final_category not in('Others','others')
                and day_id 
                between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
                and (current_Date - interval '01' day)
                and day(day_id)<= day(current_Date - interval '01' day)
    
    -- select day_id,payer_cust_id,final_category from user_paytm_payments.upi_flow_wise_base
    -- where final_category not in('Others','others')
    -- and day_id 
    -- between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
    -- and (current_Date - interval '01' day)
    -- and day(day_id)<= day(current_Date - interval '01' day)
    union all
    select day_id,payer_cust_id,final_category from  user_paytm_payments.upi_flow_wise_base_cm
    where final_category not in('Others','others')
          and day_id 
          between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
          and (current_Date - interval '01' day)
          and day(day_id)<= day(current_Date - interval '01' day)
    ),
    
use_cases_ as (
          select lifecycle,
              case 
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day) then 'MTD'
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day - interval '01' month) then 'LMTD' 
              end as MTD_flag,
              payer_cust_id customer_id,
              count(Distinct final_category) use_case 
          from outt a
          left join nrr b on a.payer_cust_id=b.custid
          group by 1,2,3
  union all
      select 'd.Overall' lifecycle,
              case 
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day) then 'MTD'
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day - interval '01' month) then 'LMTD' 
              end as MTD_flag,
              payer_cust_id customer_id,
              count(Distinct final_category) use_case 
          from outt a 
          group by 1,2,3
)

SELECT if(lifecycle is null,'d.Dormant',lifecycle) Lifecycle, MTD_flag,use_case , count(customer_id) users
from  use_cases_ c
group by 1,2,3
) AS virtual_table GROUP BY lifecycle, use_case ORDER BY mIN(concat(lifecycle,CAST(use_case AS VARCHAR))) ASC
LIMIT 1000;

"
476,2464,MAU by Usecase Distribution,"How are our monthly active users distributed across different UPI use cases, and how does this month's performance compare to the same period last month by customer lifecycle stage?","SELECT lifecycle AS ""Lifecycle CM"", use_case AS use_case__, SUM(users)filter(where MTD_flag = 'LMTD') AS ""LMTD - MAU"", SUM(users)filter(where MTD_flag = 'MTD') AS ""MTD - MAU"" 
FROM (with nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day))
            and  current_Date- interval '01' day 
  ),
  outt as (  select day_id,payer_cust_id,final_category 
          from user_paytm_payments.upi_flow_wise_base_partitioned
            where final_category not in('Others','others')
                and day_id 
                between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
                and (current_Date - interval '01' day)
                and day(day_id)<= day(current_Date - interval '01' day)
    
    -- select day_id,payer_cust_id,final_category from user_paytm_payments.upi_flow_wise_base
    -- where final_category not in('Others','others')
    -- and day_id 
    -- between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
    -- and (current_Date - interval '01' day)
    -- and day(day_id)<= day(current_Date - interval '01' day)
    union all
    select day_id,payer_cust_id,final_category from  user_paytm_payments.upi_flow_wise_base_cm
    where final_category not in('Others','others')
          and day_id 
          between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
          and (current_Date - interval '01' day)
          and day(day_id)<= day(current_Date - interval '01' day)
    ),
    
use_cases_ as (
          select lifecycle,
              case 
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day) then 'MTD'
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day - interval '01' month) then 'LMTD' 
              end as MTD_flag,
              payer_cust_id customer_id,
              count(Distinct final_category) use_case 
          from outt a
          left join nrr b on a.payer_cust_id=b.custid
          group by 1,2,3
  union all
      select 'd.Overall' lifecycle,
              case 
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day) then 'MTD'
              when date_trunc('month', day_id) = date_trunc('month', current_Date - interval '01' day - interval '01' month) then 'LMTD' 
              end as MTD_flag,
              payer_cust_id customer_id,
              count(Distinct final_category) use_case 
          from outt a 
          group by 1,2,3
)

SELECT if(lifecycle is null,'d.Dormant',lifecycle) Lifecycle, MTD_flag,use_case , count(customer_id) users
from  use_cases_ c
group by 1,2,3
) AS virtual_table GROUP BY lifecycle, use_case ORDER BY mIN(concat(lifecycle,CAST(use_case AS VARCHAR))) ASC
LIMIT 1000;

"
476,2583,DAU MAU Txns by NRR,"How do daily and monthly active users, transaction volumes, and per-user metrics vary across different user lifecycle stages (new, retained, resurrected users) for UPI payments?","SELECT lifecycle AS lifecycle, date_trunc('day', CAST(day_id AS TIMESTAMP)) AS day_id, sum(""Dau"") AS ""DAU__"", sum(""Mau"") AS ""MAU"", sum(txns) AS ""TXNs"", sum(txns)*1.00/sum(DAU) AS ""TPU"", sum(GMV)*1.00/sum(DAU) AS ""GPU"" 
FROM (-- Users (DAU,MAU), Txns split by states and top 20 cities
-- Users (DAU,MAU), Txns split by NRR
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max(case when upper(popular_city) in (
        'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD',
        'PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA'
        ) then popular_city else 'Other' end) as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id, count(distinct txn_id)txns, sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>= date_trunc('month',current_date+interval'-1' day)-interval '1' month
  and transaction_date_key>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2

),
nrr as (select date_trunc('month',dt) mt,cust_id custid,            
                user_type lifecycle
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1
                where dt>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
            and  dt<current_date
                group by 1,2,3
),
out as(  select  a.day_id,lifecycle,coalesce(popular_city,'Other')t20city,coalesce(state,'Other')state, a.payer_cust_id,
              row_number() over(partition by payer_cust_id,day_id order by day_id) rn_dau,
              row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau,
              row_number() over(partition by lifecycle,payer_cust_id,day_id order by day_id) rn_dau_nrr,
              row_number() over(partition by lifecycle,payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_nrr,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,day_id order by day_id) rn_dau_t20,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_t20,
              sum(txns) txns,
              SUM(AMOUNT) gmv
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id
            left join nrr c  on a.payer_cust_id=c.custid and c.mt=date_trunc('month',day_id)
            group by 1,2,3,4,5   
)           

select day_id,lifecycle, state,t20city,
                count(Distinct if(rn_dau=1,payer_cust_id,null)) DAU,
                count(Distinct if(rn_mau=1,payer_cust_id,null)) MAU,
                -- count(Distinct if(rn_dau_nrr=1,payer_cust_id,null)) dau_nrr,
                -- count(Distinct if(rn_mau_nrr=1,payer_cust_id,null)) mau_nrr,
                -- count(Distinct if(rn_dau_t20=1,payer_cust_id,null)) dau_t20,
                -- count(Distinct if(rn_mau_t20=1,payer_cust_id,null)) mau_t20,
                sum(txns) TXNS,
                SUM(GMV) GMV
from out 
group by 1,2,3,4
) AS virtual_table 
WHERE lifecycle IS NOT NULL GROUP BY lifecycle, date_trunc('day', CAST(day_id AS TIMESTAMP)) ORDER BY sum(""Dau"") DESC
LIMIT 10000;

"
476,2583,DAU MAU Txns by NRR,"How do daily active users, monthly active users, and transaction volumes compare across different user lifecycle segments (new, retained, and resurrected users) for UPI payments?","SELECT lifecycle AS lifecycle, date_trunc('day', CAST(day_id AS TIMESTAMP)) AS day_id, sum(""Dau"") AS ""DAU__"", sum(""Mau"") AS ""MAU"", sum(txns) AS ""TXNs"", sum(txns)*1.00/sum(DAU) AS ""TPU"", sum(GMV)*1.00/sum(DAU) AS ""GPU"" 
FROM (-- Users (DAU,MAU), Txns split by states and top 20 cities
-- Users (DAU,MAU), Txns split by NRR
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max(case when upper(popular_city) in (
        'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD',
        'PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA'
        ) then popular_city else 'Other' end) as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id, count(distinct txn_id)txns, sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>= date_trunc('month',current_date+interval'-1' day)-interval '1' month
  and transaction_date_key>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2

),
nrr as (select date_trunc('month',dt) mt,cust_id custid,            
                user_type lifecycle
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1
                where dt>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
            and  dt<current_date
                group by 1,2,3
),
out as(  select  a.day_id,lifecycle,coalesce(popular_city,'Other')t20city,coalesce(state,'Other')state, a.payer_cust_id,
              row_number() over(partition by payer_cust_id,day_id order by day_id) rn_dau,
              row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau,
              row_number() over(partition by lifecycle,payer_cust_id,day_id order by day_id) rn_dau_nrr,
              row_number() over(partition by lifecycle,payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_nrr,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,day_id order by day_id) rn_dau_t20,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_t20,
              sum(txns) txns,
              SUM(AMOUNT) gmv
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id
            left join nrr c  on a.payer_cust_id=c.custid and c.mt=date_trunc('month',day_id)
            group by 1,2,3,4,5   
)           

select day_id,lifecycle, state,t20city,
                count(Distinct if(rn_dau=1,payer_cust_id,null)) DAU,
                count(Distinct if(rn_mau=1,payer_cust_id,null)) MAU,
                -- count(Distinct if(rn_dau_nrr=1,payer_cust_id,null)) dau_nrr,
                -- count(Distinct if(rn_mau_nrr=1,payer_cust_id,null)) mau_nrr,
                -- count(Distinct if(rn_dau_t20=1,payer_cust_id,null)) dau_t20,
                -- count(Distinct if(rn_mau_t20=1,payer_cust_id,null)) mau_t20,
                sum(txns) TXNS,
                SUM(GMV) GMV
from out 
group by 1,2,3,4
) AS virtual_table 
WHERE lifecycle IS NOT NULL GROUP BY lifecycle, date_trunc('day', CAST(day_id AS TIMESTAMP)) ORDER BY sum(""Dau"") DESC
LIMIT 10000;

"
476,2587,DAU MAU Txns by T20 Cities,"What are the daily active users, monthly active users, transaction volumes, and transactions per user trends across India's top 20 cities?","SELECT t20city AS t20city, date_trunc('day', CAST(day_id AS TIMESTAMP)) AS day_id, sum(""Dau"") AS ""DAU__"", sum(""Mau"") AS ""MAU"", sum(txns) AS ""TXNs"", sum(txns)*1.00/sum(DAU) AS ""TPU"" 
FROM (-- Users (DAU,MAU), Txns split by states and top 20 cities
-- Users (DAU,MAU), Txns split by NRR
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max(case when upper(popular_city) in (
        'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD',
        'PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA'
        ) then popular_city else 'Other' end) as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id, count(distinct txn_id)txns, sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>= date_trunc('month',current_date+interval'-1' day)-interval '1' month
  and transaction_date_key>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2

),
nrr as (select date_trunc('month',dt) mt,cust_id custid,            
                user_type lifecycle
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1
                where dt>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
            and  dt<current_date
                group by 1,2,3
),
out as(  select  a.day_id,lifecycle,coalesce(popular_city,'Other')t20city,coalesce(state,'Other')state, a.payer_cust_id,
              row_number() over(partition by payer_cust_id,day_id order by day_id) rn_dau,
              row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau,
              row_number() over(partition by lifecycle,payer_cust_id,day_id order by day_id) rn_dau_nrr,
              row_number() over(partition by lifecycle,payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_nrr,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,day_id order by day_id) rn_dau_t20,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_t20,
              sum(txns) txns,
              SUM(AMOUNT) gmv
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id
            left join nrr c  on a.payer_cust_id=c.custid and c.mt=date_trunc('month',day_id)
            group by 1,2,3,4,5   
)           

select day_id,lifecycle, state,t20city,
                count(Distinct if(rn_dau=1,payer_cust_id,null)) DAU,
                count(Distinct if(rn_mau=1,payer_cust_id,null)) MAU,
                -- count(Distinct if(rn_dau_nrr=1,payer_cust_id,null)) dau_nrr,
                -- count(Distinct if(rn_mau_nrr=1,payer_cust_id,null)) mau_nrr,
                -- count(Distinct if(rn_dau_t20=1,payer_cust_id,null)) dau_t20,
                -- count(Distinct if(rn_mau_t20=1,payer_cust_id,null)) mau_t20,
                sum(txns) TXNS,
                SUM(GMV) GMV
from out 
group by 1,2,3,4
) AS virtual_table 
WHERE lifecycle IS NOT NULL GROUP BY t20city, date_trunc('day', CAST(day_id AS TIMESTAMP)) ORDER BY sum(""Dau"") DESC
LIMIT 10000;

"
476,2587,DAU MAU Txns by T20 Cities,"What are the daily active users, monthly active users, transaction volumes, and transactions per user for UPI payments across India's top 20 cities?","SELECT t20city AS t20city, date_trunc('day', CAST(day_id AS TIMESTAMP)) AS day_id, sum(""Dau"") AS ""DAU__"", sum(""Mau"") AS ""MAU"", sum(txns) AS ""TXNs"", sum(txns)*1.00/sum(DAU) AS ""TPU"" 
FROM (-- Users (DAU,MAU), Txns split by states and top 20 cities
-- Users (DAU,MAU), Txns split by NRR
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max(case when upper(popular_city) in (
        'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD',
        'PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA'
        ) then popular_city else 'Other' end) as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id, count(distinct txn_id)txns, sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>= date_trunc('month',current_date+interval'-1' day)-interval '1' month
  and transaction_date_key>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2

),
nrr as (select date_trunc('month',dt) mt,cust_id custid,            
                user_type lifecycle
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1
                where dt>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
            and  dt<current_date
                group by 1,2,3
),
out as(  select  a.day_id,lifecycle,coalesce(popular_city,'Other')t20city,coalesce(state,'Other')state, a.payer_cust_id,
              row_number() over(partition by payer_cust_id,day_id order by day_id) rn_dau,
              row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau,
              row_number() over(partition by lifecycle,payer_cust_id,day_id order by day_id) rn_dau_nrr,
              row_number() over(partition by lifecycle,payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_nrr,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,day_id order by day_id) rn_dau_t20,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_t20,
              sum(txns) txns,
              SUM(AMOUNT) gmv
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id
            left join nrr c  on a.payer_cust_id=c.custid and c.mt=date_trunc('month',day_id)
            group by 1,2,3,4,5   
)           

select day_id,lifecycle, state,t20city,
                count(Distinct if(rn_dau=1,payer_cust_id,null)) DAU,
                count(Distinct if(rn_mau=1,payer_cust_id,null)) MAU,
                -- count(Distinct if(rn_dau_nrr=1,payer_cust_id,null)) dau_nrr,
                -- count(Distinct if(rn_mau_nrr=1,payer_cust_id,null)) mau_nrr,
                -- count(Distinct if(rn_dau_t20=1,payer_cust_id,null)) dau_t20,
                -- count(Distinct if(rn_mau_t20=1,payer_cust_id,null)) mau_t20,
                sum(txns) TXNS,
                SUM(GMV) GMV
from out 
group by 1,2,3,4
) AS virtual_table 
WHERE lifecycle IS NOT NULL GROUP BY t20city, date_trunc('day', CAST(day_id AS TIMESTAMP)) ORDER BY sum(""Dau"") DESC
LIMIT 10000;

"
476,2588,DAU MAU Txns by States,"What are the daily and monthly active users, transaction volumes, and transactions per user for UPI payments broken down by different states?","SELECT state AS state, date_trunc('day', CAST(day_id AS TIMESTAMP)) AS day_id, sum(""Dau"") AS ""DAU__"", sum(""Mau"") AS ""MAU"", sum(txns) AS ""TXNs"", sum(txns)*1.00/sum(DAU) AS ""TPU"" 
FROM (-- Users (DAU,MAU), Txns split by states and top 20 cities
-- Users (DAU,MAU), Txns split by NRR
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max(case when upper(popular_city) in (
        'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD',
        'PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA'
        ) then popular_city else 'Other' end) as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id, count(distinct txn_id)txns, sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>= date_trunc('month',current_date+interval'-1' day)-interval '1' month
  and transaction_date_key>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2

),
nrr as (select date_trunc('month',dt) mt,cust_id custid,            
                user_type lifecycle
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1
                where dt>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
            and  dt<current_date
                group by 1,2,3
),
out as(  select  a.day_id,lifecycle,coalesce(popular_city,'Other')t20city,coalesce(state,'Other')state, a.payer_cust_id,
              row_number() over(partition by payer_cust_id,day_id order by day_id) rn_dau,
              row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau,
              row_number() over(partition by lifecycle,payer_cust_id,day_id order by day_id) rn_dau_nrr,
              row_number() over(partition by lifecycle,payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_nrr,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,day_id order by day_id) rn_dau_t20,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_t20,
              sum(txns) txns,
              SUM(AMOUNT) gmv
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id
            left join nrr c  on a.payer_cust_id=c.custid and c.mt=date_trunc('month',day_id)
            group by 1,2,3,4,5   
)           

select day_id,lifecycle, state,t20city,
                count(Distinct if(rn_dau=1,payer_cust_id,null)) DAU,
                count(Distinct if(rn_mau=1,payer_cust_id,null)) MAU,
                -- count(Distinct if(rn_dau_nrr=1,payer_cust_id,null)) dau_nrr,
                -- count(Distinct if(rn_mau_nrr=1,payer_cust_id,null)) mau_nrr,
                -- count(Distinct if(rn_dau_t20=1,payer_cust_id,null)) dau_t20,
                -- count(Distinct if(rn_mau_t20=1,payer_cust_id,null)) mau_t20,
                sum(txns) TXNS,
                SUM(GMV) GMV
from out 
group by 1,2,3,4
) AS virtual_table 
WHERE lifecycle IS NOT NULL GROUP BY state, date_trunc('day', CAST(day_id AS TIMESTAMP)) ORDER BY sum(""Dau"") ASC
LIMIT 10000;

"
476,2588,DAU MAU Txns by States,"What are the daily and monthly active users, transaction volumes, and transactions per user for UPI payments across different Indian states?","SELECT state AS state, date_trunc('day', CAST(day_id AS TIMESTAMP)) AS day_id, sum(""Dau"") AS ""DAU__"", sum(""Mau"") AS ""MAU"", sum(txns) AS ""TXNs"", sum(txns)*1.00/sum(DAU) AS ""TPU"" 
FROM (-- Users (DAU,MAU), Txns split by states and top 20 cities
-- Users (DAU,MAU), Txns split by NRR
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max(case when upper(popular_city) in (
        'NEW DELHI','BANGALORE','HYDERABAD','JAIPUR','MUMBAI','CHENNAI','NOIDA','GURGAON','GHAZIABAD','AHMEDABAD',
        'PUNE','FARIDABAD','INDORE','SURAT','THANE','CHANDIGARH','LUCKNOW','AGRA','THANE','PATNA','LUDHIANA'
        ) then popular_city else 'Other' end) as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id, count(distinct txn_id)txns, sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>= date_trunc('month',current_date+interval'-1' day)-interval '1' month
  and transaction_date_key>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2

),
nrr as (select date_trunc('month',dt) mt,cust_id custid,            
                user_type lifecycle
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1
                where dt>=date_trunc('month',current_date+interval'-1' day)-interval '1' month
            and  dt<current_date
                group by 1,2,3
),
out as(  select  a.day_id,lifecycle,coalesce(popular_city,'Other')t20city,coalesce(state,'Other')state, a.payer_cust_id,
              row_number() over(partition by payer_cust_id,day_id order by day_id) rn_dau,
              row_number() over(partition by payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau,
              row_number() over(partition by lifecycle,payer_cust_id,day_id order by day_id) rn_dau_nrr,
              row_number() over(partition by lifecycle,payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_nrr,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,day_id order by day_id) rn_dau_t20,
              row_number() over(partition by coalesce(popular_city,'Other'),payer_cust_id,year(day_id),month(day_id) order by day_id) rn_mau_t20,
              sum(txns) txns,
              SUM(AMOUNT) gmv
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id
            left join nrr c  on a.payer_cust_id=c.custid and c.mt=date_trunc('month',day_id)
            group by 1,2,3,4,5   
)           

select day_id,lifecycle, state,t20city,
                count(Distinct if(rn_dau=1,payer_cust_id,null)) DAU,
                count(Distinct if(rn_mau=1,payer_cust_id,null)) MAU,
                -- count(Distinct if(rn_dau_nrr=1,payer_cust_id,null)) dau_nrr,
                -- count(Distinct if(rn_mau_nrr=1,payer_cust_id,null)) mau_nrr,
                -- count(Distinct if(rn_dau_t20=1,payer_cust_id,null)) dau_t20,
                -- count(Distinct if(rn_mau_t20=1,payer_cust_id,null)) mau_t20,
                sum(txns) TXNS,
                SUM(GMV) GMV
from out 
group by 1,2,3,4
) AS virtual_table 
WHERE lifecycle IS NOT NULL GROUP BY state, date_trunc('day', CAST(day_id AS TIMESTAMP)) ORDER BY sum(""Dau"") ASC
LIMIT 10000;

"
476,2611,UPI Overall Retention: Monthly,"What is the monthly retention rate for UPI users over time, showing how many users continue to be active in subsequent months after their initial activity?","SELECT diff AS diff, date_format(cast(base_month as date), '%Y- %m') AS base_month, sum(""Retention"") AS ""Retention__"" 
FROM (with cc as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten as (
select -- a.lifecycle, 
date_diff('month',a.mt,b.mt) as diff,
        a.mt base_month, b.mt retention_month,
        count(distinct b.scope_cust_id) users 
        from cc a
        left  join  cc b on b.scope_cust_id=a.scope_cust_id
        where  b.mt>=a.mt
        group by 1,2,3)
        
        SELECT base_month, diff,users*1.0000/MAX(users) over (partition by base_month order by base_month) Retention
from reten
) AS virtual_table GROUP BY diff, date_format(cast(base_month as date), '%Y- %m') ORDER BY sum(""Retention"") DESC
LIMIT 1000;

"
476,2611,UPI Overall Retention: Monthly,"What are the monthly retention rates for UPI users, showing how many users from each starting month continue to be active in subsequent months?","SELECT diff AS diff, date_format(cast(base_month as date), '%Y- %m') AS base_month, sum(""Retention"") AS ""Retention__"" 
FROM (with cc as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten as (
select -- a.lifecycle, 
date_diff('month',a.mt,b.mt) as diff,
        a.mt base_month, b.mt retention_month,
        count(distinct b.scope_cust_id) users 
        from cc a
        left  join  cc b on b.scope_cust_id=a.scope_cust_id
        where  b.mt>=a.mt
        group by 1,2,3)
        
        SELECT base_month, diff,users*1.0000/MAX(users) over (partition by base_month order by base_month) Retention
from reten
) AS virtual_table GROUP BY diff, date_format(cast(base_month as date), '%Y- %m') ORDER BY sum(""Retention"") DESC
LIMIT 1000;

"
476,2626,UPI Retention-New,"What is the retention rate of new UPI users over time, and how does it vary by cohort month?","SELECT diff AS diff, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(""NRR_retention"") AS ""Retention"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE lifecycle = 'a:new' AND ((base_month is not null)) GROUP BY diff, date_format(base_month,'%Y-%m') ORDER BY ""Retention"" DESC
LIMIT 10000;

"
476,2626,UPI Retention-New,"What is the retention rate of new UPI users over time, and how does it vary by base month?","SELECT diff AS diff, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(""NRR_retention"") AS ""Retention"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE lifecycle = 'a:new' AND ((base_month is not null)) GROUP BY diff, date_format(base_month,'%Y-%m') ORDER BY ""Retention"" DESC
LIMIT 10000;

"
476,2627,UPI Retention-Repeat,"What is the retention rate of repeat UPI users over time, showing how many users continue to be active in subsequent months after their initial usage?","SELECT diff AS diff, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(""NRR_retention"") AS ""Retention"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE ((Base_month is not null) AND (lifecycle = 'b:repeat') AND (diff is not null)) GROUP BY diff, date_format(base_month,'%Y-%m') ORDER BY ""Retention"" DESC
LIMIT 1000;

"
476,2627,UPI Retention-Repeat,What is the retention rate of repeat UPI users over different time periods after their initial active month?,"SELECT diff AS diff, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(""NRR_retention"") AS ""Retention"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE ((Base_month is not null) AND (lifecycle = 'b:repeat') AND (diff is not null)) GROUP BY diff, date_format(base_month,'%Y-%m') ORDER BY ""Retention"" DESC
LIMIT 1000;

"
476,2630,UPI Retention-Reactivated,"What is the retention rate of reactivated UPI customers over different time periods, and which base month and time period combination shows the highest retention?","SELECT diff AS diff, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(""NRR_retention"") AS ""Retention"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE lifecycle = 'c:react' AND ((Base_month is not null) AND (diff is not null)) GROUP BY diff, date_format(base_month,'%Y-%m') ORDER BY ""Retention"" DESC
LIMIT 1000;

"
476,2630,UPI Retention-Reactivated,"What is the retention rate of reactivated UPI users over different time periods, and how does their engagement sustain month over month?","SELECT diff AS diff, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(""NRR_retention"") AS ""Retention"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE lifecycle = 'c:react' AND ((Base_month is not null) AND (diff is not null)) GROUP BY diff, date_format(base_month,'%Y-%m') ORDER BY ""Retention"" DESC
LIMIT 1000;

"
476,2639,UPI flow Wise SR,"What are the success rates for different types of UPI transactions (merchant payments, peer-to-peer transfers, and account transfers) over time?","SELECT ""Flow_category"" AS ""Flow_category"", date_trunc('day', CAST(""Date"" AS TIMESTAMP)) AS ""Date"", sum(""Success_txn"") AS ""Success"", sum(""Overall_txn"") AS ""Overall"",  cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' AS ""SR"" 
FROM (select transaction_date_key Date, Flow_category, 
COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id
    END
  ) AS Success_txn,
  COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id
    END
  ) AS Overall_txn
  from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>=date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and current_date+interval'-1' day
and transaction_type in ('PAY','COLLECT') 
  and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1 ,2
) AS virtual_table GROUP BY ""Flow_category"", date_trunc('day', CAST(""Date"" AS TIMESTAMP)) ORDER BY Date DESC
LIMIT 1000;

"
476,2639,UPI flow Wise SR,"What are the success rates for different UPI transaction flows (VPA to merchant, VPA to VPA, and VPA to account) over the past few months?","SELECT ""Flow_category"" AS ""Flow_category"", date_trunc('day', CAST(""Date"" AS TIMESTAMP)) AS ""Date"", sum(""Success_txn"") AS ""Success"", sum(""Overall_txn"") AS ""Overall"",  cast(round(SUM(success_txn)*100/SUM(overall_txn),2) as varchar)||'%' AS ""SR"" 
FROM (select transaction_date_key Date, Flow_category, 
COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id
    END
  ) AS Success_txn,
  COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id
    END
  ) AS Overall_txn
  from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>=date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and current_date+interval'-1' day
and transaction_type in ('PAY','COLLECT') 
  and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1 ,2
) AS virtual_table GROUP BY ""Flow_category"", date_trunc('day', CAST(""Date"" AS TIMESTAMP)) ORDER BY Date DESC
LIMIT 1000;

"
476,2640,UPI SR DoD Overall Line Trend,What is the day-over-day trend of UPI transaction success rates for Paytm handles over the last few months?,"SELECT ""Date"" AS ""Date"", sum(""Success_txn"") AS ""Success"", sum(""Overall_txn"") AS ""Overall"",  cast(round(SUM(success_txn*1.00)*100/SUM(overall_txn),2) as int) AS ""SR"" 
FROM (select transaction_date_key Date, Flow_category, 
COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id
    END
  ) AS Success_txn,
  COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id
    END
  ) AS Overall_txn
  from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>=date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and current_date+interval'-1' day
and transaction_type in ('PAY','COLLECT') 
  and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1 ,2
) AS virtual_table 
WHERE ""Date"" >= DATE '2025-10-01' AND ""Date"" < DATE '2025-11-30' GROUP BY ""Date"" ORDER BY ""Success"" DESC
LIMIT 100;

"
476,2640,UPI SR DoD Overall Line Trend,What is the day-over-day trend of UPI transaction success rates over the past few months?,"SELECT ""Date"" AS ""Date"", sum(""Success_txn"") AS ""Success"", sum(""Overall_txn"") AS ""Overall"",  cast(round(SUM(success_txn*1.00)*100/SUM(overall_txn),2) as int) AS ""SR"" 
FROM (select transaction_date_key Date, Flow_category, 
COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id
    END
  ) AS Success_txn,
  COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id
    END
  ) AS Overall_txn
  from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>=date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and current_date+interval'-1' day
and transaction_type in ('PAY','COLLECT') 
  and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1 ,2
) AS virtual_table 
WHERE ""Date"" >= DATE '2025-10-01' AND ""Date"" < DATE '2025-11-30' GROUP BY ""Date"" ORDER BY ""Success"" DESC
LIMIT 100;

"
476,2654,UPI SR Flow wise DoD Overall Line Trend,What is the day-over-day trend of UPI transaction success rates across different payment flow categories?,"SELECT ""Date"" AS ""Date"", ""Flow_category"" AS ""Flow_category"",  SUM(success_txn*1.0000)/SUM(overall_txn) AS ""SR"" 
FROM (select transaction_date_key Date, Flow_category, 
COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id
    END
  ) AS Success_txn,
  COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id
    END
  ) AS Overall_txn
  from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>=date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and current_date+interval'-1' day
and transaction_type in ('PAY','COLLECT') 
  and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1 ,2
) AS virtual_table 
WHERE ""Date"" >= DATE '2025-10-01' AND ""Date"" < DATE '2025-11-30' AND (""Flow_category"" NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')) GROUP BY ""Date"", ""Flow_category"" ORDER BY ""SR"" DESC
LIMIT 10000;

"
476,2654,UPI SR Flow wise DoD Overall Line Trend,What are the daily success rate trends for different UPI transaction flow categories over the past few months?,"SELECT ""Date"" AS ""Date"", ""Flow_category"" AS ""Flow_category"",  SUM(success_txn*1.0000)/SUM(overall_txn) AS ""SR"" 
FROM (select transaction_date_key Date, Flow_category, 
COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed') THEN txn_id
    END
  ) AS Success_txn,
  COUNT(  CASE
      WHEN LOWER(status) IN ('success', 'deemed', 'failure', 'pending') THEN txn_id
    END
  ) AS Overall_txn
  from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where a.dl_last_updated>=date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and transaction_date_key between date_trunc('month',current_date+interval'-1' day)-interval '2' month
  and current_date+interval'-1' day
and transaction_type in ('PAY','COLLECT') 
  and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1 ,2
) AS virtual_table 
WHERE ""Date"" >= DATE '2025-10-01' AND ""Date"" < DATE '2025-11-30' AND (""Flow_category"" NOT IN ('Mandate_Onus', 'Onus_ExcMandates', 'Mandate_Online', 'Other P2M')) GROUP BY ""Date"", ""Flow_category"" ORDER BY ""SR"" DESC
LIMIT 10000;

"
476,2687,UPI Retention- M0 MAU,What is the monthly trend of UPI active users and their month-over-month growth rate for new users in their first month?,"SELECT date_format(base_month,'%Y-%m') AS ""Base_month"", sum(users) AS ""MAU"", SUM(mom_growth*1.0000)/SUM(users)  AS ""% Growth"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                a.user_type user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.00 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
where diff=0
ORDER BY 2,1
) AS virtual_table 
WHERE diff = 0 GROUP BY date_format(base_month,'%Y-%m') ORDER BY base_month ASC
LIMIT 1000;

"
476,2687,UPI Retention- M0 MAU,What is the monthly active user count and month-over-month growth rate for UPI users in their base month (M0 retention)?,"SELECT date_format(base_month,'%Y-%m') AS ""Base_month"", sum(users) AS ""MAU"", SUM(mom_growth*1.0000)/SUM(users)  AS ""% Growth"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                a.user_type user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.00 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
where diff=0
ORDER BY 2,1
) AS virtual_table 
WHERE diff = 0 GROUP BY date_format(base_month,'%Y-%m') ORDER BY base_month ASC
LIMIT 1000;

"
476,2690,UPI Retention NRR MAU,What is the monthly active user count for each UPI user lifecycle stage over the past few months?,"SELECT lifecycle AS lifecycle, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(users) AS ""MAU"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE diff = 0 AND ((base_month is not null)) GROUP BY lifecycle, date_format(base_month,'%Y-%m') ORDER BY ""MAU"" DESC
LIMIT 10000;

"
476,2690,UPI Retention NRR MAU,What is the monthly active user distribution across different UPI user lifecycle segments?,"SELECT lifecycle AS lifecycle, date_format(base_month,'%Y-%m') AS ""Base_month"", sum(users) AS ""MAU"" 
FROM (with upi as (select  mt, scope_cust_id,user_type lifecycle  from (
            select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id ,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type)  user_type 
                from   hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date+interval'-1' day)-interval '4' month   
            )  where mt<current_date
),
reten AS (
    SELECT 
        a.lifecycle, 
        date_diff('month', a.mt, b.mt) AS diff,
        a.mt AS base_month, 
        b.mt AS retention_month,
        COUNT(DISTINCT b.scope_cust_id) AS users 
    FROM upi a
    LEFT JOIN upi b 
        ON b.scope_cust_id = a.scope_cust_id
       AND b.mt >= a.mt
    GROUP BY a.lifecycle, a.mt, b.mt
)
SELECT 
    base_month,
    lifecycle,
    diff,
    users,
    users * 1.0000 / MAX(users) OVER (PARTITION BY lifecycle, base_month) AS NRR_retention,
    LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month) AS prev_month_users,
    (users - LAG(users, 1) OVER (PARTITION BY lifecycle ORDER BY base_month)) AS mom_growth
FROM reten 
ORDER BY 2,1
) AS virtual_table 
WHERE diff = 0 AND ((base_month is not null)) GROUP BY lifecycle, date_format(base_month,'%Y-%m') ORDER BY ""MAU"" DESC
LIMIT 10000;

"
476,2755,UPI LMTD Retention,What is the month-over-month retention rate for UPI users broken down by their lifecycle stage?,"SELECT lifecycle AS lifecycle, sum(""Base_users"") AS ""LM Users"", sum(""Reatined_users"") AS ""Retained Users"", SUM(Reatined_users)*1.0000/SUM(Base_users) AS ""Retention"" 
FROM (--lmtd retention
with
lm as (select mt,cast(scope_cust_id as varchar)scope_cust_id,lifecycle 
        from (select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date +interval '-1' day) +interval '-2' month
                      and  a.dt<=date_trunc('month',current_date +interval '-1' day) +interval '-1' month +interval '-1' day
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
                            and current_date + interval '-1' day + interval '-1' month
                        and transaction_date_key between   date_trunc('month', current_date + interval '-1' day) + interval '-1' month
                            and current_date + interval '-1' day + interval '-1' month
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                            group by 1
            )   
)

select a.lifecycle,
count(distinct a.scope_cust_id) Base_users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a 
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1
) AS virtual_table GROUP BY lifecycle ORDER BY ""LM Users"" DESC
LIMIT 1000;

"
476,2755,UPI LMTD Retention,"What is the month-over-month retention rate for UPI users, broken down by user lifecycle segments?","SELECT lifecycle AS lifecycle, sum(""Base_users"") AS ""LM Users"", sum(""Reatined_users"") AS ""Retained Users"", SUM(Reatined_users)*1.0000/SUM(Base_users) AS ""Retention"" 
FROM (--lmtd retention
with
lm as (select mt,cast(scope_cust_id as varchar)scope_cust_id,lifecycle 
        from (select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>=date_trunc('month',current_date +interval '-1' day) +interval '-2' month
                      and  a.dt<=date_trunc('month',current_date +interval '-1' day) +interval '-1' month +interval '-1' day
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date_trunc('month', current_date + interval '-1' day) + interval '-1' month
                            and current_date + interval '-1' day + interval '-1' month
                        and transaction_date_key between   date_trunc('month', current_date + interval '-1' day) + interval '-1' month
                            and current_date + interval '-1' day + interval '-1' month
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                            group by 1
            )   
)

select a.lifecycle,
count(distinct a.scope_cust_id) Base_users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a 
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1
) AS virtual_table GROUP BY lifecycle ORDER BY ""LM Users"" DESC
LIMIT 1000;

"
476,2757,UPI MTD Retention,"What is the month-to-date retention rate for UPI users by lifecycle segment, showing how many users from last month are still active this month?","SELECT lifecycle AS ""Lifecycle"", sum(""Base_users"") AS ""Base Users"", sum(""Reatined_users"") AS ""Retention Users"", SUM(Reatined_users*1.0000)/SUM(Base_users) AS ""Retention"" 
FROM (--mtd retention
with
lm as (select mt,scope_cust_id,lifecycle 
        from (select date_trunc('month',a.dt) mt ,cast(a.cust_id as varchar) scope_cust_id,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>= date_trunc('month',current_date +interval '-1' day) +interval '-1' month
                 and  a.dt<= date_trunc('month',current_date +interval '-1' day) +interval '-1' day
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date_trunc('month',current_date +interval '-1' day)   
                       and   current_date +interval '-1' day
                        and transaction_date_key between  date_trunc('month',current_date +interval '-1' day)   
                       and  current_date +interval '-1' day
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                            group by 1
            )   
)

select a.lifecycle,
count(distinct a.scope_cust_id) Base_users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a 
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1
) AS virtual_table GROUP BY lifecycle ORDER BY ""Base Users"" DESC
LIMIT 1000;

"
476,2757,UPI MTD Retention,"What is the month-to-date retention rate for UPI users by lifecycle stage, showing how many users from last month continued to transact this month?","SELECT lifecycle AS ""Lifecycle"", sum(""Base_users"") AS ""Base Users"", sum(""Reatined_users"") AS ""Retention Users"", SUM(Reatined_users*1.0000)/SUM(Base_users) AS ""Retention"" 
FROM (--mtd retention
with
lm as (select mt,scope_cust_id,lifecycle 
        from (select date_trunc('month',a.dt) mt ,cast(a.cust_id as varchar) scope_cust_id,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                where a.dt>= date_trunc('month',current_date +interval '-1' day) +interval '-1' month
                 and  a.dt<= date_trunc('month',current_date +interval '-1' day) +interval '-1' day
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date_trunc('month',current_date +interval '-1' day)   
                       and   current_date +interval '-1' day
                        and transaction_date_key between  date_trunc('month',current_date +interval '-1' day)   
                       and  current_date +interval '-1' day
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                            group by 1
            )   
)

select a.lifecycle,
count(distinct a.scope_cust_id) Base_users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a 
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1
) AS virtual_table GROUP BY lifecycle ORDER BY ""Base Users"" DESC
LIMIT 1000;

"
476,2955,RMG Retentions,"What is the retention rate of gaming merchant users from August to September, broken down by user lifecycle stages?","SELECT ""Month"" AS ""Month"", gm AS gm, lifecycle AS lifecycle, sum(users) AS ""MAU Users"", sum(""Reatined_users"") AS ""Retained users"", sum(Reatined_users*1.0000)*100/SUM(users)*1.0000 AS ""Retention In %"" 
FROM (--combined
select * from (
with  category as (
select 
--a.mnt,
a.payer_cust_id customer_id
from user_paytm_payments.gaming_merchant_5816_analysis a
where  a.mnt >= date'2025-05-01' and  a.mnt <= date'2025-08-31'
and a.gaming_merc = 'Gaming merc'
group by 1--,2
 ),
lm as (select mt,scope_cust_id,lifecycle,gm 
        from (select date_trunc('month',date(dt)) mt ,a.cust_id scope_cust_id ,
        if(b.customer_id is not null,1,0)gm,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                left join category b on --date_trunc('month',date(a.dt))=date_trunc('month',mnt) and
                 a.cust_id=b.customer_id
                where date(a.dt)>=date'2025-08-01'   and  date(a.dt)<=date'2025-08-31' 
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date'2025-09-01'  
                       and  date'2025-09-30' 
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                        and transaction_date_key>=date'2025-09-01'      
                        and  transaction_date_key<=date'2025-09-30' 
                        and day(transaction_date_key)<day(current_date)
                            group by 1
            )   
)

select 'Aug to Sep' Month, a.lifecycle,a.gm, 
        count(distinct a.scope_cust_id) users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1,2,3
)
union all
--mtd retention
select * from(
with  category as (
        select 
       -- a.mnt,
        a.payer_cust_id customer_id
        from user_paytm_payments.gaming_merchant_5816_analysis a
        where  a.mnt >= date'2025-05-01' and  a.mnt <= date'2025-08-31'
        and a.gaming_merc = 'Gaming merc'
        group by 1--,2
        ),
lm as (select mt,scope_cust_id,lifecycle ,gm
        from (select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id,if(b.customer_id is not null,1,0)gm,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                left join category b on --date_trunc('month',dt)=date_trunc('month',mnt) and
                          a.cust_id=b.customer_id
                where  date(a.dt)>=date'2025-09-01'   and  date(a.dt)<=date'2025-09-30' 
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date'2025-10-01'  
                       and  date'2025-10-31' 
                        and transaction_date_key between  date'2025-10-01'  
                       and  date'2025-10-31' 
                        and day(transaction_date_key)<day(current_date)
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                            group by 1
            )   
)

select 'Sep to Oct' Month, a.lifecycle,gm,
count(distinct a.scope_cust_id) Base_users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a 
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1,2,3
)
) AS virtual_table GROUP BY ""Month"", gm, lifecycle ORDER BY ""MAU Users"" DESC
LIMIT 1000;

"
476,2955,RMG Retentions,"What is the month-over-month retention rate for UPI users from August to September 2025, broken down by user lifecycle stage and gaming merchant activity?","SELECT ""Month"" AS ""Month"", gm AS gm, lifecycle AS lifecycle, sum(users) AS ""MAU Users"", sum(""Reatined_users"") AS ""Retained users"", sum(Reatined_users*1.0000)*100/SUM(users)*1.0000 AS ""Retention In %"" 
FROM (--combined
select * from (
with  category as (
select 
--a.mnt,
a.payer_cust_id customer_id
from user_paytm_payments.gaming_merchant_5816_analysis a
where  a.mnt >= date'2025-05-01' and  a.mnt <= date'2025-08-31'
and a.gaming_merc = 'Gaming merc'
group by 1--,2
 ),
lm as (select mt,scope_cust_id,lifecycle,gm 
        from (select date_trunc('month',date(dt)) mt ,a.cust_id scope_cust_id ,
        if(b.customer_id is not null,1,0)gm,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                left join category b on --date_trunc('month',date(a.dt))=date_trunc('month',mnt) and
                 a.cust_id=b.customer_id
                where date(a.dt)>=date'2025-08-01'   and  date(a.dt)<=date'2025-08-31' 
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date'2025-09-01'  
                       and  date'2025-09-30' 
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                        and transaction_date_key>=date'2025-09-01'      
                        and  transaction_date_key<=date'2025-09-30' 
                        and day(transaction_date_key)<day(current_date)
                            group by 1
            )   
)

select 'Aug to Sep' Month, a.lifecycle,a.gm, 
        count(distinct a.scope_cust_id) users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1,2,3
)
union all
--mtd retention
select * from(
with  category as (
        select 
       -- a.mnt,
        a.payer_cust_id customer_id
        from user_paytm_payments.gaming_merchant_5816_analysis a
        where  a.mnt >= date'2025-05-01' and  a.mnt <= date'2025-08-31'
        and a.gaming_merc = 'Gaming merc'
        group by 1--,2
        ),
lm as (select mt,scope_cust_id,lifecycle ,gm
        from (select date_trunc('month',a.dt) mt ,a.cust_id scope_cust_id,if(b.customer_id is not null,1,0)gm,
                if(a.user_type in ('c:react 3+','c:react 1-3'),'c:react',a.user_type) lifecycle 
                from hive.user_paytm_payments.paytm_upi_mau_final_nrr_1  a 
                left join category b on --date_trunc('month',dt)=date_trunc('month',mnt) and
                          a.cust_id=b.customer_id
                where  date(a.dt)>=date'2025-09-01'   and  date(a.dt)<=date'2025-09-30' 
            )   
),
CMTD as (select scope_cust_id
        from ( select customer_id_payer scope_cust_id
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                        where a.dl_last_updated between date'2025-10-01'  
                       and  date'2025-10-31' 
                        and transaction_date_key between  date'2025-10-01'  
                       and  date'2025-10-31' 
                        and day(transaction_date_key)<day(current_date)
                        and transaction_type in ('PAY','COLLECT')
                        and a.status in('SUCCESS','DEEMED')
                        and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                        and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT') 
                            group by 1
            )   
)

select 'Sep to Oct' Month, a.lifecycle,gm,
count(distinct a.scope_cust_id) Base_users,
        count(distinct b.scope_cust_id) Reatined_users 
        from lm a 
        left  join  cmtd b on b.scope_cust_id=a.scope_cust_id 
        group by 1,2,3
)
) AS virtual_table GROUP BY ""Month"", gm, lifecycle ORDER BY ""MAU Users"" DESC
LIMIT 1000;

"
476,3058,[Upi Profile wise] P2P P2M Ratio,"What is the ratio of P2P to P2M transactions across different UPI user lifecycle stages in terms of daily active users, transaction volume, and transaction value?","SELECT mt_flag AS mt_flag, p2m_p2p_flag AS p2m_p2p_flag, ""Lifecycle"" AS ""Lifecycle"", sum(""DAU"") AS ""DAU__"",  lAG(sum(Dau))
OVER(
PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag
)*1.000000
/ 
sum(Dau) AS ""Ratio DAU P2p/p2m"", sum(""Txns"") AS ""Txns"",  lAG(sum(Txns))
OVER(
PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag
)*1.000000
/ 
sum(Txns) AS ""Ratio txns P2p/p2m"", sum(""Amount"") AS ""GMV"",  lAG(sum(Amount))
OVER(
PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag
)*1.000000
/ 
sum(Amount) AS ""Ratio gmv P2p/p2m"" 
FROM (-- Users (DAU,MAU), Txns split by states  
-- Retention & TPU split by NRR
with 
upi as( 

select transaction_date_key day_id,customer_id_payer payer_cust_id,
  case when is_p2p=True then 'P2P'
        when is_p2m=True then 'P2M' else flow_category
        end as p2m_p2p_flag,flow_category,
 count(distinct txn_id)txns,sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where  a.dl_last_updated  BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2,3,4

), 
out as(  select  a.day_id, a.payer_cust_id,
             p2m_p2p_flag,Flow_category,
              sum(txns) Txns,
              sum(amount) Amount
            from upi a 
            group by 1,2,3,4
),
nrr as( select lifecycle, cast(customer_id as varchar) custid,
              date_trunc('month',ft_date) mt  
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) >= date_trunc('month',(current_Date - interval '01' day )) - interval '01' month 
  )

select Lifecycle,
                CASE
                  WHEN day_id >= date_trunc('month', current_date)
                       AND day_id < current_date
                  THEN 'CMTD'
                  WHEN day_id >= date_trunc('month', current_date)+interval '-1' month
                       AND day_id <=current_date+interval '-1' month +interval '-1' day 
                  THEN 'LMTD'
                  ELSE NULL
                END AS mt_flag,
                p2m_p2p_flag,
                count(Distinct  payer_cust_id ) DAU, 
                sum(txns) Txns,
                sum(amount) Amount
from out
left join nrr on out.payer_cust_id=nrr.custid and  nrr.mt=date_trunc('month',day_id)
where day(day_id)<day(current_date) and lifecycle is not null
group by 1,2,3
) AS virtual_table GROUP BY mt_flag, p2m_p2p_flag, ""Lifecycle"" ORDER BY sum(""DAU"") DESC
LIMIT 5000;

"
476,3058,[Upi Profile wise] P2P P2M Ratio,"What is the ratio of P2P to P2M transactions across different UPI user profiles, broken down by daily active users, transaction volume, and transaction value?","SELECT mt_flag AS mt_flag, p2m_p2p_flag AS p2m_p2p_flag, ""Lifecycle"" AS ""Lifecycle"", sum(""DAU"") AS ""DAU__"",  lAG(sum(Dau))
OVER(
PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag
)*1.000000
/ 
sum(Dau) AS ""Ratio DAU P2p/p2m"", sum(""Txns"") AS ""Txns"",  lAG(sum(Txns))
OVER(
PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag
)*1.000000
/ 
sum(Txns) AS ""Ratio txns P2p/p2m"", sum(""Amount"") AS ""GMV"",  lAG(sum(Amount))
OVER(
PARTITION BY Lifecycle,mt_flag ORDER BY p2m_p2p_flag
)*1.000000
/ 
sum(Amount) AS ""Ratio gmv P2p/p2m"" 
FROM (-- Users (DAU,MAU), Txns split by states  
-- Retention & TPU split by NRR
with 
upi as( 

select transaction_date_key day_id,customer_id_payer payer_cust_id,
  case when is_p2p=True then 'P2P'
        when is_p2m=True then 'P2M' else flow_category
        end as p2m_p2p_flag,flow_category,
 count(distinct txn_id)txns,sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where  a.dl_last_updated  BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2,3,4

), 
out as(  select  a.day_id, a.payer_cust_id,
             p2m_p2p_flag,Flow_category,
              sum(txns) Txns,
              sum(amount) Amount
            from upi a 
            group by 1,2,3,4
),
nrr as( select lifecycle, cast(customer_id as varchar) custid,
              date_trunc('month',ft_date) mt  
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) >= date_trunc('month',(current_Date - interval '01' day )) - interval '01' month 
  )

select Lifecycle,
                CASE
                  WHEN day_id >= date_trunc('month', current_date)
                       AND day_id < current_date
                  THEN 'CMTD'
                  WHEN day_id >= date_trunc('month', current_date)+interval '-1' month
                       AND day_id <=current_date+interval '-1' month +interval '-1' day 
                  THEN 'LMTD'
                  ELSE NULL
                END AS mt_flag,
                p2m_p2p_flag,
                count(Distinct  payer_cust_id ) DAU, 
                sum(txns) Txns,
                sum(amount) Amount
from out
left join nrr on out.payer_cust_id=nrr.custid and  nrr.mt=date_trunc('month',day_id)
where day(day_id)<day(current_date) and lifecycle is not null
group by 1,2,3
) AS virtual_table GROUP BY mt_flag, p2m_p2p_flag, ""Lifecycle"" ORDER BY sum(""DAU"") DESC
LIMIT 5000;

"
476,3072,RMG TPU GPU,How are monthly active UPI users distributed between gaming and non-gaming customers across different use case categories?,"SELECT use_case AS use_case, ""Month"" AS ""Month"", ""Gaming_flag"" AS ""Gaming_flag"", sum(users) AS ""Users__"" 
FROM (with rmg as (
select 
a.mnt,
a.payer_cust_id customer_id
from user_paytm_payments.gaming_merchant_5816_analysis a
where  a.mnt >= date'2025-05-01' and  a.mnt <= date'2025-08-31'
and a.gaming_merc = 'Gaming merc'
group by 1,2
 ),
 
 use_case as(
              SELECT payer_cust_id customer_id,month(day_id) Month,
              count(Distinct final_category) use_case 
              from (select transaction_date_key day_id,customer_id_payer payer_cust_id,txn_id,amount,
                                  case  WHEN flow_category IN ('P2P') THEN 'P2P' WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
                                        WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online' 
                                        WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus' else null end as final_category
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                       where a.dl_last_updated between date_trunc('month',(current_Date - interval '01' day - interval '01' month)) and current_date 
                                and transaction_type in ('PAY','COLLECT')
                                and a.status in('SUCCESS','DEEMED')
                                and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                                and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')   
                            -- and final_category not in('Others','others')
                            and transaction_date_key 
                            between date_trunc('month',(current_Date - interval '01' day - interval '01' month)) and (current_Date - interval '01' day) 
                    )
            group by 1,2
            )

SELECT if(rmg.customer_id is null, 'Non_gaming', 'Gaming' )Gaming_flag,
        Month,
        if(use_case=1,'1','2+') use_case, 
        count(c.customer_id) users 
from  use_case c
left join rmg on rmg.customer_id=c.customer_id
where use_case!=0
group by 1,2,3
) AS virtual_table GROUP BY use_case, ""Month"", ""Gaming_flag"" ORDER BY sum(users) DESC
LIMIT 10000;

"
476,3072,RMG TPU GPU,"How are our monthly active UPI users distributed across different usage patterns, and how does this distribution differ between gaming and non-gaming users?","SELECT use_case AS use_case, ""Month"" AS ""Month"", ""Gaming_flag"" AS ""Gaming_flag"", sum(users) AS ""Users__"" 
FROM (with rmg as (
select 
a.mnt,
a.payer_cust_id customer_id
from user_paytm_payments.gaming_merchant_5816_analysis a
where  a.mnt >= date'2025-05-01' and  a.mnt <= date'2025-08-31'
and a.gaming_merc = 'Gaming merc'
group by 1,2
 ),
 
 use_case as(
              SELECT payer_cust_id customer_id,month(day_id) Month,
              count(Distinct final_category) use_case 
              from (select transaction_date_key day_id,customer_id_payer payer_cust_id,txn_id,amount,
                                  case  WHEN flow_category IN ('P2P') THEN 'P2P' WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
                                        WHEN flow_category IN ('Intent', 'P2M Collect', 'Mandate_Online') THEN 'Online' 
                                        WHEN flow_category IN ('Onus_ExcMandates', 'Mandate_Onus') THEN 'Onus' else null end as final_category
                        from   hive.cdo.fact_upi_transactions_snapshot_v3 a 
                       where a.dl_last_updated between date_trunc('month',(current_Date - interval '01' day - interval '01' month)) and current_date 
                                and transaction_type in ('PAY','COLLECT')
                                and a.status in('SUCCESS','DEEMED')
                                and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
                                and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')   
                            -- and final_category not in('Others','others')
                            and transaction_date_key 
                            between date_trunc('month',(current_Date - interval '01' day - interval '01' month)) and (current_Date - interval '01' day) 
                    )
            group by 1,2
            )

SELECT if(rmg.customer_id is null, 'Non_gaming', 'Gaming' )Gaming_flag,
        Month,
        if(use_case=1,'1','2+') use_case, 
        count(c.customer_id) users 
from  use_case c
left join rmg on rmg.customer_id=c.customer_id
where use_case!=0
group by 1,2,3
) AS virtual_table GROUP BY use_case, ""Month"", ""Gaming_flag"" ORDER BY sum(users) DESC
LIMIT 10000;

"
476,3238,[Growth]TG CG tracking feature for New PTS Banner 2.0,How is the new PTS Banner 2.0 performing in terms of user engagement and conversion rates across different UPI features and user profile segments?,"SELECT dt AS dt, property AS property, feature AS feature, users_viewed_banner AS users_viewed_banner, converted_post_viewing AS converted_post_viewing, users_clicked_banner AS users_clicked_banner, converted_post_clicking AS converted_post_clicking 
FROM (--TG
with ftr as (   
    -- 1. Bank Linking
    SELECT 'Bank Linking' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.bank_link
    WHERE  dt < current_date

    UNION ALL
     -- x. Mapper
    SELECT 'Mapper' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.mapper
    WHERE  dt < current_date

    UNION ALL
    -- 2. RuPay CC Linking
    SELECT 'RuPay CC Linking' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.cc_all_linkages
    WHERE  dt < current_date

    UNION ALL
    -- 3. Lite Activation
    SELECT 'UPI Lite Activation' AS type, customer_id AS custid, lite_dt AS dt
    FROM hive.user_paytm_payments.lite_active
    WHERE  lite_dt < current_date

    UNION ALL
    -- 4. UPI Statement
    SELECT 'Download UPI Statement' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.upi_statement_download_V1
    WHERE  dt < current_date

    UNION ALL
    -- 5. Receive Money widget
    SELECT 'Receive Money widget' AS type, customer_id AS custid, dl_last_updated AS dt
    FROM hive.user_paytm_payments.widget_added_rec_money_ER_daily
    WHERE  dl_last_updated < current_date

    UNION ALL
    -- 6. Scan & Pay widget
    SELECT 'Scan & Pay widget' AS type, customer_id AS custid, dl_last_updated AS dt
    FROM hive.user_paytm_payments.widget_added_snp_ER_daily
    WHERE  dl_last_updated < current_date

    UNION ALL
    -- 7. Spends Analytics
    SELECT 'Spends Analytics' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.spend_analytics
    WHERE  dt < current_date

    UNION ALL
    -- 8. Lite auto top-up
    SELECT 'UPI Lite Auto Top UP' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.lite_auto_topup
    WHERE  dt < current_date

    UNION ALL
    -- 9. Total Balance
    SELECT 'Total Balance' AS type, customer_id AS custid, DATE(dt) AS dt
    FROM hive.user_paytm_payments.check_balance
    WHERE  dt < current_date

    UNION ALL
    -- 10. Custom VPA
    SELECT 'Custom VPA' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.customer_vpa
    WHERE  dt < current_date

    UNION ALL
    -- 11. Hide Payments
    SELECT 'Hide Payments' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.hide_payments
    WHERE  dt < current_date
),
  banner AS (
  SELECT dt,
       customer_id,
       CASE 
    WHEN banner_id IN (
        '3159810','3159843','3159842','3159841','3159987',
        '3159988','3159989','3160634','3159986','3041990',
        '3159992','3159993','3159994','3159995'
    ) THEN 'PTS Banner 2.0'

    WHEN banner_id IN (
        '3136301','3135794','3137732','3135803','3135814',
        '3137499','3135812','3135813','3137500','3136333',
        '3136337','3135809'
    ) THEN 'PTS Curtain widget'
END AS property,
     CASE 
    WHEN banner_id = '3159810' THEN 'Mapper'
    WHEN banner_id = '3136301' THEN 'Mapper'
    WHEN banner_id = '3159843' THEN 'UPI Lite Auto Top UP'
    WHEN banner_id = '3137500' THEN 'UPI Lite Auto Top UP'
    WHEN banner_id = '3159842' THEN 'Spends Analytics'
    WHEN banner_id = '3135813' THEN 'Spends Analytics'
    WHEN banner_id = '3159841' THEN 'RuPay CC Linking'
    WHEN banner_id = '3137732' THEN 'RuPay CC Linking'
    WHEN banner_id = '3159987' THEN 'Scan & Pay widget'
    WHEN banner_id = '3135812' THEN 'Scan & Pay widget'
    WHEN banner_id = '3159988' THEN 'Receive Money widget'
    WHEN banner_id = '3137499' THEN 'Receive Money widget'
    WHEN banner_id = '3159989' THEN 'Download UPI Statement'
    WHEN banner_id = '3135814' THEN 'Download UPI Statement'
    WHEN banner_id = '3160634' THEN 'UPI Lite Activation'
    WHEN banner_id = '3135803' THEN 'UPI Lite Activation'
    WHEN banner_id = '3159986' THEN 'Bank Linking'
    WHEN banner_id = '3135794' THEN 'Bank Linking'
    WHEN banner_id = '3041990' THEN 'Self Transfer'
    WHEN banner_id = '3159992' THEN 'Total Balance'
    WHEN banner_id = '3136333' THEN 'Total Balance'
    WHEN banner_id = '3159993' THEN 'Custom VPA'
    WHEN banner_id = '3136337' THEN 'Custom VPA'
    WHEN banner_id = '3159994' THEN 'Hide Payments'
    WHEN banner_id = '3135809' THEN 'Hide Payments'
    WHEN banner_id = '3159995' THEN 'Handle Creation'
END AS feature,
       SUM(impressions) AS impressions,
       SUM(clicks) AS clicks
FROM team_measurement.banner_campaigns_customer_v1
WHERE dt >=  current_date- interval '35' day
  AND dt < CURRENT_DATE
  AND try_cast(banner_id as varchar) IN (
    '3159810','3136301',   -- Mapper
    '3159843','3137500',   -- UPI Lite Auto Top UP
    '3159842','3135813',   -- Spends Analytics
    '3159841','3137732',   -- RuPay CC Linking
    '3159987','3135812',   -- Scan & Pay widget
    '3159988','3137499',   -- Receive Money widget
    '3159989','3135814',   -- Download UPI Statement
    '3160634','3135803',   -- UPI Lite Activation
    '3159986','3135794',   -- Bank Linking
    '3041990',             -- Self Transfer
    '3159992','3136333',   -- Total Balance
    '3159993','3136337',   -- Custom VPA
    '3159994','3135809',   -- Hide Payments
    '3159995'              -- Handle Creation
)
GROUP BY 1,2,3,4

)

    select b.dt,property,
        b.feature, 
        count(distinct case when b.impressions>0 then b.customer_id end) as users_viewed_banner,
        count(distinct case when b.impressions>0 and f.custid is not null then b.customer_id end) as converted_post_viewing,
        count(distinct case when b.clicks>0 then b.customer_id end) as users_clicked_banner,
        count(distinct case when b.clicks>0 and f.custid is not null then b.customer_id end) as converted_post_clicking
    from banner b 
    -- left join (select custid,type, min(dt)dt from  ftr group by 1,2 having min(dt)>=DATE '2025-08-11' ) f
    --         on b.customer_id=f.custid and b.feature=f.type and b.dt=f.dt
      left join (select custid,type feature,  date(dt) dt from  ftr where dt>= current_date-interval '35' day group by 1,2,3  ) f
            on b.customer_id=f.custid and b.feature=f.feature and b.dt=f.dt
    group by 1,2,3
) AS virtual_table ORDER BY dt DESC, users_clicked_banner DESC
LIMIT 50000;

"
476,3238,[Growth]TG CG tracking feature for New PTS Banner 2.0,"How is the New PTS Banner 2.0 performing in terms of user engagement and conversion rates for different UPI features like bank linking, RuPay CC linking, and UPI Lite activation?","SELECT dt AS dt, property AS property, feature AS feature, users_viewed_banner AS users_viewed_banner, converted_post_viewing AS converted_post_viewing, users_clicked_banner AS users_clicked_banner, converted_post_clicking AS converted_post_clicking 
FROM (--TG
with ftr as (   
    -- 1. Bank Linking
    SELECT 'Bank Linking' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.bank_link
    WHERE  dt < current_date

    UNION ALL
     -- x. Mapper
    SELECT 'Mapper' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.mapper
    WHERE  dt < current_date

    UNION ALL
    -- 2. RuPay CC Linking
    SELECT 'RuPay CC Linking' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.cc_all_linkages
    WHERE  dt < current_date

    UNION ALL
    -- 3. Lite Activation
    SELECT 'UPI Lite Activation' AS type, customer_id AS custid, lite_dt AS dt
    FROM hive.user_paytm_payments.lite_active
    WHERE  lite_dt < current_date

    UNION ALL
    -- 4. UPI Statement
    SELECT 'Download UPI Statement' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.upi_statement_download_V1
    WHERE  dt < current_date

    UNION ALL
    -- 5. Receive Money widget
    SELECT 'Receive Money widget' AS type, customer_id AS custid, dl_last_updated AS dt
    FROM hive.user_paytm_payments.widget_added_rec_money_ER_daily
    WHERE  dl_last_updated < current_date

    UNION ALL
    -- 6. Scan & Pay widget
    SELECT 'Scan & Pay widget' AS type, customer_id AS custid, dl_last_updated AS dt
    FROM hive.user_paytm_payments.widget_added_snp_ER_daily
    WHERE  dl_last_updated < current_date

    UNION ALL
    -- 7. Spends Analytics
    SELECT 'Spends Analytics' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.spend_analytics
    WHERE  dt < current_date

    UNION ALL
    -- 8. Lite auto top-up
    SELECT 'UPI Lite Auto Top UP' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.lite_auto_topup
    WHERE  dt < current_date

    UNION ALL
    -- 9. Total Balance
    SELECT 'Total Balance' AS type, customer_id AS custid, DATE(dt) AS dt
    FROM hive.user_paytm_payments.check_balance
    WHERE  dt < current_date

    UNION ALL
    -- 10. Custom VPA
    SELECT 'Custom VPA' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.customer_vpa
    WHERE  dt < current_date

    UNION ALL
    -- 11. Hide Payments
    SELECT 'Hide Payments' AS type, customer_id AS custid, dt
    FROM hive.user_paytm_payments.hide_payments
    WHERE  dt < current_date
),
  banner AS (
  SELECT dt,
       customer_id,
       CASE 
    WHEN banner_id IN (
        '3159810','3159843','3159842','3159841','3159987',
        '3159988','3159989','3160634','3159986','3041990',
        '3159992','3159993','3159994','3159995'
    ) THEN 'PTS Banner 2.0'

    WHEN banner_id IN (
        '3136301','3135794','3137732','3135803','3135814',
        '3137499','3135812','3135813','3137500','3136333',
        '3136337','3135809'
    ) THEN 'PTS Curtain widget'
END AS property,
     CASE 
    WHEN banner_id = '3159810' THEN 'Mapper'
    WHEN banner_id = '3136301' THEN 'Mapper'
    WHEN banner_id = '3159843' THEN 'UPI Lite Auto Top UP'
    WHEN banner_id = '3137500' THEN 'UPI Lite Auto Top UP'
    WHEN banner_id = '3159842' THEN 'Spends Analytics'
    WHEN banner_id = '3135813' THEN 'Spends Analytics'
    WHEN banner_id = '3159841' THEN 'RuPay CC Linking'
    WHEN banner_id = '3137732' THEN 'RuPay CC Linking'
    WHEN banner_id = '3159987' THEN 'Scan & Pay widget'
    WHEN banner_id = '3135812' THEN 'Scan & Pay widget'
    WHEN banner_id = '3159988' THEN 'Receive Money widget'
    WHEN banner_id = '3137499' THEN 'Receive Money widget'
    WHEN banner_id = '3159989' THEN 'Download UPI Statement'
    WHEN banner_id = '3135814' THEN 'Download UPI Statement'
    WHEN banner_id = '3160634' THEN 'UPI Lite Activation'
    WHEN banner_id = '3135803' THEN 'UPI Lite Activation'
    WHEN banner_id = '3159986' THEN 'Bank Linking'
    WHEN banner_id = '3135794' THEN 'Bank Linking'
    WHEN banner_id = '3041990' THEN 'Self Transfer'
    WHEN banner_id = '3159992' THEN 'Total Balance'
    WHEN banner_id = '3136333' THEN 'Total Balance'
    WHEN banner_id = '3159993' THEN 'Custom VPA'
    WHEN banner_id = '3136337' THEN 'Custom VPA'
    WHEN banner_id = '3159994' THEN 'Hide Payments'
    WHEN banner_id = '3135809' THEN 'Hide Payments'
    WHEN banner_id = '3159995' THEN 'Handle Creation'
END AS feature,
       SUM(impressions) AS impressions,
       SUM(clicks) AS clicks
FROM team_measurement.banner_campaigns_customer_v1
WHERE dt >=  current_date- interval '35' day
  AND dt < CURRENT_DATE
  AND try_cast(banner_id as varchar) IN (
    '3159810','3136301',   -- Mapper
    '3159843','3137500',   -- UPI Lite Auto Top UP
    '3159842','3135813',   -- Spends Analytics
    '3159841','3137732',   -- RuPay CC Linking
    '3159987','3135812',   -- Scan & Pay widget
    '3159988','3137499',   -- Receive Money widget
    '3159989','3135814',   -- Download UPI Statement
    '3160634','3135803',   -- UPI Lite Activation
    '3159986','3135794',   -- Bank Linking
    '3041990',             -- Self Transfer
    '3159992','3136333',   -- Total Balance
    '3159993','3136337',   -- Custom VPA
    '3159994','3135809',   -- Hide Payments
    '3159995'              -- Handle Creation
)
GROUP BY 1,2,3,4

)

    select b.dt,property,
        b.feature, 
        count(distinct case when b.impressions>0 then b.customer_id end) as users_viewed_banner,
        count(distinct case when b.impressions>0 and f.custid is not null then b.customer_id end) as converted_post_viewing,
        count(distinct case when b.clicks>0 then b.customer_id end) as users_clicked_banner,
        count(distinct case when b.clicks>0 and f.custid is not null then b.customer_id end) as converted_post_clicking
    from banner b 
    -- left join (select custid,type, min(dt)dt from  ftr group by 1,2 having min(dt)>=DATE '2025-08-11' ) f
    --         on b.customer_id=f.custid and b.feature=f.type and b.dt=f.dt
      left join (select custid,type feature,  date(dt) dt from  ftr where dt>= current_date-interval '35' day group by 1,2,3  ) f
            on b.customer_id=f.custid and b.feature=f.feature and b.dt=f.dt
    group by 1,2,3
) AS virtual_table ORDER BY dt DESC, users_clicked_banner DESC
LIMIT 50000;

"
476,5971,UPI Retention TPU wise MTD,What is the month-to-date UPI user retention rate broken down by transaction volume segments and user lifecycle stages?,"SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle)  AS ""Lifecycle(LM)"", ""TPU_bucket"" AS ""TPU_bucket__"", sum(""Base_users"") AS ""Base users"", sum(""Retained_users"") AS ""Retained users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""Retention"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
CMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY lifecycle,2,3


union all

SELECT 'd. Overall' lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) , ""TPU_bucket"" ORDER BY concat(if(lifecycle is null, 'd. Fresh users (CM)', lifecycle),TPU_bucket) DESC
LIMIT 1000;

"
476,5971,UPI Retention TPU wise MTD,What is the month-to-date UPI user retention rate broken down by transaction frequency buckets and user lifecycle stages?,"SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle)  AS ""Lifecycle(LM)"", ""TPU_bucket"" AS ""TPU_bucket__"", sum(""Base_users"") AS ""Base users"", sum(""Retained_users"") AS ""Retained users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""Retention"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
CMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY lifecycle,2,3


union all

SELECT 'd. Overall' lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) , ""TPU_bucket"" ORDER BY concat(if(lifecycle is null, 'd. Fresh users (CM)', lifecycle),TPU_bucket) DESC
LIMIT 1000;

"
476,5982,UPI Retention TPU wise LMTD,What is the month-over-month retention rate of UPI users segmented by their transaction frequency levels?,"SELECT ""Lifecycle"" AS ""Lifecycle__"", tpu_bucket AS tpu_bucket__, sum(""Base_users"") AS ""Base Users"", sum(""Retained_users"") AS ""Retained Users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""%"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
lMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      and day(transaction_date_key)<day(current_date)
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LlM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(Amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN  date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr c on a.scope_cust_id=c.custid 
GROUP BY 1,2,3

union all
SELECT 'd. Overall' Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b
    ON b.scope_cust_id = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY ""Lifecycle"", tpu_bucket ORDER BY concat(Lifecycle,tpu_bucket) DESC
LIMIT 1000;

"
476,5982,UPI Retention TPU wise LMTD,"What is the retention rate of UPI users this month compared to last month, broken down by their transaction frequency buckets?","SELECT ""Lifecycle"" AS ""Lifecycle__"", tpu_bucket AS tpu_bucket__, sum(""Base_users"") AS ""Base Users"", sum(""Retained_users"") AS ""Retained Users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""%"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
lMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      and day(transaction_date_key)<day(current_date)
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LlM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(Amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN  date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr c on a.scope_cust_id=c.custid 
GROUP BY 1,2,3

union all
SELECT 'd. Overall' Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b
    ON b.scope_cust_id = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY ""Lifecycle"", tpu_bucket ORDER BY concat(Lifecycle,tpu_bucket) DESC
LIMIT 1000;

"
476,7488,State wise flow wise,"How are UPI transactions distributed across different states and payment flows, showing the breakdown of daily active users, transaction volumes, and amounts for P2P versus P2M transactions by state?","SELECT ""Lifecycle"" AS ""Lifecycle"", ""Day_id"" AS day_id, ""State"" AS state, ""Flow_category"" AS flow_category, p2m_p2p_flag AS p2m_p2p_flag, ""DAU"" AS ""DAU"", ""Txns"" AS ""Txns"", ""Amount"" AS ""Amount"" 
FROM (-- Users (DAU,MAU), Txns split by states  
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max( upper(popular_city))  as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=current_date+interval'-5' day
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id,
  case when is_p2p=True then 'P2P'
        when is_p2m=True then 'P2M' else flow_category
        end as p2m_p2p_flag,flow_category,
 count(distinct txn_id)txns,sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where  a.dl_last_updated  BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2,3,4

), 
out as(  select  a.day_id,coalesce(state,'Other')state, a.payer_cust_id,
             p2m_p2p_flag,Flow_category,
              sum(txns) Txns,
              sum(amount) Amount
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id 
            group by 1,2,3,4,5   
),
nrr as( select lifecycle, cast(customer_id as varchar) custid,
              date_trunc('month',ft_date) mt  
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) >= date_trunc('month',(current_Date - interval '01' day )) - interval '01' month 
  )

select Lifecycle,Day_id, State,p2m_p2p_flag,Flow_category,
                count(Distinct  payer_cust_id ) DAU, 
                sum(txns) Txns,
                sum(amount) Amount
from out
left join nrr on out.payer_cust_id=nrr.custid and  nrr.mt=date_trunc('month',day_id)
group by 1,2,3,4,5
) AS virtual_table 
WHERE (( day_id>=current_date-interval '3' day))
LIMIT 5000;

"
476,7488,State wise flow wise,"How are UPI transactions distributed across different states and transaction types (P2P vs P2M), showing the daily active users, transaction volumes, and amounts?","SELECT ""Lifecycle"" AS ""Lifecycle"", ""Day_id"" AS day_id, ""State"" AS state, ""Flow_category"" AS flow_category, p2m_p2p_flag AS p2m_p2p_flag, ""DAU"" AS ""DAU"", ""Txns"" AS ""Txns"", ""Amount"" AS ""Amount"" 
FROM (-- Users (DAU,MAU), Txns split by states  
-- Retention & TPU split by NRR
with top20 as(select
        customer_id,
        max( upper(popular_city))  as popular_city,
        max(popular_state)state
        from hive.midgar.engage_data_snapshot_v3 
        where customer_id is not NULL 
        group by 1
),
upi as( --select * from hive.user_paytm_payments.temp_upi_test2
-- CREATE TABLE hive.user_paytm_payments.temp_upi_test2 as  
--     select day_id, payer_cust_id, count(distinct txn_id)txns
--         from hive.user_paytm_payments.upi_abhay
--     where day_id>=current_date+interval'-5' day
-- and  day_id<current_date
-- group by 1,2

select transaction_date_key day_id,customer_id_payer payer_cust_id,
  case when is_p2p=True then 'P2P'
        when is_p2m=True then 'P2M' else flow_category
        end as p2m_p2p_flag,flow_category,
 count(distinct txn_id)txns,sum(amount) amount
 from  hive.cdo.fact_upi_transactions_snapshot_v3 a 
where  a.dl_last_updated  BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND    current_date + interval '-1' day 
and  transaction_date_key<current_date
and transaction_type in ('PAY','COLLECT')
 and a.status in('SUCCESS','DEEMED')
 and  payer_handle in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
and a.category in('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
group by 1,2,3,4

), 
out as(  select  a.day_id,coalesce(state,'Other')state, a.payer_cust_id,
             p2m_p2p_flag,Flow_category,
              sum(txns) Txns,
              sum(amount) Amount
            from upi a
            left join top20 b on a.payer_cust_id=b.customer_id 
            group by 1,2,3,4,5   
),
nrr as( select lifecycle, cast(customer_id as varchar) custid,
              date_trunc('month',ft_date) mt  
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) >= date_trunc('month',(current_Date - interval '01' day )) - interval '01' month 
  )

select Lifecycle,Day_id, State,p2m_p2p_flag,Flow_category,
                count(Distinct  payer_cust_id ) DAU, 
                sum(txns) Txns,
                sum(amount) Amount
from out
left join nrr on out.payer_cust_id=nrr.custid and  nrr.mt=date_trunc('month',day_id)
group by 1,2,3,4,5
) AS virtual_table 
WHERE (( day_id>=current_date-interval '3' day))
LIMIT 5000;

"
476,7507,UPI Retention GPU wise MTD,"What is the month-to-date UPI user retention rate broken down by user lifecycle segments and transaction value buckets, comparing last month's active users to those still transacting this month?","SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle)  AS ""Lifecycle(LM)"", gmv_bkt AS gmv_bkt__, sum(""Base_users"") AS ""Base users"", sum(""Retained_users"") AS ""Retained users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""Retention"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
CMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY lifecycle,2,3


union all

SELECT 'd. Overall' lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) , gmv_bkt ORDER BY concat(if(lifecycle is null, 'd. Fresh users (CM)', lifecycle),gmv_bkt) DESC
LIMIT 1000;

"
476,7507,UPI Retention GPU wise MTD,What is the month-to-date UPI user retention rate broken down by user lifecycle segments and GMV buckets?,"SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle)  AS ""Lifecycle(LM)"", gmv_bkt AS gmv_bkt__, sum(""Base_users"") AS ""Base users"", sum(""Retained_users"") AS ""Retained users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""Retention"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
CMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day)
                                 AND current_date + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY lifecycle,2,3


union all

SELECT 'd. Overall' lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS TPU_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM lm a
LEFT JOIN cmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr on nrr.custid = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) , gmv_bkt ORDER BY concat(if(lifecycle is null, 'd. Fresh users (CM)', lifecycle),gmv_bkt) DESC
LIMIT 1000;

"
476,7511,UPI Retention GPU wise LMTD,"What is the month-over-month retention rate for UPI users, broken down by their spending levels and user lifecycle stages?","SELECT ""Lifecycle"" AS ""Lifecycle__"", gmv_bkt AS gmv_bkt__, sum(""Base_users"") AS ""Base Users"", sum(""Retained_users"") AS ""Retained Users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""%"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
lMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      and day(transaction_date_key)<day(current_date)
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LlM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(Amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN  date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr c on a.scope_cust_id=c.custid 
GROUP BY 1,2,3

union all
SELECT 'd. Overall' Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b
    ON b.scope_cust_id = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY ""Lifecycle"", gmv_bkt ORDER BY concat(Lifecycle,gmv_bkt) DESC
LIMIT 1000;

"
476,7511,UPI Retention GPU wise LMTD,What is the UPI user retention rate by transaction volume segments comparing last month's active users to those who remained active in the current month so far?,"SELECT ""Lifecycle"" AS ""Lifecycle__"", gmv_bkt AS gmv_bkt__, sum(""Base_users"") AS ""Base Users"", sum(""Retained_users"") AS ""Retained Users"", SUM(Retained_users*1.0000)/SUM(Base_users) AS ""%"" 
FROM (-- MTD Retention by TPU Buckets (TPU calc inside source CTEs)
WITH
-- Current MTD users with TPU
lMTD AS (
    SELECT 
        customer_id_payer AS scope_cust_id 
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '1' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' day
      and day(transaction_date_key)<day(current_date)
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
-- Last month users with TPU
LlM AS (
    SELECT 
        customer_id_payer AS scope_cust_id,
        COUNT(DISTINCT txn_id) AS tpu,
        sum(Amount) gmv
    FROM hive.cdo.fact_upi_transactions_snapshot_v3 a
    WHERE a.dl_last_updated BETWEEN  date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_date_key BETWEEN date_trunc('month', current_date + interval '-1' day) - interval '2' month
                                 AND date_trunc('month', current_date + interval '-1' day) - interval '1' month + interval '-1' day
      AND a.transaction_type IN ('PAY','COLLECT')
      AND a.status IN ('SUCCESS','DEEMED')
      AND a.payer_handle IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
      AND a.category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
    GROUP BY 1
),
nrr as( select lifecycle, cast(customer_id as varchar) custid
          from hive.cdo.fact_upi_customer_lifecycle_snapshot_v3 
          where  date(ft_date) between date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            and  date_trunc('month',current_Date)- interval '01' day 
  )

SELECT if(lifecycle is null, 'd. Fresh users (CM)', lifecycle) Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b ON b.scope_cust_id = a.scope_cust_id
left join nrr c on a.scope_cust_id=c.custid 
GROUP BY 1,2,3

union all
SELECT 'd. Overall' Lifecycle,
    CASE 
        WHEN a.tpu = 1 THEN 'a.1'
        WHEN a.tpu = 2 THEN 'b.2'
        WHEN a.tpu = 3 THEN 'c.3'
        WHEN a.tpu BETWEEN 4 AND 10 THEN 'd.4-10'
        WHEN a.tpu BETWEEN 11 AND 20 THEN 'e.11-20'
        WHEN a.tpu > 20 THEN 'f.20+'
    END AS tpu_bucket,
    CASE 
    WHEN gmv >= 1      AND gmv < 1000   THEN 'A: 11k'
    WHEN gmv >= 1000   AND gmv < 3000   THEN 'B: 1k3k'
    WHEN gmv >= 3000   AND gmv < 5000   THEN 'C: 3k5k'
    WHEN gmv >= 5000   AND gmv < 10000  THEN 'D: 5k10k'
    WHEN gmv >= 10000  AND gmv < 20000  THEN 'E: 10k20k'
    WHEN gmv >= 20000                    THEN 'F: 20k+'
    ELSE 'F: 20k+'
END AS gmv_bkt,
    COUNT(DISTINCT a.scope_cust_id) AS Base_users,
    COUNT(DISTINCT CASE WHEN b.scope_cust_id IS NOT NULL THEN a.scope_cust_id END) AS Retained_users
FROM llm a
LEFT JOIN lmtd b
    ON b.scope_cust_id = a.scope_cust_id
GROUP BY 1,2,3
) AS virtual_table GROUP BY ""Lifecycle"", gmv_bkt ORDER BY concat(Lifecycle,gmv_bkt) DESC
LIMIT 1000;

"
588,2823,Hourly SR Trend (T vs T-1)- 588,What is the hourly success rate trend for UPI transactions comparing today versus yesterday?,"SELECT hour(created_on) AS ""Hour"", dt AS dt, (COUNT(txn_id) filter(WHERE status = 'SUCCESS')*1.0000) / (COUNT(txn_id)*1.0000) AS ""SR"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table GROUP BY hour(created_on), dt ORDER BY ""SR"" DESC
LIMIT 10000;

"
588,2823,Hourly SR Trend (T vs T-1)- 588,"What is the hourly success rate trend for UPI transactions, and how does it compare between the current period and the previous period?","SELECT hour(created_on) AS ""Hour"", dt AS dt, (COUNT(txn_id) filter(WHERE status = 'SUCCESS')*1.0000) / (COUNT(txn_id)*1.0000) AS ""SR"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table GROUP BY hour(created_on), dt ORDER BY ""SR"" DESC
LIMIT 10000;

"
588,2824,Top Error Codes (T vs T-1)- 588,"What are the top error codes in UPI transactions today compared to yesterday at the same time, and how much have they increased or decreased?","SELECT ""Error_code"" AS ""Error_code"", COUNT(txn_id)filter(where date(created_on) = (date(current_time_)- interval '01' day)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
) AS ""Yday Failure"", COUNT(txn_id)
filter(
where date(created_on) = date(current_time_)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
) AS ""Today Failure"", case when COUNT(txn_id)filter(where date(created_on) = (date(current_time_) - interval '01' day)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
) = 0 then 0 else

(
COUNT(txn_id)
filter(
where date(created_on) = date(current_time_)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
)
*1.0000
)/
(
COUNT(txn_id)filter(where date(created_on) = (date(current_time_)- interval '01' day)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
)*1.0000
)-1
end AS ""Failure Growth"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE status IN ('FAILURE') GROUP BY ""Error_code"" ORDER BY ""Yday Failure"" DESC
LIMIT 20;

"
588,2824,Top Error Codes (T vs T-1)- 588,"What are the top UPI error codes today compared to yesterday, and how much have the failure rates grown or declined for each error code?","SELECT ""Error_code"" AS ""Error_code"", COUNT(txn_id)filter(where date(created_on) = (date(current_time_)- interval '01' day)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
) AS ""Yday Failure"", COUNT(txn_id)
filter(
where date(created_on) = date(current_time_)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
) AS ""Today Failure"", case when COUNT(txn_id)filter(where date(created_on) = (date(current_time_) - interval '01' day)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
) = 0 then 0 else

(
COUNT(txn_id)
filter(
where date(created_on) = date(current_time_)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
)
*1.0000
)/
(
COUNT(txn_id)filter(where date(created_on) = (date(current_time_)- interval '01' day)
and hour(created_on) <= hour(
(current_time_ - interval '01' hour))
)*1.0000
)-1
end AS ""Failure Growth"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE status IN ('FAILURE') GROUP BY ""Error_code"" ORDER BY ""Yday Failure"" DESC
LIMIT 20;

"
588,2825,Top Bank Codes (T vs T-1)- 588,"Which bank codes or payee handles have the highest UPI transaction failures today compared to yesterday, and what is the failure growth rate for each?","SELECT payee_handle AS payee_handle, COUNT(txn_id)filter(where date(created_on) = (date(current_time_)- interval '01' day)
and hour(created_on) <= hour(
(cast(current_time_ as TIMESTAMP) - interval '01' hour))
) AS ""YDay_Failure"", COUNT(txn_id)
filter(
where date(created_on) = (date(current_time_))
and hour(created_on) <= hour(
(cast(current_time_ as TIMESTAMP) - interval '01' hour))
) AS ""Today_Failure"", case when COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast(current_time as TIMESTAMP) - interval '01' hour))
) = 0 then 0 else

(
COUNT(txn_id)
filter(
where date(created_on) = (current_date)
and hour(created_on) <= hour(
(cast(current_time as TIMESTAMP) - interval '01' hour))
)
*1.0000
)/
(
COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast(current_time as TIMESTAMP) - interval '01' hour))
)*1.0000
)-1
end AS ""Failure Growth"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE status IN ('FAILURE') GROUP BY payee_handle ORDER BY ""YDay_Failure"" DESC
LIMIT 20;

"
588,2825,Top Bank Codes (T vs T-1)- 588,"Which bank codes or payee handles have the highest UPI transaction failures today compared to yesterday, and what is the growth rate of failures for each?","SELECT payee_handle AS payee_handle, COUNT(txn_id)filter(where date(created_on) = (date(current_time_)- interval '01' day)
and hour(created_on) <= hour(
(cast(current_time_ as TIMESTAMP) - interval '01' hour))
) AS ""YDay_Failure"", COUNT(txn_id)
filter(
where date(created_on) = (date(current_time_))
and hour(created_on) <= hour(
(cast(current_time_ as TIMESTAMP) - interval '01' hour))
) AS ""Today_Failure"", case when COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast(current_time as TIMESTAMP) - interval '01' hour))
) = 0 then 0 else

(
COUNT(txn_id)
filter(
where date(created_on) = (current_date)
and hour(created_on) <= hour(
(cast(current_time as TIMESTAMP) - interval '01' hour))
)
*1.0000
)/
(
COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast(current_time as TIMESTAMP) - interval '01' hour))
)*1.0000
)-1
end AS ""Failure Growth"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE status IN ('FAILURE') GROUP BY payee_handle ORDER BY ""YDay_Failure"" DESC
LIMIT 20;

"
588,3174,PSP wise (T vs T-1)- 588,"What is the failure count comparison between today and yesterday for each PSP, and what is the growth rate of failures for UPI transactions with error code 588?","SELECT Lower(payer_handle) AS payer_handle, COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
) AS ""Yday Failure"", COUNT(txn_id)
filter(
where date(created_on) = (current_date)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
 )
  AS ""Today Failure"", case when COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
) = 0 then 0 else

(
COUNT(txn_id)
filter(
where date(created_on) = (current_date)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
)
*1.0000
)/
(
COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
)*1.0000
)-1
end AS ""Failure Growth"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE status IN ('FAILURE') GROUP BY Lower(payer_handle) ORDER BY ""Yday Failure"" DESC
LIMIT 100;

"
588,3174,PSP wise (T vs T-1)- 588,"How do UPI transaction failures compare between today and yesterday for each payment service provider, and what is the growth rate of failures?","SELECT Lower(payer_handle) AS payer_handle, COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
) AS ""Yday Failure"", COUNT(txn_id)
filter(
where date(created_on) = (current_date)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
 )
  AS ""Today Failure"", case when COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
) = 0 then 0 else

(
COUNT(txn_id)
filter(
where date(created_on) = (current_date)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
)
*1.0000
)/
(
COUNT(txn_id)filter(where date(created_on) = (current_date- interval '01' day)
and hour(created_on) <= hour(
(cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '01' hour))
)*1.0000
)-1
end AS ""Failure Growth"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE status IN ('FAILURE') GROUP BY Lower(payer_handle) ORDER BY ""Yday Failure"" DESC
LIMIT 100;

"
588,3229,Top Error Codes X Bank (T vs T-1)- 588,"What are the top error codes by bank for UPI transactions, showing today's failures compared to yesterday's failures and the failure growth rate?","SELECT error_code AS error_code, payer_bank AS payer_bank, sum(total_today_failures) AS ""Today Failure"", sum(total_yest_failures) AS ""Yday Failure"", sum(total_today_failures*1.000)
/
sum(total_yest_failures*1.000)
-1 AS ""Failure Growth"" 
FROM (WITH BankFailures AS (
SELECT 
error_code error_code,
payer_bank payer_bank,
count(txn_id) filter(where date(created_on)  = (current_date - interval '01' day)) n_yest_failures,
count(txn_id) filter(where date(created_on)  = (current_date )) n_today_failures
FROM
 (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
 where payer_handle in('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and error_code is Not null
group by 1,2
),
      TopBanks AS (
          SELECT payer_bank
          FROM (
              SELECT payer_bank,
                  ROW_NUMBER() OVER (ORDER BY SUM(n_today_failures) DESC, SUM(n_yest_failures) DESC) AS rn
              FROM BankFailures
              GROUP BY payer_bank
          ) ranked
          WHERE rn <= 5
      ),
      TopBankCodes AS (
          SELECT payer_bank, error_code
          FROM (
              SELECT payer_bank, error_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_bank ORDER BY n_today_failures DESC, n_yest_failures DESC) AS rn
              FROM BankFailures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_bank,
          tbc.error_code,
          SUM(bf.n_yest_failures) AS total_yest_failures,
          SUM(bf.n_today_failures) AS total_today_failures
      FROM BankFailures bf
      JOIN TopBanks tb ON bf.payer_bank = tb.payer_bank
      JOIN TopBankCodes tbc ON bf.payer_bank = tbc.payer_bank
          AND (bf.error_code = tbc.error_code OR (bf.error_code IS NULL AND tbc.error_code IS NULL))
      GROUP BY tbc.payer_bank, tbc.error_code
      ORDER BY total_today_failures DESC, total_yest_failures DESC
) AS virtual_table 
WHERE error_code IS NOT NULL GROUP BY error_code, payer_bank ORDER BY ""Today Failure"" DESC
LIMIT 50;

"
588,3229,Top Error Codes X Bank (T vs T-1)- 588,"What are the top error codes for bank 588 showing today's failures compared to yesterday's failures, and what is the growth rate in failure counts?","SELECT error_code AS error_code, payer_bank AS payer_bank, sum(total_today_failures) AS ""Today Failure"", sum(total_yest_failures) AS ""Yday Failure"", sum(total_today_failures*1.000)
/
sum(total_yest_failures*1.000)
-1 AS ""Failure Growth"" 
FROM (WITH BankFailures AS (
SELECT 
error_code error_code,
payer_bank payer_bank,
count(txn_id) filter(where date(created_on)  = (current_date - interval '01' day)) n_yest_failures,
count(txn_id) filter(where date(created_on)  = (current_date )) n_today_failures
FROM
 (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
 where payer_handle in('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and error_code is Not null
group by 1,2
),
      TopBanks AS (
          SELECT payer_bank
          FROM (
              SELECT payer_bank,
                  ROW_NUMBER() OVER (ORDER BY SUM(n_today_failures) DESC, SUM(n_yest_failures) DESC) AS rn
              FROM BankFailures
              GROUP BY payer_bank
          ) ranked
          WHERE rn <= 5
      ),
      TopBankCodes AS (
          SELECT payer_bank, error_code
          FROM (
              SELECT payer_bank, error_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_bank ORDER BY n_today_failures DESC, n_yest_failures DESC) AS rn
              FROM BankFailures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_bank,
          tbc.error_code,
          SUM(bf.n_yest_failures) AS total_yest_failures,
          SUM(bf.n_today_failures) AS total_today_failures
      FROM BankFailures bf
      JOIN TopBanks tb ON bf.payer_bank = tb.payer_bank
      JOIN TopBankCodes tbc ON bf.payer_bank = tbc.payer_bank
          AND (bf.error_code = tbc.error_code OR (bf.error_code IS NULL AND tbc.error_code IS NULL))
      GROUP BY tbc.payer_bank, tbc.error_code
      ORDER BY total_today_failures DESC, total_yest_failures DESC
) AS virtual_table 
WHERE error_code IS NOT NULL GROUP BY error_code, payer_bank ORDER BY ""Today Failure"" DESC
LIMIT 50;

"
588,3751,Top Error Codes X Payer Handle (T vs T-1) : Exc (U30-Z9 & U30-ZM)- 588,"What are the top error codes by payer handle showing the most failures today compared to yesterday, and what is the growth rate in failures for each combination?","SELECT error_code AS error_code, payer_handle AS payer_handle, sum(total_today_failures) AS ""Today's Failure"", sum(total_yest_failures) AS ""Yesterday's Failure"", case when sum(total_yest_failures)  = 0 then 0 else

(
sum(total_today_failures) *1.0000
)/
(
sum(total_yest_failures) *1.0000
)-1
end AS ""Growth"" 
FROM (WITH Payer_handle_Failures AS (
SELECT 
error_code error_code,
payer_handle payer_handle,
count(txn_id) filter(where date(created_on)  = (current_date - interval '01' day)) n_yest_failures,
count(txn_id) filter(where date(created_on)  = (current_date )) n_today_failures
FROM
 (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
 where payer_handle in('paytm','ptyes','ptaxis','pthdfc','ptsbi')
 and error_code is Not null
group by 1,2
),
      Top_Payer_handle AS (
          SELECT payer_handle
          FROM (
              SELECT payer_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(n_today_failures) DESC, SUM(n_yest_failures) DESC) AS rn
              FROM Payer_handle_Failures
              GROUP BY payer_handle
          ) ranked
          WHERE rn <= 5
      ),
      Top_Payer_handle_codes AS (
          SELECT payer_handle, error_code
          FROM (
              SELECT payer_handle, error_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_handle ORDER BY n_today_failures DESC, n_yest_failures DESC) AS rn
              FROM Payer_handle_Failures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_handle,
          tbc.error_code,
          SUM(bf.n_yest_failures) AS total_yest_failures,
          SUM(bf.n_today_failures) AS total_today_failures
      FROM Payer_handle_Failures bf
      JOIN Top_Payer_handle tb ON bf.payer_handle = tb.payer_handle
      JOIN Top_Payer_handle_codes tbc ON bf.payer_handle = tbc.payer_handle
          AND (bf.error_code = tbc.error_code OR (bf.error_code IS NULL AND tbc.error_code IS NULL))
      GROUP BY tbc.payer_handle, tbc.error_code
      ORDER BY total_today_failures DESC, total_yest_failures DESC
) AS virtual_table 
WHERE error_code IS NOT NULL GROUP BY error_code, payer_handle ORDER BY ""Today's Failure"" DESC
LIMIT 1000;

"
588,3751,Top Error Codes X Payer Handle (T vs T-1) : Exc (U30-Z9 & U30-ZM)- 588,"Which error codes and payer handles are showing the highest failure rates today compared to yesterday, and what is the growth rate of failures for each combination?","SELECT error_code AS error_code, payer_handle AS payer_handle, sum(total_today_failures) AS ""Today's Failure"", sum(total_yest_failures) AS ""Yesterday's Failure"", case when sum(total_yest_failures)  = 0 then 0 else

(
sum(total_today_failures) *1.0000
)/
(
sum(total_yest_failures) *1.0000
)-1
end AS ""Growth"" 
FROM (WITH Payer_handle_Failures AS (
SELECT 
error_code error_code,
payer_handle payer_handle,
count(txn_id) filter(where date(created_on)  = (current_date - interval '01' day)) n_yest_failures,
count(txn_id) filter(where date(created_on)  = (current_date )) n_today_failures
FROM
 (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
 where payer_handle in('paytm','ptyes','ptaxis','pthdfc','ptsbi')
 and error_code is Not null
group by 1,2
),
      Top_Payer_handle AS (
          SELECT payer_handle
          FROM (
              SELECT payer_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(n_today_failures) DESC, SUM(n_yest_failures) DESC) AS rn
              FROM Payer_handle_Failures
              GROUP BY payer_handle
          ) ranked
          WHERE rn <= 5
      ),
      Top_Payer_handle_codes AS (
          SELECT payer_handle, error_code
          FROM (
              SELECT payer_handle, error_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_handle ORDER BY n_today_failures DESC, n_yest_failures DESC) AS rn
              FROM Payer_handle_Failures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_handle,
          tbc.error_code,
          SUM(bf.n_yest_failures) AS total_yest_failures,
          SUM(bf.n_today_failures) AS total_today_failures
      FROM Payer_handle_Failures bf
      JOIN Top_Payer_handle tb ON bf.payer_handle = tb.payer_handle
      JOIN Top_Payer_handle_codes tbc ON bf.payer_handle = tbc.payer_handle
          AND (bf.error_code = tbc.error_code OR (bf.error_code IS NULL AND tbc.error_code IS NULL))
      GROUP BY tbc.payer_handle, tbc.error_code
      ORDER BY total_today_failures DESC, total_yest_failures DESC
) AS virtual_table 
WHERE error_code IS NOT NULL GROUP BY error_code, payer_handle ORDER BY ""Today's Failure"" DESC
LIMIT 1000;

"
588,3783,Top Error Codes X Payee Handle (T vs T-1): Exc (U30-Z9 & U30-ZM)- 588,"What are the top error codes by payee handle showing today's failures compared to yesterday's failures, and what is the failure growth rate for each combination?","SELECT error_code AS error_code, payee_handle AS payee_handle, sum(total_today_failures) AS ""Today Failure"", sum(total_yest_failures) AS ""Yday Failure"", sum(total_today_failures*1.0000)/
sum(total_yest_failures*1.0000)-1 AS ""Failure Growth"" 
FROM (WITH Payee_handle_Failures AS (
SELECT 
error_code error_code,
payee_handle payee_handle,
count(txn_id) filter(where date(created_on)  = (current_date - interval '01' day)) n_yest_failures,
count(txn_id) filter(where date(created_on)  = (current_date )) n_today_failures
FROM
 (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
 where payer_handle in('paytm','ptyes','ptaxis','pthdfc','ptsbi')
 and error_code not in('U30-Z9','U30-ZM')
group by 1,2
),
      Top_payee_handle AS (
          SELECT payee_handle
          FROM (
              SELECT payee_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(n_today_failures) DESC, SUM(n_yest_failures) DESC) AS rn
              FROM Payee_handle_Failures
              GROUP BY payee_handle
          ) ranked
          WHERE rn <= 5
      ),
      Top_payee_handle_code AS (
          SELECT payee_handle, error_code
          FROM (
              SELECT payee_handle, error_code,
                  ROW_NUMBER() OVER (PARTITION BY payee_handle ORDER BY n_today_failures DESC, n_yest_failures DESC) AS rn
              FROM Payee_handle_Failures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payee_handle,
          tbc.error_code,
          SUM(bf.n_yest_failures) AS total_yest_failures,
          SUM(bf.n_today_failures) AS total_today_failures
      FROM Payee_handle_Failures bf
      JOIN Top_payee_handle tb ON bf.payee_handle = tb.payee_handle
      JOIN Top_payee_handle_Code tbc ON bf.payee_handle = tbc.payee_handle
          AND (bf.error_code = tbc.error_code OR (bf.error_code IS NULL AND tbc.error_code IS NULL))
      GROUP BY tbc.payee_handle, tbc.error_code
      ORDER BY total_today_failures DESC, total_yest_failures DESC
) AS virtual_table 
WHERE error_code IS NOT NULL GROUP BY error_code, payee_handle ORDER BY ""Today Failure"" DESC
LIMIT 100;

"
588,3783,Top Error Codes X Payee Handle (T vs T-1): Exc (U30-Z9 & U30-ZM)- 588,"What are the top error codes by payee handle showing today's failures versus yesterday's failures, and what is the failure growth rate for each combination?","SELECT error_code AS error_code, payee_handle AS payee_handle, sum(total_today_failures) AS ""Today Failure"", sum(total_yest_failures) AS ""Yday Failure"", sum(total_today_failures*1.0000)/
sum(total_yest_failures*1.0000)-1 AS ""Failure Growth"" 
FROM (WITH Payee_handle_Failures AS (
SELECT 
error_code error_code,
payee_handle payee_handle,
count(txn_id) filter(where date(created_on)  = (current_date - interval '01' day)) n_yest_failures,
count(txn_id) filter(where date(created_on)  = (current_date )) n_today_failures
FROM
 (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
 where payer_handle in('paytm','ptyes','ptaxis','pthdfc','ptsbi')
 and error_code not in('U30-Z9','U30-ZM')
group by 1,2
),
      Top_payee_handle AS (
          SELECT payee_handle
          FROM (
              SELECT payee_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(n_today_failures) DESC, SUM(n_yest_failures) DESC) AS rn
              FROM Payee_handle_Failures
              GROUP BY payee_handle
          ) ranked
          WHERE rn <= 5
      ),
      Top_payee_handle_code AS (
          SELECT payee_handle, error_code
          FROM (
              SELECT payee_handle, error_code,
                  ROW_NUMBER() OVER (PARTITION BY payee_handle ORDER BY n_today_failures DESC, n_yest_failures DESC) AS rn
              FROM Payee_handle_Failures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payee_handle,
          tbc.error_code,
          SUM(bf.n_yest_failures) AS total_yest_failures,
          SUM(bf.n_today_failures) AS total_today_failures
      FROM Payee_handle_Failures bf
      JOIN Top_payee_handle tb ON bf.payee_handle = tb.payee_handle
      JOIN Top_payee_handle_Code tbc ON bf.payee_handle = tbc.payee_handle
          AND (bf.error_code = tbc.error_code OR (bf.error_code IS NULL AND tbc.error_code IS NULL))
      GROUP BY tbc.payee_handle, tbc.error_code
      ORDER BY total_today_failures DESC, total_yest_failures DESC
) AS virtual_table 
WHERE error_code IS NOT NULL GROUP BY error_code, payee_handle ORDER BY ""Today Failure"" DESC
LIMIT 100;

"
588,3852,UPI SR Monitoring(T & T-1) Top 10 Remiter Bank,What are the UPI transaction success rates for the top 10 remitter banks for today and yesterday?,"SELECT payer_bank AS payer_bank, dt AS dt, (sum(Success_txns)*1.0000)/
(SUM(total_Txn)*1.00000) AS ""SR"" 
FROM (with A as(
SELECT  created_on created_on, status status,payer_bank payer_bank, count(txn_id) txns
FROM
(
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
group by status,payer_bank, created_on 
) 

SELECT date(created_on) dt,
payer_bank,
sum(txns) total_Txn,
sum(txns) filter(where status in('SUCCESS','DEEMED')) Success_txns,
sum(txns) filter(where status in('FAILURE')) Failed_txns,
sum(txns) filter(where status in('PENDING')) Pending_txns
from A
where payer_bank in (
SELECT payer_bank payer_bank
FROM
(
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
group by payer_bank
order by count(txn_id) desc
LIMIT 10
)
GROUP by 1,2
) AS virtual_table GROUP BY payer_bank, dt ORDER BY sum(""total_Txn"") DESC
LIMIT 1000;

"
588,3852,UPI SR Monitoring(T & T-1) Top 10 Remiter Bank,What are the top 10 payer banks with the highest UPI transaction success rates for today and yesterday?,"SELECT payer_bank AS payer_bank, dt AS dt, (sum(Success_txns)*1.0000)/
(SUM(total_Txn)*1.00000) AS ""SR"" 
FROM (with A as(
SELECT  created_on created_on, status status,payer_bank payer_bank, count(txn_id) txns
FROM
(
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
group by status,payer_bank, created_on 
) 

SELECT date(created_on) dt,
payer_bank,
sum(txns) total_Txn,
sum(txns) filter(where status in('SUCCESS','DEEMED')) Success_txns,
sum(txns) filter(where status in('FAILURE')) Failed_txns,
sum(txns) filter(where status in('PENDING')) Pending_txns
from A
where payer_bank in (
SELECT payer_bank payer_bank
FROM
(
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
group by payer_bank
order by count(txn_id) desc
LIMIT 10
)
GROUP by 1,2
) AS virtual_table GROUP BY payer_bank, dt ORDER BY sum(""total_Txn"") DESC
LIMIT 1000;

"
588,3935,Top Error Codes (T-1 vs L7D Avg),"What are the top error codes causing UPI transaction failures yesterday compared to the last 7-day average, and how much did each error code change?","SELECT npci_resp_code AS npci_resp_code, COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday') AS ""Yesterday's Failure"", COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')/7 AS ""Last7day Failure"", (
COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday')*1.0000
)
/(

COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')*1.0000/7
)-1 AS ""Change Yday vs last 7 day avg"" 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table 
WHERE status = 'FAILURE' GROUP BY npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 20;

"
588,3935,Top Error Codes (T-1 vs L7D Avg),"What are the top error codes causing UPI transaction failures, and how do yesterday's failure counts compare to the 7-day average for each error code?","SELECT npci_resp_code AS npci_resp_code, COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday') AS ""Yesterday's Failure"", COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')/7 AS ""Last7day Failure"", (
COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday')*1.0000
)
/(

COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')*1.0000/7
)-1 AS ""Change Yday vs last 7 day avg"" 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table 
WHERE status = 'FAILURE' GROUP BY npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 20;

"
588,3940,Top 5 Error Code & Bank (T-1 vs L7D),"What are the top 5 error codes and banks with the highest failure rates yesterday compared to the last 7-day average, and how much did they change?","SELECT payer_bank_name AS payer_bank_name, npci_resp_code AS npci_resp_code, sum(total_yest_failures) AS ""Yesterday's Failure"", sum(""total_L7D_failures"") AS ""Last 7 Day avg"", (sum(total_yest_failures*1.0000)/sum(total_L7D_failures*1.000) -1)  AS ""% Change(Yest vs L7D Avg)"" 
FROM (WITH BankFailures AS (
       SELECT
              payer_bank_name payer_bank_name,
              npci_resp_code as npci_resp_code,
            
              count(distinct case when date(created_on) = DATE_ADD('day', -1, CURRENT_DATE) then txn_id end) as yest_failures,
              count(distinct case when date(created_on) between DATE_ADD('day', -8, CURRENT_DATE) and DATE_ADD('day', -2, CURRENT_DATE) then txn_id end)/7 as Last_7D_AVG_failures
              from (
SELECT ""final_Category"" AS ""final_Category"", payer_handle AS payer_handle, period AS period, ""success_Txns"" AS ""success_Txns"", payer_cust_id AS payer_cust_id, created_on AS created_on, dt AS dt, txn_id AS txn_id, amount AS amount, npci_resp_code AS npci_resp_code, status AS status, flow_category AS flow_category, payer_account_type AS payer_account_type, payer_bank_name AS payer_bank_name, payee_bank_name AS payee_bank_name, payee_handle AS payee_handle 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table
) AS dataset_1700 
             where  lower(status) in('failure')
             and npci_resp_code is not null
          GROUP BY 1, 2
      ),
      TopBanks AS (
          SELECT payer_bank_name
          FROM (
              SELECT payer_bank_name,
                  ROW_NUMBER() OVER (ORDER BY SUM(yest_failures) DESC, SUM(Last_7D_AVG_failures) DESC) AS rn
              FROM BankFailures
              GROUP BY payer_bank_name
          ) ranked
          WHERE rn <= 5
      ),
      TopBankCodes AS (
          SELECT payer_bank_name, npci_resp_code
          FROM (
              SELECT payer_bank_name, npci_resp_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_bank_name ORDER BY yest_failures DESC, Last_7D_AVG_failures DESC) AS rn
              FROM BankFailures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_bank_name,
          tbc.npci_resp_code,
          SUM(bf.Last_7D_AVG_failures) AS total_L7D_failures,
          SUM(bf.yest_failures) AS total_yest_failures
      FROM BankFailures bf
      JOIN TopBanks tb ON bf.payer_bank_name = tb.payer_bank_name
      JOIN TopBankCodes tbc ON bf.payer_bank_name = tbc.payer_bank_name
          AND (bf.npci_resp_code = tbc.npci_resp_code OR (bf.npci_resp_code IS NULL AND tbc.npci_resp_code IS NULL))
      GROUP BY tbc.payer_bank_name, tbc.npci_resp_code
      ORDER BY total_yest_failures DESC, total_L7D_failures DESC
) AS virtual_table GROUP BY payer_bank_name, npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 1000;

"
588,3940,Top 5 Error Code & Bank (T-1 vs L7D),"What are the top 5 combinations of banks and error codes that had the most failures yesterday, and how do those failure rates compare to the last 7-day average?","SELECT payer_bank_name AS payer_bank_name, npci_resp_code AS npci_resp_code, sum(total_yest_failures) AS ""Yesterday's Failure"", sum(""total_L7D_failures"") AS ""Last 7 Day avg"", (sum(total_yest_failures*1.0000)/sum(total_L7D_failures*1.000) -1)  AS ""% Change(Yest vs L7D Avg)"" 
FROM (WITH BankFailures AS (
       SELECT
              payer_bank_name payer_bank_name,
              npci_resp_code as npci_resp_code,
            
              count(distinct case when date(created_on) = DATE_ADD('day', -1, CURRENT_DATE) then txn_id end) as yest_failures,
              count(distinct case when date(created_on) between DATE_ADD('day', -8, CURRENT_DATE) and DATE_ADD('day', -2, CURRENT_DATE) then txn_id end)/7 as Last_7D_AVG_failures
              from (
SELECT ""final_Category"" AS ""final_Category"", payer_handle AS payer_handle, period AS period, ""success_Txns"" AS ""success_Txns"", payer_cust_id AS payer_cust_id, created_on AS created_on, dt AS dt, txn_id AS txn_id, amount AS amount, npci_resp_code AS npci_resp_code, status AS status, flow_category AS flow_category, payer_account_type AS payer_account_type, payer_bank_name AS payer_bank_name, payee_bank_name AS payee_bank_name, payee_handle AS payee_handle 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table
) AS dataset_1700 
             where  lower(status) in('failure')
             and npci_resp_code is not null
          GROUP BY 1, 2
      ),
      TopBanks AS (
          SELECT payer_bank_name
          FROM (
              SELECT payer_bank_name,
                  ROW_NUMBER() OVER (ORDER BY SUM(yest_failures) DESC, SUM(Last_7D_AVG_failures) DESC) AS rn
              FROM BankFailures
              GROUP BY payer_bank_name
          ) ranked
          WHERE rn <= 5
      ),
      TopBankCodes AS (
          SELECT payer_bank_name, npci_resp_code
          FROM (
              SELECT payer_bank_name, npci_resp_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_bank_name ORDER BY yest_failures DESC, Last_7D_AVG_failures DESC) AS rn
              FROM BankFailures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_bank_name,
          tbc.npci_resp_code,
          SUM(bf.Last_7D_AVG_failures) AS total_L7D_failures,
          SUM(bf.yest_failures) AS total_yest_failures
      FROM BankFailures bf
      JOIN TopBanks tb ON bf.payer_bank_name = tb.payer_bank_name
      JOIN TopBankCodes tbc ON bf.payer_bank_name = tbc.payer_bank_name
          AND (bf.npci_resp_code = tbc.npci_resp_code OR (bf.npci_resp_code IS NULL AND tbc.npci_resp_code IS NULL))
      GROUP BY tbc.payer_bank_name, tbc.npci_resp_code
      ORDER BY total_yest_failures DESC, total_L7D_failures DESC
) AS virtual_table GROUP BY payer_bank_name, npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 1000;

"
588,3980,Top 5 Error Code & Payer Handle (T-1 vs L7D Avg) : Exc (U30-Z9 & U30-ZM),"Which payer handles and error codes had the most failures yesterday compared to their 7-day average, and what was the percentage change?","SELECT payer_handle AS payer_handle, npci_resp_code AS npci_resp_code, sum(total_yest_failures) AS ""Yesterday's Failure"", sum(""total_L7D_failures"") AS ""Last 7 Day avg"", (sum(total_yest_failures*1.0000)/sum(total_L7D_failures*1.000) -1)  AS ""% Change(Yest vs L7D Avg)"" 
FROM (WITH BankFailures AS (
          SELECT
              payer_handle payer_handle,
              npci_resp_code as npci_resp_code,
              count(distinct case when date(created_on) = DATE_ADD('day', -1, CURRENT_DATE) then txn_id end) as yest_failures,
              count(distinct case when date(created_on) between DATE_ADD('day', -8, CURRENT_DATE) and DATE_ADD('day', -2, CURRENT_DATE) then txn_id end)/7 as Last_7D_AVG_failures
              from (
SELECT ""final_Category"" AS ""final_Category"", payer_handle AS payer_handle, period AS period, ""success_Txns"" AS ""success_Txns"", payer_cust_id AS payer_cust_id, created_on AS created_on, dt AS dt, txn_id AS txn_id, amount AS amount, npci_resp_code AS npci_resp_code, status AS status, flow_category AS flow_category, payer_account_type AS payer_account_type, payer_bank_name AS payer_bank_name, payee_bank_name AS payee_bank_name, payee_handle AS payee_handle 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table
) AS dataset_1700 
             where  lower(status) in('failure')
             and npci_resp_code is not null
             and upper(npci_resp_code) not in('U30-Z9','U30-ZM')
          GROUP BY 1, 2
          
      ),
      TopBanks AS (
          SELECT payer_handle
          FROM (
              SELECT payer_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(yest_failures) DESC, SUM(Last_7D_AVG_failures) DESC) AS rn
              FROM BankFailures
              GROUP BY payer_handle
          ) ranked
          WHERE rn <= 5
      ),
      TopBankCodes AS (
          SELECT payer_handle, npci_resp_code
          FROM (
              SELECT payer_handle, npci_resp_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_handle ORDER BY yest_failures DESC, Last_7D_AVG_failures DESC) AS rn
              FROM BankFailures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_handle,
          tbc.npci_resp_code,
          SUM(bf.Last_7D_AVG_failures) AS total_L7D_failures,
          SUM(bf.yest_failures) AS total_yest_failures
      FROM BankFailures bf
      JOIN TopBanks tb ON bf.payer_handle = tb.payer_handle
      JOIN TopBankCodes tbc ON bf.payer_handle = tbc.payer_handle
          AND (bf.npci_resp_code = tbc.npci_resp_code OR (bf.npci_resp_code IS NULL AND tbc.npci_resp_code IS NULL))
      GROUP BY tbc.payer_handle, tbc.npci_resp_code
      ORDER BY total_yest_failures DESC, total_L7D_failures DESC
) AS virtual_table GROUP BY payer_handle, npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 1000;

"
588,3980,Top 5 Error Code & Payer Handle (T-1 vs L7D Avg) : Exc (U30-Z9 & U30-ZM),"What are the top 5 combinations of error codes and payer handles that had the most failures yesterday compared to the last 7-day average, and how much did they change percentage-wise?","SELECT payer_handle AS payer_handle, npci_resp_code AS npci_resp_code, sum(total_yest_failures) AS ""Yesterday's Failure"", sum(""total_L7D_failures"") AS ""Last 7 Day avg"", (sum(total_yest_failures*1.0000)/sum(total_L7D_failures*1.000) -1)  AS ""% Change(Yest vs L7D Avg)"" 
FROM (WITH BankFailures AS (
          SELECT
              payer_handle payer_handle,
              npci_resp_code as npci_resp_code,
              count(distinct case when date(created_on) = DATE_ADD('day', -1, CURRENT_DATE) then txn_id end) as yest_failures,
              count(distinct case when date(created_on) between DATE_ADD('day', -8, CURRENT_DATE) and DATE_ADD('day', -2, CURRENT_DATE) then txn_id end)/7 as Last_7D_AVG_failures
              from (
SELECT ""final_Category"" AS ""final_Category"", payer_handle AS payer_handle, period AS period, ""success_Txns"" AS ""success_Txns"", payer_cust_id AS payer_cust_id, created_on AS created_on, dt AS dt, txn_id AS txn_id, amount AS amount, npci_resp_code AS npci_resp_code, status AS status, flow_category AS flow_category, payer_account_type AS payer_account_type, payer_bank_name AS payer_bank_name, payee_bank_name AS payee_bank_name, payee_handle AS payee_handle 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table
) AS dataset_1700 
             where  lower(status) in('failure')
             and npci_resp_code is not null
             and upper(npci_resp_code) not in('U30-Z9','U30-ZM')
          GROUP BY 1, 2
          
      ),
      TopBanks AS (
          SELECT payer_handle
          FROM (
              SELECT payer_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(yest_failures) DESC, SUM(Last_7D_AVG_failures) DESC) AS rn
              FROM BankFailures
              GROUP BY payer_handle
          ) ranked
          WHERE rn <= 5
      ),
      TopBankCodes AS (
          SELECT payer_handle, npci_resp_code
          FROM (
              SELECT payer_handle, npci_resp_code,
                  ROW_NUMBER() OVER (PARTITION BY payer_handle ORDER BY yest_failures DESC, Last_7D_AVG_failures DESC) AS rn
              FROM BankFailures
          ) ranked
          WHERE rn <= 5
      )
      SELECT
          tbc.payer_handle,
          tbc.npci_resp_code,
          SUM(bf.Last_7D_AVG_failures) AS total_L7D_failures,
          SUM(bf.yest_failures) AS total_yest_failures
      FROM BankFailures bf
      JOIN TopBanks tb ON bf.payer_handle = tb.payer_handle
      JOIN TopBankCodes tbc ON bf.payer_handle = tbc.payer_handle
          AND (bf.npci_resp_code = tbc.npci_resp_code OR (bf.npci_resp_code IS NULL AND tbc.npci_resp_code IS NULL))
      GROUP BY tbc.payer_handle, tbc.npci_resp_code
      ORDER BY total_yest_failures DESC, total_L7D_failures DESC
) AS virtual_table GROUP BY payer_handle, npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 1000;

"
588,3987,Top 5 Error Code & Payee Handle (T-1 vs L7D Avg) : Exc (U30-Z9 & U30-ZM),"What are the top 5 payee handles and error codes with the most UPI transaction failures yesterday, and how do these failure counts compare to the 7-day average?","SELECT payee_handle AS payee_handle, npci_resp_code AS npci_resp_code, sum(total_yest_failures) AS ""Yesterday's Failure"", sum(""total_L7D_failures"") AS ""Last 7 Day avg"", (sum(total_yest_failures*1.0000)/sum(total_L7D_failures*1.000) -1) *100 AS ""% Change(Yest vs L7D Avg)"" 
FROM (WITH payee_handle_Failures AS (
          SELECT
              payee_handle payee_handle,
              npci_resp_code as npci_resp_code,
              count(distinct case when date(created_on) = DATE_ADD('day', -1, CURRENT_DATE) then txn_id end) as yest_failures,
              count(distinct case when date(created_on) between DATE_ADD('day', -8, CURRENT_DATE) and DATE_ADD('day', -2, CURRENT_DATE) then txn_id end)/7 as Last_7D_AVG_failures
              from (
SELECT ""final_Category"" AS ""final_Category"", payer_handle AS payer_handle, period AS period, ""success_Txns"" AS ""success_Txns"", payer_cust_id AS payer_cust_id, created_on AS created_on, dt AS dt, txn_id AS txn_id, amount AS amount, npci_resp_code AS npci_resp_code, status AS status, flow_category AS flow_category, payer_account_type AS payer_account_type, payer_bank_name AS payer_bank_name, payee_bank_name AS payee_bank_name, payee_handle AS payee_handle 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table
) AS dataset_1700 
             where  lower(status) in('failure')
             and npci_resp_code is not null
             and upper(npci_resp_code) not in('U30-Z9','U30-ZM')
          GROUP BY 1, 2
          
      ),
      TopBanks AS (
          SELECT payee_handle
          FROM (
              SELECT payee_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(yest_failures) DESC, SUM(Last_7D_AVG_failures) DESC) AS rn
              FROM payee_handle_Failures where payee_handle is not null
              GROUP BY payee_handle
          ) ranked
          WHERE rn <= 5
      )
      
      ,
      TopBankCodes AS (
          SELECT payee_handle, npci_resp_code
          FROM (
              SELECT payee_handle, npci_resp_code,
                  ROW_NUMBER() OVER (PARTITION BY payee_handle ORDER BY yest_failures DESC, Last_7D_AVG_failures DESC) AS rn
              FROM payee_handle_Failures where payee_handle is not null
              and payee_handle in( SELECT payee_handle from TopBanks)
          ) ranked
          WHERE rn <= 5
      )
      
      SELECT
          tbc.payee_handle,
          tbc.npci_resp_code,
          SUM(bf.Last_7D_AVG_failures) AS total_L7D_failures,
          SUM(bf.yest_failures) AS total_yest_failures
      FROM payee_handle_Failures bf
      JOIN TopBanks tb ON bf.payee_handle = tb.payee_handle
      JOIN TopBankCodes tbc ON bf.payee_handle = tbc.payee_handle
          AND (bf.npci_resp_code = tbc.npci_resp_code OR (bf.npci_resp_code IS NULL AND tbc.npci_resp_code IS NULL))
      GROUP BY tbc.payee_handle, tbc.npci_resp_code
      ORDER BY total_yest_failures DESC, total_L7D_failures DESC
) AS virtual_table GROUP BY payee_handle, npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 1000;

"
588,3987,Top 5 Error Code & Payee Handle (T-1 vs L7D Avg) : Exc (U30-Z9 & U30-ZM),"What are the top 5 combinations of error codes and payee handles that had the highest failure rates yesterday compared to the last 7-day average, specifically for error codes in the U30-Z9 and U30-ZM ranges?","SELECT payee_handle AS payee_handle, npci_resp_code AS npci_resp_code, sum(total_yest_failures) AS ""Yesterday's Failure"", sum(""total_L7D_failures"") AS ""Last 7 Day avg"", (sum(total_yest_failures*1.0000)/sum(total_L7D_failures*1.000) -1) *100 AS ""% Change(Yest vs L7D Avg)"" 
FROM (WITH payee_handle_Failures AS (
          SELECT
              payee_handle payee_handle,
              npci_resp_code as npci_resp_code,
              count(distinct case when date(created_on) = DATE_ADD('day', -1, CURRENT_DATE) then txn_id end) as yest_failures,
              count(distinct case when date(created_on) between DATE_ADD('day', -8, CURRENT_DATE) and DATE_ADD('day', -2, CURRENT_DATE) then txn_id end)/7 as Last_7D_AVG_failures
              from (
SELECT ""final_Category"" AS ""final_Category"", payer_handle AS payer_handle, period AS period, ""success_Txns"" AS ""success_Txns"", payer_cust_id AS payer_cust_id, created_on AS created_on, dt AS dt, txn_id AS txn_id, amount AS amount, npci_resp_code AS npci_resp_code, status AS status, flow_category AS flow_category, payer_account_type AS payer_account_type, payer_bank_name AS payer_bank_name, payee_bank_name AS payee_bank_name, payee_handle AS payee_handle 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table
) AS dataset_1700 
             where  lower(status) in('failure')
             and npci_resp_code is not null
             and upper(npci_resp_code) not in('U30-Z9','U30-ZM')
          GROUP BY 1, 2
          
      ),
      TopBanks AS (
          SELECT payee_handle
          FROM (
              SELECT payee_handle,
                  ROW_NUMBER() OVER (ORDER BY SUM(yest_failures) DESC, SUM(Last_7D_AVG_failures) DESC) AS rn
              FROM payee_handle_Failures where payee_handle is not null
              GROUP BY payee_handle
          ) ranked
          WHERE rn <= 5
      )
      
      ,
      TopBankCodes AS (
          SELECT payee_handle, npci_resp_code
          FROM (
              SELECT payee_handle, npci_resp_code,
                  ROW_NUMBER() OVER (PARTITION BY payee_handle ORDER BY yest_failures DESC, Last_7D_AVG_failures DESC) AS rn
              FROM payee_handle_Failures where payee_handle is not null
              and payee_handle in( SELECT payee_handle from TopBanks)
          ) ranked
          WHERE rn <= 5
      )
      
      SELECT
          tbc.payee_handle,
          tbc.npci_resp_code,
          SUM(bf.Last_7D_AVG_failures) AS total_L7D_failures,
          SUM(bf.yest_failures) AS total_yest_failures
      FROM payee_handle_Failures bf
      JOIN TopBanks tb ON bf.payee_handle = tb.payee_handle
      JOIN TopBankCodes tbc ON bf.payee_handle = tbc.payee_handle
          AND (bf.npci_resp_code = tbc.npci_resp_code OR (bf.npci_resp_code IS NULL AND tbc.npci_resp_code IS NULL))
      GROUP BY tbc.payee_handle, tbc.npci_resp_code
      ORDER BY total_yest_failures DESC, total_L7D_failures DESC
) AS virtual_table GROUP BY payee_handle, npci_resp_code ORDER BY ""Yesterday's Failure"" DESC
LIMIT 1000;

"
588,3988,All Bank (T-1 vs L7D),Which banks had the highest UPI transaction failures yesterday and how do those failure rates compare to their average performance over the last 7 days?,"SELECT payer_bank_name AS payer_bank_name, COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday') AS ""Yesterday's Failure"", COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')/7 AS ""Last7day Failure"", (
COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday')*1.0000
)
/(

COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')*1.0000/7
)-1 AS ""Change Yday vs last 7 day avg"" 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table 
WHERE status = 'FAILURE' GROUP BY payer_bank_name ORDER BY ""Yesterday's Failure"" DESC
LIMIT 20;

"
588,3988,All Bank (T-1 vs L7D),Which banks had the most UPI transaction failures yesterday and how do those failure counts compare to their average daily failures over the last 7 days?,"SELECT payer_bank_name AS payer_bank_name, COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday') AS ""Yesterday's Failure"", COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')/7 AS ""Last7day Failure"", (
COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday')*1.0000
)
/(

COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')*1.0000/7
)-1 AS ""Change Yday vs last 7 day avg"" 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table 
WHERE status = 'FAILURE' GROUP BY payer_bank_name ORDER BY ""Yesterday's Failure"" DESC
LIMIT 20;

"
588,3989,Error Code & Bank All Data (T-1 vs L7D Avg),"What are the most common UPI failure error codes and banks from yesterday compared to the last 7-day average, and how much did the failure rates change?","SELECT npci_resp_code AS npci_resp_code, payer_bank_name AS payer_bank_name, COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday') AS ""Yesterday's Failure"", COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')/7 AS ""Last7day Failure"", (
COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday')*1.0000
)
/(

COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')*1.0000/7
)-1 AS ""Change Yday vs last 7 day avg"" 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table 
WHERE status = 'FAILURE' GROUP BY npci_resp_code, payer_bank_name ORDER BY ""Yesterday's Failure"" DESC
LIMIT 100;

"
588,3989,Error Code & Bank All Data (T-1 vs L7D Avg),"What are the UPI transaction failure counts by error code and payer bank for yesterday compared to the last 7-day average, and which combinations show the highest failure volumes or unusual changes?","SELECT npci_resp_code AS npci_resp_code, payer_bank_name AS payer_bank_name, COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday') AS ""Yesterday's Failure"", COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')/7 AS ""Last7day Failure"", (
COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'Yday')*1.0000
)
/(

COUNT(txn_id) filter(WHERE status = 'FAILURE' and period = 'last7day')*1.0000/7
)-1 AS ""Change Yday vs last 7 day avg"" 
FROM (select 
txn_timestamp created_on
,date(txn_timestamp) dt
,txn_id
,amount
,coalesce(npci_resp_code,app_resp_code) npci_resp_code
,status
,flow_category
,payer_handle
,customer_id_payer payer_cust_id
,payer_account_type payer_account_type
,payer_bank_name
,payee_bank_name
,payee_handle
,CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_Category
,case
when date(txn_timestamp) = (current_date - interval '01' day) then 'Yday'
when date(txn_timestamp) between (current_date - interval '08' day) and (current_date - interval '02' day) then 'last7day'
end as period
,case when status ='SUCCESS' then txn_id end as success_Txns

FROM   hive.cdo.fact_upi_transactions_snapshot_v3
WHERE dl_last_updated >= (current_date - interval '08' day)
  AND transaction_date_key   >= (current_date - interval '08' day)
  AND transaction_type IN ('PAY','COLLECT')
  AND lower(payer_handle) IN ('paytm','ptyes','ptaxis','pthdfc','ptsbi')
  and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
  and purpose_code !='14'
) AS virtual_table 
WHERE status = 'FAILURE' GROUP BY npci_resp_code, payer_bank_name ORDER BY ""Yesterday's Failure"" DESC
LIMIT 100;

"
588,3990,Hourly SR Trend By Category (T vs T-1)- 588,"What is the hourly success rate trend for different UPI transaction categories, comparing today versus yesterday?","SELECT date_trunc('hour',created_on) AS ""Time_"", ""final_Category"" AS ""final_Category"", (COUNT(txn_id) filter(WHERE status = 'SUCCESS')*1.0000) / (COUNT(txn_id)*1.0000) AS ""SR"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE dt >= DATE '2025-11-30' AND dt < DATE '2025-12-01' AND flow_cat != 'Other P2M' GROUP BY date_trunc('hour',created_on), ""final_Category"" ORDER BY ""SR"" DESC
LIMIT 10000;

"
588,3990,Hourly SR Trend By Category (T vs T-1)- 588,"What are the hourly success rates for different UPI transaction categories, and how do they compare between today and yesterday?","SELECT date_trunc('hour',created_on) AS ""Time_"", ""final_Category"" AS ""final_Category"", (COUNT(txn_id) filter(WHERE status = 'SUCCESS')*1.0000) / (COUNT(txn_id)*1.0000) AS ""SR"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE dt >= DATE '2025-11-30' AND dt < DATE '2025-12-01' AND flow_cat != 'Other P2M' GROUP BY date_trunc('hour',created_on), ""final_Category"" ORDER BY ""SR"" DESC
LIMIT 10000;

"
588,3992,Paytm to Competition Overall SR (T & T-1),"How is Paytm's UPI transaction success rate performing compared to competitors, and what is the day-over-day change in success rate by hour and payee?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payee_ AS payee_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payee_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ = 'Paytm' GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payee_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3992,Paytm to Competition Overall SR (T & T-1),"What is Paytm's UPI transaction success rate compared to competitors for today versus yesterday, and how has the success rate changed hour by hour?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payee_ AS payee_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payee_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ = 'Paytm' GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payee_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3995,Paytm to Competition P2P SR (T & T-1),"What is Paytm's peer-to-peer payment success rate compared to competitors, and how has it changed from yesterday to today by hour and recipient?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payee_ AS payee_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payee_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ = 'Paytm' AND category IN ('VPA2VPA', 'VPA2ACCOUNT') GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payee_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3995,Paytm to Competition P2P SR (T & T-1),"How is Paytm's peer-to-peer payment success rate performing compared to competitors today versus yesterday, broken down by hour and recipient?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payee_ AS payee_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payee_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ = 'Paytm' AND category IN ('VPA2VPA', 'VPA2ACCOUNT') GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payee_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3996,Competition to Paytm P2P SR (T & T-1),"How are Paytm's competitors performing in terms of UPI peer-to-peer transaction success rates compared to the previous day, broken down by hour and payment provider?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payer_ AS payer_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payer_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ != 'Paytm' AND category IN ('VPA2VPA', 'VPA2ACCOUNT') GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payer_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3996,Competition to Paytm P2P SR (T & T-1),"How are our competitors performing in UPI peer-to-peer transaction success rates compared to today and yesterday, broken down by hour and payment provider?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payer_ AS payer_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payer_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ != 'Paytm' AND category IN ('VPA2VPA', 'VPA2ACCOUNT') GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payer_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3997,Paytm to Competition QR SR (T & T-1),"What is Paytm's QR code transaction success rate compared to competitors, and how has it changed from the previous period?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payee_ AS payee_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payee_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ = 'Paytm' AND ""QR_FLAG"" IN ('3P QR', 'Paytm QR') GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payee_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3997,Paytm to Competition QR SR (T & T-1),"What is the success rate of Paytm QR payments to different merchants/competitors, and how has this success rate changed compared to yesterday?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payee_ AS payee_, sum(txns) AS ""Total Txn"", sum(txns)filter(where status in('SUCCESS','DEEMED')) AS ""Success Txns"", ((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100 AS ""SR"", (((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100)
-
(
lag(
((
sum(txns)filter(where status in('SUCCESS','DEEMED'))*1.0000
)/(
sum(txns)*1.0000)
)*100
) over(
partition by hr, payee_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      mandate_flag,
      category,
      status,
      resp_code,
      QR_FLAG,
      payee_,
      payer_,
      response_constant,
      coalesce(txns,0) as txns
      from user_paytm_payments.T_vs_T1_Paytm_N_Competition_SR
) AS virtual_table 
WHERE payer_ = 'Paytm' AND ""QR_FLAG"" IN ('3P QR', 'Paytm QR') GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payee_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3998,Competition to Paytm QR SR (T & T-1),"What is Paytm's UPI transaction success rate performance by hour compared to the previous day, including total transactions, successful transactions, and the percentage change in success rate?","SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payer_ AS payer_, sum(""Overall_txn"") AS ""Total Txn"", sum(success) AS ""Success Txns"", (
sum(success) *1.0000
)/(
sum(Overall_txn)*1.0000)
*100 AS ""SR"", ((
sum(success) *1.0000
)/(
sum(Overall_txn)*1.0000)
*100)
-
(
lag(
(
sum(success) *1.0000
)/(
sum(Overall_txn)*1.0000)
*100
) over(
partition by hr, payer_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      payer_,
      Overall_txn,
      success
      from 
 user_paytm_payments.t1_vs_t2_competition_to_paytm_sr
) AS virtual_table 
WHERE payer_ = 'Paytm' GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payer_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,3998,Competition to Paytm QR SR (T & T-1),What is Paytm's UPI transaction success rate by hour and how has it changed compared to the previous day?,"SELECT date_trunc('day', CAST(dt AS TIMESTAMP)) AS dt, hr AS hr, payer_ AS payer_, sum(""Overall_txn"") AS ""Total Txn"", sum(success) AS ""Success Txns"", (
sum(success) *1.0000
)/(
sum(Overall_txn)*1.0000)
*100 AS ""SR"", ((
sum(success) *1.0000
)/(
sum(Overall_txn)*1.0000)
*100)
-
(
lag(
(
sum(success) *1.0000
)/(
sum(Overall_txn)*1.0000)
*100
) over(
partition by hr, payer_ order by date_trunc('day', CAST(dt AS TIMESTAMP))
)
) AS ""% Change SR"" 
FROM (select
      dt,
      hr,
      payer_,
      Overall_txn,
      success
      from 
 user_paytm_payments.t1_vs_t2_competition_to_paytm_sr
) AS virtual_table 
WHERE payer_ = 'Paytm' GROUP BY date_trunc('day', CAST(dt AS TIMESTAMP)), hr, payer_ ORDER BY ""Total Txn"" DESC
LIMIT 10000;

"
588,4001,Last Hour SR Overall Alert,"What is the UPI transaction success rate for the last hour compared to the historical average, and how much does it differ from the benchmark?","SELECT hour AS hour, sr_current AS sr_current, sr_avg AS sr_avg, sr_difference AS sr_difference 
FROM (WITH current_sr AS (
        SELECT
          HOUR(CAST(txn_timestamp AS TIMESTAMP)) AS hour,
          CAST(COUNT(DISTINCT CASE WHEN LOWER(status) IN ('success','deemed') THEN txn_id END) AS DOUBLE) /
          CAST(COUNT(DISTINCT txn_id) AS DOUBLE) AS sr_current
        FROM hive.upi_txn.upi_activities_data_snapshot_v3
        WHERE type IN ('COLLECT','PAY')
          AND TRY(LOWER(SPLIT(payer_vpa, '@')[2])) IN ('paytm','ptsbi','ptaxis','pthdfc','ptyes')
          AND category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
          AND dl_last_updated >= DATE_ADD('day', -1, CURRENT_DATE)
          AND (
          --  Normal case: Only include today's transactions
          (HOUR(CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Kolkata') > 0
           AND DATE(cast(txn_timestamp as timestamp)) = CURRENT_DATE)

          --  Special case for 12 AM: Include 11 PM transactions from yesterday
          OR (HOUR(CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Kolkata') = 0
              AND DATE(cast(txn_timestamp as timestamp)) = DATE_ADD('day', -1, CURRENT_DATE))
      )
          AND HOUR(CAST(txn_timestamp AS TIMESTAMP)) =
              CASE
                  WHEN HOUR(CAST(DATE_FORMAT(current_timestamp AT TIME ZONE 'Asia/Kolkata',
                  '%Y-%m-%d %H:%i:%s.%f Asia/Calcutta') AS TIMESTAMP)) = 0
                  THEN 23
                  ELSE HOUR(CAST(DATE_FORMAT(current_timestamp AT TIME ZONE 'Asia/Kolkata',
                  '%Y-%m-%d %H:%i:%s.%f Asia/Calcutta') AS TIMESTAMP)) - 1
              END
          AND participant_type = 'PAYER'
          AND (LOWER(businesstype) <> 'mandate' OR businesstype IS NULL)
        GROUP BY 1
      )


      SELECT
        cs.hour,
        cs.sr_current,
        sb.sr_avg,
        cast(cs.sr_current as double)- cast(sb.sr_avg as double) AS sr_difference
      FROM current_sr cs
      LEFT JOIN user_paytm_payments.feb_hourly_sr_benchamrk sb
      ON cs.hour = sb.hour
) AS virtual_table
LIMIT 1000;

"
588,4001,Last Hour SR Overall Alert,"How does the UPI transaction success rate in the last hour compare to the historical average, and what is the difference between current and expected performance?","SELECT hour AS hour, sr_current AS sr_current, sr_avg AS sr_avg, sr_difference AS sr_difference 
FROM (WITH current_sr AS (
        SELECT
          HOUR(CAST(txn_timestamp AS TIMESTAMP)) AS hour,
          CAST(COUNT(DISTINCT CASE WHEN LOWER(status) IN ('success','deemed') THEN txn_id END) AS DOUBLE) /
          CAST(COUNT(DISTINCT txn_id) AS DOUBLE) AS sr_current
        FROM hive.upi_txn.upi_activities_data_snapshot_v3
        WHERE type IN ('COLLECT','PAY')
          AND TRY(LOWER(SPLIT(payer_vpa, '@')[2])) IN ('paytm','ptsbi','ptaxis','pthdfc','ptyes')
          AND category IN ('VPA2MERCHANT','VPA2VPA','VPA2ACCOUNT')
          AND dl_last_updated >= DATE_ADD('day', -1, CURRENT_DATE)
          AND (
          --  Normal case: Only include today's transactions
          (HOUR(CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Kolkata') > 0
           AND DATE(cast(txn_timestamp as timestamp)) = CURRENT_DATE)

          --  Special case for 12 AM: Include 11 PM transactions from yesterday
          OR (HOUR(CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Kolkata') = 0
              AND DATE(cast(txn_timestamp as timestamp)) = DATE_ADD('day', -1, CURRENT_DATE))
      )
          AND HOUR(CAST(txn_timestamp AS TIMESTAMP)) =
              CASE
                  WHEN HOUR(CAST(DATE_FORMAT(current_timestamp AT TIME ZONE 'Asia/Kolkata',
                  '%Y-%m-%d %H:%i:%s.%f Asia/Calcutta') AS TIMESTAMP)) = 0
                  THEN 23
                  ELSE HOUR(CAST(DATE_FORMAT(current_timestamp AT TIME ZONE 'Asia/Kolkata',
                  '%Y-%m-%d %H:%i:%s.%f Asia/Calcutta') AS TIMESTAMP)) - 1
              END
          AND participant_type = 'PAYER'
          AND (LOWER(businesstype) <> 'mandate' OR businesstype IS NULL)
        GROUP BY 1
      )


      SELECT
        cs.hour,
        cs.sr_current,
        sb.sr_avg,
        cast(cs.sr_current as double)- cast(sb.sr_avg as double) AS sr_difference
      FROM current_sr cs
      LEFT JOIN user_paytm_payments.feb_hourly_sr_benchamrk sb
      ON cs.hour = sb.hour
) AS virtual_table
LIMIT 1000;

"
588,4002,T vs T-1 Error Codes Alert,"How do today's UPI transaction error codes compare to yesterday's, and which error codes are showing increased failure rates?","SELECT error_code AS error_code, todays_txns AS todays_txns, yesterdays_txns AS yesterdays_txns, ""Failure_Growth"" AS ""Failure_Growth"" 
FROM (with A as(
SELECT   error_code error_code, 
date(created_on) day_id,
count(txn_id) txns
FROM (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
group by error_code, created_on 
) 


select error_code,todays_txns,yesterdays_txns, ((todays_txns*1.0000)/(yesterdays_txns*1.0000)-1) Failure_Growth
from (
select 
error_code
,sum(txns) filter(WHERE day_id  = current_Date) todays_txns
,sum(txns) filter(WHERE day_id  = current_Date - interval '01' day) yesterdays_txns
from A
WHERE error_code is not null
group by 1 
having sum(txns) filter(WHERE day_id  = current_Date)>5000
)
) AS virtual_table ORDER BY todays_txns DESC
LIMIT 1000;

"
588,4002,T vs T-1 Error Codes Alert,"How do today's UPI transaction error codes compare to yesterday's error codes, and what is the failure growth rate for each error type?","SELECT error_code AS error_code, todays_txns AS todays_txns, yesterdays_txns AS yesterdays_txns, ""Failure_Growth"" AS ""Failure_Growth"" 
FROM (with A as(
SELECT   error_code error_code, 
date(created_on) day_id,
count(txn_id) txns
FROM (
SELECT ""final_Category"" AS ""final_Category"", payer_cust_id AS payer_cust_id, payee_handle AS payee_handle, created_on AS created_on, dt AS dt, date_time_hourly AS date_time_hourly, txn_id AS txn_id, amount AS amount, payer_bank AS payer_bank, ""Error_code"" AS ""Error_code"", status AS status, payer_vpa AS payer_vpa, payer_handle AS payer_handle, payer_account_type AS payer_account_type, payee_bank AS payee_bank, flow_cat AS flow_cat, current_time_ AS current_time_ 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table
) AS dataset_1133
group by error_code, created_on 
) 


select error_code,todays_txns,yesterdays_txns, ((todays_txns*1.0000)/(yesterdays_txns*1.0000)-1) Failure_Growth
from (
select 
error_code
,sum(txns) filter(WHERE day_id  = current_Date) todays_txns
,sum(txns) filter(WHERE day_id  = current_Date - interval '01' day) yesterdays_txns
from A
WHERE error_code is not null
group by 1 
having sum(txns) filter(WHERE day_id  = current_Date)>5000
)
) AS virtual_table ORDER BY todays_txns DESC
LIMIT 1000;

"
588,4382,CC 0n UPI Hourly SR Trend (T vs T-1)- 588,What is the hourly success rate trend for UPI transactions today compared to yesterday?,"SELECT hour(created_on) AS ""Hour"", dt AS dt, (COUNT(txn_id) filter(WHERE status = 'SUCCESS')*1.0000) / (COUNT(txn_id)*1.0000) AS ""SR"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE payer_account_type = 'CREDIT' GROUP BY hour(created_on), dt ORDER BY ""SR"" DESC
LIMIT 10000;

"
588,4382,CC 0n UPI Hourly SR Trend (T vs T-1)- 588,What is the hourly success rate trend for UPI transactions today compared to yesterday?,"SELECT hour(created_on) AS ""Hour"", dt AS dt, (COUNT(txn_id) filter(WHERE status = 'SUCCESS')*1.0000) / (COUNT(txn_id)*1.0000) AS ""SR"" 
FROM (with ti as (
select 
-- date_Trunc('minute',cast(created_on as timestamp)) time_,
created_on,
txn_id,
amount,
app_resp_code,
npci_resp_code,
case when  status in('SUCCESS','DEEMED') then 'SUCCESS' else status end as status,
case when
        (category= 'VPA2MERCHANT') and business_type = 'MANDATE'
                then 'MANDATE'                
    when category in ('VPA2VPA','VPA2ACCOUNT') and (business_type is null or business_type <> 'MANDATE')
        then 'P2P'        
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM_QR_MERCHANTS'
        then 'Paytm QR'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('00','01','15','22','23')
        then '3P QR'
    when type = 'COLLECT' and category = 'VPA2MERCHANT' and (business_type is null or business_type <> 'MANDATE')
        then 'P2M Collect'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) = 'PAYTM'
        and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') in ('04','03')
        then 'Intent'
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_3P_NATIVE')
        then 'Intent'                
    when type = 'PAY' and category = 'VPA2MERCHANT' and upper(channel_code) in ('ONLINE_ONUS_NATIVE')
        then 'Onus_ExcMandates'
    when type = 'PAY' and category = 'VPA2MERCHANT'
        then 'Other P2M'
    else 'Others'
    end flow_cat
            FROM hive.switch.txn_info_snapshot_v3
            WHERE dl_last_updated >= current_date - interval '01' day
            and date(created_on) >= current_date - interval '01' day
            and type in ('PAY','COLLECT')
            AND category in('VPA2VPA','VPA2ACCOUNT','VPA2MERCHANT')
            --AND status in('SUCCESS','DEEMED')
            and lower(psp_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
            and JSON_EXTRACT_SCALAR(extended_info, '$.initiationMode') !='14'
            ---<= (cast((current_timestamp AT TIME ZONE 'Asia/Kolkata')as TIMESTAMP) - interval '60' minute)
),
tp1 as (
select txn_id, vpa payer_vpa,handle payer_handle, scope_cust_id payer_cust_id, account_type,bank_code payer_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day 
and lower(handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi') 
and participant_type = 'PAYER'
),
tp2 as (
select txn_id, vpa payee_vpa,handle payee_handle,bank_code payee_bank from 
hive.switch.txn_participants_snapshot_v3 p
where dl_last_updated >=  current_date - interval '01' day
and participant_type = 'PAYEE'
),
on_us_vpa as
(
select lower(merchant_vpa) as onus_vpa
from user_paytm_payments.onus_vpa_base
group by 1
) 

select 
ti.created_on
,date(ti.created_on) dt
,date_Trunc('hour',ti.created_on) date_time_hourly
,ti.txn_id
,ti.amount
,coalesce(ti.npci_resp_code,ti.app_resp_code) Error_code
,ti.status
--,flow_cat
,tp1.payer_vpa
,tp1.payer_handle
,tp1.payer_cust_id
,tp1.account_type payer_account_type
,tp1.payer_bank
,tp2.payee_bank
,tp2.payee_handle
,case when flow_cat = 'MANDATE' and c.onus_vpa is not null then 'Mandate_onus'
when  flow_cat = 'MANDATE' and c.onus_vpa is null then 'Mandate_online'
when flow_cat = '3P QR' and payee_handle in ('pty', 'ptybl', 'ptys','ptsbi','ptyes','pthdfc','ptaxis') then 'Paytm QR'
else flow_cat end as flow_cat
,case when flow_cat IN ('P2P') THEN 'P2P'
  WHEN flow_cat IN ('3P QR', 'Paytm QR') THEN 'SnP'
  WHEN flow_cat IN ('Intent', 'P2M Collect') or (flow_cat = 'MANDATE' and c.onus_vpa is null) THEN 'Online'
  WHEN flow_cat IN ('Onus_ExcMandates','Mandate_Onus') or(flow_cat = 'MANDATE' and c.onus_vpa is not null) THEN 'Onus'
  else flow_cat end as final_Category,
  
  (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date) current_time_
  
 from  ti  
 join tp1 on ti.txn_id = tp1.txn_id
 join tp2 on ti.txn_id = tp2.txn_id
 left join on_us_vpa c  ON lower(tp2.payee_vpa) = lower(c.onus_vpa)
 WHERE 
(
(
date(created_on)  =  current_Date 
and 
created_on <= (select (max(created_on) - interval '10' minute) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
Or
(date(created_on)  =  (current_Date - interval '01' day)
and 
created_on <= (select (max(created_on) - interval '10' minute - interval '01' day ) last_time from hive.switch.txn_info_snapshot_v3
where  dl_last_updated = current_date)
)
)
) AS virtual_table 
WHERE payer_account_type = 'CREDIT' GROUP BY hour(created_on), dt ORDER BY ""SR"" DESC
LIMIT 10000;

"
585,3157,3P online top 1k Daily Summary,"What is the daily performance summary for our top 1000 third-party online merchants, including their user activity, transaction volumes, revenue, and growth rates compared to recent periods?","SELECT online_merchant_name AS online_merchant_name, sum(""7d_avg_DAU"") AS ""7d avg DAU"", sum(""Yday_DAU"") AS ""Yday DAU"", AVG(Yday_DAU)/AVG(""7d_avg_DAU"") - 1 AS ""Yday DAU Growth"", sum(""LMTD_mau"") AS ""LMTD MAU"", sum(""MTD_mau"") AS ""MTD MAU"", AVG(MTD_mau)/AVG(LMTD_mau) - 1 AS ""MTD MAU Growth"", sum(""Yday_txns"") AS ""yday txns"", sum(""7d_avg_txns"") AS ""7d avg Txns"", avg(Yday_txns)/avg(""7d_avg_txns"") - 1 AS ""Yday Txn Growth"", sum(""LMTD_txns"") AS ""LMTD Txns"", sum(""MTD_txns"") AS ""MTD Txns"", avg(MTD_txns)/avg(LMTD_txns)-1 AS ""MTD Txn _Growth"", sum(""7d_avg_gmv"") AS ""7d avg Gmv"", sum(""Yday_gmv"") AS ""yday Gmv"", avg(Yday_gmv)/avg(""7d_avg_gmv"") - 1 AS ""Yday Gmv Growth"", sum(""LMTD_gmv"") AS ""LMTD Gmv"", sum(""MTD_gmv"") AS ""MTD GMV"", avg(MTD_gmv)/avg(LMTD_gmv) -1 AS ""MTD Gmv Growth"", sum(""7d_avg_nr"") AS ""7d avg NR"", sum(""Yday_nr"") AS ""Yday NR"", avg(yday_nr)/avg(""7d_avg_nr"")- 1 AS ""Yday NR Growth"", sum(""LMTD_nr"") AS ""LMTD NR"", sum(""MTD_nr"") AS ""MTD NR"", avg(MTD_nr)/avg(LMTD_nr) - 1 AS ""MTD NR Grwoth"" 
FROM (with A as(
SELECT * FROM (
SELECT day_id AS day_id, online_merchant_name AS online_merchant_name, dau AS dau, mau AS mau, ""NR"" AS ""NR"", new AS new, ""React"" AS ""React"", n_txns AS n_txns, gmv AS gmv 
FROM (with upi_flow_wise_base as (
select a.*, b.online_merchant_name, date_trunc('month',day_id) mnt,
case when day_id between date_trunc('month',current_date - interval '01' day) and current_date - interval '01' day then 'MTD'
when day_id between date_trunc('month',current_date - interval '01' day - interval '01' month) and current_date - interval '01' day - interval '01' month then 'LMTD'
end as periods,
--row_number() over (partition by payer_cust_id,b.online_merchant_name, date_trunc('month', date(cast(txn_timestamp as timestamp ))) order by txn_timestamp) as rn_online_merchant_name
row_number() over (partition by customer_id, date_trunc('month', date(day_id)) order by created_on) as rn_ft
from (
select
transaction_date_key day_id,
customer_id_payer customer_id,
txn_timestamp created_on,
txn_id,
amount,
payee_vpa,
CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_category

from  cdo.fact_upi_transactions_snapshot_v3
where dl_last_updated >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)
and transaction_type in('PAY','COLLECT')
and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
and status = 'SUCCESS'
and lower(payer_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')

)a
left JOIN  user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on LOWER(a.payee_vpa) = LOWER(b.payee_vpa)
),

paytm_nrr AS (
      SELECT customer_id customer_id, date_trunc('month',date(txn_date) ) mnt, txn_date day_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type
      FROM  user_paytm_payments.rolling_nrr_v1 
      WHERE txn_date >= date'2025-08-01'
      and user_type not IN ('Repeat')
       and
        customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt >=  date_trunc('month',current_Date - interval  '01' day - interval '01' month)
        and channel in (
        'fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ) 
        union all
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt >=  date_trunc('month',current_Date - interval  '01' day - interval '01' month)
        and channel in (
        'fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong') 
        )
      )

-- select day_id,txn_id,customer_id,online_merchant_name,amount,rn_ft,mnt,
-- row_number() over (partition by customer_id,online_merchant_name, date_trunc('month', day_id) order by day_id) as rn_mau
-- from  upi_flow_wise_base 
--                 where 
--                 -- lower(online_merchant_name) in (select lower(online_merchant_name) from user_paytm_payments.top1000_merchnats_nov_dec_and_offeractive_ss)
--                 -- and
--                 final_category = 'Online'

-- and day_id >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)      

select
a.day_id,
online_merchant_name,
        count(distinct a.customer_id) as dau,
        count(distinct case when a.rn_mau = 1 then a.customer_id end) as mau,
        count(distinct case when a.rn_ft = 1 and b.customer_id is not null then a.customer_id  end) as NR, --- paytm new/react 
        count(distinct case when a.rn_ft = 1 and b.user_type = 'New' then a.customer_id  end) as new, --- paytm new/react 
        count(distinct case when a.rn_ft = 1 and  b.user_type = 'React_2M+' then a.customer_id  end) as React, --- paytm new/react 
        count(distinct a.txn_id) as n_txns,
        sum(cast (amount as double)) as gmv

from
(  
select day_id,txn_id,customer_id,online_merchant_name,amount,rn_ft,mnt,
row_number() over (partition by customer_id,online_merchant_name, date_trunc('month', day_id) order by day_id) as rn_mau
from  upi_flow_wise_base 
                where lower(online_merchant_name) in (select lower(online_merchant_name) from user_paytm_payments.top1000_merchnats_nov_dec_and_offeractive_ss)
                and final_category = 'Online'

and day_id >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)
)a
left join paytm_nrr b on a.customer_id = b.customer_id  and a.mnt = b.mnt
group by 1,2

UNION ALL

select 
        a.day_id,
        'overall' as online_merchant_name,
        count(distinct a.customer_id) as dau,
        count(distinct case when rn_mau = 1 then a.customer_id end) as mau,
        count(distinct case when rn_ft = 1 and b.customer_id is not null then a.customer_id  end) as NR, --- paytm new/react
        count(distinct case when a.rn_ft = 1 and b.user_type = 'New' then a.customer_id  end) as new, --- paytm new/react 
        count(distinct case when a.rn_ft = 1 and  b.user_type = 'React_2M+' then a.customer_id  end) as React, --- paytm new/react 
 
        count(distinct txn_id) as n_txns,
        sum(cast (amount as double)) as gmv
from
      (  
select day_id,txn_id,customer_id,online_merchant_name,amount,rn_ft,mnt,
row_number() over (partition by customer_id, date_trunc('month', day_id) order by day_id) as rn_mau
from  upi_flow_wise_base 
                where final_category = 'Online'
and day_id >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)
)a
left join paytm_nrr b on a.customer_id = b.customer_id and a.day_id = b.day_id
group by 1,2
) AS virtual_table
) AS dataset_970
)

,Date_ as(
SELECT date_column
FROM UNNEST(
    SEQUENCE(
        date_trunc('month', current_date - interval '1' month),
        current_date - interval '1' day,
        interval '1' day
    )
) AS t(date_column)
)



,date_a as (
select 
date_column,
case 
when date_column between date_trunc('month',current_date  - interval '01' day) and (current_date  - interval '01' day) then 'MTD'
when date_column between date_trunc('month',current_date  - interval '01' day - interval '01' month ) and (current_date  - interval '01' day - interval '01' month ) then 'LMTD'
end as MTD_Flag,
case when date_column = (current_date  - interval '01' day) then 'Yesterday'
when date_column between (current_date  - interval '08' day) and (current_date  - interval '02' day) then 'last_7_day'
end as yday_flag from date_
)

select
online_merchant_name,
sum(dau) filter(where yday_flag = 'Yesterday') Yday_DAU,
sum(nr) filter(where yday_flag = 'Yesterday') Yday_nr,
sum(new) filter(where yday_flag = 'Yesterday') Yday_new,
sum(react) filter(where yday_flag = 'Yesterday') Yday_react,
sum(n_txns) filter(where yday_flag = 'Yesterday') Yday_txns,
sum(gmv) filter(where yday_flag = 'Yesterday') Yday_gmv,

avg(dau) filter(where yday_flag = 'last_7_day') ""7d_avg_DAU"",
avg(nr) filter(where yday_flag = 'last_7_day') ""7d_avg_nr"",
avg(new) filter(where yday_flag = 'last_7_day') ""7d_avg_new"",
avg(react) filter(where yday_flag = 'last_7_day') ""7d_avg_react"",
avg(n_txns) filter(where yday_flag = 'last_7_day') ""7d_avg_txns"",
avg(gmv) filter(where yday_flag = 'last_7_day') ""7d_avg_gmv"",

sum(mau) filter(where MTD_Flag = 'LMTD') LMTD_mau,
sum(nr) filter(where MTD_Flag = 'LMTD') LMTD_nr,
sum(new) filter(where MTD_Flag = 'LMTD') LMTD_new,
sum(react) filter(where MTD_Flag = 'LMTD') LMTD_react,
sum(n_txns) filter(where MTD_Flag = 'LMTD') LMTD_txns,
sum(gmv) filter(where MTD_Flag = 'LMTD') LMTD_gmv,
----
sum(mau) filter(where MTD_Flag = 'MTD') MTD_mau,
sum(nr) filter(where MTD_Flag = 'MTD') MTD_nr,
sum(new) filter(where MTD_Flag = 'MTD') MTD_new,
sum(react) filter(where MTD_Flag = 'MTD') MTD_react,
sum(n_txns) filter(where MTD_Flag = 'MTD') MTD_txns,
sum(gmv) filter(where MTD_Flag = 'MTD') MTD_gmv
--max(day_id) data_as_of

from A a join date_a b on a.day_id in(b.date_column)
where MTD_Flag is not null or yday_flag is not null
GROUP by 1
order by MTD_txns desc
) AS virtual_table GROUP BY online_merchant_name ORDER BY ""7d avg DAU"" DESC
LIMIT 1000;

"
585,3157,3P online top 1k Daily Summary,"What is the daily performance summary of our top 1000 third-party online merchants, including their user engagement, transaction volumes, revenue metrics, and growth rates compared to recent averages?","SELECT online_merchant_name AS online_merchant_name, sum(""7d_avg_DAU"") AS ""7d avg DAU"", sum(""Yday_DAU"") AS ""Yday DAU"", AVG(Yday_DAU)/AVG(""7d_avg_DAU"") - 1 AS ""Yday DAU Growth"", sum(""LMTD_mau"") AS ""LMTD MAU"", sum(""MTD_mau"") AS ""MTD MAU"", AVG(MTD_mau)/AVG(LMTD_mau) - 1 AS ""MTD MAU Growth"", sum(""Yday_txns"") AS ""yday txns"", sum(""7d_avg_txns"") AS ""7d avg Txns"", avg(Yday_txns)/avg(""7d_avg_txns"") - 1 AS ""Yday Txn Growth"", sum(""LMTD_txns"") AS ""LMTD Txns"", sum(""MTD_txns"") AS ""MTD Txns"", avg(MTD_txns)/avg(LMTD_txns)-1 AS ""MTD Txn _Growth"", sum(""7d_avg_gmv"") AS ""7d avg Gmv"", sum(""Yday_gmv"") AS ""yday Gmv"", avg(Yday_gmv)/avg(""7d_avg_gmv"") - 1 AS ""Yday Gmv Growth"", sum(""LMTD_gmv"") AS ""LMTD Gmv"", sum(""MTD_gmv"") AS ""MTD GMV"", avg(MTD_gmv)/avg(LMTD_gmv) -1 AS ""MTD Gmv Growth"", sum(""7d_avg_nr"") AS ""7d avg NR"", sum(""Yday_nr"") AS ""Yday NR"", avg(yday_nr)/avg(""7d_avg_nr"")- 1 AS ""Yday NR Growth"", sum(""LMTD_nr"") AS ""LMTD NR"", sum(""MTD_nr"") AS ""MTD NR"", avg(MTD_nr)/avg(LMTD_nr) - 1 AS ""MTD NR Grwoth"" 
FROM (with A as(
SELECT * FROM (
SELECT day_id AS day_id, online_merchant_name AS online_merchant_name, dau AS dau, mau AS mau, ""NR"" AS ""NR"", new AS new, ""React"" AS ""React"", n_txns AS n_txns, gmv AS gmv 
FROM (with upi_flow_wise_base as (
select a.*, b.online_merchant_name, date_trunc('month',day_id) mnt,
case when day_id between date_trunc('month',current_date - interval '01' day) and current_date - interval '01' day then 'MTD'
when day_id between date_trunc('month',current_date - interval '01' day - interval '01' month) and current_date - interval '01' day - interval '01' month then 'LMTD'
end as periods,
--row_number() over (partition by payer_cust_id,b.online_merchant_name, date_trunc('month', date(cast(txn_timestamp as timestamp ))) order by txn_timestamp) as rn_online_merchant_name
row_number() over (partition by customer_id, date_trunc('month', date(day_id)) order by created_on) as rn_ft
from (
select
transaction_date_key day_id,
customer_id_payer customer_id,
txn_timestamp created_on,
txn_id,
amount,
payee_vpa,
CASE                        
        WHEN flow_category IN ('P2P') THEN 'P2P'
        WHEN flow_category IN ('3P QR', 'Paytm QR') THEN 'SnP'
        WHEN flow_category IN ('Intent', 'P2M Collect','Mandate_Online') THEN 'Online'
        WHEN flow_category IN ('Onus_ExcMandates','Mandate_Onus') THEN 'Onus'
        ELSE 'Others' 
END AS final_category

from  cdo.fact_upi_transactions_snapshot_v3
where dl_last_updated >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)
and transaction_type in('PAY','COLLECT')
and category in ('VPA2ACCOUNT','VPA2VPA','VPA2MERCHANT')
and status = 'SUCCESS'
and lower(payer_handle) in ('paytm','ptyes','ptaxis','pthdfc','ptsbi')

)a
left JOIN  user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on LOWER(a.payee_vpa) = LOWER(b.payee_vpa)
),

paytm_nrr AS (
      SELECT customer_id customer_id, date_trunc('month',date(txn_date) ) mnt, txn_date day_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type
      FROM  user_paytm_payments.rolling_nrr_v1 
      WHERE txn_date >= date'2025-08-01'
      and user_type not IN ('Repeat')
       and
        customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt >=  date_trunc('month',current_Date - interval  '01' day - interval '01' month)
        and channel in (
        'fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ) 
        union all
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt >=  date_trunc('month',current_Date - interval  '01' day - interval '01' month)
        and channel in (
        'fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong') 
        )
      )

-- select day_id,txn_id,customer_id,online_merchant_name,amount,rn_ft,mnt,
-- row_number() over (partition by customer_id,online_merchant_name, date_trunc('month', day_id) order by day_id) as rn_mau
-- from  upi_flow_wise_base 
--                 where 
--                 -- lower(online_merchant_name) in (select lower(online_merchant_name) from user_paytm_payments.top1000_merchnats_nov_dec_and_offeractive_ss)
--                 -- and
--                 final_category = 'Online'

-- and day_id >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)      

select
a.day_id,
online_merchant_name,
        count(distinct a.customer_id) as dau,
        count(distinct case when a.rn_mau = 1 then a.customer_id end) as mau,
        count(distinct case when a.rn_ft = 1 and b.customer_id is not null then a.customer_id  end) as NR, --- paytm new/react 
        count(distinct case when a.rn_ft = 1 and b.user_type = 'New' then a.customer_id  end) as new, --- paytm new/react 
        count(distinct case when a.rn_ft = 1 and  b.user_type = 'React_2M+' then a.customer_id  end) as React, --- paytm new/react 
        count(distinct a.txn_id) as n_txns,
        sum(cast (amount as double)) as gmv

from
(  
select day_id,txn_id,customer_id,online_merchant_name,amount,rn_ft,mnt,
row_number() over (partition by customer_id,online_merchant_name, date_trunc('month', day_id) order by day_id) as rn_mau
from  upi_flow_wise_base 
                where lower(online_merchant_name) in (select lower(online_merchant_name) from user_paytm_payments.top1000_merchnats_nov_dec_and_offeractive_ss)
                and final_category = 'Online'

and day_id >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)
)a
left join paytm_nrr b on a.customer_id = b.customer_id  and a.mnt = b.mnt
group by 1,2

UNION ALL

select 
        a.day_id,
        'overall' as online_merchant_name,
        count(distinct a.customer_id) as dau,
        count(distinct case when rn_mau = 1 then a.customer_id end) as mau,
        count(distinct case when rn_ft = 1 and b.customer_id is not null then a.customer_id  end) as NR, --- paytm new/react
        count(distinct case when a.rn_ft = 1 and b.user_type = 'New' then a.customer_id  end) as new, --- paytm new/react 
        count(distinct case when a.rn_ft = 1 and  b.user_type = 'React_2M+' then a.customer_id  end) as React, --- paytm new/react 
 
        count(distinct txn_id) as n_txns,
        sum(cast (amount as double)) as gmv
from
      (  
select day_id,txn_id,customer_id,online_merchant_name,amount,rn_ft,mnt,
row_number() over (partition by customer_id, date_trunc('month', day_id) order by day_id) as rn_mau
from  upi_flow_wise_base 
                where final_category = 'Online'
and day_id >= date_trunc('month',current_Date - interval  '01' day - interval '01' month)
)a
left join paytm_nrr b on a.customer_id = b.customer_id and a.day_id = b.day_id
group by 1,2
) AS virtual_table
) AS dataset_970
)

,Date_ as(
SELECT date_column
FROM UNNEST(
    SEQUENCE(
        date_trunc('month', current_date - interval '1' month),
        current_date - interval '1' day,
        interval '1' day
    )
) AS t(date_column)
)



,date_a as (
select 
date_column,
case 
when date_column between date_trunc('month',current_date  - interval '01' day) and (current_date  - interval '01' day) then 'MTD'
when date_column between date_trunc('month',current_date  - interval '01' day - interval '01' month ) and (current_date  - interval '01' day - interval '01' month ) then 'LMTD'
end as MTD_Flag,
case when date_column = (current_date  - interval '01' day) then 'Yesterday'
when date_column between (current_date  - interval '08' day) and (current_date  - interval '02' day) then 'last_7_day'
end as yday_flag from date_
)

select
online_merchant_name,
sum(dau) filter(where yday_flag = 'Yesterday') Yday_DAU,
sum(nr) filter(where yday_flag = 'Yesterday') Yday_nr,
sum(new) filter(where yday_flag = 'Yesterday') Yday_new,
sum(react) filter(where yday_flag = 'Yesterday') Yday_react,
sum(n_txns) filter(where yday_flag = 'Yesterday') Yday_txns,
sum(gmv) filter(where yday_flag = 'Yesterday') Yday_gmv,

avg(dau) filter(where yday_flag = 'last_7_day') ""7d_avg_DAU"",
avg(nr) filter(where yday_flag = 'last_7_day') ""7d_avg_nr"",
avg(new) filter(where yday_flag = 'last_7_day') ""7d_avg_new"",
avg(react) filter(where yday_flag = 'last_7_day') ""7d_avg_react"",
avg(n_txns) filter(where yday_flag = 'last_7_day') ""7d_avg_txns"",
avg(gmv) filter(where yday_flag = 'last_7_day') ""7d_avg_gmv"",

sum(mau) filter(where MTD_Flag = 'LMTD') LMTD_mau,
sum(nr) filter(where MTD_Flag = 'LMTD') LMTD_nr,
sum(new) filter(where MTD_Flag = 'LMTD') LMTD_new,
sum(react) filter(where MTD_Flag = 'LMTD') LMTD_react,
sum(n_txns) filter(where MTD_Flag = 'LMTD') LMTD_txns,
sum(gmv) filter(where MTD_Flag = 'LMTD') LMTD_gmv,
----
sum(mau) filter(where MTD_Flag = 'MTD') MTD_mau,
sum(nr) filter(where MTD_Flag = 'MTD') MTD_nr,
sum(new) filter(where MTD_Flag = 'MTD') MTD_new,
sum(react) filter(where MTD_Flag = 'MTD') MTD_react,
sum(n_txns) filter(where MTD_Flag = 'MTD') MTD_txns,
sum(gmv) filter(where MTD_Flag = 'MTD') MTD_gmv
--max(day_id) data_as_of

from A a join date_a b on a.day_id in(b.date_column)
where MTD_Flag is not null or yday_flag is not null
GROUP by 1
order by MTD_txns desc
) AS virtual_table GROUP BY online_merchant_name ORDER BY ""7d avg DAU"" DESC
LIMIT 1000;

"
585,3462,3P Online - Overall MTD LMTD FT RT Summary,"How is our online third-party payment performance trending this month compared to last month, broken down by user type including metrics like user count, transaction volume, GMV, and growth rates?","SELECT paytm_user_type AS paytm_user_type, sum(users_mtd) AS ""MTD Users"", sum(txns_mtd) AS ""MTD Txns"", sum(gmv_mtd) AS ""MTD Gmv"", sum(txns_mtd*1.00)/sum(users_mtd*1.00) AS ""TPU"", sum(users_lmtd) AS ""LMTD Users"", sum(txns_lmtd) AS ""LMTD Txns"", sum(gmv_lmtd) AS ""LMTD Gmv"", sum(txns_lmtd*1.00)/sum(users_lmtd*1.00) AS ""LMTD TPU"", (SUM(users_mtd)*1.0000)
/
(SUM(users_lmtd)*1.0000) -1 AS ""MTD User Growth"", (SUM(txns_mtd)*1.0000)
/
(SUM(txns_lmtd)*1.0000) -1 AS ""MTD Txn Growth"", (SUM(gmv_mtd)*1.0000)
/
(SUM(gmv_lmtd)*1.0000) -1 AS ""MTD Gmv Growth"" 
FROM (WITH date_ranges AS (
          SELECT
              DATE_TRUNC('MONTH', DATE_ADD('day', -1, CURRENT_DATE)) AS mtd_start,
              DATE_ADD('day', -1, CURRENT_DATE) AS mtd_end,
              DATE_TRUNC('MONTH', DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE))) AS lmtd_start,
              DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE)) AS lmtd_end
      ),

      paytm_nrr_mtd AS (
      WITH paytm_nrr AS (
      SELECT txn_date day_id,payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date,customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type
      FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
       and

        customer_Id not in (
            Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt between (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
        and lower(channel) in (
        'fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ) )

      )
      WHERE user_type IN ('New', 'React_2M+')
      )
      SELECT day_id,payer_cust_id, paytm_user_type, 'MTD' AS period FROM paytm_nrr
      ),

      paytm_nrr_lmtd AS (
      WITH paytm_nrr AS (
      SELECT txn_date day_id,payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date,customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type
      FROM hive.user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)

      and customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt between (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      )
      SELECT day_id, payer_cust_id, paytm_user_type, 'LMTD' AS period FROM paytm_nrr
      ),

      upi_online_ft AS (
      SELECT day_id,payer_cust_id, 'MTD' AS period
      FROM (
      SELECT payer_cust_id, final_category,day_id,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay
      WHERE day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges) -- MTD Source
      )
      WHERE final_category = 'Online'
      AND rnk = 1


      UNION ALL

      SELECT day_id,payer_cust_id, 'LMTD' AS period
      FROM (
      SELECT payer_cust_id, final_category,day_id,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay
      where day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      )
      WHERE final_category = 'Online'
      AND rnk = 1

      ),

      upi_online_txns AS (
      SELECT payer_cust_id,day_id, COUNT(txn_id) AS n_txns, SUM(amount) AS gmv, 'MTD' AS period
      FROM user_paytm_payments.upi_abhay  -- MTD Source
      WHERE payer_cust_id IN (SELECT payer_cust_id FROM upi_online_ft WHERE period = 'MTD')
      AND day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
      GROUP BY 1,2

      UNION ALL

      SELECT payer_cust_id,day_id, COUNT(txn_id) AS n_txns, SUM(amount) AS gmv, 'LMTD' AS period
      FROM user_paytm_payments.upi_abhay  -- LMTD Source
      WHERE payer_cust_id IN (SELECT payer_cust_id FROM upi_online_ft WHERE period = 'LMTD')
      AND day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      GROUP BY 1,2
      ),

      final_base as (
      SELECT
      a.paytm_user_type,
      a.period,
      COUNT(DISTINCT a.payer_cust_id) AS users,
      COALESCE(SUM(n_txns), 0) AS n_txns,
      COALESCE(SUM(gmv), 0) AS gmv
      FROM (
      SELECT * FROM paytm_nrr_mtd
      UNION ALL
      SELECT * FROM paytm_nrr_lmtd
      ) AS a
      INNER JOIN upi_online_ft AS b
      ON a.payer_cust_id = b.payer_cust_id
      -- AND a.period = b.period
      and a.day_id = b.day_id
      LEFT JOIN upi_online_txns AS c
      ON b.payer_cust_id = c.payer_cust_id
      -- AND b.period = c.period
      and b.day_id = c.day_id
      GROUP BY 1, 2
      ORDER BY 3, 1
      )

      select
      paytm_user_type,
      sum(case when period = 'MTD' then users end) as users_mtd,
      sum(case when period = 'MTD' then n_txns end) as txns_mtd,
      sum(case when period = 'MTD' then gmv end) as gmv_mtd,

      sum(case when period = 'LMTD' then users end) as users_lmtd,
      sum(case when period = 'LMTD' then n_txns end) as txns_lmtd,
      sum(case when period = 'LMTD' then gmv end) as gmv_lmtd
      from final_base
      group by 1
) AS virtual_table GROUP BY paytm_user_type ORDER BY ""MTD Users"" DESC
LIMIT 1000;

"
585,3462,3P Online - Overall MTD LMTD FT RT Summary,"How are our 3P online payment users performing this month compared to last month, broken down by user type (new, repeat, and reactivated users), including metrics like user count, transaction volume, GMV, and growth rates?","SELECT paytm_user_type AS paytm_user_type, sum(users_mtd) AS ""MTD Users"", sum(txns_mtd) AS ""MTD Txns"", sum(gmv_mtd) AS ""MTD Gmv"", sum(txns_mtd*1.00)/sum(users_mtd*1.00) AS ""TPU"", sum(users_lmtd) AS ""LMTD Users"", sum(txns_lmtd) AS ""LMTD Txns"", sum(gmv_lmtd) AS ""LMTD Gmv"", sum(txns_lmtd*1.00)/sum(users_lmtd*1.00) AS ""LMTD TPU"", (SUM(users_mtd)*1.0000)
/
(SUM(users_lmtd)*1.0000) -1 AS ""MTD User Growth"", (SUM(txns_mtd)*1.0000)
/
(SUM(txns_lmtd)*1.0000) -1 AS ""MTD Txn Growth"", (SUM(gmv_mtd)*1.0000)
/
(SUM(gmv_lmtd)*1.0000) -1 AS ""MTD Gmv Growth"" 
FROM (WITH date_ranges AS (
          SELECT
              DATE_TRUNC('MONTH', DATE_ADD('day', -1, CURRENT_DATE)) AS mtd_start,
              DATE_ADD('day', -1, CURRENT_DATE) AS mtd_end,
              DATE_TRUNC('MONTH', DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE))) AS lmtd_start,
              DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE)) AS lmtd_end
      ),

      paytm_nrr_mtd AS (
      WITH paytm_nrr AS (
      SELECT txn_date day_id,payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date,customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type
      FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
       and

        customer_Id not in (
            Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt between (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
        and lower(channel) in (
        'fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ) )

      )
      WHERE user_type IN ('New', 'React_2M+')
      )
      SELECT day_id,payer_cust_id, paytm_user_type, 'MTD' AS period FROM paytm_nrr
      ),

      paytm_nrr_lmtd AS (
      WITH paytm_nrr AS (
      SELECT txn_date day_id,payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date,customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type
      FROM hive.user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)

      and customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt between (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      )
      SELECT day_id, payer_cust_id, paytm_user_type, 'LMTD' AS period FROM paytm_nrr
      ),

      upi_online_ft AS (
      SELECT day_id,payer_cust_id, 'MTD' AS period
      FROM (
      SELECT payer_cust_id, final_category,day_id,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay
      WHERE day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges) -- MTD Source
      )
      WHERE final_category = 'Online'
      AND rnk = 1


      UNION ALL

      SELECT day_id,payer_cust_id, 'LMTD' AS period
      FROM (
      SELECT payer_cust_id, final_category,day_id,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay
      where day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      )
      WHERE final_category = 'Online'
      AND rnk = 1

      ),

      upi_online_txns AS (
      SELECT payer_cust_id,day_id, COUNT(txn_id) AS n_txns, SUM(amount) AS gmv, 'MTD' AS period
      FROM user_paytm_payments.upi_abhay  -- MTD Source
      WHERE payer_cust_id IN (SELECT payer_cust_id FROM upi_online_ft WHERE period = 'MTD')
      AND day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
      GROUP BY 1,2

      UNION ALL

      SELECT payer_cust_id,day_id, COUNT(txn_id) AS n_txns, SUM(amount) AS gmv, 'LMTD' AS period
      FROM user_paytm_payments.upi_abhay  -- LMTD Source
      WHERE payer_cust_id IN (SELECT payer_cust_id FROM upi_online_ft WHERE period = 'LMTD')
      AND day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      GROUP BY 1,2
      ),

      final_base as (
      SELECT
      a.paytm_user_type,
      a.period,
      COUNT(DISTINCT a.payer_cust_id) AS users,
      COALESCE(SUM(n_txns), 0) AS n_txns,
      COALESCE(SUM(gmv), 0) AS gmv
      FROM (
      SELECT * FROM paytm_nrr_mtd
      UNION ALL
      SELECT * FROM paytm_nrr_lmtd
      ) AS a
      INNER JOIN upi_online_ft AS b
      ON a.payer_cust_id = b.payer_cust_id
      -- AND a.period = b.period
      and a.day_id = b.day_id
      LEFT JOIN upi_online_txns AS c
      ON b.payer_cust_id = c.payer_cust_id
      -- AND b.period = c.period
      and b.day_id = c.day_id
      GROUP BY 1, 2
      ORDER BY 3, 1
      )

      select
      paytm_user_type,
      sum(case when period = 'MTD' then users end) as users_mtd,
      sum(case when period = 'MTD' then n_txns end) as txns_mtd,
      sum(case when period = 'MTD' then gmv end) as gmv_mtd,

      sum(case when period = 'LMTD' then users end) as users_lmtd,
      sum(case when period = 'LMTD' then n_txns end) as txns_lmtd,
      sum(case when period = 'LMTD' then gmv end) as gmv_lmtd
      from final_base
      group by 1
) AS virtual_table GROUP BY paytm_user_type ORDER BY ""MTD Users"" DESC
LIMIT 1000;

"
585,3463,FT/RT DoD Merchant Level (Apply Merchant filter on top for any specific merchant),"What is the month-over-month growth in new users and reactivated users for our top merchants, and how does the current month's performance compare to the same period last month?","SELECT day_id AS day_id__, sum(""MTD_New_Users"") AS ""MTD New users"", sum(""MTD_React2Mplus_Users"") AS ""MTD React Users"", sum(""LMTD_New_Users"") AS ""LMTD New Users"", sum(""LMTD_React2Mplus_Users"") AS ""LMTD React Users"", SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users) AS ""MTD New + React Users"", SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users) AS ""LMTD New + React Users"", (SUM(MTD_New_Users)*1.0000)/
(SUM(LMTD_New_Users)*1.0000)-1 AS ""New user Growth"", (SUM(MTD_React2Mplus_Users)*1.0000)/
(SUM(LMTD_React2Mplus_Users)*1.0000)-1 AS ""React User Growth"", ((SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users)
)*1.0000)
/
((SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users)
)*1.0000) - 1 AS ""New+React User Growth"" 
FROM (WITH date_ranges AS (
          SELECT
              DATE_TRUNC('MONTH', DATE_ADD('day', -1, CURRENT_DATE)) AS mtd_start,
              DATE_ADD('day', -1, CURRENT_DATE) AS mtd_end,
              DATE_TRUNC('MONTH', DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE))) AS lmtd_start,
              DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE)) AS lmtd_end
      ),

      paytm_nrr_mtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
         FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
       and

        customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt between (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'MTD' AS period FROM paytm_nrr
      ),

      paytm_nrr_lmtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
     FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
       and

        customer_Id not in (
            Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt between (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'LMTD' AS period FROM paytm_nrr
      ),

      upi_online_ft AS (
      SELECT payer_cust_id, day_id,online_merchant_name, 'MTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      WHERE day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges) -- MTD Source
      )
      WHERE final_category = 'Online'
      AND rnk = 1


      UNION ALL

      SELECT payer_cust_id, day_id,online_merchant_name, 'LMTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      where day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      )
      WHERE final_category = 'Online'
      AND rnk = 1

      )

      SELECT
      day(b.day_id) as day_id,
      b.online_merchant_name,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_Repeat_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_Repeat_Users

      FROM (
      SELECT * FROM paytm_nrr_mtd
      UNION ALL
      SELECT * FROM paytm_nrr_lmtd
      ) AS a
      INNER JOIN upi_online_ft AS b
      ON a.payer_cust_id = b.payer_cust_id
      -- AND a.period = b.period
      and a.dt = b.day_id
      GROUP BY 1, 2
      ORDER BY 3, 1
) AS virtual_table GROUP BY day_id ORDER BY max(day_id) ASC
LIMIT 1000;

"
585,3463,FT/RT DoD Merchant Level (Apply Merchant filter on top for any specific merchant),"What is the month-to-date performance of new and reactivated users compared to last month for our top online merchants, and what are the growth rates for each user type?","SELECT day_id AS day_id__, sum(""MTD_New_Users"") AS ""MTD New users"", sum(""MTD_React2Mplus_Users"") AS ""MTD React Users"", sum(""LMTD_New_Users"") AS ""LMTD New Users"", sum(""LMTD_React2Mplus_Users"") AS ""LMTD React Users"", SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users) AS ""MTD New + React Users"", SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users) AS ""LMTD New + React Users"", (SUM(MTD_New_Users)*1.0000)/
(SUM(LMTD_New_Users)*1.0000)-1 AS ""New user Growth"", (SUM(MTD_React2Mplus_Users)*1.0000)/
(SUM(LMTD_React2Mplus_Users)*1.0000)-1 AS ""React User Growth"", ((SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users)
)*1.0000)
/
((SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users)
)*1.0000) - 1 AS ""New+React User Growth"" 
FROM (WITH date_ranges AS (
          SELECT
              DATE_TRUNC('MONTH', DATE_ADD('day', -1, CURRENT_DATE)) AS mtd_start,
              DATE_ADD('day', -1, CURRENT_DATE) AS mtd_end,
              DATE_TRUNC('MONTH', DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE))) AS lmtd_start,
              DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE)) AS lmtd_end
      ),

      paytm_nrr_mtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
         FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
       and

        customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt between (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'MTD' AS period FROM paytm_nrr
      ),

      paytm_nrr_lmtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
     FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
       and

        customer_Id not in (
            Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt between (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'LMTD' AS period FROM paytm_nrr
      ),

      upi_online_ft AS (
      SELECT payer_cust_id, day_id,online_merchant_name, 'MTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      WHERE day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges) -- MTD Source
      )
      WHERE final_category = 'Online'
      AND rnk = 1


      UNION ALL

      SELECT payer_cust_id, day_id,online_merchant_name, 'LMTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      where day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      )
      WHERE final_category = 'Online'
      AND rnk = 1

      )

      SELECT
      day(b.day_id) as day_id,
      b.online_merchant_name,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_Repeat_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_Repeat_Users

      FROM (
      SELECT * FROM paytm_nrr_mtd
      UNION ALL
      SELECT * FROM paytm_nrr_lmtd
      ) AS a
      INNER JOIN upi_online_ft AS b
      ON a.payer_cust_id = b.payer_cust_id
      -- AND a.period = b.period
      and a.dt = b.day_id
      GROUP BY 1, 2
      ORDER BY 3, 1
) AS virtual_table GROUP BY day_id ORDER BY max(day_id) ASC
LIMIT 1000;

"
585,3562,online_category_missingvpa_mapping,Which online merchant VPAs have more than 100 transactions this month but are missing from our merchant mapping database?,"SELECT payee_vpa AS payee_vpa, online_merchant_name AS online_merchant_name, sum(n_txns) AS ""Txns(>100)"" 
FROM (select lower(a.payee_vpa) as payee_vpa, a.online_merchant_name,
count(txn_id) as n_txns
from
 user_paytm_payments.upi_flow_wise_base_cm a
left JOIN user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on LOWER(a.payee_vpa) = LOWER(b.payee_vpa)
where dl_last_updated >= date_trunc('month',current_Date - interval '01' day)
and final_category = 'Online'
and b.online_merchant_name is null
group by 1,2
having count(*) > 100
order by 3 desc
) AS virtual_table GROUP BY payee_vpa, online_merchant_name ORDER BY ""Txns(>100)"" DESC
LIMIT 1000;

"
585,3562,online_category_missingvpa_mapping,Which online merchants with high transaction volumes (over 100 transactions) are missing from our VPA mapping system this month?,"SELECT payee_vpa AS payee_vpa, online_merchant_name AS online_merchant_name, sum(n_txns) AS ""Txns(>100)"" 
FROM (select lower(a.payee_vpa) as payee_vpa, a.online_merchant_name,
count(txn_id) as n_txns
from
 user_paytm_payments.upi_flow_wise_base_cm a
left JOIN user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on LOWER(a.payee_vpa) = LOWER(b.payee_vpa)
where dl_last_updated >= date_trunc('month',current_Date - interval '01' day)
and final_category = 'Online'
and b.online_merchant_name is null
group by 1,2
having count(*) > 100
order by 3 desc
) AS virtual_table GROUP BY payee_vpa, online_merchant_name ORDER BY ""Txns(>100)"" DESC
LIMIT 1000;

"
585,6505,MTU_Live_Non_Live_Top_15_,"What is the daily breakdown of transaction users across different merchant categories - including overall users, live merchants, non-live merchants, top 15 merchants, and top 1000 merchants?","SELECT date_trunc('day', CAST(mnt AS TIMESTAMP)) AS mnt, sum(overall_mtu) AS ""Overall_MTU__"", sum(live_merchants) AS ""Live_Merch_MTU"", sum(non_live_exc_live) AS ""Non_Live_MTU(excld_Live)"", sum(""Top_15_merc"") AS ""Top_15_Merch_MTU"", sum(""Top_1K_MTU"") AS ""Top_1K_MTU"" 
FROM (with base_ as (
select
mnt,
payer_cust_id,
SUM(1)
filter (where 
      lower(online_merchant_name) IN ('flipkart','Reliance','blinkit','zomato','swiggy','meesho','bharti','zepto','rapido','myntra','vodafone',
        'mpokket','bookmyshow','gokwik','jar','district','kreditbee','bigbasket','jiomart','cashfree','urban company','fancode','Paytm PG',
        'tataplay','hungerbox','nykaa','ola cabs','burger king','stage','magicpin','zee5','DMRC Momentum',
        '1mg','apollo','ajio','firstcry','chartr','eatclub','kfc','pharmeasy','zivame','pvr','snapdeal','gaana com','bbdaily','ketto online ventures pvt',
        'ferns n petal','gullak','rentomojo','dish tv','chaupal tv','healthians','tata play binge','rail yatri','igp','aha media','bakingo','nearbuy','netmeds'
        ,'Intrcity','d2h','freeup','floweraura','bix42','walmart')
)Live_MTU,
SUM(1) filter (where 
       lower(online_merchant_name) IN ('meesho','flipkart','zomato','Reliance','Myntra','bharti','gokwik','swiggy','rapido',
'blinkit','zepto','bookmyshow','mpokket','jar','vodafone') 
)Top_15_MTU, 
SUM(1)
filter (where 
        lower(online_merchant_name) Not IN ('flipkart','Reliance','blinkit','zomato','swiggy','meesho','bharti','zepto','rapido','myntra','vodafone',
        'mpokket','bookmyshow','gokwik','jar','district','kreditbee','bigbasket','jiomart','cashfree','urban company','fancode','Paytm PG',
        'tataplay','hungerbox','nykaa','ola cabs','burger king','stage','magicpin','zee5','DMRC Momentum',
        '1mg','apollo','ajio','firstcry','chartr','eatclub','kfc','pharmeasy','zivame','pvr','snapdeal','gaana com','bbdaily','ketto online ventures pvt',
        'ferns n petal','gullak','rentomojo','dish tv','chaupal tv','healthians','tata play binge','rail yatri','igp','aha media','bakingo','nearbuy','netmeds'
        ,'Intrcity','d2h','freeup','floweraura','bix42','walmart')
        )
Non_Live_MTU,
SUM(1) filter (where  top_1k = 1) top_1K_MTU
from 
(
select mnt,
payer_cust_id,
coalesce(b.online_merchant_name,'aaaaaaaaaa')online_merchant_name,
case when TP.online_merchant_name is not null then 1 else 0 end as top_1k
from
        (
           select distinct  date_Trunc('month',day_id)mnt, payer_cust_id,payee_vpa
        FROM user_paytm_payments.upi_abhay --user_paytm_payments.upi_flow_wise_base_partitioned
        WHERE
            day_id >= date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            AND day(day_id) <= day(current_Date - interval '01' day)
            AND final_category = 'Online'
        ) a
        left join (SELECT payee_vpa,lower(online_merchant_name) online_merchant_name
        FROM (
        select *, row_number() over(partition by payee_vpa order by updated_on DESC) as rn from user_paytm_payments.upi_3p_online_merchant_vpa_mapping_V1
        )
        WHERE RN=1
        ) b
        ON LOWER(a.payee_vpa) = lower(b.payee_vpa)   
        
        LEFT JOIN (SELECT DISTINCT online_merchant_name from  user_paytm_payments.top1000_merchnats_nov_dec_and_offeractive_ss) TP
          ON lower(b.online_merchant_name) = lower(tp.online_merchant_name)
)
group by 1,2
) 

select 
mnt,
count(distinct payer_cust_id) overall_mtu
,count(distinct payer_cust_id) filter(where coalesce(Live_MTU,0)>=1) live_merchants
,count(distinct payer_cust_id) filter(where coalesce(Live_MTU,0)>=1 and coalesce(Non_Live_MTU,0)>=1) live_n_non_live
,count(distinct payer_cust_id) filter(where coalesce(Live_MTU,0) =0 and coalesce(Non_Live_MTU,0)>=1) non_live_exc_live
,count(distinct payer_cust_id) filter(where coalesce(Top_15_MTU,0)>=1) Top_15_merc
,count(distinct payer_cust_id) filter(where coalesce(top_1K_MTU,0)>=1) Top_1K_MTU
from base_
group by 1
) AS virtual_table GROUP BY date_trunc('day', CAST(mnt AS TIMESTAMP)) ORDER BY sum(overall_mtu) DESC
LIMIT 5000;

"
585,6505,MTU_Live_Non_Live_Top_15_,"What is the daily breakdown of monthly transacting users across live merchants, non-live merchants, and top 15 merchants in our online payment platform?","SELECT date_trunc('day', CAST(mnt AS TIMESTAMP)) AS mnt, sum(overall_mtu) AS ""Overall_MTU__"", sum(live_merchants) AS ""Live_Merch_MTU"", sum(non_live_exc_live) AS ""Non_Live_MTU(excld_Live)"", sum(""Top_15_merc"") AS ""Top_15_Merch_MTU"", sum(""Top_1K_MTU"") AS ""Top_1K_MTU"" 
FROM (with base_ as (
select
mnt,
payer_cust_id,
SUM(1)
filter (where 
      lower(online_merchant_name) IN ('flipkart','Reliance','blinkit','zomato','swiggy','meesho','bharti','zepto','rapido','myntra','vodafone',
        'mpokket','bookmyshow','gokwik','jar','district','kreditbee','bigbasket','jiomart','cashfree','urban company','fancode','Paytm PG',
        'tataplay','hungerbox','nykaa','ola cabs','burger king','stage','magicpin','zee5','DMRC Momentum',
        '1mg','apollo','ajio','firstcry','chartr','eatclub','kfc','pharmeasy','zivame','pvr','snapdeal','gaana com','bbdaily','ketto online ventures pvt',
        'ferns n petal','gullak','rentomojo','dish tv','chaupal tv','healthians','tata play binge','rail yatri','igp','aha media','bakingo','nearbuy','netmeds'
        ,'Intrcity','d2h','freeup','floweraura','bix42','walmart')
)Live_MTU,
SUM(1) filter (where 
       lower(online_merchant_name) IN ('meesho','flipkart','zomato','Reliance','Myntra','bharti','gokwik','swiggy','rapido',
'blinkit','zepto','bookmyshow','mpokket','jar','vodafone') 
)Top_15_MTU, 
SUM(1)
filter (where 
        lower(online_merchant_name) Not IN ('flipkart','Reliance','blinkit','zomato','swiggy','meesho','bharti','zepto','rapido','myntra','vodafone',
        'mpokket','bookmyshow','gokwik','jar','district','kreditbee','bigbasket','jiomart','cashfree','urban company','fancode','Paytm PG',
        'tataplay','hungerbox','nykaa','ola cabs','burger king','stage','magicpin','zee5','DMRC Momentum',
        '1mg','apollo','ajio','firstcry','chartr','eatclub','kfc','pharmeasy','zivame','pvr','snapdeal','gaana com','bbdaily','ketto online ventures pvt',
        'ferns n petal','gullak','rentomojo','dish tv','chaupal tv','healthians','tata play binge','rail yatri','igp','aha media','bakingo','nearbuy','netmeds'
        ,'Intrcity','d2h','freeup','floweraura','bix42','walmart')
        )
Non_Live_MTU,
SUM(1) filter (where  top_1k = 1) top_1K_MTU
from 
(
select mnt,
payer_cust_id,
coalesce(b.online_merchant_name,'aaaaaaaaaa')online_merchant_name,
case when TP.online_merchant_name is not null then 1 else 0 end as top_1k
from
        (
           select distinct  date_Trunc('month',day_id)mnt, payer_cust_id,payee_vpa
        FROM user_paytm_payments.upi_abhay --user_paytm_payments.upi_flow_wise_base_partitioned
        WHERE
            day_id >= date_trunc('month',(current_Date - interval '01' day - interval '01' month))
            AND day(day_id) <= day(current_Date - interval '01' day)
            AND final_category = 'Online'
        ) a
        left join (SELECT payee_vpa,lower(online_merchant_name) online_merchant_name
        FROM (
        select *, row_number() over(partition by payee_vpa order by updated_on DESC) as rn from user_paytm_payments.upi_3p_online_merchant_vpa_mapping_V1
        )
        WHERE RN=1
        ) b
        ON LOWER(a.payee_vpa) = lower(b.payee_vpa)   
        
        LEFT JOIN (SELECT DISTINCT online_merchant_name from  user_paytm_payments.top1000_merchnats_nov_dec_and_offeractive_ss) TP
          ON lower(b.online_merchant_name) = lower(tp.online_merchant_name)
)
group by 1,2
) 

select 
mnt,
count(distinct payer_cust_id) overall_mtu
,count(distinct payer_cust_id) filter(where coalesce(Live_MTU,0)>=1) live_merchants
,count(distinct payer_cust_id) filter(where coalesce(Live_MTU,0)>=1 and coalesce(Non_Live_MTU,0)>=1) live_n_non_live
,count(distinct payer_cust_id) filter(where coalesce(Live_MTU,0) =0 and coalesce(Non_Live_MTU,0)>=1) non_live_exc_live
,count(distinct payer_cust_id) filter(where coalesce(Top_15_MTU,0)>=1) Top_15_merc
,count(distinct payer_cust_id) filter(where coalesce(top_1K_MTU,0)>=1) Top_1K_MTU
from base_
group by 1
) AS virtual_table GROUP BY date_trunc('day', CAST(mnt AS TIMESTAMP)) ORDER BY sum(overall_mtu) DESC
LIMIT 5000;

"
585,6680,FT/RT DoD Merchant Level (Top 15),"Which are the top 15 online merchants showing the best growth in new users and reactivated users compared to last month, and what are their month-over-month growth rates?","SELECT online_merchant_name AS online_merchant_name, day_id AS day_id__, sum(""MTD_New_Users"") AS ""MTD New users"", sum(""MTD_React2Mplus_Users"") AS ""MTD React Users"", sum(""LMTD_New_Users"") AS ""LMTD New Users"", sum(""LMTD_React2Mplus_Users"") AS ""LMTD React Users"", SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users) AS ""MTD New + React Users"", SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users) AS ""LMTD New + React Users"", case when SUM(LMTD_New_Users) = 0 then 0 else

(SUM(MTD_New_Users)*1.0000)/
(SUM(LMTD_New_Users)*1.0000)-1

end AS ""New user Growth"", case when SUM(LMTD_React2Mplus_Users) = 0 then 0 else
(SUM(MTD_React2Mplus_Users)*1.0000)/
(SUM(LMTD_React2Mplus_Users)*1.0000)-1
end AS ""React User Growth"", case when 
SUM(LMTD_New_Users) + sum(LMTD_React2Mplus_Users) = 0 then 0 else

(
(SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users)
)*1.0000)
/
(
(
SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users)
)*1.0000) - 1
end AS ""New+React User Growth"" 
FROM (WITH date_ranges AS (
          SELECT
              DATE_TRUNC('MONTH', DATE_ADD('day', -1, CURRENT_DATE)) AS mtd_start,
              DATE_ADD('day', -1, CURRENT_DATE) AS mtd_end,
              DATE_TRUNC('MONTH', DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE))) AS lmtd_start,
              DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE)) AS lmtd_end
      ),

      paytm_nrr_mtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
         FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
       and

        customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt between (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'MTD' AS period FROM paytm_nrr
      ),

      paytm_nrr_lmtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
     FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
       and

        customer_Id not in (
            Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt between (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'LMTD' AS period FROM paytm_nrr
      ),

      upi_online_ft AS (
      SELECT payer_cust_id, day_id,online_merchant_name, 'MTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      WHERE day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges) -- MTD Source
      )
      WHERE final_category = 'Online'
      AND rnk = 1


      UNION ALL

      SELECT payer_cust_id, day_id,online_merchant_name, 'LMTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      where day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      )
      WHERE final_category = 'Online'
      AND rnk = 1

      )

      SELECT
      day(b.day_id) as day_id,
      b.online_merchant_name,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_Repeat_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_Repeat_Users

      FROM (
      SELECT * FROM paytm_nrr_mtd
      UNION ALL
      SELECT * FROM paytm_nrr_lmtd
      ) AS a
      INNER JOIN upi_online_ft AS b
      ON a.payer_cust_id = b.payer_cust_id
      -- AND a.period = b.period
      and a.dt = b.day_id
      GROUP BY 1, 2
      ORDER BY 3, 1
) AS virtual_table 
WHERE ((online_merchant_name IN ('meesho', 'flipkart', 'zomato', 'reliance', 'myntra', 'bharti', 'gokwik', 'swiggy', 'rapido', 'blinkit', 'zepto', 'bookmyshow', 'mpokket', 'jar', 'vodafone'))) GROUP BY online_merchant_name, day_id ORDER BY max(day_id) ASC
LIMIT 10000;

"
585,6680,FT/RT DoD Merchant Level (Top 15),"Which are the top 15 online merchants by user growth, and how are their new users and reactivated users performing this month compared to last month?","SELECT online_merchant_name AS online_merchant_name, day_id AS day_id__, sum(""MTD_New_Users"") AS ""MTD New users"", sum(""MTD_React2Mplus_Users"") AS ""MTD React Users"", sum(""LMTD_New_Users"") AS ""LMTD New Users"", sum(""LMTD_React2Mplus_Users"") AS ""LMTD React Users"", SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users) AS ""MTD New + React Users"", SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users) AS ""LMTD New + React Users"", case when SUM(LMTD_New_Users) = 0 then 0 else

(SUM(MTD_New_Users)*1.0000)/
(SUM(LMTD_New_Users)*1.0000)-1

end AS ""New user Growth"", case when SUM(LMTD_React2Mplus_Users) = 0 then 0 else
(SUM(MTD_React2Mplus_Users)*1.0000)/
(SUM(LMTD_React2Mplus_Users)*1.0000)-1
end AS ""React User Growth"", case when 
SUM(LMTD_New_Users) + sum(LMTD_React2Mplus_Users) = 0 then 0 else

(
(SUM(MTD_New_Users) + SUM(MTD_React2Mplus_Users)
)*1.0000)
/
(
(
SUM(LMTD_New_Users) + SUM(LMTD_React2Mplus_Users)
)*1.0000) - 1
end AS ""New+React User Growth"" 
FROM (WITH date_ranges AS (
          SELECT
              DATE_TRUNC('MONTH', DATE_ADD('day', -1, CURRENT_DATE)) AS mtd_start,
              DATE_ADD('day', -1, CURRENT_DATE) AS mtd_end,
              DATE_TRUNC('MONTH', DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE))) AS lmtd_start,
              DATE_ADD('month', -1, DATE_ADD('day', -1, CURRENT_DATE)) AS lmtd_end
      ),

      paytm_nrr_mtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
         FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
       and

        customer_Id not in (
        Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_cm_10_logic
        where dt between (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
           ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'MTD' AS period FROM paytm_nrr
      ),

      paytm_nrr_lmtd AS (
      WITH paytm_nrr AS (
      SELECT dt, payer_cust_id, user_type AS paytm_user_type
      FROM (
      SELECT txn_date dt, customer_id AS payer_cust_id,
      CASE
      WHEN user_type = 'New' THEN 'New'
      WHEN user_type = 'Repeat' THEN 'Repeat'
      ELSE 'React_2M+'
      END AS user_type,
      row_number() over(partition by customer_id, date_Trunc('month',txn_date) order by txn_date) krn
     FROM user_paytm_payments.rolling_nrr_v1 --hive.user_paytm_payments.paytm_mau_final_nrr_exc
      WHERE txn_date BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
       and

        customer_Id not in (
            Select cust_id from user_paytm_payments.ft_base_with_mapping_raw_rolling_nrr_with_online_10_logic
        where dt between (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
        and lower(channel) in ('fmcg','masu online','masu offline','1. masu offline via fse','2. masu via p4b app','3. masu via paytm app','4. merchant gets user offline via qr code','5. merchant gets user via soundbox','6. merchant gets user via referral (p4b app)','7. fse as payer'
        ,'1.a. fse gets merchants as user'
        ,'1.b. fse gets merchants as other'
        ,'1.c.ong'
        ))
      )
      WHERE user_type IN ('New', 'React_2M+')
      --where krn = 1
      )
      SELECT dt, payer_cust_id, paytm_user_type, 'LMTD' AS period FROM paytm_nrr
      ),

      upi_online_ft AS (
      SELECT payer_cust_id, day_id,online_merchant_name, 'MTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      WHERE day_id BETWEEN (SELECT mtd_start FROM date_ranges) AND (SELECT mtd_end FROM date_ranges) -- MTD Source
      )
      WHERE final_category = 'Online'
      AND rnk = 1


      UNION ALL

      SELECT payer_cust_id, day_id,online_merchant_name, 'LMTD' AS period
      FROM (
      SELECT payer_cust_id, final_category, day_id,b.online_merchant_name,
      ROW_NUMBER() OVER (PARTITION BY payer_cust_id ORDER BY txn_timestamp ASC) AS rnk
      FROM user_paytm_payments.upi_abhay a
      left join user_paytm_payments.upi_3p_online_merchant_vpa_mapping b on lower(a.payee_vpa) = lower(b.payee_vpa)
      where day_id BETWEEN (SELECT lmtd_start FROM date_ranges) AND (SELECT lmtd_end FROM date_ranges)
      )
      WHERE final_category = 'Online'
      AND rnk = 1

      )

      SELECT
      day(b.day_id) as day_id,
      b.online_merchant_name,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'New' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_New_Users,
      count(distinct case when a.paytm_user_type = 'React_2M+' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_React2Mplus_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'MTD' then  a.payer_cust_id end) as MTD_Repeat_Users,
      count(distinct case when a.paytm_user_type = 'Repeat' and a.period = 'LMTD' then  a.payer_cust_id end) as LMTD_Repeat_Users

      FROM (
      SELECT * FROM paytm_nrr_mtd
      UNION ALL
      SELECT * FROM paytm_nrr_lmtd
      ) AS a
      INNER JOIN upi_online_ft AS b
      ON a.payer_cust_id = b.payer_cust_id
      -- AND a.period = b.period
      and a.dt = b.day_id
      GROUP BY 1, 2
      ORDER BY 3, 1
) AS virtual_table 
WHERE ((online_merchant_name IN ('meesho', 'flipkart', 'zomato', 'reliance', 'myntra', 'bharti', 'gokwik', 'swiggy', 'rapido', 'blinkit', 'zepto', 'bookmyshow', 'mpokket', 'jar', 'vodafone'))) GROUP BY online_merchant_name, day_id ORDER BY max(day_id) ASC
LIMIT 10000;

"
